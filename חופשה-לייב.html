<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>×–××Ÿ ×–×”×‘ - ×œ×•"×– ×—×•×¤×©×”</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #ff8c42;
            --secondary: #fff0e6;
            --holiday-bg: #ffe4c4;
            --bg-event-general: #ffffff;
            --bg-event-lodging: #e6f7ff;
            --bg-event-flight: #cce0ff;
            --bg-event-activity: #fff9e6;
            --text-dark: #5a4f45;
            --text-light: #ffffff;
            --day-block-bg: #ffffff;
            --day-block-shadow: rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'Rubik', sans-serif;
            background: var(--holiday-bg);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
            padding: 2rem; /* ×¨×™×•×•×— ×¨×—×‘ ××›×œ ×”×›×™×•×•× ×™× */
        }
        .navbar-brand-live {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary) !important;
            text-decoration: none;
            display: block;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .schedule-title {
            color: var(--text-dark);
            font-weight: 700;
            font-size: 1.8em;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* ×¤×¡ ×”×›×¤×ª×•×¨×™× ×”×—×“×© */
        .action-bar {
            margin-bottom: 1.5rem;
            padding: 0.5rem 0;
        }
        .action-bar .btn {
            min-width: 140px;
        }

        .day-block {
            background: var(--day-block-bg);
            color: var(--text-dark);
            border-radius: 1.5rem;
            padding: 2rem; /* padding ××•×’×“×œ */
            margin-top: 1rem; /* ×¨×™×•×•×— ×‘×™×Ÿ ×‘×œ×•×§×™× */
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px var(--day-block-shadow);
            transition: background .3s;
        }
        .day-block:hover { background: #fefefe; }
        .day-block[data-date] { position: relative; }
        .day-header {
            display: flex; flex-wrap: wrap;
            justify-content: center; align-items: center;
            gap: .5rem; font-size: 1.3rem; font-weight: 500;
            letter-spacing: .5px; margin-bottom: 1.5rem;
            color: var(--primary);
        }
        .lodging-badge {
            background: var(--bg-event-lodging);
            color: var(--text-dark);
            padding: .3rem .6rem;
            border-radius: .75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            font-size: .95rem;
            cursor: pointer; /* ×”×•×¡×¤× ×• */
            transition: transform .2s;
        }

        .event-row {
            display: flex; align-items: stretch;
            animation: popIn .3s ease-out both;
        }
        .times-col {
            width: 5.5rem;
            font-size: 0.95rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            margin-left: 1rem;
            color: var(--text-dark);
            font-weight: 500;
        }
        .content-col {
            position: relative; flex: 1;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            background: var(--bg-event-general);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: .75rem;
            overflow: hidden; color: var(--text-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .content-col[data-type="×˜×™×¡×”"] { background: var(--bg-event-flight); }
        .content-col[data-type="×¦'×§-××™×Ÿ"],
        .content-col[data-type="×¦'×§-×××•×˜"] { background: var(--bg-event-lodging); }
        .content-col[data-type="××˜×¨×§×¦×™×”"],
        .content-col[data-type="×¡×™×•×¨"] { background: var(--bg-event-activity); }

        .content-col::before {
            content: attr(data-bg-emoji);
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(5rem, 12vh, 7rem);
            line-height: 1;
            color: var(--text-dark);
            opacity: 0.08; z-index: 0;
            pointer-events: none;
        }
        .event-content-wrapper {
            position: relative; z-index: 1;
            display: flex; align-items: center;
        }
        .event-text-details { flex-grow: 1; }
        .event-icon { font-size: 1.5rem; margin-right: 10px; }
        .event-icon-flight {
            position: absolute; left: 15px; top: 50%;
            transform: translateY(-50%); font-size: 1.8rem;
        }
        .event-divider {
            border: 0; border-top: 1px solid #eee;
            margin: 1rem 0;
        }
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .btn-navigate {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px; height: 35px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transition: background-color 0.2s;
            position: absolute; bottom: 8px; right: 10px; padding: 0;
        }
        .btn-navigate:hover { background-color: #ff701a; }

        #noScheduleMessage {
            text-align: center; font-size: 1.2em;
            padding: 2rem; background-color: var(--secondary);
            border-radius: .5rem;
        }
    </style>
</head>
<body>
    <a class="navbar-brand-live" href="#">×–××Ÿ ×–×”×‘ - ×—×•×¤×©×” ğŸ˜Š</a>

    <div class="container">
        <!-- ×¤×¡ ×›×¤×ª×•×¨×™× -->
        <div class="action-bar d-flex justify-content-center gap-2">
            <button id="btnEditSchedule"   class="btn btn-outline-primary">âœï¸ ×¢×¨×•×š ×œ×•×–</button>
            <button id="btnShareSchedule"  class="btn btn-outline-success">ğŸ“¤ ×©×ª×£ ×œ×•×–</button>
            <button id="btnDeleteSchedule" class="btn btn-outline-danger">ğŸ—‘ï¸ ××—×§ ×œ×•×–</button>
            <button id="btnActivateLive"   class="btn btn-outline-warning">ğŸ”´ ×”×¤×¢×œ ×œ×™×™×‘</button>
        </div>

        <h2 id="displayScheduleName" class="text-center mb-4 schedule-title">×˜×•×¢×Ÿ ×œ×•"×–...</h2>
        <div id="scheduleContainer"></div>
        <div id="noScheduleMessage" style="display: none;">
            <p>×œ× × ××¦× ××™×“×¢ ×¢×‘×•×¨ ×œ×•"×– ×–×”, ××• ×©×”××™×“×¢ ××™× ×• ×‘×¤×•×¨××˜ ×”× ×“×¨×©.</p>
            <p><a href="my-schedules.html">×—×–×•×¨ ×œ×œ×•"×–×™× ×©×œ×™</a></p>
        </div>
    </div>

    <!-- Lodging Detail Modal -->
    <div class="modal fade" id="lodgingDetailModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">×¤×¨×˜×™ ×œ×™× ×”</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="detailLodType"></p>
            <p id="detailLodName"></p>
            <p>
              <span id="detailLodLocation"></span>
              <button type="button" id="detailLodNav" class="btn btn-sm btn-outline-primary">ğŸ—ºï¸ × ×•×•×˜</button>
            </p>
            <p id="detailLodCheckIn"></p>
            <p id="detailLodCheckOut"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×¡×’×•×¨</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Share Schedule Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">×©×ª×£ ×œ×•×–</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>×‘×—×¨ ×›×™×¦×“ ×œ×©×ª×£ ××ª ×”×œ×•×–:</p>
            <div class="d-flex gap-2 mb-3">
              <button id="shareAsTextBtn"       class="btn btn-outline-primary">ğŸ“„ ×©×ª×£ ×›×˜×§×¡×˜</button>
              <button id="shareAsScreenshotBtn" class="btn btn-outline-secondary">ğŸ“· ×©×ª×£ ×›×¦×™×œ×•× ××¡×š</button>
            </div>
            <textarea id="shareTextArea" class="form-control" rows="8" style="display:none;"></textarea>
            <div class="text-end mt-2">
              <button id="copyShareTextBtn" class="btn btn-primary" style="display:none;">×”×¢×ª×§ ×œ×˜×§×¡×˜</button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×¡×’×•×¨</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const weekdayNames = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
        const emojiMap = {
            '×”×©×§××”': 'â°','×©×™× ×”': 'ğŸ›ï¸','×”×œ×™×›×”/× ×¡×™×¢×”': 'ğŸš¶â€â™‚ï¸',
            '×¨×›×‘':'ğŸš—','×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª':'ğŸšŒ','×”×œ×™×›×”':'ğŸš¶â€â™‚ï¸',
            '××•×›×œ':'ğŸ´','×¡×™×•×¨':'ğŸï¸','××˜×¨×§×¦×™×”':'ğŸŸï¸',
            '×˜×™×¡×”':'âœˆï¸','×¦\'×§-××™×Ÿ':'ğŸ§³','×¦\'×§-×××•×˜':'ğŸ‘‹'
        };

        document.addEventListener('DOMContentLoaded', () => {
            const storedData = localStorage.getItem('liveVacationScheduleData');
            const scheduleNameEl = document.getElementById('displayScheduleName');
            const scheduleContainerEl = document.getElementById('scheduleContainer');
            const noScheduleMessageEl = document.getElementById('noScheduleMessage');

            if (!storedData) {
                scheduleNameEl.textContent = '×©×’×™××”';
                noScheduleMessageEl.style.display = 'block';
                console.error('No schedule data found in localStorage.');
                return;
            }

            let liveVacationData;
            try {
                liveVacationData = JSON.parse(storedData);
            } catch (error) {
                scheduleNameEl.textContent = '×©×’×™××” ×‘×¢×™×‘×•×“ ×”× ×ª×•× ×™×';
                noScheduleMessageEl.style.display = 'block';
                console.error('Error parsing schedule data:', error);
                return;
            }

            if (!liveVacationData.name || !liveVacationData.scheduleEvents || !liveVacationData.lodgings) {
                scheduleNameEl.textContent = '×©×’×™××” ×‘×¤×•×¨××˜ ×”× ×ª×•× ×™×';
                noScheduleMessageEl.style.display = 'block';
                console.error('Schedule data missing fields.', liveVacationData);
                return;
            }

            scheduleNameEl.textContent = `×œ×•×–: ${liveVacationData.name}`;
            renderFullSchedule(liveVacationData.scheduleEvents, liveVacationData.lodgings, scheduleContainerEl);

            // â€¼ï¸ ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” â€¼ï¸
            document.getElementById('btnEditSchedule').addEventListener('click', () => {
                localStorage.setItem('liveVacationScheduleDataEdit', storedData);
                window.location.href = '×—×•×¤×©×”.html'; // ×œ×“×£ ×¢×¨×™×›×ª ×”×œ×•×–
            });

            const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
            document.getElementById('btnShareSchedule').addEventListener('click', () => {
                document.getElementById('shareTextArea').style.display = 'none';
                document.getElementById('copyShareTextBtn').style.display = 'none';
                shareModal.show();
            });
            document.getElementById('shareAsTextBtn').addEventListener('click', () => {
                let text = `×œ×•×–: ${liveVacationData.name}\n\n`;
                const events = liveVacationData.scheduleEvents;
                Object.keys(events).sort((a,b)=>new Date(a)-new Date(b)).forEach(date => {
                    text += `${new Date(date).toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'numeric'})}:\n`;
                    events[date].sort((a,b)=>(a.start||a.departTime).localeCompare(b.start||b.departTime))
                        .forEach(ev => {
                            let line = `  - ${ev.type}`;
                            if (ev.type==='×˜×™×¡×”') {
                                line += ` ${ev.number||''} ${ev.from||''}â†’${ev.to||''} (${ev.departTime||''}-${ev.arriveTime||''})`;
                            } else if (ev.start && ev.end) {
                                line += ` (${ev.start}-${ev.end})`;
                            }
                            if (ev.location) line += ` @ ${ev.location}`;
                            text += line + '\n';
                        });
                    text += '\n';
                });
                const ta = document.getElementById('shareTextArea');
                ta.value = text;
                ta.style.display = 'block';
                const copyBtn = document.getElementById('copyShareTextBtn');
                copyBtn.style.display = 'inline-block';
                copyBtn.onclick = () => {
                    ta.select();
                    document.execCommand('copy');
                };
            });
            document.getElementById('shareAsScreenshotBtn').addEventListener('click', () => {
                captureAndDownloadScheduleScreenshot(liveVacationData.name);
                shareModal.hide();
            });

            document.getElementById('btnDeleteSchedule').addEventListener('click', () => {
                if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×œ×•×–?')) {
                    localStorage.removeItem('liveVacationScheduleData');
                    window.location.href = 'my-schedules.html';
                }
            });

            document.getElementById('btnActivateLive').addEventListener('click', () => {
                alert('TODO: ×”×¤×¢×œ×ª ×œ×•×– ×‘×œ×™×™×‘ ×¢×“×™×™×Ÿ ×œ× ××™×•×©××ª.');
            });

            // × ×™×•×•×˜ ×œ×¤×¨×˜×™ ×”×œ×™× ×”
            scheduleContainerEl.addEventListener('click', e => {
                if (e.target.classList.contains('lodging-badge')) {
                    const id = e.target.getAttribute('data-lodging-id');
                    showLodgingDetail(id);
                }
            });
        });

        // â€¼ï¸ ×¤×•× ×§×¦×™×•×ª ××¨×›×–×™×•×ª (××”×§×•×“ ×”××§×•×¨×™) â€¼ï¸
        function renderFullSchedule(scheduleEvents, lodgings, container) {
            container.innerHTML = '';
            if (Object.keys(scheduleEvents).length === 0) {
                container.innerHTML = '<p class="text-center p-3">×”×œ×•"×– ×”×–×” ×¨×™×§ ×××™×¨×•×¢×™×.</p>';
                return;
            }
            const sortedDates = Object.keys(scheduleEvents).sort((a,b)=>new Date(a)-new Date(b));
            sortedDates.forEach(dateString => {
                const dayName = weekdayNames[new Date(dateString).getDay()];
                const dayBlockElement = createDayBlock(dayName, dateString, lodgings);
                container.appendChild(dayBlockElement);
                const eventsForDate = scheduleEvents[dateString] || [];
                eventsForDate.sort((a,b)=>(a.start||a.departTime).localeCompare(b.start||b.departTime));
                eventsForDate.forEach((eventData, idx) => {
                    if (idx>0) {
                        let hr = document.createElement('hr');
                        hr.className = 'event-divider';
                        dayBlockElement.appendChild(hr);
                    }
                    renderEventRow(dayBlockElement, dateString, eventData);
                });
            });
        }

        function createDayBlock(day, date, lodgingsArray) {
            let blk = document.createElement('div');
            blk.className = 'day-block';
            blk.dataset.date = date;
            let badgesHTML = '';
            if (Array.isArray(lodgingsArray)) {
                badgesHTML = lodgingsArray
                    .filter(l => date >= l.checkInDate && date <= l.checkOutDate)
                    .map(l => `<span class="lodging-badge" data-lodging-id="${l.id}">${l.name}</span>`)
                    .join('');
            }
            blk.innerHTML = `<div class="day-header"><span>${day} â€“ ${new Date(date).toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'numeric'})}</span>${badgesHTML}</div>`;
            return blk;
        }

        function renderEventRow(dayBlockElement, date, eventData) {
            let rowDiv = document.createElement('div');
            rowDiv.className = 'event-row';
            let times = document.createElement('div');
            times.className = 'times-col';
            const start = eventData.start || eventData.departTime || '';
            const end   = eventData.end   || eventData.arriveTime || '';
            times.innerHTML = `<span>${start}</span><span>${end}</span>`;

            let content = document.createElement('div');
            content.className = 'content-col';
            content.setAttribute('data-type', eventData.type);

            let bgKey = eventData.type;
            if (eventData.type==='×”×œ×™×›×”/× ×¡×™×¢×”' && eventData.mode) {
                if (eventData.mode.includes('×¨×›×‘')) bgKey='×¨×›×‘';
                else if (eventData.mode.includes('×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª')) bgKey='×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª';
                else if (eventData.mode.includes('×”×œ×™×›×”')) bgKey='×”×œ×™×›×”';
            }
            const bgEmoji = emojiMap[bgKey] || '';
            if (bgEmoji) content.setAttribute('data-bg-emoji', bgEmoji);

            let iconHTML='', eventHTML='';
            const genEmoji = emojiMap[eventData.type] || 'ğŸ“';
            switch(eventData.type) {
                case '×˜×™×¡×”':
                    iconHTML = `<div class="event-icon-flight">âœˆï¸</div>`;
                    eventHTML = `
                        <div class="event-text-details">
                            <div><strong>×˜×™×¡×” ×${eventData.from||''} â¬…ï¸ ${eventData.to||''}</strong></div>
                            <div>${eventData.number||''}${eventData.airline?` / ${eventData.airline}`:''}</div>
                            <div>×”××¨××” ğŸ›«: ${eventData.departTime||''}</div>
                            <div>× ×—×™×ª×” ğŸ›¬: ${eventData.arriveTime||''}</div>
                            ${eventData.description?`<div><em>${eventData.description}</em></div>`:''}
                        </div>`;
                    if (eventData.from) {
                        eventHTML += `<button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${eventData.from.replace(/'/g,"\\'")}')" title="× ×•×•×˜ ××œ ${eventData.from}">ğŸ—ºï¸</button>`;
                    }
                    break;
                case '×”×©×§××”': case '×©×™× ×”':
                    iconHTML = `<div class="event-icon">${genEmoji}</div>`;
                    eventHTML = `<div class="event-text-details"><div><strong>${eventData.type}</strong></div>${eventData.description?`<div>${eventData.description}</div>`:''}</div>`;
                    break;
                case '×”×œ×™×›×”/× ×¡×™×¢×”':
                    let dispEmoji = emojiMap['×”×œ×™×›×”/× ×¡×™×¢×”'];
                    if (eventData.mode) {
                        if (eventData.mode.includes('×¨×›×‘')) dispEmoji = emojiMap['×¨×›×‘'];
                        else if (eventData.mode.includes('×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª')) dispEmoji = emojiMap['×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª'];
                        else if (eventData.mode.includes('×”×œ×™×›×”')) dispEmoji = emojiMap['×”×œ×™×›×”'];
                    }
                    iconHTML = `<div class="event-icon">${dispEmoji}</div>`;
                    eventHTML = `
                        <div class="event-text-details">
                            <div><strong>${eventData.mode||'×”×œ×™×›×”/× ×¡×™×¢×”'}</strong></div>
                            ${eventData.startLocation?`<div>×: ${eventData.startLocation}</div>`:''}
                            <div>××œ: ${eventData.endLocation||''}</div>
                            ${eventData.description?`<div>${eventData.description}</div>`:''}
                        </div>`;
                    if (eventData.endLocation) {
                        eventHTML += `<button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${eventData.endLocation.replace(/'/g,"\\'")}')" title="× ×•×•×˜ ××œ ${eventData.endLocation}">ğŸ—ºï¸</button>`;
                    }
                    break;
                case "×¦'×§-××™×Ÿ": case "×¦'×§-×××•×˜":
                    iconHTML = `<div class="event-icon">${genEmoji}</div>`;
                    eventHTML = `<div class="event-text-details"><div><strong>${eventData.type}: ${eventData.lodgingName||''}</strong></div>${eventData.location?`<div>${eventData.location}</div>`:''}</div>`;
                    if (eventData.type==="×¦'×§-××™×Ÿ" && eventData.location) {
                        eventHTML += `<button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${eventData.location.replace(/'/g,"\\'")}')" title="× ×•×•×˜ ××œ ${eventData.location}">ğŸ—ºï¸</button>`;
                    }
                    break;
                default:
                    iconHTML = `<div class="event-icon">${genEmoji}</div>`;
                    let title = eventData.customSubjectName||eventData.type;
                    if (eventData.type==='××•×›×œ' && eventData.foodPlace) title = eventData.foodPlace;
                    eventHTML = `<div class="event-text-details"><div><strong>${title}</strong></div>${eventData.location?`<div>××™×§×•×: ${eventData.location}</div>`:''}${eventData.description?`<div>${eventData.description}</div>`:''}</div>`;
                    if (eventData.location) {
                        eventHTML += `<button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${eventData.location.replace(/'/g,"\\'")}')" title="× ×•×•×˜ ××œ ${eventData.location}">ğŸ—ºï¸</button>`;
                    }
            }

            content.innerHTML = `<div class="event-content-wrapper">${iconHTML}${eventHTML}</div>`;
            rowDiv.append(times, content);
            dayBlockElement.appendChild(rowDiv);
        }

        function openMapForNavigation(addr) {
            if (addr) window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}`, '_blank');
        }

        function captureAndDownloadScheduleScreenshot(scheduleName) {
            const scheduleContainerElement = document.getElementById('scheduleContainer');
            if (!scheduleContainerElement || !scheduleContainerElement.children.length) {
                alert("××™×Ÿ ×ª×•×›×Ÿ ×œ×¦×œ× ×‘×œ×•×–.");
                return;
            }
            const wrapper = document.createElement('div');
            wrapper.style.padding = '20px';
            wrapper.style.backgroundColor = '#FFFFFF';
            wrapper.style.display = 'inline-block';
            const titleElement = document.getElementById('displayScheduleName');
            if (titleElement) {
                const clonedTitle = titleElement.cloneNode(true);
                clonedTitle.style.textAlign = 'center';
                clonedTitle.style.marginBottom = '20px';
                wrapper.appendChild(clonedTitle);
            }
            const clone = scheduleContainerElement.cloneNode(true);
            wrapper.appendChild(clone);
            wrapper.style.position = 'absolute';
            wrapper.style.left = '-9999px';
            wrapper.style.top = '-9999px';
            document.body.appendChild(wrapper);

            html2canvas(wrapper, {
                scale: 1.5,
                useCORS: true,
                backgroundColor: "#ffffff",
                logging: false
            }).then(canvas => {
                document.body.removeChild(wrapper);
                const image = canvas.toDataURL("image/png");
                const link = document.createElement('a');
                const safeName = (scheduleName || '×œ×•×–-×—×•×¤×©×”').replace(/[^a-z0-9×-×ª_\-\s]/gi, '').replace(/\s+/g, '_');
                link.download = `${safeName}.png`;
                link.href = image;
                link.click();
                setTimeout(() => URL.revokeObjectURL(link.href), 100);
            }).catch(err => {
                if (document.body.contains(wrapper)) document.body.removeChild(wrapper);
                console.error('×©×’×™××” ×‘×¦×™×œ×•× ××¡×š:', err);
                alert('××™×¨×¢×” ×©×’×™××” ×‘××”×œ×š ×¦×™×œ×•× ×”××¡×š.');
            });
        }
    </script>
</body>
</html>