<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>×–××Ÿ ×–×”×‘ - ×œ×•"×– ×—×•×¤×©×”</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <style>
        :root {
            --primary: #ff8c42; /* ×›×ª×•× ×¨××©×™ */
            --primary-dark: #e67300; /* ×’×•×•×Ÿ ×›×”×” ×™×•×ª×¨ ×©×œ ×”×¨××©×™ ×œ-hover */
            --secondary: #fffaf0; /* ×§×¨× ×‘×”×™×¨ ×œ×¨×§×¢×™× ×©×œ ×§×•× ×˜×™×™× ×¨×™× */
            --holiday-bg: #fef7ef; /* ×¨×§×¢ ×›×œ×œ×™ ×¢×“×™×Ÿ ×××•×“ */
            --bg-event-general: #ffffff;
            --bg-event-lodging: #e6f7ff; /* ×ª×›×œ×ª ×œ×œ×™× ×” */
            --bg-event-flight: #d6ebff;  /* ×›×—×•×œ ×‘×”×™×¨ ×™×•×ª×¨ ×œ×˜×™×¡×” */
            --bg-event-activity: #fffacd; /* ×¦×”×•×‘ ×‘×”×™×¨ ×œ××˜×¨×§×¦×™×” */
            --text-dark: #4a3f35;  /* ×—×•× ×›×”×” ×œ×˜×§×¡×˜ */
            --text-light: #ffffff;
            --text-muted: #75665a; /* ×—×•× ××¤×¨×¤×¨ ×œ×˜×§×¡×˜ ××©× ×™ */
            --border-color: #e0e0e0;   /* ×¦×‘×¢ ×’×‘×•×œ ×¢×“×™×Ÿ */
            --day-block-bg: #ffffff;
            --day-block-shadow: rgba(0, 0, 0, 0.07); /* ×¦×œ ×¨×š ×™×•×ª×¨ */
            --hover-lift-shadow: rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'Rubik', sans-serif;
            background: var(--holiday-bg);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
            padding: 2rem;
        }
        .navbar-brand-live {
            font-size: 2.2rem; /* ××¢×˜ ×’×“×•×œ ×™×•×ª×¨ */
            font-weight: 700;
            color: var(--primary) !important;
            text-decoration: none;
            display: block;
            text-align: center;
            margin-bottom: 2.5rem; /* ×¨×™×•×•×— ×’×“×•×œ ×™×•×ª×¨ */
        }
        .schedule-title {
            color: var(--text-dark);
            font-weight: 700;
            font-size: 2em; /* ××¢×˜ ×’×“×•×œ ×™×•×ª×¨ */
            margin-bottom: 2.5rem; /* ×¨×™×•×•×— × ×•×¡×£ */
        }
        .container {
            background-color: var(--secondary); /* ×¨×§×¢ ××˜×•× ×•× ×¢×™× ×™×•×ª×¨ */
            border-radius: 1.25rem; /* ×¨×“×™×•×¡ ×¤×™× ×•×ª ××•×’×“×œ */
            padding: 2.5rem 3rem; /* ×¨×™×•×•×— ×¤× ×™××™ ××•×’×“×œ */
            box-shadow: 0 12px 35px rgba(0,0,0,0.08); /* ×¦×œ ××•×“×’×© ×™×•×ª×¨ ××š ××¤×•×–×¨ */
            max-width: 1100px; /* ×”×’×‘×œ×ª ×¨×•×—×‘ ×œ×§×¨×™××•×ª ×˜×•×‘×” ×™×•×ª×¨ */
            margin-left: auto;
            margin-right: auto;
        }

        .action-bar {
            margin-bottom: 2.5rem; /* ×¨×™×•×•×— ×’×“×•×œ ×™×•×ª×¨ */
            padding-bottom: 1.5rem; /* ×¨×™×•×•×— × ×•×¡×£ ××ª×—×ª ×œ×›×¤×ª×•×¨×™× */
            border-bottom: 1px solid var(--border-color); /* ×§×• ×”×¤×¨×“×” ×¢×“×™×Ÿ */
        }
        .action-bar .btn {
            min-width: 150px; /* ×¨×•×—×‘ ××™× ×™××œ×™ ×’×“×•×œ ×™×•×ª×¨ */
            font-weight: 500; /* ×¤×•× ×˜ ××¢×˜ ××•×“×’×© ×œ×›×¤×ª×•×¨×™× */
            padding: 0.7rem 1.2rem; /* ×¨×™×•×•×— ×¤× ×™××™ ×‘×›×¤×ª×•×¨×™× */
            border-radius: 0.5rem; /* ×¤×™× ×•×ª ××¢×•×’×œ×•×ª */
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s;
        }
        .action-bar .btn:hover {
            transform: translateY(-2px); /* ××¤×§×˜ ×”×¨××” ×§×œ */
        }

        #btnEditSchedule   { background-color: var(--primary); border-color: var(--primary); color: var(--text-light); }
        #btnEditSchedule:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }

        #btnShareSchedule  { background-color: #28a745; border-color: #28a745; color: var(--text-light); } /* ×™×¨×•×§ */
        #btnShareSchedule:hover { background-color: #218838; border-color: #1e7e34; }

        #btnDeleteSchedule { background-color: #dc3545; border-color: #dc3545; color: var(--text-light); } /* ××“×•× */
        #btnDeleteSchedule:hover { background-color: #c82333; border-color: #bd2130; }

        #btnActivateLive   { background-color: #ffc107; border-color: #ffc107; color: var(--text-dark); } /* ×¦×”×•×‘ */
        #btnActivateLive:hover { background-color: #e0a800; border-color: #d39e00; }


        .day-block {
            background: var(--day-block-bg);
            color: var(--text-dark);
            border-radius: 1rem;
            padding: 2rem 2.5rem; /* ×¨×™×•×•×— ×¤× ×™××™ ××•×’×“×œ */
            margin-bottom: 3rem; /* ×¨×™×•×•×— ××—×™×“ ×•×’×“×•×œ ×™×•×ª×¨ ×‘×™×Ÿ ×‘×œ×•×§×™× */
            box-shadow: 0 8px 20px var(--day-block-shadow); /* ×¦×œ ××¢×•×“×Ÿ */
            transition: transform .2s ease-out, box-shadow .2s ease-out;
            border: 1px solid var(--border-color);
        }
        .day-block:hover {
            transform: translateY(-5px); /* ×”×¨××” ××•×“×’×©×ª ×™×•×ª×¨ */
            box-shadow: 0 12px 25px var(--hover-lift-shadow);
        }
        .day-block[data-date] { position: relative; }
        .day-header {
            display: flex; flex-wrap: wrap;
            justify-content: space-between; /* ×™×™×©×•×¨ ×”×ª××¨×™×š ×œ×©×××œ ×•×ª×’×™×•×ª ×œ×™××™×Ÿ */
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem; /* ×¤×•× ×˜ ×›×•×ª×¨×ª ×™×•× ×’×“×•×œ ×™×•×ª×¨ */
            font-weight: 600;
            letter-spacing: .5px;
            margin-bottom: 1.8rem; /* ×¨×™×•×•×— ×’×“×•×œ ×™×•×ª×¨ */
            padding-bottom: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary);
        }
        .lodging-badge {
            background: var(--bg-event-lodging);
            color: #004085; /* ×¦×‘×¢ ×˜×§×¡×˜ ×›×”×” ×™×•×ª×¨ ×œ× ×™×’×•×“×™×•×ª ×˜×•×‘×” ×™×•×ª×¨ */
            padding: .5rem .9rem;
            border-radius: .5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            font-size: .95rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform .2s, background-color .2s, box-shadow .2s;
            border: 1px solid #b8daff;
        }
        .lodging-badge:hover {
            transform: translateY(-2px);
            background-color: #d4eaff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .event-row {
            display: flex; align-items: stretch;
            animation: popIn .35s ease-out both .1s; /* ×“×™×œ×™×™ ×§×œ ×œ×× ×™××¦×™×” */
            margin-top: 1.2rem;
        }
        .times-col {
            width: 6.5rem;
            font-size: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-left: 1.8rem;
            color: var(--text-muted);
            font-weight: 500;
            flex-shrink: 0; /* ×× ×™×¢×ª ×”×ª×›×•×•×¦×•×ª ×¢××•×“×ª ×”×©×¢×•×ª */
        }
        .times-col span:first-child { margin-bottom: 0.4rem; }

        .content-col {
            position: relative; flex: 1;
            padding: 1.3rem 2rem;
            border-radius: 0.8rem;
            background: var(--bg-event-general);
            box-shadow: 0 5px 15px rgba(0,0,0,0.06);
            margin-bottom: 1rem;
            overflow: hidden; color: var(--text-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid var(--border-color);
            transition: box-shadow .2s;
        }
        .content-col:hover {
            box-shadow: 0 7px 18px rgba(0,0,0,0.08);
        }

        .content-col[data-type="×˜×™×¡×”"] { background: var(--bg-event-flight); border-color: #b3d7ff; }
        .content-col[data-type="×¦'×§-××™×Ÿ"],
        .content-col[data-type="×¦'×§-×××•×˜"] { background: var(--bg-event-lodging); border-color: #b3d7ff; }
        .content-col[data-type="××˜×¨×§×¦×™×”"],
        .content-col[data-type="×¡×™×•×¨"] { background: var(--bg-event-activity); border-color: #ffe082;}

        .content-col::before {
            content: attr(data-bg-emoji);
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(6rem, 14vh, 8rem);
            line-height: 1;
            color: var(--text-dark);
            opacity: 0.05; /* ×¢×•×“ ×™×•×ª×¨ ×¢×“×™×Ÿ */
            z-index: 0;
            pointer-events: none;
        }
        .event-content-wrapper {
            position: relative; z-index: 1;
            display: flex; align-items: center;
        }
        .event-text-details { flex-grow: 1; line-height: 1.65; }
        .event-text-details strong { font-weight: 600; color: var(--text-dark); }
        .event-text-details div { margin-bottom: 0.3rem; }
        .event-text-details div:last-child { margin-bottom: 0; }
        .event-icon { font-size: 1.7rem; margin-right: 15px; color: var(--primary); }
        .event-icon-flight {
            position: absolute; left: 20px;
            top: 50%;
            transform: translateY(-50%); font-size: 2.2rem; color: var(--primary);
        }
        .event-divider {
            border: 0; border-top: 1px dashed #e0e0e0; /* ×§×• ××¨×•×¡×§ ×¢×“×™×Ÿ */
            margin: 2rem 0; /* ×¨×™×•×•×— ×’×“×•×œ ×™×•×ª×¨ */
        }
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(15px) scale(0.97); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .btn-navigate {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 20px; /* ×¢×™×’×•×œ ××œ× ×™×•×ª×¨ */
            width: 40px; height: 40px; /* ×’×•×“×œ ××—×™×“ */
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 1.1rem; /* ××™×™×§×•×Ÿ ×’×“×•×œ ×™×•×ª×¨ */
            box-shadow: 0 3px 7px rgba(0,0,0,0.15);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            position: absolute; bottom: 15px; right: 15px; padding: 0;
        }
        .btn-navigate:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

        #noScheduleMessage {
            text-align: center; font-size: 1.25em;
            padding: 3.5rem;
            background-color: #fff3e0; /* ×¨×§×¢ ××¢×˜ ×—× ×™×•×ª×¨ */
            border-radius: .8rem;
            color: var(--text-muted);
            border: 1px dashed var(--primary);
        }
        #noScheduleMessage p { margin-bottom: 1rem; }
        #noScheduleMessage a { color: var(--primary); text-decoration: none; font-weight: 500; }
        #noScheduleMessage a:hover { text-decoration: underline; color: var(--primary-dark); }

        .modal-content {
            border-radius: 1rem;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .modal-header {
            background-color: var(--primary);
            color: var(--text-light);
            border-bottom: none; /* ×”×¡×¨×ª ×§×• ×ª×—×ª×•×Ÿ */
            padding: 1.2rem 1.8rem;
            border-top-left-radius: 1rem; /* ×”×ª×××ª ×¨×“×™×•×¡×™× */
            border-top-right-radius: 1rem;
        }
        .modal-header .btn-close {
            filter: brightness(0) invert(1); /* ×œ×”×¤×•×š ××ª ×¦×‘×¢ ×”××™×§×¡ ×œ×œ×‘×Ÿ */
        }
        .modal-title {
            font-weight: 600;
            font-size: 1.4rem;
        }
        .modal-body {
            padding: 1.8rem;
            line-height: 1.75;
        }
        .modal-body p { margin-bottom: 1.1rem; }
        #detailLodNav { margin-right: 0.5rem; } /* ×¨×™×•×•×— ×§×˜×Ÿ ××™××™×Ÿ ×œ×›×¤×ª×•×¨ ×”× ×™×•×•×˜ ×‘××•×“×œ */

        .modal-footer {
            background-color: #f9f9f9;
            border-top: 1px solid var(--border-color);
            padding: 1.2rem 1.8rem;
            border-bottom-left-radius: 1rem; /* ×”×ª×××ª ×¨×“×™×•×¡×™× */
            border-bottom-right-radius: 1rem;
        }
        .modal-footer .btn {
            padding: 0.6rem 1.2rem;
            font-weight: 500;
        }

        #shareModal .btn-outline-primary,
        #shareModal .btn-outline-secondary {
            padding: 0.7rem 1rem;
            font-weight: 500;
        }
        #shareModal .btn-outline-primary {
            color: var(--primary);
            border-color: var(--primary);
        }
        #shareModal .btn-outline-primary:hover {
            background-color: var(--primary);
            color: var(--text-light);
        }
        #shareModal .btn-outline-secondary {
            color: #6c757d;
            border-color: #6c757d;
        }
        #shareModal .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: var(--text-light);
        }
        #copyShareTextBtn {
            background-color: var(--primary);
            border-color: var(--primary);
            color: var(--text-light);
            font-weight: 500;
            padding: 0.6rem 1.2rem;
        }
        #copyShareTextBtn:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        #shareTextArea {
            border-radius: 0.5rem;
            border-color: var(--border-color);
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <a class="navbar-brand-live" href="#">×–××Ÿ ×–×”×‘ - ×—×•×¤×©×” ğŸ˜Š</a>

    <div class="container">
        <div class="action-bar d-flex justify-content-center flex-wrap gap-2"> <button id="btnEditSchedule"   class="btn">âœï¸ ×¢×¨×•×š ×œ×•×–</button>
            <button id="btnShareSchedule"  class="btn">ğŸ“¤ ×©×ª×£ ×œ×•×–</button>
            <button id="btnDeleteSchedule" class="btn">ğŸ—‘ï¸ ××—×§ ×œ×•×–</button>
            <button id="btnActivateLive"   class="btn">ğŸ”´ ×”×¤×¢×œ ×œ×™×™×‘</button>
        </div>

        <h2 id="displayScheduleName" class="text-center mb-4 schedule-title">×˜×•×¢×Ÿ ×œ×•"×–...</h2>
        <div id="scheduleContainer"></div>
        <div id="noScheduleMessage" style="display: none;">
            <p>×œ× × ××¦× ××™×“×¢ ×¢×‘×•×¨ ×œ×•"×– ×–×”, ××• ×©×”××™×“×¢ ××™× ×• ×‘×¤×•×¨××˜ ×”× ×“×¨×©.</p>
            <p><a href="my-schedules.html">×—×–×•×¨ ×œ×œ×•"×–×™× ×©×œ×™</a></p>
        </div>
    </div>

    <div class="modal fade" id="lodgingDetailModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">×¤×¨×˜×™ ×œ×™× ×”</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="detailLodType"></p>
            <p id="detailLodName"></p>
            <p>
              <span id="detailLodLocation"></span>
              <button type="button" id="detailLodNav" class="btn btn-sm btn-outline-primary">ğŸ—ºï¸ × ×•×•×˜</button>
            </p>
            <p id="detailLodCheckIn"></p>
            <p id="detailLodCheckOut"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×¡×’×•×¨</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="shareModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">×©×ª×£ ×œ×•×–</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>×‘×—×¨ ×›×™×¦×“ ×œ×©×ª×£ ××ª ×”×œ×•×–:</p>
            <div class="d-flex gap-2 mb-3">
              <button id="shareAsTextBtn"       class="btn btn-outline-primary">ğŸ“„ ×©×ª×£ ×›×˜×§×¡×˜</button>
              <button id="shareAsScreenshotBtn" class="btn btn-outline-secondary">ğŸ“· ×©×ª×£ ×›×¦×™×œ×•× ××¡×š</button>
            </div>
            <textarea id="shareTextArea" class="form-control" rows="8" style="display:none;"></textarea>
            <div class="text-end mt-2">
              <button id="copyShareTextBtn" class="btn" style="display:none;">×”×¢×ª×§ ×˜×§×¡×˜</button> </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×¡×’×•×¨</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const weekdayNames = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
        const emojiMap = {
            '×”×©×§××”': 'â°','×©×™× ×”': 'ğŸ›ï¸','×”×œ×™×›×”/× ×¡×™×¢×”': 'ğŸš¶â€â™‚ï¸',
            '×¨×›×‘':'ğŸš—','×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª':'ğŸšŒ','×”×œ×™×›×”':'ğŸš¶â€â™‚ï¸',
            '××•×›×œ':'ğŸ´','×¡×™×•×¨':'ğŸï¸','××˜×¨×§×¦×™×”':'ğŸŸï¸',
            '×˜×™×¡×”':'âœˆï¸','×¦\'×§-××™×Ÿ':'ğŸ§³','×¦\'×§-×××•×˜':'ğŸ‘‹'
        };

        document.addEventListener('DOMContentLoaded', () => {
            const storedData = localStorage.getItem('liveVacationScheduleData');
            const scheduleNameEl = document.getElementById('displayScheduleName');
            const scheduleContainerEl = document.getElementById('scheduleContainer');
            const noScheduleMessageEl = document.getElementById('noScheduleMessage');

            if (!storedData) {
                scheduleNameEl.textContent = '×©×’×™××”';
                noScheduleMessageEl.style.display = 'block';
                console.error('No schedule data found in localStorage.');
                return;
            }

            let liveVacationData;
            try {
                liveVacationData = JSON.parse(storedData);
            } catch (error) {
                scheduleNameEl.textContent = '×©×’×™××” ×‘×¢×™×‘×•×“ ×”× ×ª×•× ×™×';
                noScheduleMessageEl.style.display = 'block';
                console.error('Error parsing schedule data:', error);
                return;
            }

            if (!liveVacationData || typeof liveVacationData !== 'object' || !liveVacationData.name || !liveVacationData.scheduleEvents || !liveVacationData.lodgings) {
                scheduleNameEl.textContent = '×©×’×™××” ×‘×¤×•×¨××˜ ×”× ×ª×•× ×™×';
                noScheduleMessageEl.style.display = 'block';
                console.error('Schedule data missing fields or invalid format.', liveVacationData);
                return;
            }


            scheduleNameEl.textContent = `×œ×•×–: ${liveVacationData.name}`;
            renderFullSchedule(liveVacationData.scheduleEvents, liveVacationData.lodgings, scheduleContainerEl);

            // â€¼ï¸ ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” â€¼ï¸
            document.getElementById('btnEditSchedule').addEventListener('click', () => {
                localStorage.setItem('liveVacationScheduleDataEdit', storedData);
                window.location.href = '×—×•×¤×©×”.html'; // ×œ×“×£ ×¢×¨×™×›×ª ×”×œ×•×–
            });

            const shareModalEl = document.getElementById('shareModal');
            if (shareModalEl) {
                const shareModalInstance = new bootstrap.Modal(shareModalEl);
                document.getElementById('btnShareSchedule').addEventListener('click', () => {
                    document.getElementById('shareTextArea').style.display = 'none';
                    document.getElementById('copyShareTextBtn').style.display = 'none';
                    shareModalInstance.show();
                });
            }


            document.getElementById('shareAsTextBtn').addEventListener('click', () => {
                let text = `×œ×•×–: ${liveVacationData.name}\n\n`;
                const events = liveVacationData.scheduleEvents;
                Object.keys(events).sort((a,b)=>new Date(a)-new Date(b)).forEach(date => {
                    const formattedDate = new Date(date).toLocaleDateString('he-IL',{weekday: 'long', day:'2-digit',month:'2-digit',year:'numeric'});
                    text += `${formattedDate}:\n`;
                    events[date].sort((a,b)=>(a.start||a.departTime).localeCompare(b.start||b.departTime))
                        .forEach(ev => {
                            let line = `  ${ev.start || ev.departTime || ''}`;
                            if(ev.end || ev.arriveTime) line += `-${ev.end || ev.arriveTime || ''}`;
                            line += ` - ${ev.type}`;

                            if (ev.type==='×˜×™×¡×”') {
                                line += ` ${ev.number||''} ×:${ev.from||''} ××œ:${ev.to||''}`;
                                if(ev.airline) line += ` (${ev.airline})`;
                            } else if (ev.type==='×¦\'×§-××™×Ÿ' || ev.type==='×¦\'×§-×××•×˜') {
                                line += `: ${ev.lodgingName || ''}`;
                                if (ev.location) line += ` (${ev.location})`;
                            } else if (ev.type==='×”×œ×™×›×”/× ×¡×™×¢×”'){
                                if(ev.mode) line += ` (${ev.mode})`;
                                if(ev.startLocation) line += ` ×:${ev.startLocation}`;
                                if(ev.endLocation) line += ` ××œ:${ev.endLocation}`;
                            } else {
                                if (ev.customSubjectName) line += `: ${ev.customSubjectName}`;
                                else if (ev.type === '××•×›×œ' && ev.foodPlace) line += `: ${ev.foodPlace}`;
                                if (ev.location) line += ` (${ev.location})`;
                            }
                            if (ev.description) line += ` - ${ev.description}`;
                            text += line + '\n';
                        });
                    text += '\n';
                });
                const ta = document.getElementById('shareTextArea');
                ta.value = text;
                ta.style.display = 'block';
                const copyBtn = document.getElementById('copyShareTextBtn');
                copyBtn.style.display = 'inline-block';
                copyBtn.onclick = () => {
                    ta.select();
                    navigator.clipboard.writeText(ta.value).then(() => {
                        copyBtn.textContent = '×”×•×¢×ª×§!';
                        setTimeout(() => { copyBtn.textContent = '×”×¢×ª×§ ×˜×§×¡×˜'; }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        // Fallback for older browsers
                        try {
                            document.execCommand('copy');
                            copyBtn.textContent = '×”×•×¢×ª×§!';
                            setTimeout(() => { copyBtn.textContent = '×”×¢×ª×§ ×˜×§×¡×˜'; }, 2000);
                        } catch (e) {
                            alert('×”×”×¢×ª×§×” × ×›×©×œ×”. ×× × ×”×¢×ª×§ ×™×“× ×™×ª.');
                        }
                    });
                };
            });
            document.getElementById('shareAsScreenshotBtn').addEventListener('click', () => {
                if (typeof html2canvas === 'undefined') {
                    alert('×¡×¤×¨×™×™×ª ×¦×™×œ×•× ×”××¡×š (html2canvas) ×œ× × ×˜×¢× ×”. ×œ× × ×™×ª×Ÿ ×œ×¦×œ× ××¡×š.');
                    const shareModalInstance = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
                    if (shareModalInstance) shareModalInstance.hide();
                    return;
                }
                captureAndDownloadScheduleScreenshot(liveVacationData.name);
                const shareModalInstance = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
                if (shareModalInstance) shareModalInstance.hide();
            });

            document.getElementById('btnDeleteSchedule').addEventListener('click', () => {
                if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×œ×•×–? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”.')) {
                    localStorage.removeItem('liveVacationScheduleData'); // ××—×™×§×ª ×”×œ×•×– ×”× ×•×›×—×™ ×”××•×¦×’
                    // × × ×™×— ×©×™×© ××¤×ª×— × ×•×¡×£ ×©××—×–×™×§ ××ª ×¨×©×™××ª ×›×œ ×”×œ×•×–×™×, × ×¦×˜×¨×š ×œ×¢×“×›×Ÿ ×’× ××•×ª×•
                    // ×œ×“×•×’××”, ×× ×”×œ×•×–×™× × ×©××¨×™× ×‘××¢×¨×š ×ª×—×ª ××¤×ª×— 'userSchedules' ×•×©× ×”×œ×•×– ×”×•× ×”××–×”×”
                    // ×”×§×•×“ ×”×‘× ×”×•× ×¨×§ ×“×•×’××” ×•×™×© ×œ×”×ª××™× ××•×ª×• ×œ××‘× ×” ×”× ×ª×•× ×™× ×”×××™×ª×™ ×©×œ×š
                    const scheduleId = liveVacationData.id || liveVacationData.name; // × × ×™×— ×©×™×© ID ××• ×©×”×©× ×™×™×—×•×“×™
                    let allSchedules = JSON.parse(localStorage.getItem('userSchedules') || '[]');
                    allSchedules = allSchedules.filter(s => (s.id || s.name) !== scheduleId);
                    localStorage.setItem('userSchedules', JSON.stringify(allSchedules));

                    alert('×”×œ×•×– × ××—×§ ×‘×”×¦×œ×—×”.');
                    window.location.href = 'my-schedules.html'; // ×”×¤× ×™×” ×œ×“×£ ×”×œ×•×–×™× ×©×œ×™
                }
            });

            document.getElementById('btnActivateLive').addEventListener('click', () => {
                alert('TODO: ×”×¤×¢×œ×ª ×œ×•×– ×‘×œ×™×™×‘ ×¢×“×™×™×Ÿ ×œ× ××™×•×©××ª.');
            });

            // × ×™×•×•×˜ ×œ×¤×¨×˜×™ ×”×œ×™× ×”
             const lodgingModalEl = document.getElementById('lodgingDetailModal');
            if (lodgingModalEl) {
                const lodgingModalInstance = new bootstrap.Modal(lodgingModalEl);
                scheduleContainerEl.addEventListener('click', e => {
                    const badge = e.target.closest('.lodging-badge');
                    if (badge) {
                        const id = badge.getAttribute('data-lodging-id');
                        showLodgingDetail(id, liveVacationData.lodgings, lodgingModalInstance);
                    }
                });
            }
        });

        function renderFullSchedule(scheduleEvents, lodgings, container) {
            container.innerHTML = '';
            if (Object.keys(scheduleEvents).length === 0) {
                container.innerHTML = '<p class="text-center p-3">×”×œ×•"×– ×”×–×” ×¨×™×§ ×××™×¨×•×¢×™×.</p>';
                return;
            }
            const sortedDates = Object.keys(scheduleEvents).sort((a,b)=>new Date(a)-new Date(b));
            sortedDates.forEach(dateString => {
                const dayName = weekdayNames[new Date(dateString).getDay()];
                const dayBlockElement = createDayBlock(dayName, dateString, lodgings);
                container.appendChild(dayBlockElement);
                const eventsForDate = scheduleEvents[dateString] || [];
                eventsForDate.sort((a,b)=>(a.start||a.departTime).localeCompare(b.start||b.departTime));
                eventsForDate.forEach((eventData, idx) => {
                    renderEventRow(dayBlockElement, dateString, eventData);
                     // ×”×•×¡×¤×ª ×§×• ××¤×¨×™×“ ×¨×§ ×× ×–×” ×œ× ×”××™×¨×•×¢ ×”××—×¨×•×Ÿ
                    if (idx < eventsForDate.length - 1) {
                        let hr = document.createElement('hr');
                        hr.className = 'event-divider';
                        dayBlockElement.appendChild(hr);
                    }
                });
            });
        }

        function createDayBlock(day, date, lodgingsArray) {
            let blk = document.createElement('div');
            blk.className = 'day-block';
            blk.dataset.date = date;
            let badgesHTML = '';
            if (Array.isArray(lodgingsArray)) {
                const relevantLodgings = lodgingsArray
                    .filter(l => {
                        // ×‘×“×™×§×” ×× ×”×ª××¨×™×š ×©×œ ×”×‘×œ×•×§ × ××¦× ×‘×˜×•×•×— ×”×ª××¨×™×›×™× ×©×œ ×”×œ×™× ×”
                        const eventDate = new Date(date);
                        eventDate.setHours(0,0,0,0); // ××™×¤×•×¡ ×©×¢×•×ª ×œ×¦×•×¨×š ×”×©×•×•××” ×ª××¨×™×›×™×ª ×‘×œ×‘×“
                        const checkIn = new Date(l.checkInDate);
                        checkIn.setHours(0,0,0,0);
                        const checkOut = new Date(l.checkOutDate);
                        checkOut.setHours(0,0,0,0);
                        return eventDate >= checkIn && eventDate <= checkOut;
                    });
                if (relevantLodgings.length > 0) {
                     badgesHTML = `<div class="lodging-badges-container d-flex flex-wrap gap-2 justify-content-end">${relevantLodgings
                        .map(l => `<span class="lodging-badge" data-lodging-id="${l.id}">${l.name} ğŸ¨</span>`)
                        .join('')}</div>`;
                }
            }
            blk.innerHTML = `<div class="day-header"><span>${day} â€“ ${new Date(date).toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'numeric'})}</span>${badgesHTML}</div>`;
            return blk;
        }


        function renderEventRow(dayBlockElement, date, eventData) {
            let rowDiv = document.createElement('div');
            rowDiv.className = 'event-row';
            let times = document.createElement('div');
            times.className = 'times-col';
            const start = eventData.start || eventData.departTime || '';
            const end   = eventData.end   || eventData.arriveTime || '';
            times.innerHTML = `<span>${start}</span>${start && end ? '<span>|</span>' : ''}<span>${end}</span>`;


            let content = document.createElement('div');
            content.className = 'content-col';
            content.setAttribute('data-type', eventData.type);

            let bgKey = eventData.type;
            if (eventData.type==='×”×œ×™×›×”/× ×¡×™×¢×”' && eventData.mode) {
                if (eventData.mode.includes('×¨×›×‘')) bgKey='×¨×›×‘';
                else if (eventData.mode.includes('×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª')) bgKey='×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª';
                else if (eventData.mode.includes('×”×œ×™×›×”')) bgKey='×”×œ×™×›×”';
            }
            const bgEmoji = emojiMap[bgKey] || '';
            if (bgEmoji) content.setAttribute('data-bg-emoji', bgEmoji);

            let iconHTML='', eventHTML='';
            const genEmoji = emojiMap[eventData.type] || 'ğŸ“';
            iconHTML = `<div class="event-icon">${genEmoji}</div>`; // ×‘×¨×™×¨×ª ××—×“×œ ×œ××™×™×§×•×Ÿ

            switch(eventData.type) {
                case '×˜×™×¡×”':
                    iconHTML = `<div class="event-icon-flight">âœˆï¸</div>`;
                    eventHTML = `
                        <div class="event-text-details">
                            <div><strong>×˜×™×¡×” ${eventData.number||''} ×${eventData.from||''} â¬…ï¸ ${eventData.to||''}</strong></div>
                            ${eventData.airline?`<div>×—×‘×¨×ª ×ª×¢×•×¤×”: ${eventData.airline}</div>`:''}
                            <div>×”××¨××” ğŸ›«: ${eventData.departTime||''}</div>
                            <div>× ×—×™×ª×” ğŸ›¬: ${eventData.arriveTime||''}</div>
                            ${eventData.description?`<div><em>${eventData.description}</em></div>`:''}
                        </div>`;
                    if (eventData.fromAirportLocation || eventData.from) { // ×‘×“×™×§×” ×× ×™×© ××™×§×•× ×œ×©×“×” ×”×ª×¢×•×¤×”
                        const departureLocation = eventData.fromAirportLocation || eventData.from;
                        eventHTML += `<button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${departureLocation.replace(/'/g,"\\'")}')" title="× ×•×•×˜ ××œ ${departureLocation}">ğŸ—ºï¸</button>`;
                    }
                    break;
                case '×”×©×§××”': case '×©×™× ×”':
                    eventHTML = `<div class="event-text-details"><div><strong>${eventData.type}</strong></div>${eventData.description?`<div>${eventData.description}</div>`:''}</div>`;
                    break;
                case '×”×œ×™×›×”/× ×¡×™×¢×”':
                    let dispEmoji = emojiMap['×”×œ×™×›×”/× ×¡×™×¢×”'];
                    if (eventData.mode) {
                        if (eventData.mode.includes('×¨×›×‘')) dispEmoji = emojiMap['×¨×›×‘'];
                        else if (eventData.mode.includes('×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª')) dispEmoji = emojiMap['×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª'];
                        else if (eventData.mode.includes('×”×œ×™×›×”')) dispEmoji = emojiMap['×”×œ×™×›×”'];
                    }
                    iconHTML = `<div class="event-icon">${dispEmoji}</div>`;
                    eventHTML = `
                        <div class="event-text-details">
                            <div><strong>${eventData.mode||'×”×œ×™×›×”/× ×¡×™×¢×”'}</strong></div>
                            ${eventData.startLocation?`<div>×: ${eventData.startLocation}</div>`:''}
                            <div>××œ: ${eventData.endLocation||''}</div>
                            ${eventData.description?`<div>${eventData.description}</div>`:''}
                        </div>`;
                    if (eventData.endLocation) {
                        eventHTML += `<button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${eventData.endLocation.replace(/'/g,"\\'")}')" title="× ×•×•×˜ ××œ ${eventData.endLocation}">ğŸ—ºï¸</button>`;
                    }
                    break;
                case "×¦'×§-××™×Ÿ": case "×¦'×§-×××•×˜":
                    eventHTML = `<div class="event-text-details"><div><strong>${eventData.type}: ${eventData.lodgingName||''}</strong></div>${eventData.location?`<div>${eventData.location}</div>`:''}${eventData.description?`<div>${eventData.description}</div>`:''}</div>`;
                    if (eventData.location) { // ×›×¤×ª×•×¨ × ×™×•×•×˜ ×’× ×œ×¦'×§-×××•×˜ ×× ×™×© ××™×§×•× (×œ××©×œ, ×× ×–×” ××œ×•×Ÿ ××—×¨)
                        eventHTML += `<button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${eventData.location.replace(/'/g,"\\'")}')" title="× ×•×•×˜ ××œ ${eventData.location}">ğŸ—ºï¸</button>`;
                    }
                    break;
                default: // ×›×•×œ×œ ××•×›×œ, ×¡×™×•×¨, ××˜×¨×§×¦×™×” ×•×›×•'
                    let title = eventData.customSubjectName||eventData.type;
                    if (eventData.type==='××•×›×œ' && eventData.foodPlace) title = eventData.foodPlace;

                    eventHTML = `<div class="event-text-details"><div><strong>${title}</strong></div>${eventData.location?`<div>××™×§×•×: ${eventData.location}</div>`:''}${eventData.description?`<div>${eventData.description}</div>`:''}</div>`;
                    if (eventData.location) {
                        eventHTML += `<button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${eventData.location.replace(/'/g,"\\'")}')" title="× ×•×•×˜ ××œ ${eventData.location}">ğŸ—ºï¸</button>`;
                    }
            }

            content.innerHTML = `<div class="event-content-wrapper">${iconHTML}${eventHTML}</div>`;
            rowDiv.append(times, content);
            dayBlockElement.appendChild(rowDiv);
        }

        function showLodgingDetail(lodgingId, lodgings, modalInstance) {
            const lodging = lodgings.find(l => l.id === lodgingId);
            if (!lodging || !modalInstance) return;

            document.getElementById('detailLodType').textContent = `×¡×•×’ ×œ×™× ×”: ${lodging.type || '×œ× ×¦×•×™×Ÿ'}`;
            document.getElementById('detailLodName').textContent = `×©×: ${lodging.name || '×œ× ×¦×•×™×Ÿ'}`;
            document.getElementById('detailLodLocation').textContent = lodging.address || '×œ× ×¦×•×™×Ÿ ××™×§×•×';

            const navButton = document.getElementById('detailLodNav');
            if (lodging.address) {
                navButton.style.display = 'inline-block';
                navButton.onclick = () => openMapForNavigation(lodging.address);
            } else {
                navButton.style.display = 'none';
            }

            const checkInDate = lodging.checkInDate ? new Date(lodging.checkInDate).toLocaleDateString('he-IL') : '×œ× ×¦×•×™×Ÿ';
            const checkInTime = lodging.checkInTime || '';
            document.getElementById('detailLodCheckIn').textContent = `×¦'×§-××™×Ÿ: ${checkInDate} ${checkInTime}`;

            const checkOutDate = lodging.checkOutDate ? new Date(lodging.checkOutDate).toLocaleDateString('he-IL') : '×œ× ×¦×•×™×Ÿ';
            const checkOutTime = lodging.checkOutTime || '';
            document.getElementById('detailLodCheckOut').textContent = `×¦'×§-×××•×˜: ${checkOutDate} ${checkOutTime}`;

            modalInstance.show();
        }


        function openMapForNavigation(addr) {
            if (addr) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`, '_blank');
        }

        function captureAndDownloadScheduleScreenshot(scheduleName) {
            const scheduleContainerElement = document.getElementById('scheduleContainer');
            if (!scheduleContainerElement || !scheduleContainerElement.children.length) {
                alert("××™×Ÿ ×ª×•×›×Ÿ ×œ×¦×œ× ×‘×œ×•×–.");
                return;
            }

            // ×™×¦×™×¨×ª ×¢×˜×™×¤×” ×©×ª×›×™×œ ××ª ×”×›×•×ª×¨×ª ×•×”×ª×•×›×Ÿ ×©×œ ×”×œ×•"×–
            const wrapper = document.createElement('div');
            wrapper.style.padding = '30px'; // ×¨×™×•×•×— ×¤× ×™××™ ×’×“×•×œ ×™×•×ª×¨
            wrapper.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--holiday-bg').trim() || '#fef7ef'; // ×¨×§×¢ ××”××©×ª× ×™×
            wrapper.style.display = 'inline-block'; // ×›×“×™ ×©×”×¨×•×—×‘ ×™×ª××™× ×œ×ª×•×›×Ÿ
            wrapper.style.direction = 'rtl'; // ×œ×•×•×“× ×›×™×•×•× ×™×•×ª × ×›×•× ×” ×’× ×‘×¦×™×œ×•×

            // ×©×›×¤×•×œ ×•×”×•×¡×¤×ª ×›×•×ª×¨×ª ×”×œ×•"×–
            const titleElement = document.getElementById('displayScheduleName');
            if (titleElement) {
                const clonedTitle = titleElement.cloneNode(true);
                clonedTitle.style.color = getComputedStyle(document.body).getPropertyValue('--text-dark').trim();
                clonedTitle.style.textAlign = 'center';
                clonedTitle.style.marginBottom = '25px';
                clonedTitle.style.fontSize = '1.8em'; // ×”×ª×××ª ×’×•×“×œ ×¤×•× ×˜ ×× ×¦×¨×™×š
                wrapper.appendChild(clonedTitle);
            }

            // ×©×›×¤×•×œ ×•×”×•×¡×¤×ª ×ª×•×›×Ÿ ×”×œ×•"×–
            const clone = scheduleContainerElement.cloneNode(true);
            // ×”×¡×¨×ª ×¦×œ ×•×× ×™××¦×™×•×ª ××¨×—×¤×•×ª ××”××œ×× ×˜×™× ×”××©×•×›×¤×œ×™×
             clone.querySelectorAll('.day-block, .content-col, .lodging-badge, .btn-navigate').forEach(el => {
                el.style.transition = 'none';
                el.style.animation = 'none';
                // ×× ×™×© hover effects ×©××¤×¨×™×¢×™×, ××•×œ×™ ×›×“××™ ×œ×”×¡×™×¨ ××•×ª× ×¡×¤×¦×™×¤×™×ª ××• ×œ×”×’×“×™×¨ ×œ×”× ×¡×’× ×•×Ÿ ×‘×¡×™×¡
            });
            wrapper.appendChild(clone);

            // ××™×§×•× ×”×¢×˜×™×¤×” ××—×•×¥ ×œ××¡×š ×”× ×¨××”
            wrapper.style.position = 'absolute';
            wrapper.style.left = '-9999px';
            wrapper.style.top = '-9999px';
            document.body.appendChild(wrapper);

            html2canvas(wrapper, {
                scale: 1.5, // ××¤×©×¨ ×œ×©×—×§ ×¢× ×”×¡×§×™×™×œ ×œ××™×›×•×ª ×˜×•×‘×” ×™×•×ª×¨
                useCORS: true,
                backgroundColor: wrapper.style.backgroundColor, // ×©×™××•×© ×‘×¦×‘×¢ ×”×¨×§×¢ ×©×œ ×”×¢×˜×™×¤×”
                logging: true, // ×”×¤×¢×œ×ª ×œ×•×’×™× ×œ×“×™×‘×•×’ ×× ×™×© ×‘×¢×™×•×ª
                width: wrapper.offsetWidth, // ×”×’×“×¨×ª ×¨×•×—×‘ ×•×’×•×‘×” ××¤×•×¨×©×™×
                height: wrapper.offsetHeight,
                windowWidth: wrapper.scrollWidth,
                windowHeight: wrapper.scrollHeight
            }).then(canvas => {
                document.body.removeChild(wrapper); // ×”×¡×¨×ª ×”×¢×˜×™×¤×” ××”-DOM
                const image = canvas.toDataURL("image/png", 0.95); // ××™×›×•×ª PNG ××¢×˜ ×’×‘×•×”×” ×™×•×ª×¨
                const link = document.createElement('a');
                const safeName = (scheduleName || '×œ×•×–-×—×•×¤×©×”').replace(/[^a-z0-9×-×ª_\-\s]/gi, '').replace(/\s+/g, '_');
                link.download = `${safeName}_${new Date().toISOString().slice(0,10)}.png`; // ×”×•×¡×¤×ª ×ª××¨×™×š ×œ×©× ×”×§×•×‘×¥
                link.href = image;
                link.click();
                // ××™×Ÿ ×¦×•×¨×š ×‘-revokeObjectURL ×¢×‘×•×¨ dataURL
            }).catch(err => {
                if (document.body.contains(wrapper)) document.body.removeChild(wrapper);
                console.error('×©×’×™××” ×‘×¦×™×œ×•× ××¡×š:', err);
                alert('××™×¨×¢×” ×©×’×™××” ×‘××”×œ×š ×¦×™×œ×•× ×”××¡×š. × ×¡×• ×©×•×‘, ×•×× ×”×‘×¢×™×” × ××©×›×ª ×‘×“×§×• ××ª ×”×§×•× ×¡×•×œ.');
            });
        }
    </script>
</body>
</html>
