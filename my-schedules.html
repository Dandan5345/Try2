<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×–××Ÿ ×–×”×‘ - ×”×œ×•×–×™× ×©×œ×™</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://i.imgur.com/GaYFAp1.png" type="image/png">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- ×›×œ×•×œ ××ª ×”×§×•×‘×¥ ×”××©×•×ª×£ ×©×œ Firebase -->
  <script src="firebase-config.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => console.log('Service Worker registered with scope:', registration.scope))
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
  </script>

  <style>
    /* Reset ×‘×¡×™×¡×™ */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      direction: rtl;
      padding-top: 70px;
      padding-bottom: 60px;
      text-align: center;
      color: #333;
      /* --- ×¨×§×¢ ×’×¨×“×™×× ×˜ ×—×“×© --- */
      background-color: #f8f9fa; /* Fallback color */
      background-image: linear-gradient(to top, #e6f7ff, #f8f9fa); /* Light blue bottom to light gray top */
      background-repeat: no-repeat; /* Ensure gradient doesn't tile */
      min-height: 100vh; /* Ensure gradient covers full height */
      /* --- ×¡×•×£ ×©×™× ×•×™ ×¨×§×¢ --- */
    }

    /* --- ×¡×’× ×•× ×•×ª ×”×“×¨ ×•×ª×¤×¨×™×˜ ×¦×“ (××”×“×£ ×”×¨××©×™) --- */
    .topbar {
      background-color: #0A2342; /* ×›×—×•×œ ×›×”×” ×¨××©×™ */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      transition: transform 0.3s ease;
      border-bottom: 3px solid #2A558C;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .site-name {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 26px;
      color: #ecf0f1;
      cursor: pointer;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .hamburger-menu {
      font-size: 24px;
      color: #ecf0f1;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 5px;
      transition: background-color 0.3s;
      z-index: 1002;
    }
    .hamburger-menu:hover {
      background-color: rgba(255, 255, 255, 0.15);
    }

    .auth-button {
      background-color: #007bff;
      padding: 8px 16px;
      border-radius: 6px;
      transition: background-color 0.3s, box-shadow 0.3s;
      font-weight: 600;
      color: #FFFFFF;
      border: none;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.95em;
    }
    .auth-button:hover {
      background-color: #0056b3;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .side-menu {
      position: fixed;
      top: 0;
      right: -280px;
      width: 280px;
      height: 100%;
      background-color: #0A2342;
      z-index: 1001;
      padding-top: 70px;
      transition: right 0.3s ease;
      box-shadow: -3px 0 8px rgba(0, 0, 0, 0.15);
    }
    .side-menu.active { right: 0; }

    .close-menu {
      position: absolute;
      top: 15px;
      left: 15px;
      font-size: 26px;
      color: #ecf0f1;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
    }
     .close-menu:hover {
        color: #bdc3c7;
     }

    .side-menu-links {
      display: flex;
      flex-direction: column;
      padding: 10px 0;
    }
    .side-menu-links a {
      padding: 16px 25px;
      color: #ecf0f1;
      text-decoration: none;
      font-size: 17px;
      border-bottom: 1px solid rgba(236, 240, 241, 0.15);
      transition: background-color 0.2s ease-in-out;
      text-align: right;
      display: flex;
      align-items: center;
    }
     .side-menu-links a i {
         margin-left: 12px;
         width: 20px;
         text-align: center;
         font-size: 0.95em;
     }
    .side-menu-links a:last-child { border-bottom: none; }
    .side-menu-links a:hover {
      background-color: rgba(42, 85, 140, 0.5);
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.55);
      z-index: 1000;
      display: none;
      transition: opacity 0.3s ease;
       opacity: 0;
    }
    .overlay.active {
      display: block;
       opacity: 1;
    }
    /* --- ×¡×•×£ ×¡×’× ×•× ×•×ª ×”×“×¨ ×•×ª×¤×¨×™×˜ ×¦×“ --- */


    /* --- ×¡×’× ×•× ×•×ª ×ª×•×›×Ÿ ×¢××•×“ "×”×œ×•×–×™× ×©×œ×™" --- */
    main {
      padding: 30px;
      min-height: calc(100vh - 190px); /* ×’×•×‘×” ××™× ×™××œ×™ ×‘×”×ª×—×©×‘ ×‘×”×“×¨ ×•×¤×•×˜×¨ */
      background-color: #ffffff; /* ×¨×§×¢ ×œ×‘×Ÿ × ×§×™ */
      border-radius: 10px; /* ×¨×“×™×•×¡ ××¢×•×’×œ ×™×•×ª×¨ */
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* ×¦×œ ××¢×•×“×Ÿ */
      max-width: 850px; /* ×¨×•×—×‘ ××§×¡×™××œ×™ ××•×’×“×œ */
      margin: 30px auto; /* ×”×’×“×œ×ª ×¨×•×•×— ×¢×œ×™×•×Ÿ ×•×ª×—×ª×•×Ÿ */
    }
    h2#main-title, h2 { /* Target specific ID or general H2 inside main */
      font-size: 2.4em; /* ×’×•×“×œ ×›×•×ª×¨×ª ××¢×•×“×›×Ÿ */
      color: #0056b3; /* ×›×—×•×œ ×¢××•×§ ×™×•×ª×¨ ×œ×›×•×ª×¨×ª */
      margin-bottom: 40px; /* ×¨×™×•×•×— ×’×“×•×œ ×™×•×ª×¨ ××ª×—×ª ×œ×›×•×ª×¨×ª */
      font-weight: 600;
      text-align: center; /* Ensure title remains centered */
    }


    /* ×¢×™×¦×•×‘ ×§×˜×’×•×¨×™×•×ª */
    .category-item {
      margin-bottom: 25px; /* ×¨×™×•×•×— ×‘×™×Ÿ ×§×˜×’×•×¨×™×•×ª */
      max-width: 550px; /* ×¨×•×—×‘ ×§×˜×’×•×¨×™×” ××¢×•×“×›×Ÿ */
      margin-left: auto;
      margin-right: auto;
    }
    .category-btn {
      background-color: #34495e; /* ×›×—×•×œ-××¤×•×¨ ×›×”×” */
      color: #ecf0f1;
      padding: 12px 25px; /* ×¨×™×•×•×— ×¤× ×™××™ ××•×’×“×œ */
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 500; /* ×¢×™×‘×•×™ ×§×œ */
      cursor: pointer;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .category-btn:hover {
        background-color: #2c3e50; /* ×’×•×•×Ÿ ×›×”×” ×™×•×ª×¨ ×‘×”×•×‘×¨ */
        transform: translateY(-2px); /* ××¤×§×˜ ×”×¨××” ×§×œ */
    }
     .category-btn:active {
         transform: translateY(0px); /* ×—×–×¨×” ×œ××§×•× ×‘×œ×—×™×¦×” */
     }
    .category-btn span:first-child { /* ×˜×§×¡×˜ ×”×§×˜×’×•×¨×™×” */
        display: flex;
        align-items: center;
        gap: 10px; /* ×¨×•×•×— ×‘×™×Ÿ ×”××™×™×§×•×Ÿ ×œ×˜×§×¡×˜ */
    }
    .category-btn span.arrow {
      font-size: 16px;
      transition: transform 0.3s ease; /* ×× ×™××¦×™×” ×œ×—×¥ */
    }
     .category-btn[aria-expanded="true"] span.arrow {
         transform: rotate(180deg); /* ×¡×™×‘×•×‘ ×”×—×¥ ×›×©×”×§×˜×’×•×¨×™×” ×¤×ª×•×—×” */
     }

    .category-list {
      text-align: center;
      display: none;
      animation: fadeInDown 0.4s ease-out; /* ×× ×™××¦×™×” ××©×•×¤×¨×ª */
      margin-top: 15px; /* ×¨×™×•×•×— ××”×›×¤×ª×•×¨ */
      background-color: #f8f9fa; /* ×¨×§×¢ ××¤×¨×¤×¨ ×œ×¨×©×™××” */
      border-radius: 8px;
      padding: 15px 0; /* Increased padding */
      border: 1px solid #e9ecef; /* ×’×‘×•×œ ×¢×“×™×Ÿ */
    }
     .category-list p { /* ×”×•×“×¢×” ×¢×œ ×¨×©×™××” ×¨×™×§×” */
        color: #6c757d; /* ×¦×‘×¢ ×˜×§×¡×˜ ××¤×•×¨ */
        padding: 10px 20px;
        margin-bottom: 10px;
     }
      .category-list .btn { /* Style button inside empty category */
          margin-top: 5px;
      }


    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ×¢×™×¦×•×‘ ×¤×¨×™×˜ ×œ×•"×– ×©××•×¨ ×‘×¨×©×™××” */
    .saved-schedule-item {
      background-color: #ffffff;
      margin: 12px auto; /* ×”×’×“×œ×ª ×¨×•×•×— ×× ×›×™ */
      padding: 15px 20px; /* ×¨×™×•×•×— ×¤× ×™××™ ××¢×•×“×›×Ÿ */
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.07); /* ×¦×œ ××¢×•×“×Ÿ ×™×•×ª×¨ */
      cursor: pointer;
      text-align: right; /* ×™×™×©×•×¨ ×œ×™××™×Ÿ ×›×‘×¨×™×¨×ª ××—×“×œ */
      font-weight: 500; /* ×¢×•×‘×™ ×¤×•× ×˜ */
      color: #34495e;
      max-width: 95%; /* ×¨×•×—×‘ ×™×—×¡×™ ×‘×ª×•×š ×”×§×˜×’×•×¨×™×” */
      position: relative;
      display: flex; /* ×©×™××•×© ×‘-flex ×œ×™×™×©×•×¨ */
      justify-content: space-between; /* ×”×¤×¨×“×” ×‘×™×Ÿ ×©× ×œ××™×™×§×•×Ÿ ××—×™×§×” */
      align-items: center;
      transition: background-color 0.2s, transform 0.2s;
       border: 1px solid #eee; /* Add subtle border */
    }
     .saved-schedule-item:hover {
       background-color: #f1f3f5; /* ×¨×§×¢ ×‘×”×™×¨ ×××•×“ ×‘×”×•×‘×¨ */
       transform: translateX(-3px); /* ×ª×–×•×–×” ×§×œ×” ×‘×”×•×‘×¨ */
        border-color: #ddd;
     }

    .saved-schedule-item span[title="××—×§ ×œ×•×– ×–×”"] { /* More specific selector for delete icon */
      cursor: pointer;
      font-size: 1.1em;
      padding: 5px 8px; /* ×¨×™×•×•×— ×œ××–×•×¨ ×”×œ×—×™×¦×” */
      color: #e74c3c; /* ×¦×‘×¢ ××“×•× ×œ××—×™×§×” */
      transition: color 0.2s;
      order: 1; /* ××™×§×•× ××™×™×§×•×Ÿ ×”××—×™×§×” ×‘×¦×“ ×©×××œ */
       margin-right: 10px; /* ×¨×•×•×— ××©× ×”×œ×•×– */
       line-height: 1; /* Prevent affecting item height */
    }
     .saved-schedule-item span[title="××—×§ ×œ×•×– ×–×”"]:hover {
         color: #c0392b; /* ××“×•× ×›×”×” ×™×•×ª×¨ ×‘×”×•×‘×¨ */
     }

    .saved-schedule-item h3 { /* ×©× ×”×œ×•×– */
       margin: 0;
       font-size: 1.05em; /* ×’×•×“×œ ×¤×•× ×˜ ××¢×•×“×›×Ÿ */
       color: #2c3e50;
       flex-grow: 1; /* ×××¤×©×¨ ×œ×©× ×œ×ª×¤×•×¡ ××ª ×©××¨ ×”×¨×•×—×‘ */
       text-align: right; /* ×•×™×“×•× ×™×™×©×•×¨ ×œ×™××™×Ÿ */
    }


     /* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×•×ª ×›×œ×œ×™×™× */
    .btn {
      display: inline-flex; /* ×©×™××•×© ×‘-flex ×œ×™×™×©×•×¨ ××™×™×§×•×Ÿ ×•×˜×§×¡×˜ */
      align-items: center;
      gap: 8px; /* ×¨×•×•×— ×‘×™×Ÿ ××™×™×§×•×Ÿ ×œ×˜×§×¡×˜ */
      padding: 10px 22px; /* ×¨×™×•×•×— ××¢×•×“×›×Ÿ */
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 15px; /* ×’×•×“×œ ×¤×•× ×˜ ×œ×›×¤×ª×•×¨ */
      font-weight: 500;
      border-radius: 6px;
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
      margin: 5px;
      text-decoration: none;
      box-shadow: 0 2px 5px rgba(0, 123, 255, 0.2); /* ×¦×œ ×‘×¦×‘×¢ ×”×›×¤×ª×•×¨ */
    }
    .btn:hover {
        background-color: #0056b3;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        transform: translateY(-2px); /* ××¤×§×˜ ×”×¨××” ×§×œ */
    }
     .btn:active {
         transform: translateY(0);
     }
     .btn i { /* ×¡×’× ×•×Ÿ ×œ××™×™×§×•×Ÿ ×‘×ª×•×š ×›×¤×ª×•×¨ */
         font-size: 0.9em;
         line-height: 1; /* ×× ×™×¢×ª ×”×©×¤×¢×” ×¢×œ ×’×•×‘×” ×”×›×¤×ª×•×¨ */
     }

     .button-group { /* ×§×‘×•×¦×ª ×›×¤×ª×•×¨×™× ×‘×ª×¦×•×’×ª ×œ×•×– */
        margin-top: 30px; /* ×¨×™×•×•×— ××”×ª×•×›×Ÿ */
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px; /* ×”×’×“×œ×ª ×¨×•×•×— ×‘×™×Ÿ ×›×¤×ª×•×¨×™× */
    }

    /* ×¨×§×¢ ×××•×’'×™ ×‘×ª×¦×•×’×ª ×œ×•×– */
    .emoji-background {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 70px;
      opacity: 0.06; /* ×¢××¢×•× ×—×–×§ ×™×•×ª×¨ */
      pointer-events: none;
      z-index: 0;
    }

    /* ×¡×’× ×•× ×•×ª ×ª×¦×•×’×ª ×œ×•×– ×¡×¤×¦×™×¤×™ (Detail View) */
     #finalScheduleDisplay {
        border-top: 1px solid #eee; /* ×§×• ×”×¤×¨×“×” ×¢×œ×™×•×Ÿ */
        margin-top: 25px;
        padding-top: 25px;
     }
     #finalScheduleDisplay .saved-schedule-item { /* Reusing class, but specific styling */
         cursor: default;
         background-color: #f8f9fa; /* ×¨×§×¢ ××¤×¨×¤×¨ ×‘×”×™×¨ ×œ×¤×¨×™×˜ */
         text-align: right;
         padding: 18px 25px; /* ×¨×™×•×•×— ×¤× ×™××™ ××•×’×“×œ */
         margin-bottom: 15px; /* ×”×’×“×œ×ª ×¨×•×•×— ×‘×™×Ÿ ×¤×¨×™×˜×™× */
         display: block; /* ×—×–×¨×” ×œ×ª×¦×•×’×” ×¨×’×™×œ×” (×œ× flex) */
         box-shadow: none; /* ×”×¡×¨×ª ×¦×œ ×‘×ª×•×š ×”×ª×¦×•×’×” */
         border: 1px solid #e9ecef; /* ×’×‘×•×œ ×¢×“×™×Ÿ */
          transition: none; /* No hover effect needed here */
          transform: none; /* No hover effect needed here */
     }
     #finalScheduleDisplay .saved-schedule-item:hover {
          background-color: #f8f9fa; /* ××™×Ÿ ×©×™× ×•×™ ×¨×§×¢ ×‘×”×•×‘×¨ */
          border-color: #e9ecef;
          transform: none;
     }
     #finalScheduleDisplay .saved-schedule-item h3 {
         font-size: 1.15em;
         color: #34495e;
         margin-bottom: 8px; /* ×”×’×“×œ×ª ×¨×•×•×— ××ª×—×ª ×œ×›×•×ª×¨×ª */
         font-weight: 600;
     }
      #finalScheduleDisplay .saved-schedule-item p {
         font-size: 1em;
         color: #555;
         line-height: 1.5; /* ×©×™×¤×•×¨ ×§×¨×™××•×ª ×”×ª×™××•×¨ */
         margin: 0;
     }
      /* Styling for the schedule name title above the detail view */
     #content > h3 {
        font-size: 1.6em;
        color: #34495e;
        margin-bottom: 25px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        text-align: center;
     }

      /* Message area styling */
     #message-area p {
         margin-top: 20px;
         padding: 10px 15px;
         border-radius: 6px;
         font-size: 1.05em;
     }
     #message-area p.info { /* General info message style */
         background-color: #e9ecef;
         color: #495057;
         border: 1px solid #ced4da;
     }
      #message-area p.error { /* Error message style */
         background-color: #f8d7da;
         color: #721c24;
         border: 1px solid #f5c6cb;
     }


    footer {
      text-align: center;
      padding: 25px; /* ×¨×™×•×•×— ××•×’×“×œ */
      color: #7f8c8d;
      font-size: 14px;
      background-color: #e9ecef;
      border-top: 1px solid #ddd;
      margin-top: 40px; /* ×”×¨×—×§×” ××”×ª×•×›×Ÿ */
    }

    /* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª (× ×©××¨×” ×–×”×”) */
    @media (max-width: 768px) {
        body { padding-top: 60px; }
        .site-name { font-size: 22px; }
        main { max-width: 95%; padding: 20px; margin: 20px auto; }
        h2#main-title, h2 { font-size: 2em; margin-bottom: 30px; }
         #content > h3 { font-size: 1.4em; margin-bottom: 20px;}
        .category-item { max-width: 100%; }
        .category-btn { padding: 12px 20px; font-size: 17px;}
        #finalScheduleDisplay .saved-schedule-item { padding: 15px 20px; }
    }
    @media (max-width: 600px) {
        .auth-button { padding: 7px 12px; font-size: 0.9em;}
        .side-menu { width: 250px; } /* ×”×§×˜× ×ª ×¨×•×—×‘ ×ª×¤×¨×™×˜ ×¦×“ */
        .side-menu-links a { padding: 14px 20px; font-size: 16px; }
         .side-menu-links a i { margin-left: 10px; }

        main { padding: 15px; }
        h2#main-title, h2 { font-size: 1.8em; }
         #content > h3 { font-size: 1.3em;}
        .category-btn { font-size: 16px; padding: 10px 15px;}
         .category-btn span:first-child { gap: 8px; }

        .saved-schedule-item { padding: 12px 15px; }
         .saved-schedule-item h3 { font-size: 1em; }
         .saved-schedule-item span[title="××—×§ ×œ×•×– ×–×”"] { font-size: 1em; padding: 4px 6px; }

        .btn { font-size: 14px; padding: 9px 18px; gap: 6px; }
        .button-group { flex-direction: column; align-items: stretch; gap: 10px;}
         .button-group .btn { width: 100%; /* ×›×¤×ª×•×¨×™× ×‘×¨×•×—×‘ ××œ× ×‘××•×‘×™×™×œ */ }

         #finalScheduleDisplay .saved-schedule-item { padding: 15px; }
         #finalScheduleDisplay .saved-schedule-item h3 { font-size: 1.1em; }
         #finalScheduleDisplay .saved-schedule-item p { font-size: 0.95em; }

        footer { padding: 20px; }
    }
    /* --- ×¡×•×£ ×¡×’× ×•× ×•×ª ×ª×•×›×Ÿ --- */
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>

  <nav class="topbar">
    <div class="hamburger-menu" onclick="toggleMenu()">
      <i class="fas fa-bars"></i>
    </div>
    <div class="site-name" onclick="goHome()">×–××Ÿ ×–×”×‘</div>
    <a href="auth.html" id="authLink" class="auth-button">×”×ª×—×‘×¨×•×ª</a>
  </nav>

  <div class="side-menu" id="sideMenu">
    <div class="close-menu" onclick="toggleMenu()">
      <i class="fas fa-times"></i>
    </div>
    <div class="side-menu-links">
      <a href="choose-schedule.html"><i class="fas fa-calendar-plus"></i> ×œ×•×´×– ×—×“×©</a>
      <a href="my-schedules.html"><i class="fas fa-folder-open"></i> ×”×œ×•×–×™×´× ×©×œ×™</a>
      <a href="tips.html"><i class="fas fa-lightbulb"></i> ×˜×™×¤×™× ×œ× ×™×”×•×œ ×–×× ×™×</a>
      <a href="how-to-use.html"><i class="fas fa-info-circle"></i> ×¢×–×¨×” ×•×”×¡×‘×¨</a>
    </div>
  </div>

  <main id="content">
    <h2 id="main-title">×”×œ×•×–×™×´× ×©×œ×™</h2>
    <div id="categories-container">
        </div>
    <div id="message-area"></div>
  </main>

  <footer>Â©ï¸doronnakache</footer>

  <script>
    // --- ×¤×•× ×§×¦×™×•×ª × ×™×•×•×˜ ×•×ª×¤×¨×™×˜ (××”×“×£ ×”×¨××©×™) ---
    function goHome() {
      window.location.href = "index.html";
    }

    function toggleMenu() {
      const sideMenu = document.getElementById("sideMenu");
      const overlay = document.getElementById("overlay");
      const isActive = sideMenu.classList.contains("active");

      sideMenu.classList.toggle("active");
      overlay.classList.toggle("active");

      document.body.style.overflow = isActive ? "" : "hidden";
    }

    document.getElementById("overlay").addEventListener("click", toggleMenu);

    // --- × ×™×”×•×œ ××¦×‘ ××™××•×ª (Auth) ---
    firebase.auth().onAuthStateChanged(function(user) {
      const authLink = document.getElementById("authLink");
       const contentElement = document.getElementById("content");
       const categoriesContainer = document.getElementById("categories-container");
       const messageArea = document.getElementById("message-area");

       // × ×§×” ××–×•×¨×™× ×œ×¤× ×™ ×¢×“×›×•×Ÿ
        if (categoriesContainer) categoriesContainer.innerHTML = '';
        if (messageArea) messageArea.innerHTML = '';


      if (user) {
        // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×”×ª×—×‘×¨×•×ª/×‘×¨×›×”
        let currentHour = new Date().getHours();
        let greeting = "×‘×•×§×¨ ×˜×•×‘";
        if (currentHour >= 12 && currentHour < 18) greeting = "×¦×”×¨×™×™× ×˜×•×‘×™×";
        else if (currentHour >= 18) greeting = "×¢×¨×‘ ×˜×•×‘";

        let firstName = user.displayName ? user.displayName.split(" ")[0] : user.email.split("@")[0]; // ×©×™××•×© ×‘×—×œ×§ ×”×¨××©×•×Ÿ ×©×œ ×”××™××™×™×œ ×× ××™×Ÿ ×©×
        firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1); // ××•×ª ×¨××©×•× ×” ×’×“×•×œ×”

        authLink.innerText = `${greeting}, ${firstName}!`;
        authLink.title = "×”×ª× ×ª×§"; // ×”×•×¡×¤×ª title ×œ×›×¤×ª×•×¨
        authLink.onclick = function(e) {
          e.preventDefault();
          if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?")) {
            firebase.auth().signOut().catch(function(error){
                console.error("Sign out error", error);
                alert("×©×’×™××” ×‘×”×ª× ×ª×§×•×ª: " + error.message);
            });
          }
        };
        authLink.href = "#";

        // ×˜×¢×™× ×ª ×”×œ×•×–×™× ×©×œ ×”××©×ª××©
        loadMySchedules();

      } else {
        // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×œ×”×ª×—×‘×¨×•×ª
        authLink.innerText = "×”×ª×—×‘×¨×•×ª";
        authLink.title = "×”×ª×—×‘×¨ ××• ×”×™×¨×©×";
        authLink.href = "auth.html";
        authLink.onclick = null;

        // ×”×¦×’×ª ×”×•×“×¢×” ×œ××©×ª××© ×œ× ××—×•×‘×¨
        if (contentElement && !document.getElementById('login-prompt')) { // ×‘×“×•×§ ×× ×”×”×•×“×¢×” ×›×‘×¨ ×§×™×™××ª
             contentElement.innerHTML = `
                 <h2 id="main-title">×”×œ×•×–×™×´× ×©×œ×™</h2>
                 <p id="login-prompt" style="font-size: 1.1em; color: #555; margin-top: 20px; background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
                    × ×¨××” ×©××ª×” ×œ× ××—×•×‘×¨. <br>
                    <a href="auth.html" class="btn" style="margin-top:15px;">×”×ª×—×‘×¨ / ×”×™×¨×©×</a>
                    <br> ×›×“×™ ×œ×¨××•×ª ×•×œ× ×”×œ ××ª ×”×œ×•"×–×™× ×©×œ×š.
                 </p>
            `;
        }
         clearScheduleDisplay(); // × ×™×§×•×™ ×ª×¦×•×’×” ×§×•×“××ª ×× ×§×™×™××ª
      }
    });

    // --- ×”×¡×ª×¨×ª/×”×¦×’×ª ×”×“×¨ ×‘×’×œ×™×œ×” ---
    let lastScrollTop = 0;
    window.addEventListener("scroll", function() {
      let currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      const nav = document.querySelector(".topbar");
      const sideMenu = document.getElementById("sideMenu");

      if (nav && (!sideMenu || !sideMenu.classList.contains("active"))) {
           if (currentScroll > lastScrollTop && currentScroll > 70) { // ×’×œ×™×œ×” ×œ××˜×”
             nav.style.transform = "translateY(-100%)";
           } else { // ×’×œ×™×œ×” ×œ××¢×œ×” ××• ×§×¨×•×‘ ×œ×”×ª×—×œ×”
             nav.style.transform = "translateY(0)";
           }
      }
      lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
    }, false);


    // --- ×¤×•× ×§×¦×™×•×ª ×¡×¤×¦×™×¤×™×•×ª ×œ×“×£ "×”×œ×•×–×™× ×©×œ×™" ---

    let savedSchedules = []; // ××¢×¨×š ×’×œ×•×‘×œ×™ ×œ××—×¡×•×Ÿ ×”×œ×•×–×™×

     function showMessage(msg, type = 'info') {
         const messageArea = document.getElementById("message-area");
         if (messageArea) {
             // Remove any existing messages first
             messageArea.innerHTML = '';
             if (msg) { // Only add message if msg is not empty
                 const p = document.createElement('p');
                 p.className = `message ${type}`;
                 p.innerHTML = msg; // Use innerHTML to allow links
                 messageArea.appendChild(p);
             }
         }
     }

    // ×˜×¢×™× ×ª ×”×œ×•×–×™× ×-Firestore
    function loadMySchedules() {
      const user = firebase.auth().currentUser;
       const categoriesContainer = document.getElementById("categories-container");
       if (!user || !categoriesContainer) return; // ×™×¦×™××” ×× ××™×Ÿ ××©×ª××© ××• ×§×•× ×˜×™×™× ×¨

       showMessage("×˜×•×¢×Ÿ ×œ×•\"×–×™×...", 'info'); // ×”×¦×’×ª ×”×•×“×¢×ª ×˜×¢×™× ×”

      db.collection("schedules").doc(user.uid).get()
        .then((doc) => {
           showMessage(""); // × ×™×§×•×™ ×”×•×“×¢×ª ×˜×¢×™× ×”/×©×’×™××” ×§×•×“××ª
          if (doc.exists && doc.data().schedules) { // Check also if schedules array exists
            savedSchedules = doc.data().schedules || [];
            // ×§×‘×™×¢×ª/×•×™×“×•× ×§×˜×’×•×¨×™×” ×œ×›×œ ×œ×•"×–
            savedSchedules.forEach(sch => {
              if (!sch.category) {
                   if (sch.name.toLowerCase().includes("×—×•×¤×©×”")) sch.category = "×—×•×¤×©×”"; // Case insensitive check
                   else if (sch.name.toLowerCase().includes("× ×™×”×•×œ") || sch.name.toLowerCase().includes("×™×•××™")) sch.category = "× ×™×”×•×œ ×™×•×";
                   else sch.category = "×œ××™×“×”";
              }
            });
            renderCategoriesAndSchedules(); // ×§×¨×™××” ×œ×¤×•× ×§×¦×™×” ×©××¦×™×’×” ×”×›×œ
          } else {
            savedSchedules = [];
            renderCategoriesAndSchedules(); // ×”×¦×’×ª ××¦×‘ ×¨×™×§ (×™×¦×™×’ ×”×•×“×¢×” ×‘×¤× ×™×)
            console.log("No schedules found for user or document is empty.");
          }
        })
        .catch((error) => {
          console.error("Error loading schedules: ", error);
          showMessage("××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×œ×•\"×–×™×. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.", 'error');
        });
    }

    // ×™×¦×™×¨×” ×•×¨×™× ×“×•×¨ ×©×œ ×”×§×˜×’×•×¨×™×•×ª ×•×”×œ×•×–×™× ×‘×ª×•×›×Ÿ
    function renderCategoriesAndSchedules() {
        const categoriesContainer = document.getElementById("categories-container");
        if (!categoriesContainer) return;

        // ××™×¤×•×¡ ×”×§×•× ×˜×™×™× ×¨
        categoriesContainer.innerHTML = '';

        const schedulesByCategory = { "×œ××™×“×”": [], "×—×•×¤×©×”": [], "× ×™×”×•×œ ×™×•×": [] };
        savedSchedules.forEach((sch, originalIndex) => {
            const category = sch.category || "×œ××™×“×”";
            if (category in schedulesByCategory) {
                schedulesByCategory[category].push({ schedule: sch, index: originalIndex });
            } else {
                schedulesByCategory["×œ××™×“×”"].push({ schedule: sch, index: originalIndex }); // ×‘×¨×™×¨×ª ××—×“×œ
            }
        });

        const categoryOrder = ["×œ××™×“×”", "×—×•×¤×©×”", "× ×™×”×•×œ ×™×•×"]; // ×¡×“×¨ ×ª×¦×•×’×” ×¨×¦×•×™
        const categoryDetails = {
            "×œ××™×“×”": { icon: "ğŸ“–", emptyMsg: "×¢×“×™×™×Ÿ ×œ× ×©××¨×ª ×œ×•×– ×œ××™×“×”.", createLink: "learning-schedule.html" },
            "×—×•×¤×©×”": { icon: "ğŸ–ï¸", emptyMsg: "×¢×“×™×™×Ÿ ×œ× ×©××¨×ª ×œ×•×– ×—×•×¤×©×”.", createLink: "vacation-schedule.html" },
            "× ×™×”×•×œ ×™×•×": { icon: "ğŸ“…", emptyMsg: "×¢×“×™×™×Ÿ ×œ× ×©××¨×ª ×œ×•×– × ×™×”×•×œ ×™×•×.", createLink: "daily-schedule.html" }
        };

        let hasRenderedCategories = false;
        categoryOrder.forEach(catName => {
            if (catName in categoryDetails) {
                hasRenderedCategories = true; // Mark that we attempted to render categories
                const details = categoryDetails[catName];
                const schedulesList = schedulesByCategory[catName];

                // ×™×¦×™×¨×ª ××œ×× ×˜ ×”×§×˜×’×•×¨×™×”
                const categoryItemDiv = document.createElement('div');
                categoryItemDiv.className = 'category-item';

                // ×™×¦×™×¨×ª ×›×¤×ª×•×¨ ×”×§×˜×’×•×¨×™×”
                const categoryBtn = document.createElement('button');
                categoryBtn.className = 'category-btn';
                categoryBtn.setAttribute('onclick', `toggleCategory('${catName}')`);
                categoryBtn.setAttribute('aria-expanded', 'false'); // × ×’×™×©×•×ª: ××¦×‘ ×”×ª×—×œ×ª×™ ×¡×’×•×¨
                categoryBtn.innerHTML = `
                    <span>${details.icon} ${catName}</span>
                    <span class="arrow" id="arrow-${catName}" style="transform: rotate(0deg);">â–¼</span>
                `;

                // ×™×¦×™×¨×ª ×¨×©×™××ª ×”×œ×•×–×™×
                const categoryListDiv = document.createElement('div');
                categoryListDiv.className = 'category-list';
                categoryListDiv.id = `category-${catName}`;
                categoryListDiv.style.display = 'none'; // ×”×ª×—×œ×” ×‘××¦×‘ ××•×¡×ª×¨

                let listHtml = "";
                if (schedulesList.length === 0) {
                    listHtml = `<p>${details.emptyMsg}</p><button class="btn" onclick="window.location.href='${details.createLink}'"><i class="fas fa-plus"></i> ×¦×•×¨ ×œ×•"×– ×›×–×”</button>`;
                } else {
                    listHtml += "<ul style='list-style: none; padding:0;'>";
                    schedulesList.forEach(item => {
                        // Added check for item.schedule before accessing name
                        const scheduleName = item.schedule ? (item.schedule.name || '×œ×•"×– ×œ×œ× ×©×') : '×œ×•"×– ×œ× ×ª×§×™×Ÿ';
                        listHtml += `<li class="saved-schedule-item" onclick="viewSavedSchedule(${item.index})" title="×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×¤×¨×˜×™ ×”×œ×•×–">
                                       <h3>${scheduleName}</h3>
                                       <span title="××—×§ ×œ×•×– ×–×”" onclick="event.stopPropagation(); deleteSavedSchedule(${item.index})">ğŸ—‘ï¸</span>
                                     </li>`;
                    });
                    listHtml += "</ul>";
                }
                categoryListDiv.innerHTML = listHtml;

                // ×”×•×¡×¤×ª ×”×›×¤×ª×•×¨ ×•×”×¨×©×™××” ×œ-div ×©×œ ×”×§×˜×’×•×¨×™×”
                categoryItemDiv.appendChild(categoryBtn);
                categoryItemDiv.appendChild(categoryListDiv);

                // ×”×•×¡×¤×ª ×”-div ×©×œ ×”×§×˜×’×•×¨×™×” ×œ×§×•× ×˜×™×™× ×¨ ×”×¨××©×™
                categoriesContainer.appendChild(categoryItemDiv);
            }
        });
         // ×× ××™×Ÿ ×œ×•×–×™× ×‘×›×œ×œ, ×•×”×§×˜×’×•×¨×™×•×ª ×¨×•× ×“×¨×• (×›×œ×•××¨, ×”××©×ª××© ××—×•×‘×¨), ×”×¦×’ ×”×•×“×¢×”
         if (hasRenderedCategories && savedSchedules.length === 0 && !document.getElementById('login-prompt')) {
              showMessage('×¢×“×™×™×Ÿ ×œ× ×™×¦×¨×ª ×œ×•"×–×™×. <a href="choose-schedule.html">×œ×—×¥ ×›××Ÿ</a> ×›×“×™ ×œ×”×ª×—×™×œ.', 'info');
         }
    }

     // × ×™×§×•×™ ×ª×¦×•×’×ª ×”×œ×•×–×™× (×‘××§×¨×” ×©×œ ×”×ª× ×ª×§×•×ª)
     function clearScheduleDisplay() {
         const categoriesContainer = document.getElementById("categories-container");
         if(categoriesContainer) categoriesContainer.innerHTML = '';
         showMessage(''); // Clear any messages
     }

    // ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×¨×©×™××ª ×”×œ×•×–×™× ×‘×§×˜×’×•×¨×™×”
    function toggleCategory(cat) {
      const list = document.getElementById("category-" + cat);
      const arrow = document.getElementById("arrow-" + cat);
      const btn = list ? list.previousElementSibling : null; // ×”×›×¤×ª×•×¨ ×©××’×™×¢ ×œ×¤× ×™ ×”×¨×©×™××”

      if (!list || !arrow || !btn) return;

      const isHidden = list.style.display === "none";

      // ×¡×’×™×¨×ª ×›×œ ×”×§×˜×’×•×¨×™×•×ª ×”××—×¨×•×ª
      if (isHidden) {
          document.querySelectorAll('.category-list').forEach(l => {
              if (l.id !== list.id) {
                 l.style.display = 'none';
                 const otherBtn = l.previousElementSibling;
                 if (otherBtn) otherBtn.setAttribute('aria-expanded', 'false');
                 const otherArrow = otherBtn ? otherBtn.querySelector('.arrow') : null;
                  if (otherArrow) otherArrow.style.transform = 'rotate(0deg)';
              }
          });
      }

      // ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×”×§×˜×’×•×¨×™×” ×”× ×•×›×—×™×ª
      list.style.display = isHidden ? "block" : "none";
      btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
       arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    // ××—×™×§×ª ×œ×•×– ×©××•×¨
    function deleteSavedSchedule(index) {
      if (index < 0 || index >= savedSchedules.length || !savedSchedules[index]) { // Added check for existence
           console.error("Invalid index or schedule for deletion:", index);
           alert("×©×’×™××”: ××™× ×“×§×¡ ×œ× ×ª×§×™×Ÿ ××• ×œ×•\"×– ×œ× ×§×™×™× ×œ××—×™×§×”.");
           return;
      }

      const scheduleNameToDelete = savedSchedules[index].name || '×œ×•"×– ×œ×œ× ×©×';
      if (confirm(`×”×× ×œ××—×•×§ ××ª ×”×œ×•"×– "${scheduleNameToDelete}"?`)) {
        savedSchedules.splice(index, 1);
        saveSchedulesToFirestore(); // ×©××™×¨×” ×‘-Firestore
         // ×¨×™× ×“×•×¨ ××—×“×© ×©×œ ×›×œ ×”×§×˜×’×•×¨×™×•×ª ×•×”×œ×•×–×™×
         renderCategoriesAndSchedules();
        alert(`×”×œ×•"×– "${scheduleNameToDelete}" × ××—×§.`);
      }
    }

    // ×”×¦×’×ª ×œ×•×– ×¡×¤×¦×™×¤×™ ×©× ×‘×—×¨
    function viewSavedSchedule(idx) {
       if (idx < 0 || idx >= savedSchedules.length || !savedSchedules[idx]) { // Added check for existence
           console.error("Invalid index or schedule for viewing:", idx);
           alert("×©×’×™××”: ××™× ×“×§×¡ ×œ× ×ª×§×™×Ÿ ××• ×œ×•\"×– ×œ× ×§×™×™× ×œ×¦×¤×™×™×”.");
           goBackToCategoriesView(); // ×—×–×¨×” ×œ×ª×¦×•×’×ª ×”×§×˜×’×•×¨×™×•×ª
           return;
       }

      const sch = savedSchedules[idx];
      const contentElement = document.getElementById('content');
       if (!contentElement) return;

       // ×©×™××•×¨ ×”×›×•×ª×¨×ª ×”×¨××©×™×ª ×©×œ ×”×“×£
       const mainTitleHTML = `<h2 id="main-title">×”×œ×•×–×™×´× ×©×œ×™</h2>`;

      let finalHtml = "";
      // Added check for scheduleItems existence and type
      if (sch.scheduleItems && Array.isArray(sch.scheduleItems) && sch.scheduleItems.length > 0) {
          finalHtml += `<div id="finalScheduleDisplay">`; // ×¢×˜×™×¤×” ×œ×ª×¦×•×’×ª ×”×œ×•×–
          sch.scheduleItems.forEach(item => {
             // Basic check if item is valid
             if (item && item.subject) {
                 const emoji = getBackgroundEmoji(item.subject || '');
                 const startTime = item.startTime || '??:??';
                 const endTime = item.endTime || '??:??';
                 const subject = item.subject || '×œ×œ× × ×•×©×';
                 const description = item.description ? `<p>${item.description}</p>` : '';

                 finalHtml += `<div class="saved-schedule-item">
                                <div class="emoji-background">${emoji}</div>
                                <h3>${startTime} - ${endTime} : ${subject}</h3>
                                ${description}
                              </div>`;
             }
          });
           finalHtml += `</div>`;
      } else {
           finalHtml = `<div id="finalScheduleDisplay"><p style="margin-top: 20px; color: #6c757d;">×œ×•"×– ×–×” ×¨×™×§ ××¤×¢×™×œ×•×™×•×ª.</p></div>`;
      }

       const scheduleName = sch.name || '×œ×•"×– ×œ×œ× ×©×';
       const safeScheduleName = scheduleName.replace(/'/g, "\\'"); // Escape single quotes for JS string

       // ×¢×“×›×•×Ÿ ×”-DOM ×¢× ×”×›×•×ª×¨×ª, ×©× ×”×œ×•×–, ×”×ª×•×›×Ÿ ×•×”×›×¤×ª×•×¨×™×
       contentElement.innerHTML = `
          ${mainTitleHTML}
          <h3 style="font-size: 1.6em; color: #34495e; margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 10px;">${scheduleName}</h3>
          ${finalHtml}
          <div class="button-group">
             <button class="btn" onclick="captureScreenshotFromElement('finalScheduleDisplay', '${safeScheduleName}')">
                 <i class="fas fa-camera"></i> ×¦×™×œ×•× ××¡×š
             </button>
             <button class="btn" onclick="copyScheduleToClipboardFromSchedule(${idx})">
                 <i class="fas fa-copy"></i> ×”×¢×ª×§ ×›×˜×§×¡×˜
             </button>
             <button class="btn" onclick="editSchedule(${idx})">
                 <i class="fas fa-edit"></i> ×¢×¨×•×š ×œ×•"×–
             </button>
             <button class="btn" onclick="goBackToCategoriesView()">
                 <i class="fas fa-arrow-right"></i> ×—×–×•×¨ ×œ×¨×©×™××”
             </button>
          </div>
       `;
    }

     // ×¤×•× ×§×¦×™×” ×œ×—×–×¨×” ×œ×ª×¦×•×’×ª ×”×§×˜×’×•×¨×™×•×ª
     function goBackToCategoriesView() {
        const contentElement = document.getElementById('content');
        if (contentElement) {
             // ××™×¤×•×¡ ×”-HTML ×œ××‘× ×” ×”×‘×¡×™×¡×™ ×©×œ ×”×“×£
             contentElement.innerHTML = `
                 <h2 id="main-title">×”×œ×•×–×™×´× ×©×œ×™</h2>
                 <div id="categories-container"></div>
                 <div id="message-area"></div>
             `;
             // ×¨×™× ×“×•×¨ ××—×“×© ×©×œ ×”×§×˜×’×•×¨×™×•×ª ×•×”×œ×•×–×™× (×˜×•×¢×Ÿ ××—×“×© ××”××¢×¨×š ×”×§×™×™×)
             renderCategoriesAndSchedules();
        }
     }

     // ×¤×•× ×§×¦×™×” ×œ×¢×¨×™×›×ª ×œ×•"×–
     function editSchedule(idx) {
          if (idx < 0 || idx >= savedSchedules.length || !savedSchedules[idx]) { // Added check for existence
              alert("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×¢×¨×•×š ×œ×•\"×– ×œ× ×§×™×™×.");
              return;
          }
         try {
            // Ensure the schedule object is valid before stringifying
            const scheduleToEdit = { schedule: savedSchedules[idx], originalIndex: idx };
            if (!scheduleToEdit.schedule || typeof scheduleToEdit.schedule !== 'object') {
                throw new Error("Invalid schedule object for editing.");
            }
            localStorage.setItem('scheduleToEdit', JSON.stringify(scheduleToEdit));
            window.location.href = 'edit-schedule.html'; // ×•×“× ×©×©× ×”×§×•×‘×¥ × ×›×•×Ÿ
         } catch (e) {
             console.error("Error saving schedule to localStorage or invalid schedule:", e);
             alert("×©×’×™××” ×‘×”×›× ×” ×œ×¢×¨×™×›×”. ×™×™×ª×›×Ÿ ×©×”×œ×•\"×– ××™× ×• ×ª×§×™×Ÿ ××• ×©××™×Ÿ ××¡×¤×™×§ ××§×•× ×‘××—×¡×•×Ÿ ×”×“×¤×“×¤×Ÿ.");
         }
     }

    // ×©××™×¨×ª ×›×œ ××¢×¨×š ×”×œ×•×–×™× ×‘-Firestore
    function saveSchedulesToFirestore() {
      const user = firebase.auth().currentUser;
      if (user) {
        // Enhanced filtering for valid schedules
        const validSchedules = savedSchedules.filter(sch =>
             sch && typeof sch === 'object' && sch.name && typeof sch.name === 'string' &&
             Array.isArray(sch.scheduleItems) &&
             // Optional: check if items inside scheduleItems are valid too
             sch.scheduleItems.every(item => item && typeof item === 'object' && item.subject)
        );

        db.collection("schedules").doc(user.uid).set({ schedules: validSchedules })
        .then(() => { console.log("Schedules saved successfully to Firestore"); })
        .catch((error) => {
             console.error("Error saving schedules to Firestore: ", error);
             // Provide more specific feedback if possible, e.g., based on error code
             alert(`××™×¨×¢×” ×©×’×™××” ×‘×©××™×¨×ª ×”×œ×•"×–×™×: ${error.message}`);
        });
      } else {
           console.warn("Cannot save schedules. User not logged in.");
           // Maybe alert the user they need to log in again
           // alert("××™× ×š ××—×•×‘×¨. ×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”×©×™× ×•×™×™×.");
      }
    }

    // ××™×œ×•×Ÿ ×××•×’'×™ ×•××¦×™××ª ×××•×’'×™ ××ª××™× (× ×©××¨ ×–×”×” ×œ×’×¨×¡×” ×”×§×•×“××ª)
    const subjectEmojis = {
      "×§×¨×™××”": "ğŸ“–", "×§×¨×™××ª ×—×•××¨": "ğŸ“–", "×—×•××¨ ×œ×™××•×“": "ğŸ“–",
      "×ª×¨×’×•×œ": "ğŸ“", "×ª×¨×’×™×œ×™×": "ğŸ“",
      "××¢×‘×¨": "â©", "×—×–×¨×”": "â©", "×¡×™×›×•×": "ğŸ“‘",
      "×œ××™×“×”": "ğŸ’¡", "×©×™×¢×•×¨": "ğŸ§‘â€ğŸ«", "×¤×¨×•×™×§×˜": "ğŸ’»",
      "×œ×§×•×": "â°", "×”×©×›××”": "â°",
      "×”×¤×¡×§×”": "â˜•", "×× ×•×—×”": "ğŸ§˜",
      "×©×™× ×”": "ğŸ˜´", "×œ×™×©×•×Ÿ": "ğŸ˜´",
      "××•×›×œ": "ğŸ½ï¸", "××¨×•×—×”": "ğŸ½ï¸", "×‘×•×§×¨": "ğŸ¥", "×¦×”×¨×™×™×": "ğŸ¥ª", "×¢×¨×‘": "ğŸ²",
      "×¡×¤×•×¨×˜": "ğŸ‹ï¸â€â™€ï¸", "××™××•×Ÿ": "ğŸƒâ€â™‚ï¸", "×”×œ×™×›×”": "ğŸš¶â€â™€ï¸",
      "×¤×’×™×©×”": "ğŸ‘¥", "×©×™×—×”": "ğŸ“",
      "×¡×™×“×•×¨×™×": "ğŸ›’", "×§× ×™×•×ª": "ğŸ›ï¸",
      "× ×¡×™×¢×”": "ğŸš—", "×˜×™×¡×”": "âœˆï¸", "××•×˜×•×‘×•×¡": "ğŸšŒ", "×¨×›×‘×ª": "ğŸš†",
      "×‘×™×œ×•×™": "ğŸ‰", "×¡×¨×˜": "ğŸ¬", "××¡×¢×“×”": "ğŸœ",
      "×—×•×£": "ğŸ–ï¸", "×™×": "ğŸŒŠ", "×‘×¨×™×›×”": "ğŸŠ",
      "×˜×™×•×œ": "ğŸï¸", "×˜×‘×¢": "ğŸŒ²",
       "×›×œ×œ×™": "ğŸ“Œ" // ×‘×¨×™×¨×ª ××—×“×œ
    };

    function getBackgroundEmoji(subject) {
      if (!subject || typeof subject !== 'string') return subjectEmojis["×›×œ×œ×™"]; // Added type check
      const lowerSubject = subject.toLowerCase();

       // ×—×™×¤×•×© ××“×•×™×§ ×™×•×ª×¨ ×©×œ ×××•×’'×™ ×‘×¡×•×£ ××• ×‘×ª×—×™×œ×ª ×”××—×¨×•×–×ª
       const trimmedSubject = subject.trim();
       // Use regex for more robust emoji detection at start/end
       const emojiAtEnd = trimmedSubject.match(/\p{Emoji_Presentation}$/u);
       if (emojiAtEnd) return emojiAtEnd[0];
       const emojiAtStart = trimmedSubject.match(/^\p{Emoji_Presentation}/u);
       if (emojiAtStart) return emojiAtStart[0];


      // ×—×™×¤×•×© ××™×œ×” ×‘××™×œ×•×Ÿ
      for (const key in subjectEmojis) {
        // Ensure key exists and is a string before calling toLowerCase
        if (subjectEmojis.hasOwnProperty(key) && typeof key === 'string' && lowerSubject.includes(key.toLowerCase())) {
          return subjectEmojis[key];
        }
      }
      // ×—×™×¤×•×© ×××•×’'×™ ×›×œ×©×”×• ×‘×ª×•×š ×”××—×¨×•×–×ª
       const emojiMatch = subject.match(/\p{Emoji_Presentation}/u);
       if (emojiMatch) return emojiMatch[0];

      return subjectEmojis["×›×œ×œ×™"];
    }

    // ×¦×™×œ×•× ××¡×š ×©×œ ××œ×× ×˜ ×¡×¤×¦×™×¤×™
    function captureScreenshotFromElement(elementId, name) {
      const elem = document.getElementById(elementId);
      if (!elem) {
          console.error("Element not found for screenshot:", elementId);
          alert("×©×’×™××”: ×œ× × ××¦× ×”××œ×× ×˜ ×œ×¦×™×œ×•×.");
          return;
      }

      // ×™×¦×™×¨×ª ×¢×˜×™×¤×” ×–×× ×™×ª ×¢× ×¨×§×¢ ×œ×‘×Ÿ ×œ×¦×™×œ×•× × ×§×™ ×™×•×ª×¨
       const wrapper = document.createElement('div');
       wrapper.style.padding = '20px';
       wrapper.style.backgroundColor = '#ffffff';
       wrapper.style.display = 'inline-block';
       wrapper.style.minWidth = elem.offsetWidth + 'px'; // Ensure wrapper is at least as wide

       // ×©×›×¤×•×œ ×”××œ×× ×˜ ×œ×ª×•×š ×”×¢×˜×™×¤×”
       const clone = elem.cloneNode(true);
       wrapper.appendChild(clone);

       // ×”×•×¡×¤×ª ×”×¢×˜×™×¤×” ×œ-body ×‘××•×¤×Ÿ ×–×× ×™ ×•×‘×œ×ª×™ × ×¨××”
       wrapper.style.position = 'absolute';
       wrapper.style.left = '-9999px';
       wrapper.style.top = '-9999px';
       document.body.appendChild(wrapper);


      html2canvas(wrapper, {
          backgroundColor: "#ffffff",
          useCORS: true,
           scale: 1.5, // Slightly higher resolution
           logging: false // Disable html2canvas logging to console
      }).then(canvas => {
        document.body.removeChild(wrapper); // ×”×¡×¨×ª ×”×¢×˜×™×¤×” ×”×–×× ×™×ª

        canvas.toBlob(function(blob) {
          if (blob) {
              const link = document.createElement("a");
              // Sanitize filename more thoroughly
              const safeName = (name || '×œ×•×–')
                 .replace(/[\s]/g, '_') // Replace spaces with underscore
                 .replace(/[^a-z0-9×-×ª_\-]/gi, '') // Remove invalid characters
                 || '×œ×•×–'; // Fallback name
              link.download = safeName + ".png";
              link.href = URL.createObjectURL(blob);
              link.click();
              // Clean up the object URL after a short delay
              setTimeout(() => URL.revokeObjectURL(link.href), 100);
          } else {
               console.error("Failed to create blob from canvas.");
               alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×§×•×‘×¥ ×”×ª××•× ×”.");
          }
        }, 'image/png');
      }).catch(err => {
           if (document.body.contains(wrapper)) {
                 document.body.removeChild(wrapper);
           }
           console.error("Error capturing screenshot:", err);
           alert("×©×’×™××” ×‘×¦×™×œ×•× ×”××¡×š.");
      });
    }

    // ×”×¢×ª×§×ª ×œ×•×– ×œ×œ×•×— ×›×˜×§×¡×˜ ××¢×•×¦×‘
    function copyScheduleToClipboardFromSchedule(idx) {
        if (idx < 0 || idx >= savedSchedules.length || !savedSchedules[idx]) { // Added existence check
            alert("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ×œ×•\"×– ×œ× ×§×™×™×.");
            return;
         }
      const sch = savedSchedules[idx];
      let text = `*${sch.name || '×œ×•"×– ×œ×œ× ×©×'}*\n\n`;

      if (sch.scheduleItems && Array.isArray(sch.scheduleItems) && sch.scheduleItems.length > 0) {
          sch.scheduleItems.forEach(item => {
             if (item && item.subject) { // Check item validity
                 const emoji = getBackgroundEmoji(item.subject || '');
                 const startTime = item.startTime || '??:??';
                 const endTime = item.endTime || '??:??';
                 const subject = item.subject || '×œ×œ× × ×•×©×';
                 text += `*${startTime} - ${endTime}* : ${subject} ${emoji}\n`;
                 if (item.description) {
                      text += `   - ${item.description.trim()}\n`;
                 }
                 text += "\n";
             }
          });
      } else {
           text += "(×œ×•\"×– ×¨×™×§)\n";
      }

       const finalText = text.trim(); // Trim final text

       // Use Clipboard API first
       if (navigator.clipboard && navigator.clipboard.writeText) {
           navigator.clipboard.writeText(finalText).then(() => {
             alert("×”×œ×•×´×– ×”×•×¢×ª×§ ×œ×œ×•×— ×‘×”×¦×œ×—×”!");
           }).catch(err => {
             console.error("Clipboard API error:", err);
             // Fallback to execCommand if Clipboard API fails
             copyUsingExecCommand(finalText);
           });
       } else {
           // Fallback immediately if Clipboard API is not available
           copyUsingExecCommand(finalText);
       }
    }

     // Fallback copy function using execCommand
     function copyUsingExecCommand(textToCopy) {
         const textArea = document.createElement("textarea");
         textArea.value = textToCopy;
         // Make textarea non-editable and visually hidden
         textArea.style.position = "fixed";
         textArea.style.top = "-9999px";
         textArea.style.left = "-9999px";
         textArea.setAttribute("readonly", "");
         document.body.appendChild(textArea);
         textArea.select();
         try {
             const successful = document.execCommand('copy');
             if (successful) {
                 alert("×”×œ×•×´×– ×”×•×¢×ª×§ ×œ×œ×•×— ×‘×”×¦×œ×—×”!");
             } else {
                  console.error("execCommand failed to copy.");
                  alert("×”×¢×ª×§×” × ×›×©×œ×”. ×™×™×ª×›×Ÿ ×©×”×“×¤×“×¤×Ÿ ×©×œ×š ××™× ×• ×ª×•××š ×‘×¤×¢×•×œ×” ×–×•.");
             }
         } catch (err) {
             console.error("Error during execCommand:", err);
             alert("×”×¢×ª×§×” × ×›×©×œ×”. ×™×™×ª×›×Ÿ ×©×”×“×¤×“×¤×Ÿ ×©×œ×š ××™× ×• ×ª×•××š ×‘×¤×¢×•×œ×” ×–×•.");
         } finally {
             document.body.removeChild(textArea);
         }
     }


    // --- ×¡×•×£ ×¤×•× ×§×¦×™×•×ª ×¡×¤×¦×™×¤×™×•×ª ---

  </script>
</body>
</html>
