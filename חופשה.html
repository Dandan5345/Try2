<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>×–××Ÿ ×–×”×‘ - ×—×•×¤×©×”</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #ff8c42;
      --secondary: #fff0e6;
      --holiday-bg: #ffe4c4;
      --bg-event-general: #ffffff;
      --bg-event-lodging: #e6f7ff;
      --bg-event-flight: #cce0ff;
      --bg-event-activity: #fff9e6;
      --text-dark: #5a4f45;
      --text-light: #ffffff;
      --day-block-bg: #ffffff;
      --day-block-shadow: rgba(0, 0, 0, 0.1);
    }
    body {
      font-family: 'Rubik', sans-serif;
      background: var(--holiday-bg);
      color: var(--text-dark);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .modal-backdrop, .offcanvas-backdrop {
      background-color: rgba(255, 140, 66, 0.3) !important;
    }
    .navbar-brand { font-size: 1.5rem; font-weight: 700; color: var(--primary) !important; }
    .offcanvas { width: 50vw; max-width: 360px; }
    .offcanvas-body { background: var(--secondary); padding-top: 2rem; }
    .list-group-item { font-size: 1.1rem; transition: background .2s; }
    .list-group-item:hover { background: rgba(255,255,255,0.5); border-radius: .5rem; }

    .btn-vacation {
      background: var(--primary);
      color: var(--text-light);
      border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: transform .2s;
      border: none;
    }
    .btn-vacation:hover {
      background: #ff701a;
      transform: translateY(-2px);
      color: var(--text-light);
    }
    .day-block {
      background: var(--day-block-bg);
      color: var(--text-dark);
      border-radius: 1.5rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 25px var(--day-block-shadow);
      transition: background .3s;
    }
    .day-block:hover { background: #fefefe; }
    .day-block[data-date] { position: relative; }
    .day-header {
      display: flex; flex-wrap: wrap;
      justify-content: center; align-items: center;
      gap: .5rem; font-size: 1.3rem; font-weight: 500;
      letter-spacing: .5px; margin-bottom: 1.5rem;
      color: var(--primary);
    }
    .lodging-badge {
      background: var(--bg-event-lodging);
      color: var(--text-dark);
      padding: .3rem .6rem;
      border-radius: .75rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: .95rem;
      cursor: pointer;
      transition: transform .2s;
    }
    .lodging-badge:hover { transform: translateY(-1px); }
    .event-row {
      display: flex; align-items: stretch;
      animation: popIn .3s ease-out both;
      cursor: pointer; /* Add cursor pointer for edit functionality */
    }
    .times-col {
      width: 5.5rem;
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      margin-left: 1rem;
      color: var(--text-dark);
      font-weight: 500;
    }
    .content-col {
      position: relative; flex: 1;
      padding: 1rem 1.5rem;
      border-radius: 1rem;
      background: var(--bg-event-general);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: .75rem;
      transition: transform .2s, box-shadow .2s;
      overflow: hidden; color: var(--text-dark);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .content-col:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .content-col[data-type="×˜×™×¡×”"]       { background: var(--bg-event-flight); }
    .content-col[data-type="×¦'×§-××™×Ÿ"],
    .content-col[data-type="×¦'×§-×××•×˜"] { background: var(--bg-event-lodging); }
    .content-col[data-type="××˜×¨×§×¦×™×”"],
    .content-col[data-type="×¡×™×•×¨"]      { background: var(--bg-event-activity); }

    .event-icon {
      font-size: 1.5rem;
      margin-right: 10px;
    }
    .content-col[data-type="×˜×™×¡×”"] .event-icon-flight {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.8rem;
    }
    .event-content-wrapper {
        display: flex;
        align-items: center;
    }
     .event-text-details {
        flex-grow: 1;
    }
    .event-divider {
      border: 0; border-top: 1px solid #eee;
      margin: 1rem 0;
    }
    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }
    .modal-content { position: relative; }
    .loader-overlay {
      display: none; position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); color: #fff;
      font-size: 1.4rem; align-items: center;
      justify-content: center; z-index: 1050;
      border-radius: .5rem;
    }
    .btn-navigate {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      transition: background-color 0.2s;
      padding: 0;
      position: absolute;
      bottom: 8px;
      left: 10px;
    }
    .btn-navigate:hover {
      background-color: #ff701a;
    }
    .schedule-title { color: var(--text-dark); font-weight: 700;}
    .modal-header.bg-vacation { background-color: var(--primary) !important; }
    #eventActionModal .modal-body p { margin-bottom: 0.5rem; }
    #eventActionModal .modal-body strong { color: var(--primary); }

  </style>
</head>
<body>

<nav class="navbar navbar-light bg-transparent px-3">
  <button class="navbar-toggler me-auto" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">
    <span class="navbar-toggler-icon"></span>
  </button>
  <span class="navbar-brand mx-auto">×–××Ÿ ×–×”×‘ - ×—×•×¤×©×” ğŸ˜Š</span>
</nav>
<div class="offcanvas offcanvas-start" id="offcanvasMenu" tabindex="-1">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">ğŸ“‹ ×ª×¤×¨×™×˜</h5>
    <button class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div class="list-group">
      <div class="list-group-item">ğŸ†• ×‘× ×™×™×ª ×œ×•×´×– ×—×“×©</div>
      <div class="list-group-item">ğŸ—‚ï¸ ×”×œ×•×´×–×™× ×©×œ×™</div>
      <div class="list-group-item">â° ×˜×™×¤×™× ×œ× ×™×”×•×œ ×–×× ×™×</div>
      <div class="list-group-item">ğŸ“‹ ×œ×•×— ××©×™××•×ª</div>
      <div class="list-group-item">â“ ×¢×–×¨×” ×•×”×¡×‘×¨</div>
    </div>
  </div>
</div>

<div class="container py-4">
  <h2 id="displayScheduleName" class="text-center mb-4 schedule-title"></h2>
  <div class="d-flex justify-content-center gap-2 mb-4">
    <button id="btnAddEvent" class="btn btn-vacation" data-bs-toggle="modal" data-bs-target="#modalAddEvent" disabled>â• ×”×•×¡×£ ××™×¨×•×¢</button>
    <button id="btnLodging" class="btn btn-vacation" data-bs-toggle="modal" data-bs-target="#modalLodging" disabled>ğŸ¨ ×”×•×¡×£ ×œ×™× ×”</button>
    <button id="btnFlight" class="btn btn-vacation" data-bs-toggle="modal" data-bs-target="#modalFlight" disabled>âœˆï¸ ×”×•×¡×£ ×˜×™×¡×”</button>
  </div>
  <div id="scheduleContainer"></div>
</div>

<div class="modal fade" id="modalScheduleName" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header bg-vacation"><h5 class="modal-title text-white">ğŸ‰ ×¦×•×¨ ×©× ×œ×œ×•×–</h5></div>
    <div class="modal-body">
      <input type="text" id="inputScheduleName" class="form-control" placeholder="×œ×“×•×’××”: ×—×•×¤×©×ª ×§×™×¥ ×‘×¤×¨××’">
    </div>
    <div class="modal-footer">
      <button id="btnCreateSchedule" class="btn btn-vacation">×¦×•×¨ ×œ×•×´×–</button>
    </div>
  </div></div>
</div>

<div class="modal fade" id="modalAddEvent"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content">
  <div class="modal-header bg-vacation">
    <h5 class="modal-title text-white" id="modalAddEventTitle">â• ×”×•×¡×£ ××™×¨×•×¢ ×œ×œ×•"×–</h5>
    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
    <form id="formAddEvent">
      <input type="hidden" id="editingEventId"> <div class="mb-3">
        <label class="form-label">×‘×—×¨ × ×•×©×</label>
        <div class="d-flex align-items-center">
          <select id="eventType" class="form-select" style="flex:1;" required></select>
          <button id="btnShowDeleteSubjects" class="btn btn-outline-danger ms-2" style="display:none;">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div id="customSubjectsContainer" class="mb-3" style="display:none;">
        <ul class="list-group list-group-flush" id="customSubjectsList"></ul>
      </div>
      <div id="dynamicFields"></div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" data-bs-dismiss="modal">×‘×™×˜×•×œ</button>
    <button id="btnSaveEvent" class="btn btn-vacation">×©××•×¨ ××™×¨×•×¢</button>
  </div>
</div></div></div>

<div class="modal fade" id="modalLodgingDetail"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header bg-vacation">
    <h5 class="modal-title text-white" id="lodDetailTitle">×¤×¨×˜×™ ××§×•× ×©×”×™×™×”</h5>
    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
    <p id="lodDetailType"></p>
    <p id="lodDetailName"></p>
    <p>
      <span id="lodDetailLocation"></span>
      <button class="btn btn-sm btn-outline-secondary" id="btnNavigateLodging">× ×•×•×˜ ğŸ—ºï¸</button>
    </p>
    <p id="lodDetailCheckIn"></p>
    <p id="lodDetailCheckOut"></p>
  </div>
  <div class="modal-footer">
    <button class="btn btn-danger" id="btnDeleteLodgingDetail">ğŸ—‘ï¸ ××—×§</button>
    <button class="btn btn-secondary" id="btnEditLodgingDetail">âœï¸ ×¢×¨×•×š</button>
  </div>
</div></div></div>

<div class="modal fade" id="modalLodging"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header bg-vacation">
    <h5 class="modal-title text-white" id="modalLodgingTitle">ğŸ¨ ×”×•×¡×¤×ª ××§×•× ×©×”×™×™×”</h5>
    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
    <form id="formLodging">
      <div class="mb-3">
        <label class="form-label">×¡×•×’ × ×›×¡</label>
        <select id="lodgingType" class="form-select" required>
          <option value="">-- ×‘×—×¨ ×¡×•×’ --</option>
          <option value="××œ×•×Ÿ">ğŸ¨ ××œ×•×Ÿ</option>
          <option value="×“×™×¨×”">ğŸ  ×“×™×¨×”</option>
          <option value="×‘×™×ª">ğŸ¡ ×‘×™×ª</option>
          <option value="×§××¤×™× ×’">â›º ×§××¤×™× ×’</option>
          <option value="××—×¨">â“ ××—×¨</option>
        </select>
      </div>
      <div class="mb-3"><label class="form-label">×©× ×”××§×•×</label><input type="text" id="lodName" class="form-control" required></div>
      <div class="mb-3">
        <label class="form-label">××™×§×•×</label>
        <div class="input-group">
          <input type="text" id="lodLocation" class="form-control" required>
          <button class="btn btn-outline-secondary" type="button" onclick="openMapForInput('lodLocation')">ğŸ—ºï¸</button>
        </div>
      </div>
      <div class="mb-3 row">
        <div class="col-6"><label class="form-label">×ª××¨×™×š ×¦×³×§-××™×Ÿ</label><input type="date" id="lodCheckInDate" class="form-control" required></div>
        <div class="col-6"><label class="form-label">×©×¢×ª ×¦×³×§-××™×Ÿ</label><input type="time" id="lodCheckInTime" class="form-control"></div>
      </div>
      <div class="mb-3 row">
        <div class="col-6"><label class="form-label">×ª××¨×™×š ×¦×³×§-×××•×˜</label><input type="date" id="lodCheckOutDate" class="form-control" required></div>
        <div class="col-6"><label class="form-label">×©×¢×ª ×¦×³×§-×××•×˜</label><input type="time" id="lodCheckOutTime" class="form-control"></div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" data-bs-dismiss="modal">×‘×™×˜×•×œ</button>
    <button id="btnSaveLodging" class="btn btn-vacation">×©××•×¨ ××§×•×</button>
  </div>
</div></div></div>

<div class="modal fade" id="modalFlight"><div class="modal-dialog"><div class="modal-content">
  <div id="loader" class="loader-overlay">××—×¤×© ×¤×¨×˜×™ ×˜×™×¡×”..âœˆï¸</div>
  <div class="modal-header bg-vacation">
    <h5 class="modal-title text-white" id="modalFlightTitle">âœˆï¸ ×”×•×¡×£ ×˜×™×¡×”</h5>
    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="editingFlightEventId"> <div id="flightSearchResult" style="display:none;">
      <span class="close-search" id="closeSearchModal" style="cursor:pointer; float:left; font-size:1.5rem;">Ã—</span>
      <h5>×ª×•×¦××•×ª ×—×™×¤×•×© ×˜×™×¡×”</h5>
      <div id="flightResultContent"></div>
      <button type="button" class="btn btn-vacation mt-2" id="copyFlightData">×”×¢×ª×§ ×œ×˜×•×¤×¡</button>
    </div>
    <form id="formFlight">
      <div class="mb-3"><label class="form-label">×ª××¨×™×š:</label><input type="date" id="flightDate" class="form-control" required></div>
      <div class="mb-3">
        <label class="form-label">××¡×¤×¨ ×˜×™×¡×”:</label>
        <div class="input-group">
          <input type="text" id="flightNumber" class="form-control" placeholder="×œ××©×œ LY2523" required>
          <button type="button" class="btn btn-outline-secondary" id="btnSearchFlight">ğŸ”</button>
        </div>
      </div>
      <div class="mb-3"><label class="form-label">×©×“×” ×”××¨××”:</label><input type="text" id="flightFrom" class="form-control" placeholder="×©× ××œ× ×©×œ ×©×“×” ×”×ª×¢×•×¤×”" required></div>
      <div class="mb-3"><label class="form-label">×©×¢×ª ×”××¨××”:</label><input type="time" id="flightDepart" class="form-control" required></div>
      <div class="mb-3"><label class="form-label">×©×“×” × ×—×™×ª×”:</label><input type="text" id="flightTo" class="form-control" placeholder="×©× ××œ× ×©×œ ×©×“×” ×”×ª×¢×•×¤×”" required></div>
      <div class="mb-3"><label class="form-label">×©×¢×ª × ×—×™×ª×”:</label><input type="time" id="flightArrive" class="form-control" required></div>
      <div class="mb-3"><label class="form-label">×—×‘×¨×ª ×ª×¢×•×¤×”:</label><input type="text" id="flightAirline" class="form-control"></div>
      <div class="mb-3"><label class="form-label">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™):</label><textarea id="flightDesc" class="form-control" rows="2"></textarea></div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" data-bs-dismiss="modal">×‘×™×˜×•×œ</button>
    <button class="btn btn-vacation" id="btnSaveFlight">×©××•×¨ ×˜×™×¡×”</button>
  </div>
</div></div></div>

<div class="modal fade" id="eventActionModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-vacation">
        <h5 class="modal-title text-white">×¤×¢×•×œ×•×ª ×‘××™×¨×•×¢</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>××” ×ª×¨×¦×” ×œ×¢×©×•×ª ×¢× ×”××™×¨×•×¢?</p>
        <p><strong id="eventActionDetails"></strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="btnDeleteEventFromActionModal">ğŸ—‘ï¸ ××—×§</button>
        <button type="button" class="btn btn-primary" id="btnEditEventFromActionModal">âœï¸ ×¢×¨×•×š</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- GLOBALS ---
  const weekdayNames=['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
  let permanentSubjects=JSON.parse(localStorage.getItem('permanentSubjects')||'[]'),
      oneTimeSubjects=[],
      defaultSubjects=['×”×©×§××”','×©×™× ×”','×”×œ×™×›×”/× ×¡×™×¢×”','××•×›×œ','×¡×™×•×¨','××˜×¨×§×¦×™×”'],
      emojiMap={
        '×”×©×§××”': 'â°', '×©×™× ×”': 'ğŸ›ï¸', '×”×œ×™×›×”/× ×¡×™×¢×”': 'ğŸš¶â€â™‚ï¸',
        '××•×›×œ': 'ğŸ´', '×¡×™×•×¨': 'ğŸï¸', '××˜×¨×§×¦×™×”': 'ğŸŸï¸',
        '×˜×™×¡×”': 'âœˆï¸', '×¦\'×§-××™×Ÿ': 'ğŸ§³', '×¦\'×§-×××•×˜': 'ğŸ‘‹'
      },
      lodgings=[], editingLodgingId=null, lodgingIdCounter=0,
      scheduleEvents = {}, // Object to hold events: { "YYYY-MM-DD": [eventObj1, eventObj2] }
      eventIdCounter = 0, // For unique event IDs
      flightDataTmp=null,
      currentEditingEventId = null; // To store ID of event being actioned upon

  // --- UTILITY FUNCTIONS ---
  function getDatesBetween(s,e){
    let a=[], d=new Date(s), l=new Date(e);
    if (d > l) return []; // Handle invalid date range
    while(d<=l){ a.push(d.toISOString().split('T')[0]); d.setDate(d.getDate()+1); }
    return a;
  }

  function generateEventId() {
    return `event-${eventIdCounter++}`;
  }

  // --- EVENT RENDERING AND MANAGEMENT ---
  function sortDayEvents(date){
    let b=document.querySelector(`[data-date="${date}"]`);
    if(!b) return;
    let rows=Array.from(b.querySelectorAll('.event-row'));
    rows.sort((x,y)=>{
      let t1=x.querySelector('.times-col span:first-child').textContent,
          t2=y.querySelector('.times-col span:first-child').textContent;
      return t1.localeCompare(t2);
    });
    b.querySelectorAll('.event-row, .event-divider').forEach(el => el.remove());
    rows.forEach((r,i)=>{
        if(i > 0){
            let hr=document.createElement('hr'); hr.className='event-divider'; b.append(hr);
        }
        b.append(r);
    });
  }

  function createDayBlock(day,date){
    let blk=document.createElement('div'); blk.className='day-block'; blk.dataset.date=date;
    let badges=lodgings.filter(l=>date>=l.checkInDate&&date<=l.checkOutDate)
      .map(l=>`<span class="lodging-badge" data-lodging-id="${l.id}" onclick="showLodgingDetail(${l.id})">${l.name}</span>`).join('');
    blk.innerHTML=`<div class="day-header"><span>${day} â€“ ${new Date(date).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric'})}</span>${badges}</div>`;
    return blk;
  }

  function addEventToScheduleData(date, eventData) {
    if (!scheduleEvents[date]) {
        scheduleEvents[date] = [];
    }
    // If editing, remove old version first
    const existingEventIndex = scheduleEvents[date].findIndex(e => e.id === eventData.id);
    if (existingEventIndex > -1) {
        scheduleEvents[date].splice(existingEventIndex, 1);
    }
    scheduleEvents[date].push(eventData);
    scheduleEvents[date].sort((a,b) => (a.start || a.departTime).localeCompare(b.start || b.departTime));
  }


  function removeEventFromScheduleData(date, eventId) {
    if (scheduleEvents[date]) {
        scheduleEvents[date] = scheduleEvents[date].filter(event => event.id !== eventId);
        if (scheduleEvents[date].length === 0) {
            delete scheduleEvents[date];
        }
    }
  }
  function getEventFromScheduleData(eventId) {
    for (const date in scheduleEvents) {
        const event = scheduleEvents[date].find(e => e.id === eventId);
        if (event) return { ...event, date: date }; // Return a copy with its date
    }
    return null;
  }


function renderEventRow(date, eventData) { // eventData should now include an 'id'
    let blk = document.querySelector(`[data-date="${date}"]`);
    if (!blk) {
        let wd = new Date(date).getDay();
        blk = createDayBlock(weekdayNames[wd], date);
        const container = document.getElementById('scheduleContainer');
        const blocks = Array.from(container.children);
        blocks.push(blk);
        blocks.sort((a, b) => new Date(a.dataset.date) - new Date(b.dataset.date));
        blocks.forEach(b => container.appendChild(b));
    } else { // Ensure header is up-to-date
        let wd = new Date(date).getDay(),
            nh = createDayBlock(weekdayNames[wd], date).querySelector('.day-header');
        if (blk.querySelector('.day-header')) blk.querySelector('.day-header').replaceWith(nh);
        else blk.prepend(nh);
    }

    // Remove existing row if editing
    const existingRow = document.getElementById(eventData.id);
    if (existingRow) {
        const prevDivider = existingRow.previousElementSibling;
        if (prevDivider && prevDivider.classList.contains('event-divider')) prevDivider.remove();
        else { // Check if it was the first, then the next divider might need removal if this was the only one left
            const nextDivider = existingRow.nextElementSibling;
            if(nextDivider && nextDivider.classList.contains('event-divider') && blk.querySelectorAll('.event-row').length === 1){ // only 1 event row means this is it
                 nextDivider.remove();
            }
        }
        existingRow.remove();
    }


    let row = document.createElement('div');
    row.className = 'event-row';
    row.id = eventData.id; // Assign unique ID to the row for easy access/removal
    if (eventData.type !== "×¦'×§-××™×Ÿ" && eventData.type !== "×¦'×§-×××•×˜") { // Only allow click for non-lodging-meta events
        row.onclick = () => handleEventClick(eventData.id);
    } else {
        row.style.cursor = 'default';
    }


    let times = document.createElement('div');
    times.className = 'times-col';
    // Use eventData.start/end for general events, or departTime/arriveTime for flights
    const startTime = eventData.start || eventData.departTime;
    const endTime = eventData.end || eventData.arriveTime;
    times.innerHTML = `<span>${startTime}</span><span>${endTime}</span>`;

    let content = document.createElement('div');
    content.className = 'content-col';
    content.setAttribute('data-type', eventData.type);

    let eventHTML = '', iconHTML = '';
    const generalEmoji = emojiMap[eventData.type] || 'ğŸ“';

    switch (eventData.type) {
        case '×˜×™×¡×”':
            iconHTML = `<div class="event-icon-flight">âœˆï¸</div>`;
            eventHTML = `
                <div class="event-text-details">
                    <div><strong>×˜×™×¡×” ×${eventData.from} â¬…ï¸ ${eventData.to}</strong></div>
                    <div>${eventData.number}${eventData.airline ? ` / ${eventData.airline}` : ''}</div>
                    <div>×”××¨××” ğŸ›«: ${eventData.departTime}</div>
                    <div>× ×—×™×ª×” ğŸ›¬: ${eventData.arriveTime}</div>
                    ${eventData.description ? `<div><em>${eventData.description}</em></div>` : ''}
                </div>`;
            break;
        case '×”×©×§××”': case '×©×™× ×”':
            iconHTML = `<div class="event-icon">${generalEmoji}</div>`;
            eventHTML = `
                <div class="event-text-details">
                    <div><strong>${eventData.type}</strong></div>
                    ${eventData.description ? `<div>${eventData.description}</div>` : ''}
                </div>`;
            break;
        case '×”×œ×™×›×”/× ×¡×™×¢×”':
            let modeEmoji = emojiMap['×”×œ×™×›×”/× ×¡×™×¢×”'];
            if (eventData.mode) {
                if (eventData.mode.includes('×¨×›×‘')) modeEmoji = 'ğŸš—';
                else if (eventData.mode.includes('×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª')) modeEmoji = 'ğŸšŒ';
                else if (eventData.mode.includes('×”×œ×™×›×”')) modeEmoji = 'ğŸš¶â€â™‚ï¸';
            }
            iconHTML = `<div class="event-icon">${modeEmoji}</div>`;
            eventHTML = `
                <div class="event-text-details">
                    <div><strong>${eventData.mode || '×”×œ×™×›×”/× ×¡×™×¢×”'}</strong></div>
                    ${eventData.startLocation ? `<div>×: ${eventData.startLocation}</div>` : ''}
                    <div>××œ: ${eventData.endLocation}</div>
                    ${eventData.description ? `<div>${eventData.description}</div>` : ''}
                </div>
                <button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${eventData.endLocation}')" title="× ×•×•×˜ ××œ ${eventData.endLocation}">ğŸ—ºï¸</button>`;
            break;
        case "×¦'×§-××™×Ÿ": case "×¦'×§-×××•×˜":
            iconHTML = `<div class="event-icon">${generalEmoji}</div>`;
            eventHTML = `
                <div class="event-text-details">
                    <div><strong>${eventData.type}: ${eventData.lodgingName}</strong></div>
                    ${eventData.location ? `<div>${eventData.location}</div>` : ''}
                </div>`;
            break;
        default: // '××•×›×œ', '×¡×™×•×¨', '××˜×¨×§×¦×™×”', custom
            iconHTML = `<div class="event-icon">${generalEmoji}</div>`;
            let title = eventData.customSubjectName || eventData.type;
            if (eventData.type === '××•×›×œ' && eventData.foodPlace) title = `${eventData.foodPlace}`;

            eventHTML = `
                <div class="event-text-details">
                    <div><strong>${title}</strong></div>
                    ${eventData.location ? `<div>××™×§×•×: ${eventData.location}</div>` : ''}
                    ${eventData.description ? `<div>${eventData.description}</div>` : ''}
                </div>`;
            if (eventData.location) {
                eventHTML += `<button class="btn-navigate" onclick="event.stopPropagation(); openMapForNavigation('${eventData.location}')" title="× ×•×•×˜ ××œ ${eventData.location}">ğŸ—ºï¸</button>`;
            }
    }
    content.innerHTML = `<div class="event-content-wrapper">${iconHTML}${eventHTML}</div>`;

    const existingRowsCount = blk.querySelectorAll('.event-row').length;
    // Add divider only if it's a new row being appended and there are already rows
    // or if it's an update and it's not the only row.
    if (existingRowsCount > 0 && !document.getElementById(eventData.id)) { // Appending a new row, not the first
         let hr = document.createElement('hr'); hr.className = 'event-divider'; blk.append(hr);
    }


    row.append(times, content);
    blk.append(row);
    sortDayEvents(date); // This will re-add dividers correctly
}


  // --- SUBJECT MANAGEMENT ---
  function buildSubjectOptions(){
    let sel=document.getElementById('eventType');
    sel.innerHTML='<option value="">-- ×‘×—×¨ × ×•×©× --</option>';
    defaultSubjects.forEach(s=>{let o=document.createElement('option');o.value=s;o.textContent=`${emojiMap[s]||'ğŸ“'} ${s}`;sel.append(o);});
    permanentSubjects.forEach(s=>{let o=document.createElement('option');o.value=s;o.textContent=`ğŸ“Œ ${s}`;sel.append(o);});
    oneTimeSubjects.forEach(s=>{let o=document.createElement('option');o.value=s;o.textContent=`ğŸ†• ${s}`;sel.append(o);});
    document.getElementById('btnShowDeleteSubjects').style.display=(permanentSubjects.length||oneTimeSubjects.length)?'inline-block':'none';
    renderCustomSubjects();
  }
  function renderCustomSubjects(){
    let ul=document.getElementById('customSubjectsList');ul.innerHTML='';
    permanentSubjects.forEach(s=>{let li=document.createElement('li');li.className='list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML=`ğŸ“Œ ${s} <span onclick="deleteSubject('${s}','permanent')" style="cursor:pointer;">ğŸ—‘ï¸</span>`;ul.append(li);});
    oneTimeSubjects.forEach(s=>{let li=document.createElement('li');li.className='list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML=`ğŸ†• ${s} <span onclick="deleteSubject('${s}','oneTime')" style="cursor:pointer;">ğŸ—‘ï¸</span>`;ul.append(li);});
  }
  function deleteSubject(name,type){
    if(type==='permanent'){permanentSubjects=permanentSubjects.filter(x=>x!==name);localStorage.setItem('permanentSubjects',JSON.stringify(permanentSubjects));}
    else oneTimeSubjects=oneTimeSubjects.filter(x=>x!==name);
    buildSubjectOptions();
  }

  // --- ADD/EDIT GENERAL EVENT LOGIC ---
  function addEvent() {
    let typeValue = document.getElementById('eventType').value;
    let date = document.getElementById('evDate')?.value,
        start = document.getElementById('evStart')?.value,
        end = document.getElementById('evEnd')?.value,
        desc = document.getElementById('evDesc')?.value;
    const editingEventIdValue = document.getElementById('editingEventId').value;


    if (!date || !start || !end || !typeValue) { alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™× (× ×•×©×, ×ª××¨×™×š ×•×©×¢×•×ª).'); return; }
    if (end <= start) { alert('×©×¢×ª ×”×¡×™×•× ×—×™×™×‘×ª ×œ×”×™×•×ª ××—×¨×™ ×©×¢×ª ×”×”×ª×—×œ×”.'); return; }

    let eventData = {
        id: editingEventIdValue || generateEventId(), // Use existing ID if editing, else generate new
        type: typeValue,
        customSubjectName: (!defaultSubjects.includes(typeValue) && typeValue !== '×˜×™×¡×”') ? typeValue : null,
        description: desc,
        start: start,
        end: end
    };

    if (typeValue === '×”×œ×™×›×”/× ×¡×™×¢×”') {
        let mode = document.getElementById('walkMode').value,
            startLoc = document.getElementById('walkStartLoc').value,
            endLoc = document.getElementById('walkEndLoc').value;
        if (!mode || !endLoc) { alert('×‘××™×¨×•×¢ "×”×œ×™×›×”/× ×¡×™×¢×”", ×× × ××œ× ×¡×•×’ ××¡×œ×•×œ ×•××™×§×•× ×¡×•×£.'); return; }
        eventData.mode = mode; eventData.startLocation = startLoc; eventData.endLocation = endLoc;
    } else if (typeValue === '××•×›×œ') {
        let p = document.getElementById('foodPlace').value;
        if (!p) { alert('×‘××™×¨×•×¢ "××•×›×œ", ×× × ×‘×—×¨ ×”×™×›×Ÿ ××•×›×œ×™×.'); return; }
        eventData.foodPlace = p;
        if (['ğŸ½ï¸ ××¡×¢×“×”', 'ğŸ” ××•×›×œ ××”×™×¨'].includes(p)) {
            eventData.location = document.getElementById('foodLocation')?.value;
            if (!eventData.location) { alert("×‘××™×¨×•×¢ '××•×›×œ' ×‘××¡×¢×“×”/××–×•×Ÿ ××”×™×¨, ×× × ×”×–×Ÿ ××™×§×•×."); return; }
        }
    } else if (typeValue === '×¡×™×•×¨' || typeValue === '××˜×¨×§×¦×™×”' || eventData.customSubjectName) {
        let loc = document.getElementById('eventLocation')?.value;
        if ((typeValue === '×¡×™×•×¨' || typeValue === '××˜×¨×§×¦×™×”') && !loc) { alert(`×‘××™×¨×•×¢ "${typeValue}", ×× × ××œ× ××™×§×•×.`); return; }
        if(loc) eventData.location = loc;
    }


    addEventToScheduleData(date, eventData);
    renderEventRow(date, eventData);

    bootstrap.Modal.getInstance(document.getElementById('modalAddEvent')).hide();
    document.getElementById('formAddEvent').reset();
    document.getElementById('editingEventId').value = ''; // Clear editing ID
    document.getElementById('modalAddEventTitle').textContent = 'â• ×”×•×¡×£ ××™×¨×•×¢ ×œ×œ×•"×–';
    document.getElementById('dynamicFields').innerHTML = '';
    document.getElementById('eventType').value = "";
  }


  // --- MAP FUNCTIONS ---
  function openMapForInput(inputId){
    let loc=document.getElementById(inputId).value.trim();
    if(loc) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`,'_blank');
  }
  function openMapForNavigation(address){
    if(address) window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`, '_blank');
  }
  function openMapDetail(){
    let l=lodgings.find(x=>x.id===editingLodgingId);
    if(l?.location) openMapForNavigation(l.location);
  }

  // --- LODGING MANAGEMENT ---
  function showLodgingDetail(id){
    editingLodgingId=id;
    let l=lodgings.find(x=>x.id===id);
    if (!l) return;
    document.getElementById('lodDetailTitle').textContent=l.name;
    document.getElementById('lodDetailType').textContent=`×¡×•×’: ${l.type}`;
    document.getElementById('lodDetailName').textContent=`×©×: ${l.name}`;
    document.getElementById('lodDetailLocation').textContent=`××™×§×•×: ${l.location}`;
    document.getElementById('btnNavigateLodging').onclick = openMapDetail;
    document.getElementById('lodDetailCheckIn').textContent=`×¦×³×§-××™×Ÿ: ${new Date(l.checkInDate).toLocaleDateString('he-IL')} ${l.checkInTime||''}`;
    document.getElementById('lodDetailCheckOut').textContent=`×¦×³×§-×××•×˜: ${new Date(l.checkOutDate).toLocaleDateString('he-IL')} ${l.checkOutTime||''}`;
    new bootstrap.Modal(document.getElementById('modalLodgingDetail')).show();
  }

  function deleteLodgingDetail(){
    if (editingLodgingId === null) return;
    const lodgingToDelete = lodgings.find(l => l.id === editingLodgingId);
    if (!lodgingToDelete) return;

    const datesAffected = getDatesBetween(lodgingToDelete.checkInDate, lodgingToDelete.checkOutDate);

    datesAffected.forEach(date => {
        if(scheduleEvents[date]) {
            scheduleEvents[date] = scheduleEvents[date].filter(event => {
                if ((event.type === "×¦'×§-××™×Ÿ" || event.type === "×¦'×§-×××•×˜") && event.lodgingName === lodgingToDelete.name) {
                    const rowElement = document.getElementById(event.id);
                    if (rowElement) {
                        const prevDivider = rowElement.previousElementSibling; // Check for preceding divider
                        if (prevDivider && prevDivider.classList.contains('event-divider')) {
                            prevDivider.remove();
                        } else { // If no preceding, check for succeeding (might be the first element)
                            const nextDivider = rowElement.nextElementSibling;
                            if (nextDivider && nextDivider.classList.contains('event-divider')) {
                                nextDivider.remove();
                            }
                        }
                        rowElement.remove();
                    }
                    return false; // Remove from data
                }
                return true; // Keep in data
            });
            if (scheduleEvents[date].length === 0) delete scheduleEvents[date];
        }
    });

    lodgings = lodgings.filter(x => x.id !== editingLodgingId);
    bootstrap.Modal.getInstance(document.getElementById('modalLodgingDetail')).hide();

    datesAffected.forEach(date => {
        const dayBlock = document.querySelector(`.day-block[data-date="${date}"]`);
        if (dayBlock) {
            let wd = new Date(date).getDay();
            let hdr = createDayBlock(weekdayNames[wd], date).querySelector('.day-header');
            if (dayBlock.querySelector('.day-header')) {
                dayBlock.querySelector('.day-header').replaceWith(hdr);
            }
            const hasEvents = scheduleEvents[date] && scheduleEvents[date].length > 0;
            const hasOtherLodgings = lodgings.some(l => date >= l.checkInDate && date <= l.checkOutDate);
            if (!hasEvents && !hasOtherLodgings) {
                dayBlock.remove();
            } else {
                sortDayEvents(date);
            }
        }
    });
    editingLodgingId = null;
  }
  function editLodgingDetail(){
    let l=lodgings.find(x=>x.id===editingLodgingId);
    if(!l) return;
    document.getElementById('modalLodgingTitle').textContent = 'âœï¸ ×¢×¨×•×š ××§×•× ×©×”×™×™×”';
    document.getElementById('lodgingType').value=l.type;
    document.getElementById('lodName').value=l.name;
    document.getElementById('lodLocation').value=l.location;
    document.getElementById('lodCheckInDate').value=l.checkInDate;
    document.getElementById('lodCheckInTime').value=l.checkInTime;
    document.getElementById('lodCheckOutDate').value=l.checkOutDate;
    document.getElementById('lodCheckOutTime').value=l.checkOutTime;
    bootstrap.Modal.getInstance(document.getElementById('modalLodgingDetail')).hide();
    new bootstrap.Modal(document.getElementById('modalLodging')).show();
  }

  function saveLodging() {
    let ciD = document.getElementById('lodCheckInDate').value,
        coD = document.getElementById('lodCheckOutDate').value,
        ciT = document.getElementById('lodCheckInTime').value,
        coT = document.getElementById('lodCheckOutTime').value,
        name = document.getElementById('lodName').value.trim(),
        type = document.getElementById('lodgingType').value,
        loc = document.getElementById('lodLocation').value.trim();
    if (!ciD || !coD || !name || !type || !loc) { alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×'); return; }
    if (coD < ciD) { alert('×ª××¨×™×š ×¦\'×§-×××•×˜ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×œ×¤× ×™ ×ª××¨×™×š ×¦\'×§-××™×Ÿ.'); return; }

    const oldLodging = editingLodgingId !== null ? lodgings.find(l => l.id === editingLodgingId) : null;
    const oldDates = oldLodging ? getDatesBetween(oldLodging.checkInDate, oldLodging.checkOutDate) : [];


    if (oldLodging) {
        oldDates.forEach(date => {
            if (scheduleEvents[date]) {
                scheduleEvents[date] = scheduleEvents[date].filter(event => {
                    if ((event.type === "×¦'×§-××™×Ÿ" || event.type === "×¦'×§-×××•×˜") && event.lodgingName === oldLodging.name) {
                        const rowElement = document.getElementById(event.id);
                        if (rowElement) {
                             const prevDivider = rowElement.previousElementSibling;
                             if (prevDivider && prevDivider.classList.contains('event-divider')) prevDivider.remove();
                             else {const nextDivider = rowElement.nextElementSibling; if(nextDivider && nextDivider.classList.contains('event-divider')) nextDivider.remove();}
                             rowElement.remove();
                        }
                        return false;
                    }
                    return true;
                });
                if (scheduleEvents[date].length === 0) delete scheduleEvents[date]; else sortDayEvents(date);
            }
        });
    }

    let currentId = editingLodgingId !== null ? editingLodgingId : lodgingIdCounter++;
    const newLodgingData = { id: currentId, type, name, location: loc, checkInDate: ciD, checkInTime: ciT, checkOutDate: coD, checkOutTime: coT };

    if (editingLodgingId !== null) {
        lodgings = lodgings.map(x => x.id === currentId ? newLodgingData : x);
    } else {
        lodgings.push(newLodgingData);
    }

    if (ciT) {
        const checkInEvent = { id: generateEventId(), type: "×¦'×§-××™×Ÿ", lodgingName: name, location: loc, start: ciT, end: ciT };
        addEventToScheduleData(ciD, checkInEvent);
        renderEventRow(ciD, checkInEvent);
    }
    if (coT) {
        const checkOutEvent = { id: generateEventId(), type: "×¦'×§-×××•×˜", lodgingName: name, location: loc, start: coT, end: coT };
        addEventToScheduleData(coD, checkOutEvent);
        renderEventRow(coD, checkOutEvent);
    }

    const newDates = getDatesBetween(ciD, coD);
    const allAffectedDates = new Set([...oldDates, ...newDates]);

    allAffectedDates.forEach(date => {
        let wd = new Date(date).getDay();
        let blk = document.querySelector(`[data-date="${date}"]`);

        const hasEventsForDate = scheduleEvents[date] && scheduleEvents[date].length > 0;
        const hasLodgingForDate = lodgings.some(l => date >= l.checkInDate && date <= l.checkOutDate);

        if (!blk && (hasEventsForDate || hasLodgingForDate)) { // Create block if it should exist but doesn't
            blk = createDayBlock(weekdayNames[wd], date);
            const container = document.getElementById('scheduleContainer');
            const blocks = Array.from(container.children); blocks.push(blk);
            blocks.sort((a, b) => new Date(a.dataset.date) - new Date(b.dataset.date));
            blocks.forEach(b => container.appendChild(b));
        }
        
        if(blk) { // If block exists or was just created
            let hdr = createDayBlock(weekdayNames[wd], date).querySelector('.day-header');
            if (blk.querySelector('.day-header')) blk.querySelector('.day-header').replaceWith(hdr);
            else blk.prepend(hdr);

            if (!hasEventsForDate && !hasLodgingForDate) { // Remove block if it's now empty
                blk.remove();
            } else {
                sortDayEvents(date); // Ensure events are sorted if block remains
            }
        }
    });

    bootstrap.Modal.getInstance(document.getElementById('modalLodging')).hide();
    document.getElementById('formLodging').reset();
    document.getElementById('modalLodgingTitle').textContent = 'ğŸ¨ ×”×•×¡×¤×ª ××§×•× ×©×”×™×™×”';
    editingLodgingId = null;
}


  // --- FLIGHT MANAGEMENT ---
  document.getElementById('btnSearchFlight').addEventListener('click',()=>{
    let num=document.getElementById('flightNumber').value.trim(),
        date=document.getElementById('flightDate').value;
    if(!num||!date){alert('×× × ××œ× ×ª××¨×™×š ×•××¡×¤×¨ ×˜×™×¡×”.');return;}
    let loader=document.getElementById('loader'); loader.style.display='flex';

    const apiKey = '33d4ecb375mshcf029fba766af44p17668djsnaef3c36cb209';

    // Updated API endpoint structure
    fetch(`https://aerodatabox.p.rapidapi.com/flights/number/${encodeURIComponent(num)}/${encodeURIComponent(date)}`,{
      method:'GET',
      headers:{
        'X-RapidAPI-Key': apiKey,
        'X-RapidAPI-Host': 'aerodatabox.p.rapidapi.com'
      }
    })
    .then(r => {
        if (!r.ok) {
            // Try to parse error message from API if available
            return r.json().then(err => {
                let errorMsg = `×©×’×™××” ${r.status}`;
                if (err && err.message) errorMsg += `: ${err.message}`;
                else if (typeof err === 'string') errorMsg += `: ${err}`;
                return Promise.reject(errorMsg);
            }).catch(() => Promise.reject(`×©×’×™××” ${r.status} ×•×œ× × ×™×ª×Ÿ ×”×™×” ×œ× ×ª×— ××ª ×ª×’×•×‘×ª ×”×©×’×™××” ××”×©×¨×ª.`));
        }
        return r.json();
    })
    .then(data => {
        handleFlightAPIResponse(data, num);
    })
    .catch(err=>{
      document.getElementById('flightResultContent').innerHTML=`<p>×©×’×™××” ×‘×—×™×¤×•×© ×˜×™×¡×”: ${err}</p>`; flightDataTmp=null;
    })
    .finally(()=>loader.style.display='none');
  });

  function handleFlightAPIResponse(data, flightNumberInput) {
  let html = '';
  if (Array.isArray(data) && data.length > 0) {
    const ft = data[0];
    // ×©××•×ª × ××œ×™ ×ª×¢×•×¤×”
    const depAirportName = ft.departure.airport.name || ft.departure.airport.iata || '×œ× ×™×“×•×¢';
    const arrAirportName = ft.arrival.airport.name   || ft.arrival.airport.iata   || '×œ× ×™×“×•×¢';

    // ×”×–×× ×™× ×”××œ××™× (ISO) ××”Ö¾API
    const depTimeFull = ft.departure.scheduledTime?.local || '';
    const arrTimeFull = ft.arrival.scheduledTime?.local   || '';

    // ×—×ª×•×š ×¨×§ ××ª ×”×©×¢×” HH:MM
    const departTime = depTimeFull.substr(11,5);
    const arriveTime = arrTimeFull.substr(11,5);

    html = `
      <div class="flight-card">
        <p><strong>×—×‘×¨×”:</strong> ${ft.airline.name || '×œ× ×™×“×•×¢'}</p>
        <p><strong>×™×¦×™××”:</strong> ${depAirportName} â€” ${depTimeFull}</p>
        <p><strong>× ×—×™×ª×”:</strong> ${arrAirportName} â€” ${arrTimeFull}</p>
      </div>`;

    // ×©××•×¨ ×‘Ö¾flightDataTmp ×’× ××ª ×”×©×¢×•×ª ×©×¢×‘×¨×• ×—×™×ª×•×š
    flightDataTmp = {
      type:       '×˜×™×¡×”',
      number:     ft.number || flightNumberInput,
      airline:    ft.airline.name || '',
      from:       depAirportName,
      to:         arrAirportName,
      departTime: departTime,
      arriveTime: arriveTime,
      description:''
    };
  } else {
    html = '<p>×œ× × ××¦××• ×ª×•×¦××•×ª ×¢×‘×•×¨ ×˜×™×¡×” ×–×•.</p>';
    flightDataTmp = null;
  }
  document.getElementById('flightResultContent').innerHTML = html;
  document.getElementById('flightSearchResult').style.display = 'block';
}
  document.getElementById('closeSearchModal').addEventListener('click',()=>{ document.getElementById('flightSearchResult').style.display='none'; });
  document.getElementById('copyFlightData').addEventListener('click',()=>{
    if(!flightDataTmp){alert('××™×Ÿ × ×ª×•× ×™× ×œ×”×¢×ª×§×”.');return;}
    document.getElementById('flightNumber').value=flightDataTmp.number;
    document.getElementById('flightAirline').value=flightDataTmp.airline;
    document.getElementById('flightFrom').value=flightDataTmp.from;
    document.getElementById('flightTo').value=flightDataTmp.to;
    document.getElementById('flightDepart').value=flightDataTmp.departTime;
    document.getElementById('flightArrive').value=flightDataTmp.arriveTime;
    document.getElementById('flightSearchResult').style.display='none';
  });

  document.getElementById('btnSaveFlight').addEventListener('click', () => {
    let num = document.getElementById('flightNumber').value.trim(),
        date = document.getElementById('flightDate').value,
        depTime = document.getElementById('flightDepart').value,
        arrTime = document.getElementById('flightArrive').value,
        from = document.getElementById('flightFrom').value.trim(),
        to = document.getElementById('flightTo').value.trim(),
        airline = document.getElementById('flightAirline').value.trim(),
        desc = document.getElementById('flightDesc').value.trim();
    const editingFlightEventIdValue = document.getElementById('editingFlightEventId').value;

    if (!date || !depTime || !arrTime || !from || !to || !num) { alert('×× × ××œ× ××ª ×›×œ ×©×“×•×ª ×”×˜×™×¡×” ×”× ×“×¨×©×™×.'); return; }

    const flightEventData = {
        id: editingFlightEventIdValue || generateEventId(),
        type: '×˜×™×¡×”', number: num, from: from, to: to,
        departTime: depTime, arriveTime: arrTime,
        airline: airline, description: desc
    };

    addEventToScheduleData(date, flightEventData);
    renderEventRow(date, flightEventData);

    bootstrap.Modal.getInstance(document.getElementById('modalFlight')).hide();
    document.getElementById('formFlight').reset();
    document.getElementById('editingFlightEventId').value = '';
    document.getElementById('modalFlightTitle').textContent = 'âœˆï¸ ×”×•×¡×£ ×˜×™×¡×”';
});

  // --- EVENT CLICK HANDLING AND EDIT/DELETE MODAL ---
  function handleEventClick(eventId) {
    currentEditingEventId = eventId;
    const eventData = getEventFromScheduleData(eventId);
    if (!eventData) return;

    // Check-in/Check-out are not editable/deletable this way
    if (eventData.type === "×¦'×§-××™×Ÿ" || eventData.type === "×¦'×§-×××•×˜") return;

    const detailsElement = document.getElementById('eventActionDetails');
    let eventSummary = `${eventData.type} - ${eventData.start || eventData.departTime}`;
    if (eventData.type === '×˜×™×¡×”') {
        eventSummary = `×˜×™×¡×” ${eventData.number} ×${eventData.from} ×œ${eventData.to}`;
    } else if (eventData.customSubjectName) {
        eventSummary = `${eventData.customSubjectName} - ${eventData.start}`;
    }
    detailsElement.textContent = eventSummary;

    let modal = new bootstrap.Modal(document.getElementById('eventActionModal'));
    modal.show();
  }

  document.getElementById('btnDeleteEventFromActionModal').addEventListener('click', () => {
    if (!currentEditingEventId) return;
    const eventData = getEventFromScheduleData(currentEditingEventId);
    if (!eventData) return;

    if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××™×¨×•×¢ ×–×”: ${eventData.customSubjectName || eventData.type}?`)) {
        const rowElement = document.getElementById(eventData.id);
        if (rowElement) {
            const prevDivider = rowElement.previousElementSibling;
            if (prevDivider && prevDivider.classList.contains('event-divider')) prevDivider.remove();
            else {const nextDivider = rowElement.nextElementSibling; if(nextDivider && nextDivider.classList.contains('event-divider')) nextDivider.remove();}
            rowElement.remove();
        }
        removeEventFromScheduleData(eventData.date, eventData.id);

        const dayBlock = document.querySelector(`.day-block[data-date="${eventData.date}"]`);
        if (dayBlock) {
            const hasEvents = scheduleEvents[eventData.date] && scheduleEvents[eventData.date].length > 0;
            const hasLodgings = lodgings.some(l => eventData.date >= l.checkInDate && eventData.date <= l.checkOutDate);
            if (!hasEvents && !hasLodgings) {
                dayBlock.remove();
            } else {
                sortDayEvents(eventData.date);
            }
        }
    }
    bootstrap.Modal.getInstance(document.getElementById('eventActionModal')).hide();
    currentEditingEventId = null;
  });

  document.getElementById('btnEditEventFromActionModal').addEventListener('click', () => {
    if (!currentEditingEventId) return;
    const eventData = getEventFromScheduleData(currentEditingEventId);
    if (!eventData) return;

    bootstrap.Modal.getInstance(document.getElementById('eventActionModal')).hide();

    if (eventData.type === '×˜×™×¡×”') {
        document.getElementById('modalFlightTitle').textContent = 'âœï¸ ×¢×¨×•×š ×˜×™×¡×”';
        document.getElementById('editingFlightEventId').value = eventData.id;
        document.getElementById('flightDate').value = eventData.date;
        document.getElementById('flightNumber').value = eventData.number;
        document.getElementById('flightFrom').value = eventData.from;
        document.getElementById('flightTo').value = eventData.to;
        document.getElementById('flightDepart').value = eventData.departTime;
        document.getElementById('flightArrive').value = eventData.arriveTime;
        document.getElementById('flightAirline').value = eventData.airline || '';
        document.getElementById('flightDesc').value = eventData.description || '';
        new bootstrap.Modal(document.getElementById('modalFlight')).show();
    } else {
        document.getElementById('modalAddEventTitle').textContent = 'âœï¸ ×¢×¨×•×š ××™×¨×•×¢';
        document.getElementById('editingEventId').value = eventData.id;
        buildSubjectOptions(); // Ensure options are populated before setting value
        document.getElementById('eventType').value = eventData.customSubjectName || eventData.type;
        document.getElementById('eventType').dispatchEvent(new Event('change'));

        setTimeout(() => { // Ensure dynamic fields are ready
            document.getElementById('evDate').value = eventData.date;
            document.getElementById('evStart').value = eventData.start;
            document.getElementById('evEnd').value = eventData.end;
            if(document.getElementById('evDesc')) document.getElementById('evDesc').value = eventData.description || '';

            if (eventData.type === '×”×œ×™×›×”/× ×¡×™×¢×”') {
                if(document.getElementById('walkMode')) document.getElementById('walkMode').value = eventData.mode || '';
                if(document.getElementById('walkStartLoc')) document.getElementById('walkStartLoc').value = eventData.startLocation || '';
                if(document.getElementById('walkEndLoc')) document.getElementById('walkEndLoc').value = eventData.endLocation || '';
            } else if (eventData.type === '××•×›×œ') {
                if(document.getElementById('foodPlace')) document.getElementById('foodPlace').value = eventData.foodPlace || '';
                document.getElementById('foodPlace').dispatchEvent(new Event('change'));
                 setTimeout(() => {
                    if(document.getElementById('foodLocation') && document.getElementById('foodLocationGroup').style.display === 'block') {
                        document.getElementById('foodLocation').value = eventData.location || '';
                    }
                 },0);
            } else if (document.getElementById('eventLocation') && eventData.location) {
                 document.getElementById('eventLocation').value = eventData.location;
            }
        }, 50); // Increased timeout slightly for safety

        new bootstrap.Modal(document.getElementById('modalAddEvent')).show();
    }
    currentEditingEventId = null;
  });


  // --- INITIALIZATION AND DOM LISTENERS ---
  function attachAutoTimes(evDateField, evStartField, evEndField){
    evDateField.addEventListener('change',()=>{
      let date=evDateField.value;
      if(!date) return;
      let baseTime = '08:00';
        if (scheduleEvents[date] && scheduleEvents[date].length > 0) {
            const lastEvent = scheduleEvents[date][scheduleEvents[date].length - 1];
            baseTime = lastEvent.end || lastEvent.arriveTime;
        }

        let [h, m] = baseTime.split(':').map(Number);
        let s = new Date(1970,0,1,h,m); // Use a fixed date for time manipulation
        if (scheduleEvents[date] && scheduleEvents[date].length > 0) {
            s.setMinutes(s.getMinutes() + 10);
        }
        let e = new Date(s.getTime());
        e.setHours(s.getHours() + 1);

        evStartField.value = `${String(s.getHours()).padStart(2, '0')}:${String(s.getMinutes()).padStart(2, '0')}`;
        evEndField.value = `${String(e.getHours()).padStart(2, '0')}:${String(e.getMinutes()).padStart(2, '0')}`;
    });
  }

  document.addEventListener('DOMContentLoaded',()=>{
    let nameModal=new bootstrap.Modal(document.getElementById('modalScheduleName'));
    nameModal.show();
    document.getElementById('btnCreateSchedule').onclick=()=>{
      let v=document.getElementById('inputScheduleName').value.trim();
      if(!v){alert('×× × ×”×–×Ÿ ×©× ×œ×œ×•×–');return;}
      document.getElementById('displayScheduleName').textContent=`×œ×•×–: ${v}`;
      ['btnAddEvent','btnLodging','btnFlight'].forEach(id=>document.getElementById(id).removeAttribute('disabled'));
      nameModal.hide();
    };
    document.getElementById('btnDeleteLodgingDetail').addEventListener('click', deleteLodgingDetail);
    document.getElementById('btnEditLodgingDetail').addEventListener('click', editLodgingDetail);

    document.getElementById('btnAddEvent').addEventListener('click',()=>{
      document.getElementById('modalAddEventTitle').textContent = 'â• ×”×•×¡×£ ××™×¨×•×¢ ×œ×œ×•"×–';
      document.getElementById('editingEventId').value = '';
      buildSubjectOptions();
      document.getElementById('formAddEvent').reset();
      document.getElementById('dynamicFields').innerHTML='';
      document.getElementById('eventType').value = "";
    });
    document.getElementById('btnShowDeleteSubjects').addEventListener('click',()=>{ document.getElementById('customSubjectsContainer').style.display = document.getElementById('customSubjectsContainer').style.display==='none'?'block':'none';});
    document.getElementById('eventType').addEventListener('change',()=>{
        let type=document.getElementById('eventType').value, df=document.getElementById('dynamicFields');
        df.innerHTML='';
        if (!type) return;
        df.innerHTML=`
            <div class="mb-3"><label class="form-label">×ª××¨×™×š</label><input type="date" id="evDate" class="form-control" required></div>
            <div class="mb-3 row">
                <div class="col-6"><label class="form-label">×©×¢×ª ×”×ª×—×œ×”</label><input type="time" id="evStart" class="form-control" required></div>
                <div class="col-6"><label class="form-label">×©×¢×ª ×¡×™×•×</label><input type="time" id="evEnd" class="form-control" required></div>
            </div>`;
        const evDateInput = document.getElementById('evDate'), evStartInput = document.getElementById('evStart'), evEndInput = document.getElementById('evEnd');
        attachAutoTimes(evDateInput, evStartInput, evEndInput);
        evEndInput.addEventListener('change',()=>{ if(evEndInput.value && evStartInput.value && evEndInput.value<=evStartInput.value){ alert('×©×¢×ª ×”×¡×™×•× ×—×™×™×‘×ª ×œ×”×™×•×ª ××—×¨×™ ×©×¢×ª ×”×”×ª×—×œ×”.'); evEndInput.value='';}});

          if(type==='×”×©×§××”'||type==='×©×™× ×”'){
            df.innerHTML+=`<div class="mb-3"><label class="form-label">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</label><textarea id="evDesc" class="form-control" rows="2"></textarea></div>`;
          } else if(type==='×”×œ×™×›×”/× ×¡×™×¢×”'){
            df.innerHTML+=`
              <div class="mb-3"><label class="form-label">×¡×•×’ ××¡×œ×•×œ:</label>
                <select id="walkMode" class="form-select" required>
                  <option value="">-- ×‘×—×¨ --</option><option value="× ×¡×™×¢×” ×‘×¨×›×‘">ğŸš— ×¨×›×‘</option><option value="× ×¡×™×¢×” ×‘×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª">ğŸšŒ ×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª</option><option value="×”×œ×™×›×”">ğŸš¶ ×”×œ×™×›×”</option>
                </select>
              </div>
              <div class="mb-3"><label class="form-label">×××™×§×•× (××•×¤×¦×™×•× ×œ×™)</label>
                <div class="input-group"><input type="text" id="walkStartLoc" class="form-control"><button class="btn btn-outline-secondary" type="button" onclick="openMapForInput('walkStartLoc')">ğŸ—ºï¸</button></div>
              </div>
              <div class="mb-3"><label class="form-label">×œ××™×§×•×</label>
                <div class="input-group"><input type="text" id="walkEndLoc" class="form-control" required><button class="btn btn-outline-secondary" type="button" onclick="openMapForInput('walkEndLoc')">ğŸ—ºï¸</button></div>
              </div>
              <div class="mb-3"><label class="form-label">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</label><textarea id="evDesc" class="form-control" rows="2"></textarea></div>`;
          } else if(type==='××•×›×œ'){
            df.innerHTML+=`
              <div class="mb-3"><label class="form-label">××›×™×œ×” ×‘:</label>
                <select id="foodPlace" class="form-select" required>
                  <option value="">-- ×‘×—×¨ --</option><option value="ğŸ½ï¸ ××¡×¢×“×”">ğŸ½ï¸ ××¡×¢×“×”</option><option value="ğŸ” ××•×›×œ ××”×™×¨">ğŸ” ××•×›×œ ××”×™×¨</option><option value="ğŸ  ×‘×‘×™×ª/×‘×“×™×¨×”">ğŸ  ×‘×‘×™×ª/×‘×“×™×¨×”</option><option value="ğŸ¥¡ ××•×›×œ ××•×›×Ÿ">ğŸ¥¡ ××•×›×œ ××•×›×Ÿ</option>
                </select>
              </div>
              <div class="mb-3" id="foodLocationGroup" style="display:none;">
                <label class="form-label">××™×§×•×</label>
                <div class="input-group"><input type="text" id="foodLocation" class="form-control"><button class="btn btn-outline-secondary" type="button" onclick="openMapForInput('foodLocation')">ğŸ—ºï¸</button></div>
              </div>
              <div class="mb-3"><label class="form-label">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</label><textarea id="evDesc" class="form-control" rows="2"></textarea></div>`;
            document.getElementById('foodPlace').addEventListener('change', function() {
              const foodLocGroup = document.getElementById('foodLocationGroup');
              const foodLocInput = document.getElementById('foodLocation');
              if (['ğŸ½ï¸ ××¡×¢×“×”','ğŸ” ××•×›×œ ××”×™×¨'].includes(this.value)) {
                  foodLocGroup.style.display='block';
                  foodLocInput.required = true;
              } else {
                  foodLocGroup.style.display='none';
                  foodLocInput.required = false;
              }
            });
          } else { // For '×¡×™×•×¨', '××˜×¨×§×¦×™×”', and custom subjects
            df.innerHTML+=`
              <div class="mb-3"><label class="form-label">××™×§×•× ${type === '×¡×™×•×¨' || type === '××˜×¨×§×¦×™×”' ? '' : '(××•×¤×¦×™×•× ×œ×™)'}</label>
                <div class="input-group"><input type="text" id="eventLocation" class="form-control" ${type === '×¡×™×•×¨' || type === '××˜×¨×§×¦×™×”' ? 'required' : ''}><button class="btn btn-outline-secondary" type="button" onclick="openMapForInput('eventLocation')">ğŸ—ºï¸</button></div>
              </div>
              <div class="mb-3"><label class="form-label">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</label><textarea id="evDesc" class="form-control" rows="2"></textarea></div>`;
          }
    });
    document.getElementById('btnSaveEvent').addEventListener('click',addEvent);

    document.getElementById('btnFlight').addEventListener('click', () => {
        document.getElementById('modalFlightTitle').textContent = 'âœˆï¸ ×”×•×¡×£ ×˜×™×¡×”';
        document.getElementById('editingFlightEventId').value = '';
        document.getElementById('formFlight').reset();
        document.getElementById('flightSearchResult').style.display='none';
    });
    document.getElementById('btnSaveLodging').addEventListener('click',saveLodging);
  });
</script>
</body>
</html>
