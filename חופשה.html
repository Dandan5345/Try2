<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×–××Ÿ ×–×”×‘ - ×‘× ×™×™×ª ×œ×•×– ×—×•×¤×©×”</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://i.imgur.com/GaYFAp1.png" type="image/png">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script src="firebase-config.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
          .then(function(registration) {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(function(err) {
            console.log('Service Worker registration failed:', err);
          });
      });
    }
  </script>

  <style>
    /* ===== RESET ×•×›×œ×œ×™ ×‘×¡×™×¡ ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      direction: rtl;
      padding-top: 70px; /* ×›×“×™ ×œ× ×œ×”×¡×ª×ª×¨ ××ª×—×ª ×œ×”××“×¨ ×”×§×‘×•×¢ */
      padding-bottom: 40px;
      text-align: center;
      background: url("https://i.imgur.com/vPycdhd.jpeg") no-repeat center center fixed;
      background-size: cover;
      color: #333333; /* ×¦×‘×¢ ×˜×§×¡×˜ ×‘×¡×™×¡×™ */
    }

    /* ===== ×¢×™×¦×•×‘ ×”××“×™×¨ (Header) ×•×ª×¤×¨×™×˜ ×”×¦×“ (×©×™× ×•×™×™× ××™× ×™××œ×™×™× ×œ×¤×™ ×”×‘×§×©×”) ===== */
    .topbar {
      background-color: #2C3E50; /* ×¨×§×¢ ××¤×•×¨-×›×—×•×œ ×›×”×” */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      transition: transform 0.3s;
      border-bottom: 2px solid #34495E; /* ×’×‘×•×œ ×ª×—×ª×•×Ÿ ××¢×˜ ×‘×”×™×¨ ×™×•×ª×¨ */
    }
    .hamburger-menu {
      font-size: 24px;
      color: #ecf0f1; /* ×¦×‘×¢ ××™×™×§×•×Ÿ ×‘×”×™×¨ */
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 5px;
      transition: background-color 0.3s;
      z-index: 1002;
    }
    .hamburger-menu:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .site-name {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      color: #ecf0f1; /* ×¦×‘×¢ ×©× ××ª×¨ ×‘×”×™×¨ */
      cursor: pointer;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    .auth-button {
      background-color: #F1C40F; /* ×¨×§×¢ ×–×”×‘ */
      color: #333333; /* ×˜×§×¡×˜ ×›×”×” ×œ× ×™×’×•×“×™×•×ª */
      padding: 10px 15px;
      border-radius: 8px;
      transition: background-color 0.3s, box-shadow 0.3s;
      font-weight: bold;
      border: none;
      cursor: pointer;
      text-decoration: none;
    }
    .auth-button:hover {
      background-color: #f39c12; /* ×–×”×‘ ×›×”×” ×™×•×ª×¨ ×‘-hover */
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    /* ×ª×¤×¨×™×˜ ×¦×“ */
    .side-menu {
      position: fixed;
      top: 0;
      right: -280px; /* × ×©××¨ ××•×¡×ª×¨ ××™××™×Ÿ */
      width: 280px;
      height: 100%;
      background-color: #2C3E50; /* ×¨×§×¢ ××¤×•×¨-×›×—×•×œ ×›×”×” */
      z-index: 1001;
      padding-top: 80px;
      transition: right 0.3s ease;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
    }
    .side-menu.active {
      right: 0;
    }
    .close-menu {
      position: absolute;
      top: 20px;
      left: 20px; /* ×©×™× ×•×™ ×§×˜×Ÿ: ×××•×§× ×‘×¦×“ ×©×××œ ×©×œ ×”×ª×¤×¨×™×˜ */
      font-size: 24px;
      color: #ecf0f1; /* ×¦×‘×¢ ××™×™×§×•×Ÿ ×‘×”×™×¨ */
      cursor: pointer;
    }
    .side-menu-links {
      display: flex;
      flex-direction: column;
      padding: 0 20px;
    }
    .side-menu-links a {
      padding: 15px;
      color: #ecf0f1; /* ×¦×‘×¢ ×§×™×©×•×¨×™× ×‘×”×™×¨ */
      text-decoration: none;
      font-size: 18px;
      border-bottom: 1px solid rgba(236, 240, 241, 0.1); /* ×§×• ×”×¤×¨×“×” ×¢×“×™×Ÿ */
      transition: background-color 0.3s;
      text-align: right;
    }
    .side-menu-links a:last-child {
      border-bottom: none;
    }
    .side-menu-links a:hover {
      background-color: rgba(255, 255, 255, 0.05); /* ××¤×§×˜ hover ×¢×“×™×Ÿ */
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6); /* ×›×™×¡×•×™ ××¢×˜ ×›×”×” ×™×•×ª×¨ */
      z-index: 1000;
      display: none;
    }
    .overlay.active {
      display: block;
    }

    /* ===== ×¢×™×¦×•×‘ ×—×™×¤×•×© ×˜×™×¡×” (× ×©××¨ ×›××¢×˜ ×–×”×”) ===== */
    .flight-search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .flight-search-wrapper input {
      width: 100%;
      padding-left: 2.5rem; /* ×¨×™×•×•×— ××©×××œ ×¢×‘×•×¨ ×”××™×™×§×•×Ÿ */
    }
    .flight-search-wrapper .search-icon {
      position: absolute;
      left: 10px; /* ××™×§×•× ××©×××œ */
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      cursor: pointer;
      color: #7f8c8d; /* ×¦×‘×¢ ××¤×•×¨ ×œ××™×™×§×•×Ÿ */
    }

    /* ===== ×©××¨ ×”×¡×’× ×•× ×•×ª ×¢× ×”×¢×™×¦×•×‘ ×”×—×“×© ===== */
    main { padding: 20px; margin-top: 20px; min-height: 70vh; text-align: center; }
    footer {
      text-align: center;
      padding: 10px;
      color: #7f8c8d; /* ×¦×‘×¢ ×˜×§×¡×˜ ××¤×•×¨ ×¢×“×™×Ÿ */
      font-size: 14px;
      background-color: #ecf0f1; /* ×¨×§×¢ ××¤×•×¨ ×‘×”×™×¨ */
      border-top: 1px solid #bdc3c7; /* ×§×• ×”×¤×¨×“×” ×¢×“×™×Ÿ */
    }
    .schedule-item {
      position: relative;
      background-color: #FFFFFF; /* ×¨×§×¢ ×œ×‘×Ÿ ××˜×•× */
      padding: 20px; /* ×¨×™×•×•×— ×¤× ×™××™ ×’×“×•×œ ×™×•×ª×¨ */
      margin: 15px auto; /* ××¨×•×•×— ×’×“×•×œ ×™×•×ª×¨ ×‘×™×Ÿ ×¤×¨×™×˜×™× */
      border-radius: 12px; /* ×¤×™× ×•×ª ××¢×•×’×œ×•×ª */
      box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* ×¦×œ ×¢××•×§ ×™×•×ª×¨ */
      cursor: pointer;
      text-align: center;
      max-width: 450px; /* ×¨×•×—×‘ ××§×¡×™××œ×™ ××¢×˜ ×’×“×•×œ ×™×•×ª×¨ */
      transition: transform 0.2s, box-shadow 0.2s;
      overflow: hidden;
    }
    .schedule-item:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* ×¦×œ ××•×“×’×© ×‘-hover */
    }
    .schedule-item h3 {
      margin-bottom: 8px; /* ××¨×•×•×— ×’×“×•×œ ×™×•×ª×¨ ××ª×—×ª ×œ×›×•×ª×¨×ª */
      color: #2C3E50; /* ×¦×‘×¢ ×›×•×ª×¨×ª ××¤×•×¨-×›×—×•×œ */
      position: relative;
      z-index: 1;
      font-size: 1.15em; /* ×’×•×“×œ ×’×•×¤×Ÿ ××¢×˜ ×’×“×•×œ ×™×•×ª×¨ */
    }
    .schedule-item p {
      position: relative;
      z-index: 1;
      color: #333333; /* ×¦×‘×¢ ×˜×§×¡×˜ ×¨×’×™×œ */
      font-size: 0.95em;
      margin-bottom: 5px; /* ××¨×•×•×— ×§×˜×Ÿ ×‘×™×Ÿ ×¤×¡×§××•×ª */
    }
    .schedule-item p small { /* ×¢×™×¦×•×‘ ×˜×§×¡×˜ ×§×˜×Ÿ (×›××• ×‘×›×ª×•×‘×•×ª) */
        color: #7f8c8d;
        font-size: 0.9em;
    }
     .schedule-item p:last-child {
        margin-bottom: 0;
    }
    .emoji-background {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 120px; /* ×××•×’'×™ ×’×“×•×œ ×™×•×ª×¨ */
      opacity: 0.08; /* ×©×§×™×¤×•×ª × ××•×›×” ×™×•×ª×¨ */
      pointer-events: none;
      z-index: 0;
    }
    .btn {
      display: inline-block;
      padding: 12px 24px; /* ×¨×™×•×•×— ×¤× ×™××™ ×’×“×•×œ ×™×•×ª×¨ */
      background-color: #1ABC9C; /* ×¦×‘×¢ ×˜×•×¨×§×™×– ×¨××©×™ */
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 16px;
      border-radius: 8px; /* ×¤×™× ×•×ª ××¢×•×’×œ×•×ª */
      transition: background-color 0.3s, box-shadow 0.3s;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:hover {
      background-color: #16A085; /* ×˜×•×¨×§×™×– ×›×”×” ×™×•×ª×¨ */
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    /* ×¢×™×¦×•×‘ ×¡×¤×¦×™×¤×™ ×œ×›×¤×ª×•×¨ + */
    .action-buttons .btn {
        font-size: 24px; /* ×’×•×“×œ ×¤×œ×•×¡ ×’×“×•×œ */
        padding: 10px 20px; /* ×¨×™×•×•×— ××ª××™× */
        line-height: 1; /* ×™×™×©×•×¨ ×”×¤×œ×•×¡ */
    }
    /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨ × ×™×•×•×˜ ×§×˜×Ÿ ×‘×ª×•×š ×¤×¨×™×˜ */
    .nav-button {
      position: absolute;
      left: 10px; /* ××™×§×•× ××¢×•×“×›×Ÿ */
      bottom: 10px; /* ××™×§×•× ××¢×•×“×›×Ÿ */
      font-size: 12px;
      padding: 5px 10px; /* ×¨×™×•×•×— ××¢×•×“×›×Ÿ */
      background-color: #3498DB; /* ×¦×‘×¢ ×›×—×•×œ ×œ× ×™×•×•×˜ */
    }
     .nav-button:hover {
        background-color: #2980B9; /* ×›×—×•×œ ×›×”×” ×™×•×ª×¨ */
     }
    /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™ ××—×™×§×” ×•×¢×¨×™×›×” ×§×˜× ×™× */
    .item-action-icon {
        position: absolute;
        top: 10px;
        font-size: 18px;
        cursor: pointer;
        color: #7f8c8d;
        transition: color 0.2s;
        padding: 5px;
        z-index: 2;
    }
    .item-action-icon:hover {
        color: #e74c3c; /* ××“×•× ×œ××—×™×§×” ×‘-hover */
    }
    .delete-icon { right: 10px; }
    .edit-icon { right: 40px; } /* ×× × ×•×¡×™×£ ×›×¤×ª×•×¨ ×¢×¨×™×›×” */

    /* ×¢×™×¦×•×‘ ×ª×¤×¨×™×˜ ×ª×‘× ×™×•×ª (× ×©××¨ ×›××¢×˜ ×–×”×”) */
    #templateDropdown {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: #f8f9fa; /* ×¨×§×¢ ××¤×•×¨ ×‘×”×™×¨ ×××•×“ */
      border: 1px solid #dee2e6; /* ×’×‘×•×œ ××¤×•×¨ ×‘×”×™×¨ */
      border-radius: 8px;
      display: none;
      z-index: 1500;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* ×¦×œ ××•×“×’×© */
      min-width: 220px; /* ×¨×•×—×‘ ××™× ×™××œ×™ ××¢×˜ ×’×“×•×œ ×™×•×ª×¨ */
      padding: 5px;
    }
    #templateDropdown button {
      background: none;
      border: none;
      width: 100%;
      padding: 12px 15px; /* ×¨×™×•×•×— ×¤× ×™××™ ×’×“×•×œ ×™×•×ª×¨ */
      text-align: right;
      cursor: pointer;
      transition: background-color 0.2s;
      font-weight: normal;
      color: #34495E; /* ×¦×‘×¢ ×˜×§×¡×˜ ××¤×¨×¤×¨-×›×—×•×œ */
      border-radius: 6px;
      margin-bottom: 3px; /* ××¨×•×•×— ×§×˜×Ÿ ×‘×™×Ÿ ×›×¤×ª×•×¨×™× */
    }
    #templateDropdown button:first-child { /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨ "×¦×•×¨ ×ª×‘× ×™×ª ×§×‘×•×¢×”" */
      background-color: #e9ecef; /* ×¨×§×¢ ××¤×¨×¤×¨ */
      font-weight: bold;
      color: #495057; /* ×¦×‘×¢ ×˜×§×¡×˜ ××¢×˜ ×›×”×” ×™×•×ª×¨ */
      margin-bottom: 5px;
    }
    #templateDropdown button:hover {
      background-color: #dde1e6; /* ×¨×§×¢ ××¢×˜ ×›×”×” ×™×•×ª×¨ ×‘-hover */
    }

    /* --- ×¢×™×¦×•×‘ ××•×“×œ×™× (×—×œ×•× ×•×ª ×§×•×¤×¦×™×) --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6); /* ×¨×§×¢ ×©×—×•×¨ ×©×§×•×£ */
      padding-top: 5%; /* ××¨×•×•×— ××”×—×œ×§ ×”×¢×œ×™×•×Ÿ */
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto; /* ××¨×›×•×– ×× ×›×™ ×•××•×¤×§×™ ××©×•×¤×¨ */
      padding: 25px 30px; /* ×¨×™×•×•×— ×¤× ×™××™ × ×“×™×‘ */
      border-radius: 10px; /* ×¤×™× ×•×ª ××¢×•×’×œ×•×ª ×™×•×ª×¨ */
      width: 90%;
      max-width: 550px; /* ×¨×•×—×‘ ××§×¡×™××œ×™ ××¢×˜ ×’×“×•×œ ×™×•×ª×¨ */
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* ×¦×œ ×‘×•×œ×˜ */
      text-align: right; /* ×™×™×©×•×¨ ×˜×§×¡×˜ ×œ×™××™×Ÿ ×‘××•×“×œ */
    }
     /* ×¡×’× ×•×Ÿ ×¡×¤×¦×™×¤×™ ×œ××•×“×œ "××œ×’× ×˜×™" (×¢× ×›×•×ª×¨×ª ×•×›×¤×ª×•×¨×™× ××•×ª×××™×) */
    .modal-elegant {
        border-top: 5px solid #1ABC9C; /* ×¤×¡ ×˜×•×¨×§×™×– ×¢×œ×™×•×Ÿ */
    }
    .modal-elegant h2 {
      color: #2C3E50; /* ×¦×‘×¢ ×›×•×ª×¨×ª ××¤×•×¨-×›×—×•×œ */
      text-align: center; /* ××¨×›×•×– ×›×•×ª×¨×ª */
      margin-bottom: 25px; /* ××¨×•×•×— ××ª×—×ª ×œ×›×•×ª×¨×ª */
      font-size: 1.6em; /* ×’×•×“×œ ×’×•×¤×Ÿ ×’×“×•×œ ×™×•×ª×¨ */
    }
    .modal-elegant .btn { /* ×”×ª×××ª ×›×¤×ª×•×¨×™× ×‘××•×“×œ ××œ×’× ×˜×™ */
        margin-top: 10px; /* ××¨×•×•×— ××¢×œ ×”×›×¤×ª×•×¨×™× */
    }
    .close {
      color: #aaa;
      position: absolute;
      left: 15px;
      top: 10px;
      font-size: 32px; /* ××™×™×§×•×Ÿ ×¡×’×™×¨×” ×’×“×•×œ ×™×•×ª×¨ */
      font-weight: bold;
      cursor: pointer;
      line-height: 1; /* ×™×™×©×•×¨ */
    }
    .close:hover, .close:focus {
      color: #333; /* ×¦×‘×¢ ×›×”×” ×‘-hover */
      text-decoration: none;
    }

    /* --- ×¢×™×¦×•×‘ ×©×“×•×ª ×˜×•×¤×¡ --- */
    .form-group {
      margin-bottom: 20px; /* ××¨×•×•×— ×’×“×•×œ ×™×•×ª×¨ ×‘×™×Ÿ ×©×“×•×ª */
      text-align: right; /* ×™×™×©×•×¨ ×ª×•×›×Ÿ ×”×©×“×” ×œ×™××™×Ÿ */
    }
    .form-group label {
      display: block;
      margin-bottom: 8px; /* ××¨×•×•×— ××ª×—×ª ×œ×ª×•×•×™×ª */
      font-weight: bold;
      color: #555; /* ×¦×‘×¢ ××¤×¨×¤×¨ ×œ×ª×•×•×™×•×ª */
    }
     .form-group label small { /* ×¢×™×¦×•×‘ ×”×”×¡×‘×¨ ×”×§×˜×Ÿ ×œ×™×“ ×”×ª×•×•×™×ª */
        font-weight: normal;
        color: #7f8c8d;
        font-size: 0.9em;
        display: block; /* ×©×™×¨×“ ×©×•×¨×” */
        margin-top: 2px;
     }
    .form-group input[type="text"],
    .form-group input[type="time"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px; /* ×¨×™×•×•×— ×¤× ×™××™ ××—×™×“ */
      border: 1px solid #BDC3C7; /* ×’×‘×•×œ ××¤×•×¨ */
      border-radius: 6px; /* ×¤×™× ×•×ª ××¢×•×’×œ×•×ª */
      font-size: 16px;
      color: #333; /* ×¦×‘×¢ ×˜×§×¡×˜ ×§×œ×˜ */
      background-color: #fdfdfd; /* ×¨×§×¢ ×›××¢×˜ ×œ×‘×Ÿ */
      transition: border-color 0.2s, box-shadow 0.2s;
      text-align: right; /* ×™×™×©×•×¨ ×”×˜×§×¡×˜ ×‘×ª×•×š ×”×©×“×” */
    }
     /* ×©×™× ×•×™ ×¦×‘×¢ ×¨×§×¢ ×œ×©×“×•×ª ×ª××¨×™×š ×•×©×¢×” ×›×“×™ ×©×™×™×¨××• ×§×œ×™×§×‘×™×œ×™×™× */
     .form-group input[type="time"],
     .form-group input[type="date"] {
         background-color: #f8f9fa;
         cursor: pointer;
     }

    .form-group select {
        appearance: none; /* ×”×¡×ª×¨×ª ×¢×™×¦×•×‘ ×‘×¨×™×¨×ª ××—×“×œ ×©×œ ×”×“×¤×“×¤×Ÿ */
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); /* ×”×•×¡×¤×ª ×—×¥ ××•×ª×× ××™×©×™×ª */
        background-repeat: no-repeat;
        background-position: left 1rem center; /* ××™×§×•× ×”×—×¥ ×‘×¦×“ ×©×××œ */
        background-size: 0.65em auto;
        padding-left: 2.5rem; /* ×¨×™×•×•×— ×˜×§×¡×˜ ××©×××œ ×œ×—×¥ */
        cursor: pointer;
    }
    .form-group textarea {
      resize: vertical; /* ××¤×©×¨×•×ª ×©×™× ×•×™ ×’×•×“×œ ×¨×§ ×× ×›×™×ª */
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #1ABC9C; /* ×¦×‘×¢ ×’×‘×•×œ ×˜×•×¨×§×™×– ×‘××™×§×•×“ */
      box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.15); /* ×¦×œ ×¢×“×™×Ÿ ×‘××™×§×•×“ */
    }

    /* --- ×¢×™×¦×•×‘ ×¨×©×™××ª ×œ×•×–×™× ×©××•×¨×™× --- */
    .saved-schedule-item {
      background-color: #fff;
      margin: 10px auto;
      padding: 15px 20px; /* ×¨×™×•×•×— ×¤× ×™××™ */
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      text-align: right; /* ×™×™×©×•×¨ ×˜×§×¡×˜ ×œ×™××™×Ÿ */
      font-weight: bold;
      color: #2C3E50; /* ×¦×‘×¢ ×˜×§×¡×˜ */
      max-width: 400px;
      transition: background-color 0.2s, transform 0.2s;
      position: relative; /* × ×“×¨×© ×œ××™×§×•× ×”×¤×— */
      padding-left: 40px; /* ××§×•× ×œ×¤×— */
    }
    .saved-schedule-item:hover {
        background-color: #f8f9fa; /* ×¨×§×¢ ×‘×”×™×¨ ×‘-hover */
        transform: translateY(-2px); /* ××¤×§×˜ ×”×¨××” ×§×œ */
    }
    .saved-schedule-item span.delete-saved { /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨ ×”×¤×— */
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 1.1em;
      color: #e74c3c; /* ×¦×‘×¢ ××“×•× */
      opacity: 0.7;
       transition: opacity 0.2s;
    }
     .saved-schedule-item span.delete-saved:hover {
        opacity: 1;
     }

    /* --- ×§×‘×•×¦×ª ×›×¤×ª×•×¨×™× --- */
    .button-group {
      margin-top: 30px; /* ××¨×•×•×— ×’×“×•×œ ×™×•×ª×¨ ××¢×œ ×”×§×‘×•×¦×” */
      display: flex;
      justify-content: center;
      gap: 15px; /* ××¨×•×•×— ×’×“×•×œ ×™×•×ª×¨ ×‘×™×Ÿ ×›×¤×ª×•×¨×™× */
      flex-wrap: wrap;
    }
     /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨ ××©× ×™ (×œ××©×œ, ×¢×¨×™×›×”, ×¡×™×•×) */
    .button-group .btn-secondary {
        background-color: #95A5A6; /* ××¤×•×¨ */
        color: #fff;
    }
    .button-group .btn-secondary:hover {
        background-color: #7F8C8D; /* ××¤×•×¨ ×›×”×” ×™×•×ª×¨ */
    }
    /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨ ×”×¢×ª×§×” */
    .button-group .btn-copy {
        background-color: #3498DB; /* ×›×—×•×œ */
    }
    .button-group .btn-copy:hover {
        background-color: #2980B9; /* ×›×—×•×œ ×›×”×” ×™×•×ª×¨ */
    }
     /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨ ×¦×™×œ×•× ××¡×š */
    .button-group .btn-screenshot {
        background-color: #2ECC71; /* ×™×¨×•×§ */
    }
    .button-group .btn-screenshot:hover {
        background-color: #27AE60; /* ×™×¨×•×§ ×›×”×” ×™×•×ª×¨ */
    }

    /* --- Loader --- */
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(44, 62, 80, 0.85); /* ×¨×§×¢ ×›×”×” ×•×©×§×•×£ */
      color: #fff;
      display: flex;
      flex-direction: column; /* ×¡×™×“×•×¨ ×× ×›×™ */
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      z-index: 3000;
      display: none; /* ××•×¡×ª×¨ ×›×‘×¨×™×¨×ª ××—×“×œ */
    }
     /* ×× ×™××¦×™×™×ª ×˜×¢×™× ×” ×¤×©×•×˜×” */
     .loader-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px; /* ××¨×•×•×— ××ª×—×ª ×œ×¡×¤×™× ×¨ */
     }
     @keyframes spin {
        to { transform: rotate(360deg); }
     }

    /* --- ×¢×™×¦×•×‘ ×¨×¡×¤×•× ×¡×™×‘×™ --- */
    @media (max-width: 768px) {
      main#content {
        margin: 10px; /* ××¨×•×•×— ×§×˜×Ÿ ×™×•×ª×¨ ×‘× ×™×™×“ */
        padding: 15px;
      }
      .site-name { font-size: 22px; } /* ×’×•×“×œ ×˜×§×¡×˜ ××•×§×˜×Ÿ */
       .topbar { padding: 8px 15px; }
      main#content h2 { font-size: 1.8em; }
      .btn { font-size: 0.95em; padding: 10px 18px; } /* ×›×¤×ª×•×¨×™× ×§×˜× ×™× ×™×•×ª×¨ */
       .action-buttons .btn {
          font-size: 20px;
          padding: 8px 16px;
      }
      .modal-content { width: 95%; padding: 20px; margin: 10% auto; }
      .modal-elegant h2 { font-size: 1.4em; margin-bottom: 20px; }
      .schedule-item { padding: 15px; max-width: 95%; }
      .schedule-item h3 { font-size: 1.1em; }
      .form-group { margin-bottom: 15px; }
      .form-group input[type="text"],
      .form-group input[type="time"],
      .form-group input[type="date"],
      .form-group input[type="number"],
      .form-group select,
      .form-group textarea { padding: 10px; font-size: 15px; }
      .side-menu { width: 250px; right: -250px; } /* ×ª×¤×¨×™×˜ ×¦×“ ×¦×¨ ×™×•×ª×¨ */
      .side-menu-links a { font-size: 17px; padding: 12px 15px; }
    }
     /* --- ×¢×™×¦×•×‘ ×¡×¤×¦×™×¤×™ ×œ×ª×•×¦××•×ª ×—×™×¤×•×© ×˜×™×¡×” --- */
     #flightResultContent .flight-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
     }
      #flightResultContent .flight-card h2 {
         margin-bottom: 10px;
         color: #2C3E50;
         font-size: 1.3em;
      }
      #flightResultContent .flight-card p {
         margin-bottom: 5px;
         color: #333;
      }
      #flightResultContent .flight-card .time-label {
         font-weight: bold;
         color: #555;
      }
     /* ×›×¤×ª×•×¨ ×”×¢×ª×§×” ×‘××•×“×œ ×ª×•×¦××•×ª ×˜×™×¡×” */
     #flightResultModal .btn {
        background-color: #2ECC71; /* ×™×¨×•×§ */
     }
     #flightResultModal .btn:hover {
        background-color: #27AE60; /* ×™×¨×•×§ ×›×”×” ×™×•×ª×¨ */
     }

     /* --- ×¢×™×¦×•×‘ ×¤×¨×˜×™ ×¤×¨×™×˜ ×‘××•×“×œ --- */
     #itemDetailContent h3 {
        color: #2C3E50;
        margin-bottom: 15px;
     }
      #itemDetailContent p {
         margin-bottom: 8px;
         line-height: 1.7;
      }
      #itemDetailModal .button-group .btn { /* ×”×ª×××ª ×›×¤×ª×•×¨×™× ×‘××•×“×œ ×¤×¨×˜×™× */
        font-size: 0.9em;
        padding: 8px 16px;
      }
      #editItemBtn { background-color: #F39C12; } /* ×¦×”×•×‘ ×œ×¢×¨×™×›×” */
      #editItemBtn:hover { background-color: #E67E22; }
      #navigateItemBtn { background-color: #3498DB; } /* ×›×—×•×œ ×œ× ×™×•×•×˜ */
      #navigateItemBtn:hover { background-color: #2980B9; }

  </style>
</head>
<body>
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <nav class="topbar">
    <div class="hamburger-menu" onclick="toggleMenu()">
      <i class="fas fa-bars"></i>
    </div>
    <div class="site-name" onclick="goHome()">×–××Ÿ ×–×”×‘</div>
    <a href="#" id="authLink" class="auth-button">×”×ª×—×‘×¨×•×ª</a> </nav>

  <div class="side-menu" id="sideMenu">
    <div class="close-menu" onclick="toggleMenu()">
      <i class="fas fa-times"></i>
    </div>
    <div class="side-menu-links">
      <a href="choose-schedule.html"><i class="fas fa-calendar-plus fa-fw"></i> ×œ×•×´×– ×—×“×©</a>
      <a href="my-schedules.html"><i class="fas fa-folder-open fa-fw"></i> ×”×œ×•×–×™×´× ×©×œ×™</a>
      <a href="tips.html"><i class="fas fa-lightbulb fa-fw"></i> ×˜×™×¤×™× ×œ× ×™×”×•×œ ×–×× ×™×</a>
      <a href="how-to-use.html"><i class="fas fa-info-circle fa-fw"></i> ×¢×–×¨×” ×•×”×¡×‘×¨</a>
       <a href="#" id="logoutLink" style="display: none;" onclick="logoutUser(event)"><i class="fas fa-sign-out-alt fa-fw"></i> ×”×ª× ×ª×§×•×ª</a>
    </div>
  </div>

  <main id="content">
    <h2>×‘× ×™×™×ª ×œ×•×– ×—×•×¤×©×” ×—×“×©</h2>
    <p>×œ×”×•×¡×¤×ª ×—×œ×§ ×œ×œ×•×–, ×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ +</p>
    <div class="action-buttons">
      <button class="btn" onclick="openAddItemModal()">+</button>
    </div>
    <div id="scheduleContainer"></div>
    <div class="button-group">
      <button class="btn" onclick="openFinalSchedule()"><i class="fas fa-save fa-fw"></i> ×©××•×¨ ×•×¡×™×™× ×œ×•×´×–</button>
    </div>
  </main>

  <footer>Â©ï¸doronnakache - ×¢×™×¦×•×‘ ×•×©×™×¤×•×¨ ×¢×œ ×™×“×™ Gemini</footer>

  <div id="scheduleNameModal" class="modal">
    <div class="modal-content modal-elegant">
      <span class="close" onclick="closeScheduleNameModal()">Ã—</span>
      <h2>×”×–×Ÿ ×©× ×œ×œ×•×´×– ×©×œ×š</h2>
      <div class="form-group">
        <label for="scheduleNameInput">×©× ×”×œ×•×´×–:</label>
        <input type="text" id="scheduleNameInput" placeholder="×œ××©×œ: ×—×•×¤×©×” ××©×¤×—×ª×™×ª ×‘×¦×¤×•×Ÿ ğŸ–ï¸">
      </div>
      <button class="btn" onclick="saveScheduleName()"><i class="fas fa-check fa-fw"></i> ×”××©×š ×•×©××™×¨×”</button>
    </div>
  </div>

  <div id="addItemModal" class="modal">
    <div class="modal-content modal-elegant">
      <span class="close" onclick="closeAddItemModal()">Ã—</span>
      <h2 id="addItemModalTitle">×”×•×¡×¤×ª ×—×œ×§ ×œ×œ×•×´×–</h2>
      <div class="form-group">
        <label for="modalDate">×‘×—×¨ ×ª××¨×™×š:</label>
        <input type="date" id="modalDate">
      </div>
      <div class="form-group">
        <label id="startTimeLabel" for="modalStartTime">×©×¢×ª ×”×ª×—×œ×”:</label>
        <input type="time" id="modalStartTime" onchange="setDefaultEndTime()">
      </div>
      <div class="form-group">
        <label id="endTimeLabel" for="modalEndTime">×©×¢×ª ×¡×™×•×:</label>
        <input type="time" id="modalEndTime">
      </div>
      <div id="timeNote" style="font-size: 0.9rem; color: #7f8c8d; display: none; margin-bottom: 15px; text-align: center;"></div>

      <div class="form-group">
         <label for="modalSubject">× ×•×©×:</label>
         <div style="display: flex; align-items: center; gap: 10px;">
           <select id="modalSubject" onchange="subjectChangeHandler()" style="flex-grow: 1;"></select>
           <div style="position: relative; display: inline-block;">
             <button id="subjectsToggleBtn" onclick="togglePermanentSubjectsList(event)" title="× ×™×”×•×œ × ×•×©××™× ×§×‘×•×¢×™×" style="background: none; border: 1px solid #ccc; border-radius: 50%; width: 35px; height: 35px; font-size: 20px; cursor: pointer; color: #555; line-height: 30px;">â‹®</button>
             <div id="permanentSubjectsList" style="display: none; position: absolute; left: 0; top: 40px; background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 10px; z-index: 2001; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 250px;">
                <button class="btn btn-secondary" onclick="openAddSubjectModal()" style="width: 100%; margin-top: 10px; font-size: 0.9em; padding: 8px 12px;"><i class="fas fa-plus fa-fw"></i> ×”×•×¡×£ × ×•×©× ×—×“×©</button>
             </div>
           </div>
         </div>
       </div>


      <div id="extraQuestions" style="display: none; border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 15px;">
        <div class="form-group">
          <label for="fromAddress">×××™×¤×” (×›×ª×•×‘×ª ×”×ª×—×œ×”): <small>×”×–×Ÿ ××ª ×”×›×ª×•×‘×ª ××• ×”××§×•× ×©××× ×• ×™×•×¦××™×</small></label>
          <input type="text" id="fromAddress" placeholder="×œ×“×•×’××”: ×¨×—×•×‘ ×”×™×¨×§×•×Ÿ 1, ×ª×œ ××‘×™×‘">
        </div>
        <div class="form-group">
          <label for="toAddress">×•×œ××Ÿ (×›×ª×•×‘×ª ×™×¢×“): <small>×œ×“×•×’××”: ×§× ×™×•×Ÿ ×¨××ª ××‘×™×‘, ×ª×œ ××‘×™×‘</small></label>
          <input type="text" id="toAddress" placeholder="×œ×“×•×’××”: ×©×•×§ ××—× ×” ×™×”×•×“×”, ×™×¨×•×©×œ×™×">
        </div>
        <div class="form-group" id="travelModeGroup" style="display: none;">
          <label for="travelModeSelect">××™×š × ×•×¡×¢×™×?</label>
          <select id="travelModeSelect">
            <option value="car">×¨×›×‘ ×¤×¨×˜×™ ğŸš™</option>
            <option value="transit">×ª×—×‘×´×¦ ğŸš‹ğŸš†</option>
            <option value="taxi">××•× ×™×ª ğŸš–</option>
            <option value="walk">×”×œ×™×›×” (××¦×‘ × ×¡×™×¢×”)</option> </select>
        </div>
        <button class="btn btn-secondary" id="checkRouteBtn" onclick="checkRoute()" style="font-size: 0.9em; padding: 8px 15px;"><i class="fab fa-google fa-fw"></i> ×‘×“×•×§ ××¡×œ×•×œ ×‘×’×•×’×œ ××¤×•×ª</button>
      </div>

      <div id="locationField" style="display:none; border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 15px;" class="form-group">
        <label for="locationInput">××™×§×•×: <small>×”×–×Ÿ ××ª ×©× ×”××§×•× ××• ×”×›×ª×•×‘×ª</small></label>
        <input type="text" id="locationInput" placeholder="×œ×“×•×’××”: ××•×–×™××•×Ÿ ×™×©×¨××œ, ×™×¨×•×©×œ×™× / ×—×•×£ ×¤×œ××—×™×">
        <button class="btn btn-secondary" onclick="showLocationRoute()" style="font-size: 0.9em; padding: 8px 15px; margin-top: 10px;"><i class="fab fa-google fa-fw"></i> ×”×¦×’ ××¡×œ×•×œ ×‘×’×•×’×œ ××¤×•×ª</button>
      </div>

      <div id="foodExtraOptions" style="display:none; border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 15px;">
        <div class="form-group">
          <label for="foodTypeSelect">×‘×—×¨ ×¡×•×’ ××•×›×œ:</label>
          <select id="foodTypeSelect" onchange="foodTypeChangeHandler()">
            <option value="">-- ×‘×—×¨ --</option>
            <option value="××¡×¢×“×”">××¡×¢×“×” ğŸ‘¨â€ğŸ³</option>
            <option value="×‘×™×ª ×§×¤×”">×‘×™×ª ×§×¤×” â˜•</option>
            <option value="×‘××œ×•×Ÿ/×‘××§×•× ×”×œ×™× ×”">×‘××œ×•×Ÿ/×‘××§×•× ×”×œ×™× ×” ğŸ¨</option>
            <option value="×¤×™×§× ×™×§/×”×›× ×” ×¢×¦××™×ª">×¤×™×§× ×™×§/×”×›× ×” ×¢×¦××™×ª ğŸ§º</option>
            <option value="×§× ×™×™×” ×‘×¡×•×¤×¨/××›×•×œ×ª">×§× ×™×™×” ×‘×¡×•×¤×¨/××›×•×œ×ª ğŸ›’</option>
            <option value="××•×›×œ ××”×™×¨/×“×•×›×Ÿ">××•×›×œ ××”×™×¨/×“×•×›×Ÿ ğŸ¥™</option>
          </select>
        </div>
        <div id="foodLocationDiv" class="form-group" style="display:none;">
          <label for="foodLocationInput">××™×§×•× (×× ×¨×œ×•×•× ×˜×™):</label>
          <input type="text" id="foodLocationInput" placeholder="×”×–×Ÿ ××ª ×©× ×”××¡×¢×“×” / ×›×ª×•×‘×ª">
          <button class="btn btn-secondary" onclick="showFoodRoute()" style="font-size: 0.9em; padding: 8px 15px; margin-top: 10px;"><i class="fab fa-google fa-fw"></i> ×”×¦×’ ××¡×œ×•×œ ×‘×’×•×’×œ ××¤×•×ª</button>
        </div>
      </div>

      <div id="flightExtraOptions" style="display:none; border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 15px;">
        <div class="form-group flight-search-wrapper">
           <label for="flightNumberInput">××¡×¤×¨ ×˜×™×¡×” (××•×¤×¦×™×•× ×œ×™):</label>
           <div style="display: flex; align-items: center;">
              <input type="text" id="flightNumberInput" placeholder="×œ××©×œ: LY2523" style="flex-grow: 1; margin-left: 0; margin-right: 10px; padding-left: 10px;">
              <span class="search-icon" onclick="searchFlight()" title="×—×¤×© ×¤×¨×˜×™ ×˜×™×¡×”" style="position: static; transform: none; font-size: 1.5em; color: #1ABC9C;">ğŸ”</span>
           </div>
        </div>
        <div class="form-group">
          <label for="airlineInput">×—×‘×¨×ª ×ª×¢×•×¤×”:</label>
          <input type="text" id="airlineInput" placeholder="×œ×“×•×’××”: ××œ ×¢×œ">
        </div>
        <div class="form-group">
          <label for="departureAirportInput">××©×“×” ×ª×¢×•×¤×”:</label>
          <input type="text" id="departureAirportInput" placeholder="×œ×“×•×’××”: × ×ª×‘×´×’ (TLV)">
        </div>
        <div class="form-group">
          <label for="arrivalAirportInput">×œ×©×“×” ×ª×¢×•×¤×”:</label>
          <input type="text" id="arrivalAirportInput" placeholder="×œ×“×•×’××”: ×©××¨×œ ×“×” ×’×•×œ (CDG)">
        </div>
      </div>

      <div class="form-group" id="descriptionGroup" style="display: none;">
        <label for="modalDescription">×ª×™××•×¨ × ×•×¡×£ / ×”×¢×¨×•×ª:</label>
        <textarea id="modalDescription" rows="3" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ ×”×¤×¢×™×œ×•×ª, ××§×•×, ×¦×™×•×“ × ×“×¨×©, ×× ×©×™ ×§×©×¨ ×•×›×•'"></textarea>
      </div>

      <button class="btn" id="addItemBtn" onclick="saveItem()" style="display: none; width: 100%;"><i class="fas fa-check fa-fw"></i> ×”×•×¡×£ / ×©××•×¨ ×©×™× ×•×™×™×</button>
    </div>
  </div>

  <div id="flightResultModal" class="modal">
    <div class="modal-content modal-elegant">
      <span class="close" onclick="closeFlightResultModal()">Ã—</span>
      <h2>×ª×•×¦××•×ª ×—×™×¤×•×© ×˜×™×¡×”</h2>
      <div id="flightResultContent">
        </div>
      <button class="btn" onclick="copyFlightToForm()" id="copyFlightBtn" style="display: none;"><i class="fas fa-copy fa-fw"></i> ×”×¢×ª×§ ×¤×¨×˜×™× ×œ×˜×•×¤×¡</button>
    </div>
  </div>

  <div id="finalScheduleModal" class="modal">
    <div class="modal-content" id="finalScheduleContent">
      <span class="close" onclick="closeFinalScheduleModal()">Ã—</span>
      <h2 id="finalScheduleTitle" style="text-align: center; color: #2C3E50;"></h2>
      <div id="finalScheduleDisplay" style="margin-top: 20px; max-height: 60vh; overflow-y: auto; padding: 0 10px;">
          </div>
      <div class="button-group">
        <button class="btn btn-screenshot" onclick="captureScreenshotFromElement('finalScheduleDisplay', scheduleName)"><i class="fas fa-camera fa-fw"></i> ×¦×™×œ×•× ××¡×š</button>
        <button class="btn btn-copy" onclick="copyScheduleToClipboard()"><i class="fas fa-copy fa-fw"></i> ×”×¢×ª×§ ×›×˜×§×¡×˜</button>
        <button class="btn btn-secondary" onclick="closeFinalScheduleModal()"><i class="fas fa-times fa-fw"></i> ×¡×’×•×¨</button>
      </div>
    </div>
  </div>

  <div id="addSubjectModal" class="modal">
    <div class="modal-content modal-elegant">
      <span class="close" onclick="closeAddSubjectModal()">Ã—</span>
      <h2>×”×•×¡×¤×ª × ×•×©× ×—×“×©</h2>
      <div class="form-group">
        <label for="newSubjectNameInput">×©× ×”× ×•×©× (××•××œ×¥ ×œ×”×•×¡×™×£ ×××•×’'×™ ×¨×œ×•×•× ×˜×™):</label>
        <input type="text" id="newSubjectNameInput" placeholder="×œ××©×œ: ×¡×™×•×¨ ×™×§×‘×™× ğŸ‡">
      </div>
      <div class="form-group" style="text-align: center;">
        <p style="margin-bottom: 15px; font-size: 0.9em; color: #555;">×”×× ×œ×”×•×¡×™×£ ××ª ×”× ×•×©× ×¨×§ ×œ×œ×•"×– ×”× ×•×›×—×™ ××• ×œ×©××•×¨ ××•×ª×• ×œ×©×™××•×© ×§×‘×•×¢ ×‘×›×œ ×”×œ×•"×–×™×?</p>
        <button class="btn" onclick="addSubjectOneTime()"><i class="fas fa-plus fa-fw"></i> ×”×•×¡×¤×” ×—×“ ×¤×¢××™×ª</button>
        <button class="btn btn-secondary" onclick="addSubjectPermanent()" style="margin-right: 10px;"><i class="fas fa-save fa-fw"></i> ×”×•×¡×¤×” ×§×‘×•×¢×”</button>
      </div>
    </div>
  </div>

  <div id="itemDetailModal" class="modal">
    <div class="modal-content modal-elegant">
       <span class="close" onclick="closeItemDetailModal()">Ã—</span>
       <div id="itemDetailContent" style="text-align: right; margin-bottom: 20px;">
          </div>
       <div class="button-group">
          <button class="btn" id="editItemBtn" onclick="editScheduleItemFromDetail()"><i class="fas fa-edit fa-fw"></i> ×¢×¨×•×š ×¤×¨×™×˜</button>
          <button class="btn" id="navigateItemBtn" style="display: none;" onclick="navigateItemFromDetail()"><i class="fas fa-directions fa-fw"></i> × ×•×•×˜</button>
          <button class="btn btn-secondary" onclick="closeItemDetailModal()"><i class="fas fa-times fa-fw"></i> ×¡×’×•×¨</button>
       </div>
    </div>
  </div>


  <div class="loader-overlay" id="loader">
      <div class="loader-spinner"></div>
      <span id="loaderText">××—×¤×© ×¤×¨×˜×™ ×˜×™×¡×”... âœˆï¸</span>
  </div>

  <script>
    // ×”×’×“×¨×ª subjectEmojis (×›×•×œ×œ ×”×—×“×©×™×)
    const subjectEmojis = {
      "×”×œ×™×›×”": "ğŸš¶",
      "× ×¡×™×¢×”": "ğŸš—", // ×›×•×œ×œ ×’× ğŸš™, ğŸš‹, ğŸš†, ğŸš– ×‘×”×ª×× ×œ-travelMode
      "×‘×™×§×•×¨/×¡×™×•×¨": "ğŸ›ï¸",
      "×˜×™×¡×”": "âœˆï¸",
      "××•×›×œ": "ğŸ½ï¸", // ×›×•×œ×œ ×’× â˜•, ğŸ§º, ğŸ›’, ğŸ¥™
      "×©×™× ×”": "ğŸ˜´",
      "×œ×§×•×": "â°",
      "×™×": "ğŸ–ï¸",
      "×§× ×™×•×ª": "ğŸ›ï¸",
      "×‘×™×œ×•×™ ×œ×™×œ×™": "ğŸŒƒ",
      "×¡×¤×•×¨×˜/×›×•×©×¨": "ğŸ‹ï¸",
      "×× ×•×—×”/×–××Ÿ ×—×•×¤×©×™": "ğŸ§˜",
      "×¤×’×™×©×”": "ğŸ¤",
      "××—×¨": "â“" // × ×•×©× ×‘×¨×™×¨×ª ××—×“×œ
    };

    let scheduleItems = [];
    let scheduleName = null;
    let savedSchedules = []; // ×™×™×˜×¢×Ÿ ×-Firestore
    let editingIndex = -1; // ××™× ×“×§×¡ ×”×¤×¨×™×˜ ×”× ×¢×¨×š ×›×¨×’×¢ (-1 ×× ××•×¡×™×¤×™× ×—×“×©)
    let permanentSubjects = JSON.parse(localStorage.getItem('permanentSubjects')) || []; // × ×•×©××™× ×§×‘×•×¢×™× ××”××—×¡×•×Ÿ ×”××§×•××™
    let customSubjects = []; // × ×•×©××™× ×—×“-×¤×¢××™×™× ×œ×œ×•"×– ×”× ×•×›×—×™
    let currentFlightData = null; // ×œ××—×¡×•×Ÿ × ×ª×•× ×™ ×˜×™×¡×” ××”×—×™×¤×•×© ×”××—×¨×•×Ÿ

    // ××ª×—×•×œ Firebase (×•×“× ×©-firebase-config.js ×§×™×™× ×•××›×™×œ ××ª ×”×”×’×“×¨×•×ª ×©×œ×š)
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    firebase.analytics();

    // ----- × ×™×”×•×œ ××©×ª××© ×•×”×ª×—×‘×¨×•×ª -----
    auth.onAuthStateChanged((user) => {
        const authLink = document.getElementById("authLink");
        const logoutLink = document.getElementById("logoutLink");
        if (user) {
            console.log("User logged in:", user.uid);
            updateUserGreeting(user);
            loadUserData(user.uid); // ×˜×¢×™× ×ª × ×ª×•× ×™× ××—×¨×™ ×”×ª×—×‘×¨×•×ª
            authLink.style.display = 'none'; // ×”×¡×ª×¨ ×›×¤×ª×•×¨ ×”×ª×—×‘×¨×•×ª
            logoutLink.style.display = 'block'; // ×”×¦×’ ×§×™×©×•×¨ ×”×ª× ×ª×§×•×ª
        } else {
            console.log("User logged out");
            authLink.innerText = "×”×ª×—×‘×¨×•×ª";
            authLink.style.display = 'block'; // ×”×¦×’ ×›×¤×ª×•×¨ ×”×ª×—×‘×¨×•×ª
            logoutLink.style.display = 'none'; // ×”×¡×ª×¨ ×§×™×©×•×¨ ×”×ª× ×ª×§×•×ª
            authLink.onclick = login; // ×©×™×•×š ×¤×•× ×§×¦×™×™×ª ×”×ª×—×‘×¨×•×ª
            savedSchedules = []; // ××™×¤×•×¡ ×œ×•×–×™× ×©××•×¨×™×
            permanentSubjects = []; // ××™×¤×•×¡ × ×•×©××™× ×§×‘×•×¢×™× (××• ×˜×¢×™× ×” ×-localStorage ×× ×¨×•×¦×™× ×œ×©××•×¨ ××•×ª× ×’× ×œ×œ× ×”×ª×—×‘×¨×•×ª)
            renderScheduleItems(); // ×¨×¢× ×•×Ÿ ×ª×¦×•×’×” ×× × ×“×¨×©
            updateSubjectDropdownOptions();
        }
    });

    function login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then((result) => {
                console.log("Login successful:", result.user.displayName);
                // onAuthStateChanged ×™×˜×¤×œ ×‘×¢×“×›×•×Ÿ ×”×××©×§ ×•×˜×¢×™× ×ª ×”× ×ª×•× ×™×
            })
            .catch((error) => {
                console.error("Login failed:", error);
                alert("×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: " + error.message);
            });
    }

     function logoutUser(event) {
         event.preventDefault();
         if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?")) {
             auth.signOut().then(() => {
                 // onAuthStateChanged ×™×˜×¤×œ ×‘×¢×“×›×•×Ÿ ×”×××©×§
                 scheduleItems = []; // ××™×¤×•×¡ ×œ×•"×– × ×•×›×—×™
                 scheduleName = null;
                 goHome(); // ×—×–×¨×” ×œ×¢××•×“ ×”×¨××©×™ ××• ×œ×¢××•×“ ×”× ×—×™×ª×”
             }).catch((error) => {
                 console.error("Logout failed:", error);
                 alert("×©×’×™××” ×‘×”×ª× ×ª×§×•×ª: " + error.message);
             });
         }
     }


    function updateUserGreeting(user) {
        const sideMenuLinks = document.querySelector('.side-menu-links');
        let greetingElement = document.getElementById('userGreeting');
        if (!greetingElement) {
            greetingElement = document.createElement('div');
            greetingElement.id = 'userGreeting';
            greetingElement.style.color = '#ecf0f1';
            greetingElement.style.padding = '15px 20px';
            greetingElement.style.textAlign = 'center';
            greetingElement.style.borderBottom = '1px solid rgba(236, 240, 241, 0.1)';
            sideMenuLinks.insertBefore(greetingElement, sideMenuLinks.firstChild);
        }

        let currentHour = new Date().getHours();
        let greeting = "×‘×¨×•×š ×”×‘×, ";
        if (currentHour < 12) { greeting = "×‘×•×§×¨ ×˜×•×‘, "; }
        else if (currentHour < 18) { greeting = "×¦×”×¨×™×™× ×˜×•×‘×™×, "; }
        else { greeting = "×¢×¨×‘ ×˜×•×‘, "; }

        let firstName = user.displayName ? user.displayName.split(" ")[0] : user.email.split("@")[0];
        // × ×™×§×•×™ ×©× ×¤×¨×˜×™ ×× ×”×•× ××›×™×œ ×ª×•×•×™× ×œ× ×¨×¦×•×™×™×
        firstName = firstName.replace(/[^×-×ªA-Za-z]/g, '');

        greetingElement.innerHTML = `<i class="fas fa-user-circle fa-fw"></i> ${greeting}${firstName}!`;
    }


    // ----- ×˜×¢×™× ×ª ×•×©××™×¨×ª × ×ª×•× ×™× (Firestore & LocalStorage) -----

    function loadUserData(userId) {
        const docRef = db.collection("userData").doc(userId);
        docRef.get().then((doc) => {
            if (doc.exists) {
                const data = doc.data();
                savedSchedules = data.schedules || [];
                permanentSubjects = data.permanentSubjects || JSON.parse(localStorage.getItem('permanentSubjects')) || []; // ×¢×“×™×¤×•×ª ×œ-Firestore
                console.log("User data loaded from Firestore.");
            } else {
                // ×× ××™×Ÿ × ×ª×•× ×™× ×‘-Firestore, × ×¡×” ×œ×˜×¢×•×Ÿ ×-LocalStorage (×œ××§×¨×” ×©×œ ×©×™××•×© ×§×•×“× ×œ×œ× ×”×ª×—×‘×¨×•×ª)
                permanentSubjects = JSON.parse(localStorage.getItem('permanentSubjects')) || [];
                console.log("No Firestore data found, loaded permanent subjects from LocalStorage.");
                // × ×™×ª×Ÿ ×œ×©×§×•×œ ×œ×™×¦×•×¨ ××¡××š ×¨××©×•× ×™ ×œ××©×ª××© ×—×“×© ×›××Ÿ
            }
            // ×¢×“×›×•×Ÿ ×××©×§ ××—×¨×™ ×˜×¢×™× ×ª × ×ª×•× ×™×
             if (document.getElementById("content").querySelector('h2').innerText.includes("×”×œ×•×–×™× ×©×œ×™")) {
                 displayMySchedules(); // ×¨×¢× ×Ÿ ××ª ×ª×¦×•×’×ª "×”×œ×•×–×™× ×©×œ×™" ×× × ××¦××™× ×‘×”
             }
             updateSubjectDropdownOptions();
        }).catch((error) => {
            console.error("Error loading user data: ", error);
            // ×˜×¢×™× ×” ×-LocalStorage ×›×’×™×‘×•×™
            permanentSubjects = JSON.parse(localStorage.getItem('permanentSubjects')) || [];
             updateSubjectDropdownOptions();
        });
    }

    function saveUserData() {
        const user = auth.currentUser;
        if (user) {
            const userId = user.uid;
            const dataToSave = {
                schedules: savedSchedules,
                permanentSubjects: permanentSubjects
            };
            db.collection("userData").doc(userId).set(dataToSave, { merge: true })
                .then(() => {
                    console.log("User data saved successfully to Firestore.");
                })
                .catch((error) => {
                    console.error("Error saving user data to Firestore: ", error);
                });
        } else {
            // ×©××™×¨×” ×œ-LocalStorage ×× ×”××©×ª××© ×œ× ××—×•×‘×¨ (×¨×§ ×œ× ×•×©××™× ×§×‘×•×¢×™×)
            localStorage.setItem('permanentSubjects', JSON.stringify(permanentSubjects));
            console.log("User not logged in, saved permanent subjects to LocalStorage.");
            // ××–×”×¨×”: ×œ×•"×–×™× ×œ× ×™×™×©××¨×• ×œ×œ× ×”×ª×—×‘×¨×•×ª.
        }
    }

    // ----- × ×™×•×•×˜ ×•×¤×¢×•×œ×•×ª ×‘×¡×™×¡×™×•×ª -----

    function goHome() { window.location.href = "index.html"; }

    function toggleMenu() {
      const sideMenu = document.getElementById("sideMenu");
      const overlay = document.getElementById("overlay");
      sideMenu.classList.toggle("active");
      overlay.classList.toggle("active");
    }

    // ----- ×¤×ª×™×—×” ×•×¡×’×™×¨×” ×©×œ ××•×“×œ×™× -----

    function openAddItemModal() {
      if (!scheduleName && scheduleItems.length === 0) { // ×¨×§ ×× ××ª×—×™×œ×™× ×œ×•×– ×—×“×© ×œ×’××¨×™
        document.getElementById("scheduleNameModal").style.display = "block";
        document.getElementById("scheduleNameInput").focus();
      } else {
        editingIndex = -1; // ×•×“× ×©××¦×‘ ×¢×¨×™×›×” ×›×‘×•×™
        document.getElementById("addItemModalTitle").innerText = "×”×•×¡×¤×ª ×—×œ×§ ×—×“×© ×œ×œ×•×´×–";
        document.getElementById("addItemBtn").innerHTML = '<i class="fas fa-plus fa-fw"></i> ×”×•×¡×£ ×œ×œ×•"×–';
        resetAddItemModal(); // ××™×¤×•×¡ ×›×œ ×”×©×“×•×ª

        // ×§×‘×¢ ×ª××¨×™×š ×‘×¨×™×¨×ª ××—×“×œ ×œ×”×™×•× ××• ×œ×ª××¨×™×š ×”××—×¨×•×Ÿ ×‘×œ×•"×–
         const defaultDate = scheduleItems.length > 0 ? scheduleItems[scheduleItems.length - 1].date : new Date().toISOString().split('T')[0];
         document.getElementById("modalDate").value = defaultDate;


        // ×§×‘×¢ ×©×¢×ª ×”×ª×—×œ×” ×‘×¨×™×¨×ª ××—×“×œ (×“×§×” ××—×¨×™ ×”×¤×¨×™×˜ ×”××—×¨×•×Ÿ ×‘××•×ª×• ×ª××¨×™×š, ××• 09:00)
        const itemsOnDate = scheduleItems.filter(item => item.date === defaultDate);
        if (itemsOnDate.length > 0) {
            let lastItem = itemsOnDate[itemsOnDate.length - 1];
            let nextStart = addMinutesToTime(lastItem.endTime, 1); // ×“×§×” ××—×¨×™ ×”×¡×™×•×
            document.getElementById("modalStartTime").value = nextStart;
        } else {
            document.getElementById("modalStartTime").value = "09:00"; // ×‘×¨×™×¨×ª ××—×“×œ ×œ×©×¢×” 9 ×‘×‘×•×§×¨
        }
        setDefaultEndTime(); // ×—×©×‘ ×©×¢×ª ×¡×™×•× ×‘×¨×™×¨×ª ××—×“×œ

        updateSubjectDropdownOptions(); // ×¢×“×›×Ÿ ×¨×©×™××ª × ×•×©××™×
        subjectChangeHandler(); // ×¢×“×›×Ÿ ×©×“×•×ª ×œ×¤×™ ×”× ×•×©× (×©×™×”×™×” ×¨×™×§ ×‘×”×ª×—×œ×”)
        document.getElementById("addItemModal").style.display = "block";
         // ×”×¡×ª×¨ ×©×“×•×ª × ×•×¡×¤×™× ×•×©×“×” ×ª×™××•×¨ ×¢×“ ×œ×‘×—×™×¨×ª × ×•×©×
         document.getElementById("extraQuestions").style.display = "none";
         document.getElementById("locationField").style.display = "none";
         document.getElementById("foodExtraOptions").style.display = "none";
         document.getElementById("flightExtraOptions").style.display = "none";
         document.getElementById("descriptionGroup").style.display = "none";
         document.getElementById("addItemBtn").style.display = "none"; // ×”×¡×ª×¨ ×›×¤×ª×•×¨ ×©××™×¨×” ×¢×“ ×œ×‘×—×™×¨×ª × ×•×©×
      }
    }
    window.openAddItemModal = openAddItemModal; // ×—×©×™×¤×ª ×”×¤×•× ×§×¦×™×” ×œ-HTML

     function resetAddItemModal() {
        document.getElementById("modalDate").value = "";
        document.getElementById("modalStartTime").value = "";
        document.getElementById("modalEndTime").value = "";
        document.getElementById("modalSubject").value = ""; // ××™×¤×•×¡ ×‘×—×™×¨×ª × ×•×©×
        document.getElementById("modalDescription").value = "";

        // ××™×¤×•×¡ ×©×“×•×ª ×¡×¤×¦×™×¤×™×™×
        document.getElementById("fromAddress").value = "";
        document.getElementById("toAddress").value = "";
        document.getElementById("travelModeSelect").value = "car";
        document.getElementById("locationInput").value = "";
        document.getElementById("foodTypeSelect").value = "";
        document.getElementById("foodLocationInput").value = "";
        document.getElementById("flightNumberInput").value = "";
        document.getElementById("airlineInput").value = "";
        document.getElementById("departureAirportInput").value = "";
        document.getElementById("arrivalAirportInput").value = "";

        // ×”×¡×ª×¨×ª ×›×œ ×”×©×“×•×ª ×”× ×•×¡×¤×™×
         document.getElementById("extraQuestions").style.display = "none";
         document.getElementById("locationField").style.display = "none";
         document.getElementById("foodExtraOptions").style.display = "none";
         document.getElementById("flightExtraOptions").style.display = "none";
         document.getElementById("foodLocationDiv").style.display = "none"; // ×¡×¤×¦×™×¤×™ ×œ××•×›×œ
         document.getElementById("descriptionGroup").style.display = "none";
         document.getElementById("addItemBtn").style.display = "none"; // ×”×¡×ª×¨ ×’× ××ª ×›×¤×ª×•×¨ ×”×©××™×¨×”
    }


    function closeAddItemModal() {
      document.getElementById("addItemModal").style.display = "none";
      document.getElementById("permanentSubjectsList").style.display = "none"; // ×¡×’×•×¨ ×’× ××ª ×¨×©×™××ª ×”× ×•×©××™× ×× ×¤×ª×•×—×”
    }

    function openScheduleNameModal() {
        document.getElementById("scheduleNameModal").style.display = "block";
        document.getElementById("scheduleNameInput").focus();
    }

    function closeScheduleNameModal() {
        document.getElementById("scheduleNameModal").style.display = "none";
    }

     function openFinalSchedule() {
        if (!scheduleName) {
            alert("×× × ×”×–×Ÿ ×©× ×œ×œ×•×´×–.");
            openScheduleNameModal(); // ×¤×ª×— ××•×“×œ ×©× ×× ××™×Ÿ
            return;
        }
        if (scheduleItems.length === 0) {
            alert("×”×œ×•×´×– ×¨×™×§! ×¢×œ×™×š ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×—×œ×§ ××—×“.");
            return;
        }

        // ×©××™×¨×ª ×”×œ×•"×– ×”× ×•×›×—×™ ×œ×¨×©×™××ª ×”×œ×•"×–×™× ×”×©××•×¨×™×
        const existingScheduleIndex = savedSchedules.findIndex(sch => sch.id === scheduleName); // ×”× ×—×” ×©×œ×›×œ ×œ×•×– ×™×© ID ×™×™×—×•×“×™ ×©×”×•× ×©××•
         const newSchedule = {
             id: scheduleName, // ×©×™××•×© ×‘×©× ×›-ID ×–×× ×™ ××• ×§×‘×•×¢
             name: scheduleName.replace("", ""), // × ×§×” ××ª ×”×ª×’×™×ª ××”×©× ×œ×ª×¦×•×’×”
             scheduleItems: JSON.parse(JSON.stringify(scheduleItems)) // ×”×¢×ª×§ ×¢××•×§
         };

        if (existingScheduleIndex > -1) {
            // ×× ×”×œ×•"×– ×§×™×™×, ×¢×“×›×Ÿ ××•×ª×• (×œ××§×¨×” ×©×¢×¨×›× ×• ×œ×•"×– ×§×™×™×)
             if (confirm(`×œ×•"×– ×‘×©× "${newSchedule.name}" ×›×‘×¨ ×§×™×™×. ×”×× ×œ×¢×“×›×Ÿ ××•×ª×•?`)) {
                 savedSchedules[existingScheduleIndex] = newSchedule;
             } else {
                 return; // ×”××©×ª××© ×‘×—×¨ ×œ× ×œ×¢×“×›×Ÿ
             }
        } else {
            // ×× ×”×œ×•"×– ×—×“×©, ×”×•×¡×£ ××•×ª×•
             savedSchedules.push(newSchedule);
        }

        saveUserData(); // ×©××•×¨ ××ª ×›×œ ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×

        // ×”×¦×’×ª ×”×œ×•"×– ×‘××•×“×œ ×”×¡×•×¤×™
        displayScheduleInModal(scheduleItems, scheduleName.replace("", ""));
    }

     function displayScheduleInModal(itemsToDisplay, title) {
         let finalHtml = "";
         const groups = groupItemsByDate(itemsToDisplay);
         const sortedDates = Object.keys(groups).sort((a, b) => new Date(a) - new Date(b)); // ××™×•×Ÿ ×ª××¨×™×›×™× ×›×¨×•× ×•×œ×•×’×™

         sortedDates.forEach(date => {
             finalHtml += `<h3 style="text-align: center; margin: 15px 0 10px; color: #16A085;">${formatDateHeader(date)}</h3>`;
             // ××™×•×Ÿ ×”×¤×¨×™×˜×™× ×œ×¤×™ ×©×¢×ª ×”×ª×—×œ×”
             const sortedItems = groups[date].sort((a, b) => a.startTime.localeCompare(b.startTime));

             sortedItems.forEach(item => {
                let displaySubject = getDisplaySubject(item);
                let bgEmoji = getBackgroundEmoji(item);
                let extraLine = getExtraLine(item);
                let addressLine = getAddressLine(item);

                 // ×©×™××•×© ×‘××•×ª×• ×¢×™×¦×•×‘ ×›××• schedule-item ××‘×œ ×œ×œ× ××™× ×˜×¨××§×¦×™×•×ª ×¢×¨×™×›×”/××—×™×§×”
                finalHtml += `<div class="schedule-item" data-date="${item.date}" data-subject="${item.subject}" style="cursor: default; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px;">
                                  <div class="emoji-background">${bgEmoji}</div>
                                  <h3>${item.startTime} - ${item.endTime} : ${displaySubject}</h3>
                                  ${extraLine}
                                  ${addressLine}
                                  ${item.description ? `<p style="font-size: 0.9em; color: #555;">${item.description.replace(/\n/g, '<br>')}</p>` : ''}
                                </div>`;
             });
         });

         document.getElementById("finalScheduleTitle").innerText = title;
         document.getElementById("finalScheduleDisplay").innerHTML = finalHtml;
         document.getElementById("finalScheduleModal").style.display = "block";
     }

    function closeFinalScheduleModal() {
        document.getElementById("finalScheduleModal").style.display = "none";
        // ××•×¤×¦×™×•× ×œ×™: ××™×¤×•×¡ ××• × ×™×•×•×˜ ×œ×¢××•×“ ××—×¨ ××—×¨×™ ×©××™×¨×” ×•×¡×™×•×
        // scheduleItems = [];
        // scheduleName = null;
        // document.getElementById("scheduleContainer").innerHTML = "";
        // document.querySelector('#content h2').innerText = "×‘× ×™×™×ª ×œ×•×– ×—×•×¤×©×” ×—×“×©";
        // goHome();
    }

    function openAddSubjectModal() {
      // document.getElementById("addItemModal").style.display = "none"; // ××œ ×ª×¡×’×•×¨ ××ª ×”××•×“×œ ×”×¨××©×™
      document.getElementById("addSubjectModal").style.display = "block";
       document.getElementById("permanentSubjectsList").style.display = "none"; // ×¡×’×•×¨ ××ª ×¨×©×™××ª ×”× ×•×©××™×
       document.getElementById("newSubjectNameInput").value = ""; // × ×§×” ×©×“×” ×§×œ×˜
       document.getElementById("newSubjectNameInput").focus();
    }
    function closeAddSubjectModal() {
      document.getElementById("addSubjectModal").style.display = "none";
      // document.getElementById("addItemModal").style.display = "block"; // ×•×“× ×©×”××•×“×œ ×”×¨××©×™ × ×©××¨ ×¤×ª×•×—
    }

     function openItemDetailModal(item) {
         const detailContent = document.getElementById("itemDetailContent");
         const navigateBtn = document.getElementById("navigateItemBtn");
         let html = `<h3>${item.startTime} - ${item.endTime} : ${getDisplaySubject(item)} ${getBackgroundEmoji(item)}</h3>`;
         html += getExtraLine(item, true); // ×”×¤×§ ×¤×¨×˜×™× ××œ××™×
         html += getAddressLine(item);
         if (item.description) {
             html += `<p><strong>×ª×™××•×¨:</strong><br>${item.description.replace(/\n/g, '<br>')}</p>`;
         }

         detailContent.innerHTML = html;

         // ×‘×“×•×§ ×× ×™×© ××™×§×•× ×œ× ×™×•×•×˜
         const hasLocation = (item.subject === "× ×¡×™×¢×”" || item.subject === "×”×œ×™×›×”" || item.subject === "×™×" || item.subject === "×§× ×™×•×ª" || item.subject === "×‘×™×œ×•×™ ×œ×™×œ×™" || item.subject === "×¡×¤×•×¨×˜/×›×•×©×¨" || item.subject === "×¤×’×™×©×”" || item.subject === "×‘×™×§×•×¨/×¡×™×•×¨" || (item.subject === "××•×›×œ" && (item.foodType === "××¡×¢×“×”" || item.foodType === "×‘×™×ª ×§×¤×”" || item.foodType === "××•×›×œ ××”×™×¨/×“×•×›×Ÿ") && item.foodLocation));

         if (hasLocation && (item.toAddress || item.location || item.foodLocation)) {
             navigateBtn.style.display = "inline-block";
             // ×©××™×¨×ª ×”××™× ×“×§×¡ ×”× ×•×›×—×™ ×¢×‘×•×¨ ×”× ×™×•×•×˜
             navigateBtn.setAttribute('data-item-index', editingIndex);
         } else {
             navigateBtn.style.display = "none";
         }

         // ×©××™×¨×ª ×”××™× ×“×§×¡ ×”× ×•×›×—×™ ×¢×‘×•×¨ ×”×¢×¨×™×›×”
         document.getElementById('editItemBtn').setAttribute('data-item-index', editingIndex);

         document.getElementById("itemDetailModal").style.display = "block";
     }

     function closeItemDetailModal() {
         document.getElementById("itemDetailModal").style.display = "none";
     }

    // ----- × ×™×”×•×œ ×©× ×œ×•"×– -----

    function saveScheduleName() {
      const nameInput = document.getElementById("scheduleNameInput").value.trim();
      if (nameInput === "") { alert("×× × ×”×–×Ÿ ×©× ×œ×œ×•×´×–."); return; }

      // ×‘×“×•×§ ×× ×©× ×”×œ×•"×– ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××ª ×”×œ×•"×–×™× ×”×©××•×¨×™×
       const potentialDuplicate = savedSchedules.find(sch => sch.name === nameInput);
       if (potentialDuplicate && potentialDuplicate.id !== scheduleName) { // ×•×“× ×©×–×” ×œ× ×”×œ×•"×– ×”× ×•×›×—×™ ×©×× ×—× ×• ×¢×•×¨×›×™×
            alert(`×œ×•×– ×‘×©× "${nameInput}" ×›×‘×¨ ×§×™×™×. ×× × ×‘×—×¨ ×©× ××—×¨.`);
            return;
       }

      scheduleName = nameInput + ""; // ×”×•×¡×¤×ª ×ª×’×™×ª ×–×™×”×•×™ ×¤× ×™××™×ª
      closeScheduleNameModal();

      // ×¢×“×›×Ÿ ××ª ×”×›×•×ª×¨×ª ×‘×¢××•×“ ×”×¨××©×™ ×× ×”×™× ×§×™×™××ª
      const mainTitle = document.querySelector('#content h2');
      if(mainTitle) {
          mainTitle.innerText = nameInput; // ×”×¦×’ ×©× × ×§×™
      }

      // ×× ×”×œ×•"×– ×”×™×” ×¨×™×§, ×¤×ª×— ××ª ××•×“×œ ×”×•×¡×¤×ª ×”×¤×¨×™×˜ ×”×¨××©×•×Ÿ
      if (scheduleItems.length === 0) {
          openAddItemModal();
      }
    }

    // ----- × ×™×”×•×œ ×¤×¨×™×˜×™ ×œ×•"×– (×”×•×¡×¤×”, ×¢×¨×™×›×”, ××—×™×§×”) -----

    function saveItem() {
        let dateValue = document.getElementById("modalDate").value;
        let startTime = document.getElementById("modalStartTime").value;
        let endTime = document.getElementById("modalEndTime").value;
        const subject = document.getElementById("modalSubject").value;
        const description = document.getElementById("modalDescription").value.trim();

        // --- ×•×œ×™×“×¦×™×•×ª ---
        if (!dateValue) { alert("×× × ×‘×—×¨ ×ª××¨×™×š."); return; }
        if (!startTime || !endTime) { alert("×× × ×‘×—×¨ ×©×¢×ª ×”×ª×—×œ×” ×•×©×¢×ª ×¡×™×•×."); return; }
         if (!subject) { alert("×× × ×‘×—×¨ × ×•×©×."); return; }

        // ×•×“× ×©×©×¢×ª ×”×¡×™×•× ×œ× ×œ×¤× ×™ ×©×¢×ª ×”×”×ª×—×œ×” (×‘××•×ª×• ×™×•×)
        if (endTime < startTime) {
             alert("×©×¢×ª ×”×¡×™×•× ××™× ×” ×™×›×•×œ×” ×œ×”×™×•×ª ×œ×¤× ×™ ×©×¢×ª ×”×”×ª×—×œ×”.");
             return;
             // ×× ×¨×•×¦×™× ×œ××¤×©×¨ ××¢×‘×¨ ×™×•×, × ×“×¨×©×ª ×œ×•×’×™×§×” × ×•×¡×¤×ª ×¢× ×ª××¨×™×š ×¡×™×•×
        }
         // ×‘×“×™×§×ª ×—×¤×™×¤×” ×¢× ×¤×¨×™×˜×™× ××—×¨×™× (××•×¤×¦×™×•× ×œ×™ - ×™×›×•×œ ×œ×”×™×•×ª ××•×¨×›×‘)
         // checkForOverlap(dateValue, startTime, endTime, editingIndex);


        const newItem = {
            id: editingIndex === -1 ? Date.now().toString() : scheduleItems[editingIndex].id, // ID ×™×™×—×•×“×™
            date: dateValue,
            startTime,
            endTime,
            subject,
            description
        };

        // ×”×•×¡×¤×ª ×©×“×•×ª ×¡×¤×¦×™×¤×™×™× ×œ×¤×™ × ×•×©×
        if (subject === "×”×œ×™×›×”" || subject === "× ×¡×™×¢×”") {
            newItem.fromAddress = document.getElementById("fromAddress").value.trim();
            newItem.toAddress = document.getElementById("toAddress").value.trim();
            if (subject === "× ×¡×™×¢×”") {
                newItem.travelMode = document.getElementById("travelModeSelect").value;
            }
            // ×•×œ×™×“×¦×™×” ×‘×¡×™×¡×™×ª ×œ×©×“×•×ª ×›×ª×•×‘×ª
            if (!newItem.fromAddress || !newItem.toAddress) {
                alert("×× × ××œ× ××ª ×›×ª×•×‘×•×ª ×”×”×ª×—×œ×” ×•×”×™×¢×“ ×¢×‘×•×¨ × ×¡×™×¢×”/×”×œ×™×›×”.");
                return;
            }
        } else if (subject === "×‘×™×§×•×¨/×¡×™×•×¨" || subject === "×™×" || subject === "×§× ×™×•×ª" || subject === "×‘×™×œ×•×™ ×œ×™×œ×™" || subject === "×¡×¤×•×¨×˜/×›×•×©×¨" || subject === "×¤×’×™×©×”") {
            newItem.location = document.getElementById("locationInput").value.trim();
             // ×•×œ×™×“×¦×™×” ×‘×¡×™×¡×™×ª ×œ×©×“×” ××™×§×•×
             if (!newItem.location) {
                 alert(`×× × ××œ× ××ª ×”××™×§×•× ×¢×‘×•×¨ "${subject}".`);
                 return;
             }
        } else if (subject === "××•×›×œ") {
            newItem.foodType = document.getElementById("foodTypeSelect").value;
            if (newItem.foodType === "××¡×¢×“×”" || newItem.foodType === "×‘×™×ª ×§×¤×”" || newItem.foodType === "××•×›×œ ××”×™×¨/×“×•×›×Ÿ") {
                newItem.foodLocation = document.getElementById("foodLocationInput").value.trim();
                // ×•×œ×™×“×¦×™×” ×× × ×‘×—×¨ ×¡×•×’ ×©××¦×¨×™×š ××™×§×•×
                 if (!newItem.foodLocation) {
                     alert(`×× × ××œ× ××ª ××™×§×•× ×”××§×•× ×¢×‘×•×¨ "${newItem.foodType}".`);
                     return;
                 }
            }
        } else if (subject === "×˜×™×¡×”") {
            newItem.flightNumber = document.getElementById("flightNumberInput").value.trim().toUpperCase();
            newItem.airline = document.getElementById("airlineInput").value.trim();
            newItem.departureAirport = document.getElementById("departureAirportInput").value.trim();
            newItem.arrivalAirport = document.getElementById("arrivalAirportInput").value.trim();
            // ×©××™×¨×ª ×©×¢×•×ª ×”××¨××”/× ×—×™×ª×” ×’× ×‘×©×“×•×ª ×™×™×¢×•×“×™×™× (×‘× ×•×¡×£ ×œ-startTime/endTime)
            newItem.departureTime = startTime;
            newItem.arrivalTime = endTime;

             // ×•×œ×™×“×¦×™×” ×‘×¡×™×¡×™×ª ×œ×©×“×•×ª ×˜×™×¡×” (×œ×¤×—×•×ª ×—×‘×¨×” ×•×©×“×•×ª ×ª×¢×•×¤×”)
             if (!newItem.airline || !newItem.departureAirport || !newItem.arrivalAirport) {
                 alert("×× × ××œ× ×œ×¤×—×•×ª ××ª ×—×‘×¨×ª ×”×ª×¢×•×¤×” ×•×©×“×•×ª ×”×”××¨××” ×•×”× ×—×™×ª×”.");
                 return;
             }
        }

        if (editingIndex === -1) {
            // ×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×©
            scheduleItems.push(newItem);
        } else {
            // ×¢×“×›×•×Ÿ ×¤×¨×™×˜ ×§×™×™×
            scheduleItems[editingIndex] = newItem;
        }

        // ××™×•×Ÿ ×”×¨×©×™××” ×œ×¤×™ ×ª××¨×™×š ×•×©×¢×ª ×”×ª×—×œ×”
        scheduleItems.sort((a, b) => {
            if (a.date === b.date) {
                return a.startTime.localeCompare(b.startTime);
            }
            return a.date.localeCompare(b.date);
        });

        renderScheduleItems(); // ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×”
        closeAddItemModal(); // ×¡×’×™×¨×ª ×”××•×“×œ
        // ××™×Ÿ ×¦×•×¨×š ×œ×©××•×¨ ×›××Ÿ, ×”×©××™×¨×” ××ª×‘×¦×¢×ª ×‘×œ×—×™×¦×” ×¢×œ "×©××•×¨ ×•×¡×™×™× ×œ×•"×–"
        // saveUserData(); // ××• ×œ×©××•×¨ ××—×¨×™ ×›×œ ×©×™× ×•×™
    }

    function editScheduleItem(index) {
        editingIndex = index;
        const item = scheduleItems[index];

        // ×¤×ª×— ××•×“×œ ×¢×¨×™×›×”
        document.getElementById("addItemModalTitle").innerText = "×¢×¨×™×›×ª ×—×œ×§ ×‘×œ×•×´×–";
        document.getElementById("addItemBtn").innerHTML = '<i class="fas fa-save fa-fw"></i> ×©××•×¨ ×©×™× ×•×™×™×';
        resetAddItemModal(); // ××™×¤×•×¡ ×©×“×•×ª ×œ×¤× ×™ ××™×œ×•×™

        // ××œ× ××ª ×”×©×“×•×ª ×‘×¢×¨×›×™× ×©×œ ×”×¤×¨×™×˜ ×”× ×‘×—×¨
        document.getElementById("modalDate").value = item.date;
        document.getElementById("modalStartTime").value = item.startTime;
        document.getElementById("modalEndTime").value = item.endTime;
        document.getElementById("modalDescription").value = item.description || "";

        // ×•×“× ×©×”× ×•×©× ×§×™×™× ×‘×¨×©×™××” ×”× ×¤×ª×—×ª (×›×•×œ×œ × ×•×©××™× ××•×ª×××™×/×§×‘×•×¢×™×)
        updateSubjectDropdownOptions(); // ×¢×“×›×Ÿ ×§×•×“×
        const subjectExists = [...document.getElementById("modalSubject").options].some(option => option.value === item.subject);
        if (!subjectExists && !["×”×œ×™×›×”", "× ×¡×™×¢×”", "×‘×™×§×•×¨/×¡×™×•×¨", "×˜×™×¡×”", "××•×›×œ", "×©×™× ×”", "×œ×§×•×", "×™×", "×§× ×™×•×ª", "×‘×™×œ×•×™ ×œ×™×œ×™", "×¡×¤×•×¨×˜/×›×•×©×¨", "×× ×•×—×”/×–××Ÿ ×—×•×¤×©×™", "×¤×’×™×©×”", "××—×¨"].includes(item.subject)) {
            // ×× ×”× ×•×©× ×œ× ×§×™×™× ×•××™× ×• ××”× ×•×©××™× ×”×‘×¡×™×¡×™×™×, ×”×•×¡×£ ××•×ª×• ×–×× ×™×ª ×œ×¨×©×™××”
             addTemporaryCustomSubject(item.subject);
        }
        document.getElementById("modalSubject").value = item.subject;


        // ××œ× ×©×“×•×ª ×¡×¤×¦×™×¤×™×™× ×œ× ×•×©×
        if (item.subject === "×”×œ×™×›×”" || item.subject === "× ×¡×™×¢×”") {
            document.getElementById("fromAddress").value = item.fromAddress || "";
            document.getElementById("toAddress").value = item.toAddress || "";
            if (item.subject === "× ×¡×™×¢×”") {
                document.getElementById("travelModeSelect").value = item.travelMode || "car";
            }
        } else if (item.subject === "×‘×™×§×•×¨/×¡×™×•×¨" || item.subject === "×™×" || item.subject === "×§× ×™×•×ª" || item.subject === "×‘×™×œ×•×™ ×œ×™×œ×™" || item.subject === "×¡×¤×•×¨×˜/×›×•×©×¨" || item.subject === "×¤×’×™×©×”") {
            document.getElementById("locationInput").value = item.location || "";
        } else if (item.subject === "××•×›×œ") {
            document.getElementById("foodTypeSelect").value = item.foodType || "";
            if (item.foodType === "××¡×¢×“×”" || item.foodType === "×‘×™×ª ×§×¤×”" || item.foodType === "××•×›×œ ××”×™×¨/×“×•×›×Ÿ") {
                document.getElementById("foodLocationInput").value = item.foodLocation || "";
            }
        } else if (item.subject === "×˜×™×¡×”") {
            document.getElementById("flightNumberInput").value = item.flightNumber || "";
            document.getElementById("airlineInput").value = item.airline || "";
            document.getElementById("departureAirportInput").value = item.departureAirport || "";
            document.getElementById("arrivalAirportInput").value = item.arrivalAirport || "";
            // ×©×¢×ª ×”××¨××” ×•× ×—×™×ª×” ×›×‘×¨ ××•×’×“×¨×•×ª ×‘-startTime/endTime
        }

        subjectChangeHandler(); // ×¢×“×›×Ÿ ××ª ×ª×¦×•×’×ª ×”×©×“×•×ª ×œ×¤×™ ×”× ×•×©× ×”× ×˜×¢×Ÿ
        document.getElementById("addItemModal").style.display = "block"; // ×¤×ª×— ××ª ×”××•×“×œ
    }

     function deleteScheduleItem(index, event) {
         event.stopPropagation(); // ×× ×¢ ×¤×ª×™×—×ª ××•×“×œ ×¤×¨×˜×™× ×‘×œ×—×™×¦×” ×¢×œ ×”×¤×—
         const itemToDelete = scheduleItems[index];
         if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×¨×™×˜:\n"${itemToDelete.startTime} - ${itemToDelete.subject}"?`)) {
             scheduleItems.splice(index, 1); // ×”×¡×¨ ××”××¢×¨×š
             renderScheduleItems(); // ×¨×¢× ×Ÿ ××ª ×”×ª×¦×•×’×”
             // ××™×Ÿ ×¦×•×¨×š ×œ×©××•×¨ ×›××Ÿ, ×”×©××™×¨×” ×‘×¡×•×£
             // saveUserData();
             console.log("Item deleted.");
         }
     }

     function showItemDetail(index) {
         editingIndex = index; // ×©××•×¨ ××ª ×”××™× ×“×§×¡ ×œ××§×¨×” ×©× ×¨×¦×” ×œ×¢×¨×•×š/×œ× ×•×•×˜
         const item = scheduleItems[index];
         openItemDetailModal(item);
     }

     function editScheduleItemFromDetail() {
        const indexToEdit = parseInt(document.getElementById('editItemBtn').getAttribute('data-item-index'));
        if (indexToEdit >= 0 && indexToEdit < scheduleItems.length) {
            closeItemDetailModal(); // ×¡×’×•×¨ ××•×“×œ ×¤×¨×˜×™×
            editScheduleItem(indexToEdit); // ×¤×ª×— ××•×“×œ ×¢×¨×™×›×” ×¢× ×”× ×ª×•× ×™×
        }
     }

     function navigateItemFromDetail() {
        const indexToNavigate = parseInt(document.getElementById('navigateItemBtn').getAttribute('data-item-index'));
         if (indexToNavigate >= 0 && indexToNavigate < scheduleItems.length) {
             navigateItem(indexToNavigate);
         }
     }


    // ----- × ×™×”×•×œ × ×•×©××™× (×§×‘×•×¢×™×, ×—×“ ×¤×¢××™×™×) -----

    function updateSubjectDropdownOptions() {
        const subjectDropdown = document.getElementById("modalSubject");
        const currentSubjectValue = subjectDropdown.value; // ×©××•×¨ ××ª ×”×¢×¨×š ×”× ×•×›×—×™

        subjectDropdown.innerHTML = `<option value="" disabled selected>-- ×‘×—×¨ × ×•×©× --</option>
          <option value="×”×œ×™×›×”">ğŸš¶ ×”×œ×™×›×”</option>
          <option value="× ×¡×™×¢×”">ğŸš— × ×¡×™×¢×”</option>
          <option value="×‘×™×§×•×¨/×¡×™×•×¨">ğŸ›ï¸ ×‘×™×§×•×¨/×¡×™×•×¨</option>
          <option value="×™×">ğŸ–ï¸ ×™×</option>
          <option value="×§× ×™×•×ª">ğŸ›ï¸ ×§× ×™×•×ª</option>
          <option value="××•×›×œ">ğŸ½ï¸ ××•×›×œ</option>
          <option value="×‘×™×œ×•×™ ×œ×™×œ×™">ğŸŒƒ ×‘×™×œ×•×™ ×œ×™×œ×™</option>
          <option value="×¡×¤×•×¨×˜/×›×•×©×¨">ğŸ‹ï¸ ×¡×¤×•×¨×˜/×›×•×©×¨</option>
          <option value="×¤×’×™×©×”">ğŸ¤ ×¤×’×™×©×”</option>
          <option value="×˜×™×¡×”">âœˆï¸ ×˜×™×¡×”</option>
          <option value="×©×™× ×”">ğŸ˜´ ×©×™× ×”</option>
          <option value="×œ×§×•×">â° ×œ×§×•×</option>
          <option value="×× ×•×—×”/×–××Ÿ ×—×•×¤×©×™">ğŸ§˜ ×× ×•×—×”/×–××Ÿ ×—×•×¤×©×™</option>
          <option value="××—×¨">â“ ××—×¨</option>
          <optgroup label="× ×•×©××™× ×©××•×¨×™×">`; // ×§×‘×•×¦×” ×œ× ×•×©××™× ×§×‘×•×¢×™×

        // ×”×•×¡×¤×ª × ×•×©××™× ×§×‘×•×¢×™×
        permanentSubjects.forEach(subject => {
           const option = document.createElement("option");
           option.value = subject;
           option.text = subject; // ×”× ×•×©× ×××•×¨ ×›×‘×¨ ×œ×›×œ×•×œ ×××•×’'×™ ×× ×”××©×ª××© ×”×•×¡×™×£
           subjectDropdown.add(option);
        });
        subjectDropdown.innerHTML += `</optgroup><optgroup label="× ×•×©××™× ××•×ª×××™× ××™×©×™×ª">`; // ×§×‘×•×¦×” ×œ× ×•×©××™× ×—×“ ×¤×¢××™×™×

        // ×”×•×¡×¤×ª × ×•×©××™× ×—×“-×¤×¢××™×™× (×©×œ× × ××¦××™× ×‘×§×‘×•×¢×™×)
        customSubjects.forEach(subject => {
           if (!permanentSubjects.includes(subject)) {
              const option = document.createElement("option");
              option.value = subject;
              option.text = subject;
              subjectDropdown.add(option);
           }
        });
         subjectDropdown.innerHTML += `</optgroup>`;

         // ×©×—×–×¨ ××ª ×”×¢×¨×š ×©× ×‘×—×¨ ×§×•×“×, ×× ×¢×“×™×™×Ÿ ×§×™×™×
         if ([...subjectDropdown.options].some(opt => opt.value === currentSubjectValue)) {
            subjectDropdown.value = currentSubjectValue;
         } else if (editingIndex === -1) { // ×× ××•×¡×™×¤×™× ×—×“×©, ××¤×¡ ××ª ×”×‘×—×™×¨×”
             subjectDropdown.value = "";
         }
         // ×× ×¢×•×¨×›×™× ×¤×¨×™×˜ ×•×”× ×•×©× ×©×œ×• ×œ× ×‘×¨×©×™××”, ×”×•× ×™×ª×•×•×¡×£ ×–×× ×™×ª ×‘-editScheduleItem
    }


    function subjectChangeHandler() {
        const subj = document.getElementById("modalSubject").value;
        const extraQuestionsDiv = document.getElementById("extraQuestions");
        const locationFieldDiv = document.getElementById("locationField");
        const foodOptionsDiv = document.getElementById("foodExtraOptions");
        const flightOptionsDiv = document.getElementById("flightExtraOptions");
        const travelModeGroup = document.getElementById("travelModeGroup");
        const descriptionGroup = document.getElementById("descriptionGroup");
        const saveBtn = document.getElementById("addItemBtn");

        // ×”×¡×ª×¨ ××ª ×›×œ ×”×©×“×•×ª ×”× ×•×¡×¤×™× ×›×‘×¨×™×¨×ª ××—×“×œ
        extraQuestionsDiv.style.display = "none";
        locationFieldDiv.style.display = "none";
        foodOptionsDiv.style.display = "none";
        flightOptionsDiv.style.display = "none";
        travelModeGroup.style.display = "none"; // ×—×œ×§ ×-extraQuestions

        // ×”×¦×’ ×ª×™××•×¨ ×•×›×¤×ª×•×¨ ×©××™×¨×” ×× × ×‘×—×¨ × ×•×©×
        if (subj) {
             descriptionGroup.style.display = "block";
             saveBtn.style.display = "block";
        } else {
             descriptionGroup.style.display = "none";
             saveBtn.style.display = "none";
             return; // ××™×Ÿ × ×•×©×, ××™×Ÿ ××” ×œ×”×¦×™×’
        }

        // ×”×¦×’ ×©×“×•×ª ×¨×œ×•×•× ×˜×™×™× ×œ×¤×™ ×”× ×•×©×
        if (subj === "×”×œ×™×›×”" || subj === "× ×¡×™×¢×”") {
            extraQuestionsDiv.style.display = "block";
            if (subj === "× ×¡×™×¢×”") {
                travelModeGroup.style.display = "block";
            }
        } else if (subj === "×‘×™×§×•×¨/×¡×™×•×¨" || subj === "×™×" || subj === "×§× ×™×•×ª" || subj === "×‘×™×œ×•×™ ×œ×™×œ×™" || subj === "×¡×¤×•×¨×˜/×›×•×©×¨" || subj === "×¤×’×™×©×”") {
            locationFieldDiv.style.display = "block";
        } else if (subj === "××•×›×œ") {
            foodOptionsDiv.style.display = "block";
            foodTypeChangeHandler(); // ×¢×“×›×Ÿ ×× ×¦×¨×™×š ×œ×”×¦×™×’ ××™×§×•× ××•×›×œ
        } else if (subj === "×˜×™×¡×”") {
            flightOptionsDiv.style.display = "block";
             document.getElementById("startTimeLabel").innerText = "×©×¢×ª ×”××¨××”:";
             document.getElementById("endTimeLabel").innerText = "×©×¢×ª × ×—×™×ª×”:";
             document.getElementById("timeNote").innerText = "(×–×× ×™× ××§×•××™×™× ×©×œ ×©×“×•×ª ×”×ª×¢×•×¤×”)";
             document.getElementById("timeNote").style.display = "block";
        } else {
            // ×¢×‘×•×¨ ×©×™× ×”, ×œ×§×•×, ×× ×•×—×”, ××—×¨ - ××™×Ÿ ×©×“×•×ª × ×•×¡×¤×™×
             document.getElementById("startTimeLabel").innerText = "×©×¢×ª ×”×ª×—×œ×”:";
             document.getElementById("endTimeLabel").innerText = "×©×¢×ª ×¡×™×•×:";
             document.getElementById("timeNote").style.display = "none";
        }
         // ×× ×”× ×•×©× ×”×•× × ×•×©× ××•×ª×× ××™×©×™×ª ×©×œ× ××•×’×“×¨ ×œ××¢×œ×”, ××¤×©×¨ ×œ×”×—×œ×™×˜ ×× ×œ×”×¦×™×’ ×©×“×” ×›×œ×œ×™ ×›××• ××™×§×•× ××• ×›×œ×•×
         // ×›×¨×’×¢, × ×•×©××™× ××•×ª×××™× ×œ× ××¦×™×’×™× ×©×“×•×ª × ×•×¡×¤×™× ××¢×‘×¨ ×œ×ª×™××•×¨.
    }

     function foodTypeChangeHandler() {
        const foodType = document.getElementById("foodTypeSelect").value;
        const foodLocationDiv = document.getElementById("foodLocationDiv");
        // ×”×¦×’ ×©×“×” ××™×§×•× ×¢×‘×•×¨ ××¡×¢×“×”, ×‘×™×ª ×§×¤×”, ××•×›×œ ××”×™×¨/×“×•×›×Ÿ
        if (foodType === "××¡×¢×“×”" || foodType === "×‘×™×ª ×§×¤×”" || foodType === "××•×›×œ ××”×™×¨/×“×•×›×Ÿ") {
            foodLocationDiv.style.display = "block";
        } else {
            foodLocationDiv.style.display = "none";
            document.getElementById("foodLocationInput").value = ""; // × ×§×” ××™×§×•× ×× ×œ× ×¨×œ×•×•× ×˜×™
        }
    }

     function addSubjectOneTime() {
         const newSubjectName = document.getElementById("newSubjectNameInput").value.trim();
         if (newSubjectName === "") { alert("×× × ×”×–×Ÿ ×©× ×œ× ×•×©×."); return; }
         if (!customSubjects.includes(newSubjectName) && !permanentSubjects.includes(newSubjectName) && ![...document.getElementById("modalSubject").options].some(opt => opt.value === newSubjectName && opt.parentElement.tagName !== 'OPTGROUP')) {
            // ×”×•×¡×£ ×¨×§ ×× ×”×•× ×œ× ×§×™×™× ×›×‘×¨ ×›× ×•×©× ×‘×¡×™×¡×™, ×§×‘×•×¢ ××• ×—×“-×¤×¢××™ ××—×¨
            customSubjects.push(newSubjectName);
         }
         updateSubjectDropdownOptions();
         document.getElementById("modalSubject").value = newSubjectName; // ×‘×—×¨ ××ª ×”× ×•×©× ×”×—×“×©
         subjectChangeHandler(); // ×¢×“×›×Ÿ ×©×“×•×ª
         closeAddSubjectModal(); // ×¡×’×•×¨ ××•×“×œ ×”×•×¡×¤×”
     }

     function addSubjectPermanent() {
         const newSubjectName = document.getElementById("newSubjectNameInput").value.trim();
         if (newSubjectName === "") { alert("×× × ×”×–×Ÿ ×©× ×œ× ×•×©×."); return; }
         if (permanentSubjects.includes(newSubjectName)) {
              alert("× ×•×©× ×–×” ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××ª ×”× ×•×©××™× ×”×§×‘×•×¢×™×.");
               // ×‘×—×¨ ××ª ×”× ×•×©× ×”×§×™×™× ×•×¡×’×•×¨
               document.getElementById("modalSubject").value = newSubjectName;
               subjectChangeHandler();
               closeAddSubjectModal();
              return;
          }
         permanentSubjects.push(newSubjectName);
         localStorage.setItem('permanentSubjects', JSON.stringify(permanentSubjects)); // ×©××•×¨ ×œ-LocalStorage (×•×’× ×œ-Firestore ×× ××—×•×‘×¨)
         saveUserData(); // ×©××•×¨ ××ª ×”×©×™× ×•×™ ×’× ×‘-Firestore
         updateSubjectDropdownOptions();
         document.getElementById("modalSubject").value = newSubjectName; // ×‘×—×¨ ××ª ×”× ×•×©× ×”×—×“×©
         subjectChangeHandler(); // ×¢×“×›×Ÿ ×©×“×•×ª
         closeAddSubjectModal(); // ×¡×’×•×¨ ××•×“×œ ×”×•×¡×¤×”
         updatePermanentSubjectsListDisplay(); // ×¢×“×›×Ÿ ××ª ×¨×©×™××ª ×”× ×•×©××™× ×”×§×‘×•×¢×™× ×× ××•×¦×’×ª
         alert("×”× ×•×©× '" + newSubjectName + "' × ×•×¡×£ ×œ× ×•×©××™× ×”×§×‘×•×¢×™×!");
     }

     function addTemporaryCustomSubject(subjectName) {
        // ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª × ×•×©× ×©×œ× ×§×™×™× ×‘×¨×©×™××” ×‘××•×¤×Ÿ ×–×× ×™ (×œ×¦×•×¨×š ×¢×¨×™×›×”)
        if (!customSubjects.includes(subjectName) && !permanentSubjects.includes(subjectName)) {
            customSubjects.push(subjectName);
            updateSubjectDropdownOptions(); // ×¢×“×›×Ÿ ××ª ×”×¨×©×™××” ×”× ×¤×ª×—×ª
        }
    }


     function togglePermanentSubjectsList(event) {
         event.stopPropagation(); // ×× ×¢ ×¡×’×™×¨×” ××™×™×“×™×ª ×× ×œ×—×¦× ×• ×¢×œ ×”×›×¤×ª×•×¨
         const container = document.getElementById("permanentSubjectsList");
         const isDisplayed = container.style.display === "block";
         if (!isDisplayed) {
             updatePermanentSubjectsListDisplay(); // ×˜×¢×Ÿ ××ª ×”×¨×©×™××”
             container.style.display = "block";
             // ×”×•×¡×£ event listener ×œ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×¨×©×™××”
             document.addEventListener('click', closePermanentSubjectsListOnClickOutside, true);
         } else {
             container.style.display = "none";
             document.removeEventListener('click', closePermanentSubjectsListOnClickOutside, true);
         }
     }

     function closePermanentSubjectsListOnClickOutside(event) {
        const container = document.getElementById("permanentSubjectsList");
        const toggleBtn = document.getElementById("subjectsToggleBtn");
         // ×‘×“×•×§ ×× ×”×œ×—×™×¦×” ×”×™×ª×” ××—×•×¥ ×œ×¨×©×™××” ×•××—×•×¥ ×œ×›×¤×ª×•×¨ ×”×¤×ª×™×—×”
        if (container && !container.contains(event.target) && !toggleBtn.contains(event.target)) {
            container.style.display = 'none';
            document.removeEventListener('click', closePermanentSubjectsListOnClickOutside, true);
        }
    }


     function updatePermanentSubjectsListDisplay() {
         const container = document.getElementById("permanentSubjectsList");
         container.innerHTML = ""; // × ×§×” ×ª×•×›×Ÿ ×§×•×“×

         if (permanentSubjects.length === 0) {
             container.innerHTML = '<p style="text-align: center; color: #777; font-size: 0.9em;">××™×Ÿ × ×•×©××™× ×§×‘×•×¢×™× ×©××•×¨×™×.</p>';
         } else {
              const list = document.createElement('ul');
              list.style.listStyle = 'none';
              list.style.padding = '0';
              list.style.margin = '0';
              permanentSubjects.forEach((subject, index) => {
                 const listItem = document.createElement('li');
                 listItem.style.display = 'flex';
                 listItem.style.justifyContent = 'space-between';
                 listItem.style.alignItems = 'center';
                 listItem.style.padding = '8px 5px';
                 listItem.style.borderBottom = '1px solid #eee';
                 listItem.style.fontSize = '0.95em';

                 const subjectText = document.createElement('span');
                 subjectText.innerText = subject;
                 subjectText.style.flexGrow = '1';
                 subjectText.style.marginRight = '10px'; // ××¨×•×•×— ××”×¤×—
                 subjectText.style.cursor = 'pointer'; // ××¤×©×¨ ×œ×œ×—×•×¥ ×œ×‘×—×™×¨×”
                 subjectText.title = '×œ×—×¥ ×œ×‘×—×™×¨×ª ×”× ×•×©×';
                 subjectText.onclick = () => {
                     document.getElementById("modalSubject").value = subject;
                     subjectChangeHandler();
                     document.getElementById("permanentSubjectsList").style.display = 'none'; // ×¡×’×•×¨ ×¨×©×™××”
                     document.removeEventListener('click', closePermanentSubjectsListOnClickOutside, true);
                 };

                 const deleteBtn = document.createElement('span');
                 deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                 deleteBtn.style.cursor = 'pointer';
                 deleteBtn.style.color = '#e74c3c';
                 deleteBtn.style.opacity = '0.7';
                 deleteBtn.title = '××—×§ × ×•×©× ×§×‘×•×¢';
                 deleteBtn.onmouseover = () => deleteBtn.style.opacity = '1';
                 deleteBtn.onmouseout = () => deleteBtn.style.opacity = '0.7';
                 deleteBtn.onclick = (e) => {
                     e.stopPropagation(); // ×× ×¢ ×‘×—×™×¨×ª ×”× ×•×©× ×‘×œ×—×™×¦×” ×¢×œ ×”×¤×—
                     deletePermanentSubject(index);
                 };

                 listItem.appendChild(subjectText);
                 listItem.appendChild(deleteBtn);
                 list.appendChild(listItem);
             });
              container.appendChild(list);
         }
          // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ "×”×•×¡×£ ×—×“×©" ×œ×ª×—×ª×™×ª ×”×¨×©×™××”
          const addButton = document.createElement('button');
          addButton.className = 'btn btn-secondary'; // ××• ×¡×’× ×•×Ÿ ××—×¨
          addButton.innerHTML = '<i class="fas fa-plus fa-fw"></i> ×”×•×¡×£ × ×•×©× ×—×“×©';
          addButton.style.width = '100%';
          addButton.style.marginTop = '15px';
          addButton.style.fontSize = '0.9em';
          addButton.style.padding = '8px 12px';
          addButton.onclick = openAddSubjectModal;
          container.appendChild(addButton);
     }

     function deletePermanentSubject(index) {
         const subjectToDelete = permanentSubjects[index];
         if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”× ×•×©× ×”×§×‘×•×¢ "${subjectToDelete}"?`)) {
             permanentSubjects.splice(index, 1);
             localStorage.setItem('permanentSubjects', JSON.stringify(permanentSubjects)); // ×¢×“×›×Ÿ ××—×¡×•×Ÿ ××§×•××™
             saveUserData(); // ×¢×“×›×Ÿ Firestore
             updatePermanentSubjectsListDisplay(); // ×¢×“×›×Ÿ ××ª ×”×¨×©×™××” ×”××•×¦×’×ª
             updateSubjectDropdownOptions(); // ×¢×“×›×Ÿ ××ª ×”×¨×©×™××” ×”× ×¤×ª×—×ª ×”×¨××©×™×ª
             alert(`×”× ×•×©× "${subjectToDelete}" × ××—×§ ××”× ×•×©××™× ×”×§×‘×•×¢×™×.`);
         }
     }


    // ----- ×—×™×¤×•×© ×•×˜×™×¤×•×œ ×‘×¤×¨×˜×™ ×˜×™×¡×” -----

    function searchFlight() {
        const flightNumber = document.getElementById("flightNumberInput").value.trim().toUpperCase();
        const flightDate = document.getElementById("modalDate").value; // ×”×©×ª××© ×‘×ª××¨×™×š ××”×˜×•×¤×¡

        if (!flightNumber || !flightDate) {
            alert("×× × ×”×–×Ÿ ××¡×¤×¨ ×˜×™×¡×” ×•×ª××¨×™×š.");
            return;
        }

        const loader = document.getElementById("loader");
        const loaderText = document.getElementById("loaderText");
        loaderText.innerText = `××—×¤×© ×¤×¨×˜×™ ×˜×™×¡×” ${flightNumber}... âœˆï¸`;
        loader.style.display = "flex";

        // --- ×©×™××•×© ×‘-API (×“×•×’××” ×¢× RapidAPI AeroDataBox) ---
        // !!! ×”×—×œ×£ ×¢× ×”××¤×ª×— ×•×”-Host ×©×œ×š !!!
         const apiKey = "33d4ecb375mshcf029fba766af44p17668djsnaef3c36cb209"; // ×”××¤×ª×— ××”×§×•×“ ×”××§×•×¨×™
         const host = "aerodatabox.p.rapidapi.com"; // ×”-Host ××”×§×•×“ ×”××§×•×¨×™

         // ×‘× ×™×™×ª ×”-URL ×¢× ××¡×¤×¨ ×”×˜×™×¡×” ×•×”×ª××¨×™×š
         const apiUrl = `https://aerodatabox.p.rapidapi.com/flights/number/${flightNumber}/${flightDate}?withLeg=true&withCancelled=true&withCodeshares=true`;

        fetch(apiUrl, {
            method: "GET",
            headers: {
                "x-rapidapi-host": host,
                "x-rapidapi-key": apiKey,
                "Accept": "application/json"
            }
        })
        .then(response => {
            if (!response.ok) {
                 // × ×¡×” ×œ×§×¨×•× ××ª ×’×•×£ ×”×ª×©×•×‘×” ×’× ×‘××§×¨×” ×©×œ ×©×’×™××”
                 return response.json().then(errData => {
                     throw new Error(`×©×’×™××” ${response.status}: ${errData.message || response.statusText}`);
                 }).catch(() => {
                     // ×× ××™×Ÿ ×’×•×£ JSON ××• ×©×”×•× ×œ× ×ª×§×™×Ÿ
                     throw new Error(`×©×’×™××” ${response.status}: ${response.statusText}`);
                 });
            }
            return response.json();
        })
        .then(data => {
            loader.style.display = "none";
            processFlightResults(data, flightNumber);
        })
        .catch(error => {
            loader.style.display = "none";
            console.error("Flight search error:", error);
            document.getElementById("flightResultContent").innerHTML = `<p style="color: red;">×©×’×™××” ×‘×—×™×¤×•×© ×”×˜×™×¡×”: ${error.message}. ×× × ×‘×“×•×§ ××ª ××¡×¤×¨ ×”×˜×™×¡×” ×•×”×ª××¨×™×š ××• ×”×–×Ÿ ×™×“× ×™×ª.</p>`;
            document.getElementById("flightResultModal").style.display = "block";
            document.getElementById("copyFlightBtn").style.display = 'none'; // ×”×¡×ª×¨ ×›×¤×ª×•×¨ ×”×¢×ª×§×” ×‘×©×’×™××”
            currentFlightData = null;
        });
    }

    function processFlightResults(data, searchedFlightNumber) {
         let html = "";
         currentFlightData = null; // ××¤×¡ × ×ª×•× ×™× ×§×•×“××™×
         const copyBtn = document.getElementById("copyFlightBtn");

         if (data && data.length > 0) {
             // × × ×™×— ×©×”×ª×•×¦××” ×”×¨××©×•× ×” ×”×™× ×”×¨×œ×•×•× ×˜×™×ª ×‘×™×•×ª×¨ ××• ×”×™×—×™×“×”
             const flight = data[0]; // ×§×— ××ª ×”×˜×™×¡×” ×”×¨××©×•× ×” ×‘×¨×©×™××”

             // ×—×™×œ×•×¥ × ×ª×•× ×™× ×‘×¦×•×¨×” ×‘×˜×•×—×” ×™×•×ª×¨
             const airlineName = flight.airline?.name || "×œ× ×–××™×Ÿ";
             const depAirport = flight.departure?.airport?.name || "×œ× ×–××™×Ÿ";
             const arrAirport = flight.arrival?.airport?.name || "×œ× ×–××™×Ÿ";
             const depIata = flight.departure?.airport?.iata || "";
             const arrIata = flight.arrival?.airport?.iata || "";
             const depTerminal = flight.departure?.terminal ? `×˜×¨××™× ×œ ${flight.departure.terminal}` : "";
             const arrTerminal = flight.arrival?.terminal ? `×˜×¨××™× ×œ ${flight.arrival.terminal}` : "";
             const depTimeScheduledLocal = flight.departure?.scheduledTime?.local?.replace(/:\d{2}[+-]\d{2}:\d{2}$/, '') || "×œ× ×–××™×Ÿ"; // ×”×¡×¨ ×©× ×™×•×ª ×•-timezone
             const arrTimeScheduledLocal = flight.arrival?.scheduledTime?.local?.replace(/:\d{2}[+-]\d{2}:\d{2}$/, '') || "×œ× ×–××™×Ÿ";
             const depTimeActualLocal = flight.departure?.actualTime?.local?.replace(/:\d{2}[+-]\d{2}:\d{2}$/, '') || ""; // ×–××Ÿ ×××©×™ ×× ×§×™×™×
             const arrTimeActualLocal = flight.arrival?.actualTime?.local?.replace(/:\d{2}[+-]\d{2}:\d{2}$/, '') || "";
             const status = flight.status || "×œ× ×–××™×Ÿ";

             // ×‘× ×” ××ª ×”-HTML ×œ×ª×¦×•×’×”
             html += '<div class="flight-card">';
             html += `<h2>×˜×™×¡×ª ${airlineName} (${searchedFlightNumber})</h2>`;
             html += `<p><span class="time-label">×¡×˜×˜×•×¡:</span> ${status}</p>`;
             html += `<p><span class="time-label">×:</span> ${depAirport} (${depIata}) ${depTerminal}</p>`;
             html += `<p><span class="time-label">××œ:</span> ${arrAirport} (${arrIata}) ${arrTerminal}</p>`;
             html += `<p><span class="time-label">×”××¨××” ××ª×•×›× × ×ª:</span> ${depTimeScheduledLocal}`;
             if (depTimeActualLocal && depTimeActualLocal !== depTimeScheduledLocal) {
                 html += ` (×‘×¤×•×¢×œ: ${depTimeActualLocal})`;
             }
             html += `</p>`;
             html += `<p><span class="time-label">× ×—×™×ª×” ××ª×•×›× × ×ª:</span> ${arrTimeScheduledLocal}`;
             if (arrTimeActualLocal && arrTimeActualLocal !== arrTimeScheduledLocal) {
                 html += ` (×‘×¤×•×¢×œ: ${arrTimeActualLocal})`;
             }
              html += `</p>`;
             html += '</div>';

             // ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ×”×¢×ª×§×”
             currentFlightData = {
                 flightNumber: searchedFlightNumber, // ×”×©×ª××© ×‘××¡×¤×¨ ×©×”×•×–×Ÿ
                 airline: airlineName,
                 departureAirport: `${depAirport} (${depIata})`,
                 arrivalAirport: `${arrAirport} (${arrIata})`,
                 // ×”×©×ª××© ×‘×–××Ÿ ×”××ª×•×›× ×Ÿ ×›×‘×¨×™×¨×ª ××—×“×œ, ×”×¡×¨ ×©× ×™×•×ª
                 departureTime: depTimeScheduledLocal.substring(0, 16).replace('T', ' '), // ×¤×•×¨××˜ HH:MM
                 arrivalTime: arrTimeScheduledLocal.substring(0, 16).replace('T', ' '), // ×¤×•×¨××˜ HH:MM
                 // ×—×œ×¥ ×¨×§ ××ª ×©×¢×ª ×”×”××¨××”/× ×—×™×ª×” ×œ×©×™××•×© ×‘×©×“×•×ª ×–××Ÿ
                 departureTimeOnly: depTimeScheduledLocal.match(/\d{2}:\d{2}$/)[0],
                 arrivalTimeOnly: arrTimeScheduledLocal.match(/\d{2}:\d{2}$/)[0]
             };
             copyBtn.style.display = 'inline-block'; // ×”×¦×’ ×›×¤×ª×•×¨ ×”×¢×ª×§×”

         } else {
             html = `<p>×œ× × ××¦××• ×¤×¨×˜×™× ×¢×‘×•×¨ ×˜×™×¡×” ${searchedFlightNumber} ×‘×ª××¨×™×š Ø§Ù„Ù…Ø­Ø¯Ø¯. ×× × ×‘×“×•×§ ×©×•×‘ ××• ×”×–×Ÿ ×™×“× ×™×ª.</p>`;
             copyBtn.style.display = 'none'; // ×”×¡×ª×¨ ×›×¤×ª×•×¨ ×”×¢×ª×§×”
             currentFlightData = null;
         }

         document.getElementById("flightResultContent").innerHTML = html;
         document.getElementById("flightResultModal").style.display = "block";
     }


    function closeFlightResultModal() {
        document.getElementById("flightResultModal").style.display = "none";
    }

    function copyFlightToForm() {
        if (currentFlightData) {
            document.getElementById("flightNumberInput").value = currentFlightData.flightNumber;
            document.getElementById("airlineInput").value = currentFlightData.airline;
            document.getElementById("departureAirportInput").value = currentFlightData.departureAirport;
            document.getElementById("arrivalAirportInput").value = currentFlightData.arrivalAirport;
             // ×¢×“×›×Ÿ ××ª ×©×“×•×ª ×”×–××Ÿ ×”×¨××©×™×™× ×¢× ×©×¢×•×ª ×”×”××¨××”/× ×—×™×ª×” ×©××¦×× ×•
             document.getElementById("modalStartTime").value = currentFlightData.departureTimeOnly;
             document.getElementById("modalEndTime").value = currentFlightData.arrivalTimeOnly;

             // ×¢×“×›×Ÿ ××ª ×”×”×¢×¨×” ×¢× ×”×–×× ×™× ×”××œ××™× ×™×•×ª×¨
             document.getElementById("timeNote").innerText = `(×”××¨××”: ${currentFlightData.departureTime}, × ×—×™×ª×”: ${currentFlightData.arrivalTime})`;
             document.getElementById("timeNote").style.display = "block";

            closeFlightResultModal();
            alert("×¤×¨×˜×™ ×”×˜×™×¡×” ×”×•×¢×ª×§×• ×œ×˜×•×¤×¡.");
        } else {
            alert("××™×Ÿ × ×ª×•× ×™ ×˜×™×¡×” ×œ×”×¢×ª×§×”.");
        }
    }

    // ----- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (×ª××¨×™×›×™×, ×©×¢×•×ª, ×ª×¦×•×’×”) -----

    function addMinutesToTime(timeStr, minutesToAdd) {
        if (!timeStr) return ""; // ×”×—×–×¨ ×¨×™×§ ×× ××™×Ÿ ×–××Ÿ ×”×ª×—×œ×”
        let [h, m] = timeStr.split(":").map(Number);
        let totalMinutes = h * 60 + m + minutesToAdd;
        totalMinutes = totalMinutes % (24 * 60); // ×•×“× ×©×œ× ×¢×•×‘×¨×™× ××ª ×—×¦×•×ª
        let newH = Math.floor(totalMinutes / 60);
        let newM = totalMinutes % 60;
        return (newH < 10 ? "0" + newH : newH) + ":" + (newM < 10 ? "0" + newM : newM);
    }

    function setDefaultEndTime() {
        const startTime = document.getElementById("modalStartTime").value;
        if (startTime) {
             // ×‘×¨×™×¨×ª ××—×“×œ: ×©×¢×” ××—×ª ××—×¨×™ ×”×”×ª×—×œ×”
             const endTime = addMinutesToTime(startTime, 60);
             document.getElementById("modalEndTime").value = endTime;
        }
    }

     function getDisplaySubject(item) {
         if (item.subject === "× ×¡×™×¢×”" && item.travelMode) {
             return "× ×¡×™×¢×” " + translateTravelMode(item.travelMode);
         }
         if (item.subject === "××•×›×œ" && item.foodType) {
              // ××¦× ××ª ×”×××•×’'×™ ×”××ª××™× ×œ×¡×•×’ ×”××•×›×œ ×× ×§×™×™× ×‘××¤×©×¨×•×™×•×ª
             const foodSelect = document.getElementById("foodTypeSelect");
             const selectedOption = [...foodSelect.options].find(opt => opt.value === item.foodType);
             const emoji = selectedOption ? selectedOption.text.split(' ').pop() : subjectEmojis["××•×›×œ"]; // ×§×— ×××•×’'×™ ××”××•×¤×¦×™×” ××• ×‘×¨×™×¨×ª ××—×“×œ
             return `${item.foodType} ${emoji}`;
         }
          // ×”×—×–×¨ ××ª ×”× ×•×©× ×”××§×•×¨×™ ×¢× ×”×××•×’'×™ ×©×œ×• ×× ×§×™×™×
         const defaultEmoji = subjectEmojis[item.subject] || '';
         // ×‘×“×•×§ ×× ×”× ×•×©× ×›×‘×¨ ××›×™×œ ×××•×’'×™ (×œ××§×¨×” ×©×œ × ×•×©××™× ××•×ª×××™×)
         const lastChar = item.subject.slice(-1);
         const containsEmoji = lastChar.codePointAt(0) > 10000; // ×‘×“×™×§×” ×¤×©×•×˜×” ×œ×××•×’'×™
         return containsEmoji ? item.subject : `${item.subject} ${defaultEmoji}`;
     }

     function translateTravelMode(mode) {
         switch (mode) {
             case "car": return "×‘×¨×›×‘ ×¤×¨×˜×™ ğŸš™";
             case "transit": return "×‘×ª×—×‘×´×¦ ğŸš‹ğŸš†";
             case "taxi": return "×‘××•× ×™×ª ğŸš–";
             case "walk": return "×‘×”×œ×™×›×” ğŸš¶"; // ×× × ×‘×—×¨×” ×”×œ×™×›×” ×“×¨×š ××¦×‘ × ×¡×™×¢×”
             default: return ""; // ×”×—×–×¨ ×¨×™×§ ×× ××™×Ÿ ××¦×‘ × ×¡×™×¢×” ××•×’×“×¨
         }
     }


    function getBackgroundEmoji(item) {
        if (item.subject === "× ×¡×™×¢×”" && item.travelMode) {
             let translated = translateTravelMode(item.travelMode);
             let parts = translated.split(" ");
             return parts[parts.length - 1] || subjectEmojis["× ×¡×™×¢×”"]; // ×”×—×–×¨ ×××•×’'×™ ×¨×›×‘ ×× ××™×Ÿ ××©×”×• ××—×¨
        }
        if (item.subject === "××•×›×œ" && item.foodType) {
              const foodSelect = document.getElementById("foodTypeSelect");
              const selectedOption = [...foodSelect.options].find(opt => opt.value === item.foodType);
              return selectedOption ? selectedOption.text.split(' ').pop() : subjectEmojis["××•×›×œ"];
        }
         // ×‘×“×•×§ ×× ×”× ×•×©× ×¢×¦××• ××›×™×œ ×××•×’'×™ ×‘×¡×•×¤×•
         const lastChar = item.subject.slice(-1);
         if (lastChar.codePointAt(0) > 10000) { return lastChar; }
         // ××—×¨×ª, ×”×—×–×¨ ××”××¤×”
         return subjectEmojis[item.subject] || subjectEmojis["××—×¨"]; // ×”×—×–×¨ ×¡×™××Ÿ ×©××œ×” ×× ×œ× × ××¦×
    }

    function getAddressLine(item) {
        if ((item.subject === "× ×¡×™×¢×”" || item.subject === "×”×œ×™×›×”") && item.fromAddress && item.toAddress) {
            return `<p style="font-size: 0.9em; color: #555;"><i class="fas fa-map-marker-alt fa-fw"></i> ${item.fromAddress} <i class="fas fa-long-arrow-alt-left fa-fw"></i> ${item.toAddress}</p>`;
        }
        return "";
    }

    function getExtraLine(item, fullDetails = false) {
        let lines = [];
        if (item.subject === "× ×¡×™×¢×”" && item.travelMode && !fullDetails) { // ×‘×ª×¦×•×’×” ×¨×’×™×œ×”, ×”×›×ª×•×‘×•×ª ×‘×©×•×¨×” × ×¤×¨×“×ª
            // lines.push(`××•×¤×Ÿ × ×¡×™×¢×”: ${translateTravelMode(item.travelMode)}`); // ××•×¦×’ ×›×‘×¨ ×‘×›×•×ª×¨×ª
        } else if (item.subject === "× ×¡×™×¢×”" && fullDetails) { // ×‘×ª×¦×•×’×ª ×¤×¨×˜×™× ××œ××”
             lines.push(`<strong>×××™×¤×”:</strong> ${item.fromAddress || '×œ× ×¦×•×™×Ÿ'}`);
             lines.push(`<strong>×œ××Ÿ:</strong> ${item.toAddress || '×œ× ×¦×•×™×Ÿ'}`);
             lines.push(`<strong>××•×¤×Ÿ × ×¡×™×¢×”:</strong> ${translateTravelMode(item.travelMode) || '×œ× ×¦×•×™×Ÿ'}`);
        } else if (item.subject === "×”×œ×™×›×”" && fullDetails) {
             lines.push(`<strong>×××™×¤×”:</strong> ${item.fromAddress || '×œ× ×¦×•×™×Ÿ'}`);
             lines.push(`<strong>×œ××Ÿ:</strong> ${item.toAddress || '×œ× ×¦×•×™×Ÿ'}`);
        } else if ((item.subject === "×‘×™×§×•×¨/×¡×™×•×¨" || item.subject === "×™×" || item.subject === "×§× ×™×•×ª" || item.subject === "×‘×™×œ×•×™ ×œ×™×œ×™" || item.subject === "×¡×¤×•×¨×˜/×›×•×©×¨" || item.subject === "×¤×’×™×©×”") && item.location) {
            lines.push(`<p><i class="fas fa-map-pin fa-fw"></i> <strong>××™×§×•×:</strong> ${item.location}</p>`);
        } else if (item.subject === "××•×›×œ") {
            if (item.foodType) {
                 // ×”×©×•×¨×” ×”×–×• ××™×•×ª×¨×ª ×›×™ ×¡×•×’ ×”××•×›×œ ××•×¤×™×¢ ×‘×›×•×ª×¨×ª
                 // lines.push(`<strong>×¡×•×’:</strong> ${item.foodType}`);
            }
            if (item.foodLocation) {
                lines.push(`<p><i class="fas fa-map-pin fa-fw"></i> <strong>××™×§×•×:</strong> ${item.foodLocation}</p>`);
            } else if (item.foodType === "×¤×™×§× ×™×§/×”×›× ×” ×¢×¦××™×ª" || item.foodType === "×§× ×™×™×” ×‘×¡×•×¤×¨/××›×•×œ×ª" || item.foodType === "×‘××œ×•×Ÿ/×‘××§×•× ×”×œ×™× ×”") {
                // ××™×Ÿ ×¦×•×¨×š ×œ×”×¦×™×’ ××™×§×•× ××• ×©×•×¨×” × ×•×¡×¤×ª
            }
        } else if (item.subject === "×˜×™×¡×”") {
             lines.push(`<p><i class="fas fa-plane-departure fa-fw"></i> <strong>×˜×™×¡×”:</strong> ${item.airline || ''} ${item.flightNumber || ''}</p>`);
             lines.push(`<p style="font-weight: bold; font-size: 0.95em;"> ${item.departureAirport || ''} <i class="fas fa-long-arrow-alt-right fa-fw"></i> ${item.arrivalAirport || ''}</p>`);
             if (fullDetails) { // ×”×•×¡×£ ×–×× ×™× ××œ××™× ×¨×§ ×‘×ª×¦×•×’×ª ×¤×¨×˜×™×
                 lines.push(`<p><small>×”××¨××”: ${item.departureTime} | × ×—×™×ª×”: ${item.arrivalTime}</small></p>`);
             }
        }
        return lines.join(fullDetails ? "<br>" : ""); // ×”×¦×’ ×›×¤×¡×§××•×ª × ×¤×¨×“×•×ª ×‘×ª×¦×•×’×” ×¨×’×™×œ×”, ××• ×©×•×¨×•×ª ×‘×ª×¦×•×’×ª ×¤×¨×˜×™×
    }


    function groupItemsByDate(items) {
        return items.reduce((groups, item) => {
            const date = item.date; // ×”×ª××¨×™×š ×›×‘×¨ ×‘×¤×•×¨××˜ YYYY-MM-DD
            if (!groups[date]) {
                groups[date] = [];
            }
            groups[date].push(item);
            return groups;
        }, {});
    }

    function formatDateHeader(dateStr) {
        if (!dateStr) return "";
        try {
            // ×”××¨×ª ×”×ª××¨×™×š ×œ×¤×•×¨××˜ ×©××–×•×”×” ×¢×œ ×™×“×™ Date (×œ×•×•×“× ×©×”×•× YYYY-MM-DD)
            const dateObj = new Date(dateStr + 'T00:00:00'); // ×”×•×¡×£ ×©×¢×” ×›×“×™ ×œ×× ×•×¢ ×‘×¢×™×•×ª timezone
             if (isNaN(dateObj)) { // ×‘×“×•×§ ×× ×”×ª××¨×™×š ×ª×§×™×Ÿ
                 console.warn("Invalid date string for formatting:", dateStr);
                 return dateStr; // ×”×—×–×¨ ××ª ×”××—×¨×•×–×ª ×”××§×•×¨×™×ª ×× ×œ× ×ª×§×™×Ÿ
             }
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            return dateObj.toLocaleDateString('he-IL', options);
        } catch (e) {
            console.error("Error formatting date:", dateStr, e);
            return dateStr; // ×”×—×–×¨ ××—×¨×•×–×ª ××§×•×¨×™×ª ×‘××§×¨×” ×©×œ ×©×’×™××”
        }
    }


    // ----- ×¨×™× ×“×•×¨ ×ª×¦×•×’×ª ×”×œ×•"×– -----

    function renderScheduleItems() {
        const container = document.getElementById("scheduleContainer");
        if (!container) return; // ×•×“× ×©×”××œ×× ×˜ ×§×™×™×
        container.innerHTML = ""; // × ×§×” ×ª×¦×•×’×” ×§×•×“××ª

        if (scheduleItems.length === 0 && scheduleName) {
            container.innerHTML = '<p style="color: #777; margin-top: 20px;">×”×œ×•"×– ×¢×“×™×™×Ÿ ×¨×™×§. ×œ×—×¥ ×¢×œ + ×›×“×™ ×œ×”×•×¡×™×£ ××ª ×”×—×œ×§ ×”×¨××©×•×Ÿ.</p>';
            return;
        }

        const groups = groupItemsByDate(scheduleItems);
        const sortedDates = Object.keys(groups).sort((a, b) => new Date(a) - new Date(b)); // ××™×•×Ÿ ×ª××¨×™×›×™×

        sortedDates.forEach(date => {
             // ×”×•×¡×¤×ª ×›×•×ª×¨×ª ×ª××¨×™×š
             const dateHeader = document.createElement('h3');
             dateHeader.textContent = formatDateHeader(date);
             dateHeader.style.textAlign = 'center';
             dateHeader.style.margin = '25px 0 10px 0';
             dateHeader.style.color = '#16A085'; // ×¦×‘×¢ ×™×¨×§×¨×§
             container.appendChild(dateHeader);

             // ××™×•×Ÿ ×¤×¨×™×˜×™× ×œ×¤×™ ×©×¢×ª ×”×ª×—×œ×”
             const sortedItems = groups[date].sort((a, b) => a.startTime.localeCompare(b.startTime));

             sortedItems.forEach((item) => {
                const itemIndex = scheduleItems.findIndex(i => i.id === item.id); // ××¦× ××™× ×“×§×¡ ×œ×¤×™ ID ×™×™×—×•×“×™
                let displaySubject = getDisplaySubject(item);
                let bgEmoji = getBackgroundEmoji(item);
                let extraLine = getExtraLine(item);
                let addressLine = getAddressLine(item);

                 // ×‘×“×•×§ ×× ×™×© ××™×§×•× ×œ× ×™×•×•×˜
                 const hasLocation = (item.subject === "× ×¡×™×¢×”" || item.subject === "×”×œ×™×›×”" || item.subject === "×™×" || item.subject === "×§× ×™×•×ª" || item.subject === "×‘×™×œ×•×™ ×œ×™×œ×™" || item.subject === "×¡×¤×•×¨×˜/×›×•×©×¨" || item.subject === "×¤×’×™×©×”" || item.subject === "×‘×™×§×•×¨/×¡×™×•×¨" || (item.subject === "××•×›×œ" && (item.foodType === "××¡×¢×“×”" || item.foodType === "×‘×™×ª ×§×¤×”" || item.foodType === "××•×›×œ ××”×™×¨/×“×•×›×Ÿ") && item.foodLocation));
                let navButtonHtml = "";
                 if (hasLocation && (item.toAddress || item.location || item.foodLocation)) {
                     navButtonHtml = `<button class="btn nav-button" onclick="event.stopPropagation(); navigateItem(${itemIndex})" title="× ×•×•×˜ ×œ×™×¢×“"><i class="fas fa-directions"></i></button>`;
                 }

                 // ×™×¦×™×¨×ª ××œ×× ×˜ ×”-HTML
                 const itemDiv = document.createElement('div');
                 itemDiv.className = 'schedule-item';
                 itemDiv.setAttribute('data-date', item.date);
                 itemDiv.setAttribute('data-subject', item.subject);
                 itemDiv.onclick = () => showItemDetail(itemIndex); // ×¤×ª×™×—×ª ×¤×¨×˜×™× ×‘×œ×—×™×¦×”

                 itemDiv.innerHTML = `
                     ${navButtonHtml}
                     <span class="item-action-icon delete-icon" title="××—×§ ×¤×¨×™×˜" onclick="deleteScheduleItem(${itemIndex}, event)">ğŸ—‘ï¸</span>
                     <div class="emoji-background">${bgEmoji}</div>
                     <h3>${item.startTime} - ${item.endTime} : ${displaySubject}</h3>
                     ${extraLine}
                     ${addressLine}
                      ${item.description ? `<p style="font-size: 0.9em; color: #555; margin-top: 8px;">${item.description.replace(/\n/g, '<br>')}</p>` : ''}
                 `;
                 container.appendChild(itemDiv);
             });
        });
    }


    // ----- × ×™×•×•×˜ (Google Maps) -----

     function checkRoute() { // ×¤×ª×™×—×ª ×’×•×’×œ ××¤×•×ª ×œ×‘×“×™×§×ª ××¡×œ×•×œ ××”××•×“×œ
        const from = document.getElementById("fromAddress").value.trim();
        const to = document.getElementById("toAddress").value.trim();
        const subject = document.getElementById("modalSubject").value;

        if (!from || !to) {
            alert("×× × ××œ× ××ª ×›×ª×•×‘×ª ×”×”×ª×—×œ×” ×•×”×™×¢×“ ×œ×‘×“×™×§×ª ×”××¡×œ×•×œ.");
            return;
        }

        let travelModeParam = "";
        if (subject === "× ×¡×™×¢×”") {
            const mode = document.getElementById("travelModeSelect").value;
            if (mode === "car" || mode === "taxi") { travelModeParam = "&travelmode=driving"; }
            else if (mode === "transit") { travelModeParam = "&travelmode=transit"; }
            else if (mode === "walk") { travelModeParam = "&travelmode=walking"; }
        } else if (subject === "×”×œ×™×›×”") {
            travelModeParam = "&travelmode=walking";
        }

        const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}${travelModeParam}`;
        window.open(url, "_blank");
    }

    function showLocationRoute() { // ×¤×ª×™×—×ª ×’×•×’×œ ××¤×•×ª ×œ××™×§×•× ××”××•×“×œ
         const location = document.getElementById("locationInput").value.trim();
         if (!location) {
            alert("×× × ×”×–×Ÿ ××™×§×•×.");
            return;
         }
         const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
         window.open(url, "_blank");
     }

     function showFoodRoute() { // ×¤×ª×™×—×ª ×’×•×’×œ ××¤×•×ª ×œ××§×•× ××•×›×œ ××”××•×“×œ
         const location = document.getElementById("foodLocationInput").value.trim();
         if (!location) {
            alert("×× × ×”×–×Ÿ ××ª ××™×§×•× ××§×•× ×”××•×›×œ.");
            return;
         }
         const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
         window.open(url, "_blank");
     }


    function navigateItem(index) { // × ×™×•×•×˜ ××¤×¨×™×˜ ×§×™×™× ×‘×œ×•"×–
        if (index < 0 || index >= scheduleItems.length) return;
        const item = scheduleItems[index];
        let destination = "";
        let travelMode = "";

        // ×§×‘×¢ ×™×¢×“ ×•××•×¤×Ÿ × ×¡×™×¢×”
        if ((item.subject === "× ×¡×™×¢×”" || item.subject === "×”×œ×™×›×”") && item.toAddress) {
            destination = item.toAddress;
            if (item.subject === "× ×¡×™×¢×”") {
                 const mode = item.travelMode;
                 if (mode === "car" || mode === "taxi") { travelMode = "driving"; }
                 else if (mode === "transit") { travelMode = "transit"; }
                 else if (mode === "walk") { travelMode = "walking"; }
            } else { // ×”×œ×™×›×”
                travelMode = "walking";
            }
        } else if ((item.subject === "×‘×™×§×•×¨/×¡×™×•×¨" || item.subject === "×™×" || item.subject === "×§× ×™×•×ª" || item.subject === "×‘×™×œ×•×™ ×œ×™×œ×™" || item.subject === "×¡×¤×•×¨×˜/×›×•×©×¨" || item.subject === "×¤×’×™×©×”") && item.location) {
            destination = item.location;
            // ××¤×©×¨ ×œ×§×‘×•×¢ travelMode=driving ×›×‘×¨×™×¨×ª ××—×“×œ ××• ×œ×©××•×œ ××ª ×”××©×ª××©
            travelMode = "driving";
        } else if (item.subject === "××•×›×œ" && item.foodLocation) {
             destination = item.foodLocation;
             travelMode = "driving"; // ×‘×¨×™×¨×ª ××—×“×œ
        }

        if (!destination) {
            alert("×œ× × ××¦× ×™×¢×“ ×œ× ×™×•×•×˜ ×¢×‘×•×¨ ×¤×¨×™×˜ ×–×”.");
            return;
        }

        // ×©××œ ×× ×œ× ×•×•×˜ ××”××™×§×•× ×”× ×•×›×—×™ ××• ×× ×§×•×“×ª ×”××•×¦× (×× ×¨×œ×•×•× ×˜×™)
        let originParam = ""; // × ×™×•×•×˜ ××”××™×§×•× ×”× ×•×›×—×™ ×›×‘×¨×™×¨×ª ××—×“×œ
        if ((item.subject === "× ×¡×™×¢×”" || item.subject === "×”×œ×™×›×”") && item.fromAddress) {
             if (!confirm("×”×× ×œ× ×•×•×˜ ××”××™×§×•× ×”× ×•×›×—×™ ×©×œ×š?\n(×œ×—×¥ '×‘×™×˜×•×œ' ×›×“×™ ×œ× ×•×•×˜ ×: " + item.fromAddress + ")")) {
                originParam = `&origin=${encodeURIComponent(item.fromAddress)}`;
             }
        }

        const travelModeParam = travelMode ? `&travelmode=${travelMode}` : "";
        const url = `https://www.google.com/maps/dir/?api=1${originParam}&destination=${encodeURIComponent(destination)}${travelModeParam}`;
        window.open(url, "_blank");

    }

    // ----- ×”×¢×ª×§×” ×•×©×™×ª×•×£ -----

    function captureScreenshotFromElement(elementId, name) {
        const elem = document.getElementById(elementId);
        if (!elem) {
            console.error("Element not found for screenshot:", elementId);
            alert("×©×’×™××” ×‘×¦×™×œ×•× ×”××¡×š: ×”××œ×× ×˜ ×œ× × ××¦×.");
            return;
        }
         // ×”×•×¡×¤×ª ×¨×§×¢ ×œ×‘×Ÿ ×–×× ×™ ×œ××œ×× ×˜ ×œ×¦×™×œ×•× × ×§×™ ×™×•×ª×¨
         const originalBg = elem.style.backgroundColor;
         elem.style.backgroundColor = '#FFFFFF'; // ×¨×§×¢ ×œ×‘×Ÿ
         elem.style.padding = '20px'; // ×¨×™×•×•×— ×¤× ×™××™ ×œ×¦×™×œ×•×

         const loader = document.getElementById("loader");
         const loaderText = document.getElementById("loaderText");
         loaderText.innerText = '××›×™×Ÿ ×¦×™×œ×•× ××¡×š... ğŸ“¸';
         loader.style.display = 'flex';

        html2canvas(elem, {
             scale: 1.5, // ×”×’×“×œ×ª ×”×¨×–×•×œ×•×¦×™×” ×œ×—×“×•×ª ×˜×•×‘×” ×™×•×ª×¨
             useCORS: true, // × ×“×¨×© ×× ×™×© ×ª××•× ×•×ª ×—×™×¦×•× ×™×•×ª (×›××• ×××•×’'×™ ××• ×¨×§×¢)
             backgroundColor: '#ffffff' // ×¨×§×¢ ×œ×‘×Ÿ ×œ×§× ×‘×¡
        }).then(canvas => {
             // ×”×—×–×¨×ª ×”×¡×’× ×•×Ÿ ×”××§×•×¨×™
             elem.style.backgroundColor = originalBg;
             elem.style.padding = '';
             loader.style.display = 'none';

            canvas.toBlob(function(blob) {
                if (blob) {
                   const link = document.createElement("a");
                   const safeName = (name || "×œ×•×–_×–××Ÿ_×–×”×‘").replace(/[^a-zA-Z0-9×-×ª\s\-]/g, '_'); // × ×§×” ×©× ×§×•×‘×¥
                   link.download = safeName + ".png";
                   link.href = URL.createObjectURL(blob);
                   link.click();
                   URL.revokeObjectURL(link.href); // ×©×—×¨×•×¨ ×”-URL
                } else {
                     alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×§×•×‘×¥ ×”×ª××•× ×”.");
                }
            }, 'image/png'); // ×©××™×¨×” ×›-PNG
        }).catch(err => {
             // ×”×—×–×¨×ª ×”×¡×’× ×•×Ÿ ×”××§×•×¨×™ ×’× ×‘××§×¨×” ×©×’×™××”
             elem.style.backgroundColor = originalBg;
             elem.style.padding = '';
             loader.style.display = 'none';
             console.error("Error capturing screenshot:", err);
             alert("×©×’×™××” ×‘×ª×”×œ×™×š ×¦×™×œ×•× ×”××¡×š: " + err.message);
        });
    }


    function copyScheduleToClipboard() {
         if (!scheduleName || scheduleItems.length === 0) {
             alert("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ×œ×•\"×– ×¨×™×§ ××• ×œ×œ× ×©×.");
             return;
         }
         const text = generateScheduleText(scheduleItems, scheduleName.replace("", ""));
         navigator.clipboard.writeText(text).then(() => {
             alert("×”×œ×•\"×– ×”×•×¢×ª×§ ×œ×œ×•×— ×”×”×•×“×¢×•×ª!");
         }).catch(err => {
             console.error("Clipboard copy failed:", err);
             alert("×”×¢×ª×§×” × ×›×©×œ×”. ×™×™×ª×›×Ÿ ×©×”×“×¤×“×¤×Ÿ ×©×œ×š ××™× ×• ×ª×•××š ×‘×¤×¢×•×œ×” ×–×• ××• ×©× ×“×¨×©×ª ×”×¨×©××”.");
             // ×’×™×‘×•×™: ×”×¦×’×ª ×”×˜×§×¡×˜ ×œ××©×ª××© ×œ×”×¢×ª×§×” ×™×“× ×™×ª
             prompt("×”×¢×ª×§×” ××•×˜×•××˜×™×ª × ×›×©×œ×”. × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ×™×“× ×™×ª:", text);
         });
     }

    function generateScheduleText(items, name) {
        let text = `*${name}*\n\n`; // ×©× ×”×œ×•"×– ××•×“×’×©
        const groups = groupItemsByDate(items);
        const sortedDates = Object.keys(groups).sort((a, b) => new Date(a) - new Date(b)); // ××™×•×Ÿ ×ª××¨×™×›×™×

        sortedDates.forEach(date => {
            text += `*ğŸ“… ${formatDateHeader(date)}*\n--------------------\n`; // ×›×•×ª×¨×ª ×ª××¨×™×š ×¢× ×§×• ×ª×—×ª×•×Ÿ
             const sortedItems = groups[date].sort((a, b) => a.startTime.localeCompare(b.startTime)); // ××™×•×Ÿ ×œ×¤×™ ×©×¢×”

             sortedItems.forEach(item => {
                const displaySubject = getDisplaySubject(item); // ×©× ×”× ×•×©× + ×××•×’'×™
                text += `*${item.startTime} - ${item.endTime} : ${displaySubject}*\n`;

                 // ×¤×¨×˜×™× × ×•×¡×¤×™× ×œ×¤×™ × ×•×©×
                 if (item.subject === "×˜×™×¡×”") {
                    text += ` ×—×‘': ${item.airline || ''}, ××¡': ${item.flightNumber || ''}\n`;
                    text += ` *${item.departureAirport || ''}* â¬…ï¸ *${item.arrivalAirport || ''}*\n`;
                    // ××¤×©×¨ ×œ×”×•×¡×™×£ ×–×× ×™× ××œ××™× ×× ×¨×•×¦×™×:
                    // text += ` ×”××¨××”: ${item.departureTime}, × ×—×™×ª×”: ${item.arrivalTime}\n`;
                 } else if ((item.subject === "× ×¡×™×¢×”" || item.subject === "×”×œ×™×›×”") && item.fromAddress && item.toAddress) {
                     text += ` ×: ${item.fromAddress}\n ××œ: ${item.toAddress}\n`;
                     if (item.subject === "× ×¡×™×¢×”" && item.travelMode) {
                         text += ` (${translateTravelMode(item.travelMode)})\n`;
                     }
                 } else if ((item.subject === "×‘×™×§×•×¨/×¡×™×•×¨" || item.subject === "×™×" || item.subject === "×§× ×™×•×ª" || item.subject === "×‘×™×œ×•×™ ×œ×™×œ×™" || item.subject === "×¡×¤×•×¨×˜/×›×•×©×¨" || item.subject === "×¤×’×™×©×”") && item.location) {
                     text += ` ××™×§×•×: ${item.location}\n`;
                 } else if (item.subject === "××•×›×œ" && item.foodLocation) {
                     text += ` ××™×§×•×: ${item.foodLocation}\n`;
                 }

                 // ×ª×™××•×¨ (×× ×§×™×™×)
                 if (item.description) {
                     text += ` ~ ${item.description}\n`;
                 }
                 text += "\n"; // ×¨×•×•×— ×‘×™×Ÿ ×¤×¨×™×˜×™×
            });
            text += "\n"; // ×¨×•×•×— ×‘×™×Ÿ ×™××™×
        });
        return text;
    }


    // ----- ××ª×—×•×œ ×‘×¢×ª ×˜×¢×™× ×ª ×”×“×£ -----
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM fully loaded and parsed");
         // ×‘×“×•×§ ×× ×”××©×ª××© ×›×‘×¨ ××—×•×‘×¨ (×™×™×ª×›×Ÿ ×©-onAuthStateChanged ×™×¨×•×¥ ×œ×¤× ×™ ××• ××—×¨×™)
         if (auth.currentUser) {
             loadUserData(auth.currentUser.uid);
         } else {
             // ×˜×¢×Ÿ × ×•×©××™× ×§×‘×•×¢×™× ×-LocalStorage ×× ×œ× ××—×•×‘×¨
             permanentSubjects = JSON.parse(localStorage.getItem('permanentSubjects')) || [];
             updateSubjectDropdownOptions();
         }
         renderScheduleItems(); // × ×¡×” ×œ×¨× ×“×¨ (×™×”×™×” ×¨×™×§ ×× ×œ× × ×˜×¢×Ÿ ×›×œ×•×)
          // ×”×•×¡×¤×ª event listener ×œ×¡×’×™×¨×ª ×¨×©×™××ª ×”× ×•×©××™× ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×”
          // × ×¢×©×” ×‘×ª×•×š togglePermanentSubjectsList ×›×“×™ ×œ×”×‘×˜×™×— ×©×”×¨×©×™××” ×§×™×™××ª
     });

  </script>
</body>
</html>