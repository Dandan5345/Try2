<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>זמן זהב - בניית לוז חופשה</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://i.imgur.com/GaYFAp1.png" type="image/png">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script src="firebase-config.js"></script>

  <script>
    // אתחול Firebase - ודא ש-firebaseConfig נטען מהקובץ החיצוני
    if (typeof firebaseConfig !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        const db = firebase.firestore();
    } else {
        // שגיאה קריטית - הקובץ firebase-config.js לא נטען או ריק
        alert("שגיאה קריטית: לא ניתן לטעון את הגדרות Firebase.");
        console.error("Firebase config is missing!"); // נשאיר את זה למקרה קריטי
    }
  </script>

  <script>
    // רישום Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
          .then(function(registration) {
            // Service Worker registered
          })
          .catch(function(err) {
            // registration failed :(
          });
      });
    }
  </script>

  <style>
    /* Reset בסיסי */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      /* --- רקע חופשה --- */
      background: url("https://i.imgur.com/vPycdhd.jpeg") no-repeat center center fixed;
      background-size: cover;
      /* ------------------- */
      direction: rtl;
      padding-top: 70px; /* התאמה לגובה ההדר החדש */
      padding-bottom: 60px;
      text-align: center;
      color: #333; /* צבע טקסט בסיסי לקריאות */
      min-height: 100vh;
    }

    /* --- סגנונות הדר ותפריט צד (עקביים) --- */
    .topbar {
      background-color: #0A2342; /* כחול כהה נשמר לעקביות */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      transition: transform 0.3s ease;
      border-bottom: 3px solid #2A558C;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .site-name {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 26px;
      color: #ecf0f1;
      cursor: pointer;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    .hamburger-menu {
      font-size: 24px;
      color: #ecf0f1;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 5px;
      transition: background-color 0.3s;
      z-index: 1002;
    }
    .hamburger-menu:hover { background-color: rgba(255, 255, 255, 0.15); }
    .auth-button {
      background-color: #007bff; /* כחול סטנדרטי להתחברות */
      padding: 8px 16px;
      border-radius: 6px;
      transition: background-color 0.3s, box-shadow 0.3s;
      font-weight: 600;
      color: #FFFFFF;
      border: none;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.95em;
    }
    .auth-button:hover { background-color: #0056b3; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    .side-menu {
      position: fixed; top: 0; right: -280px; width: 280px; height: 100%;
      background-color: #0A2342; z-index: 1001; padding-top: 70px;
      transition: right 0.3s ease; box-shadow: -3px 0 8px rgba(0, 0, 0, 0.15);
    }
    .side-menu.active { right: 0; }
    .close-menu {
      position: absolute; top: 15px; left: 15px; font-size: 26px; color: #ecf0f1;
      cursor: pointer; padding: 5px; line-height: 1;
    }
    .close-menu:hover { color: #bdc3c7; }
    .side-menu-links { display: flex; flex-direction: column; padding: 10px 0; }
    .side-menu-links a {
      padding: 16px 25px; color: #ecf0f1; text-decoration: none; font-size: 17px;
      border-bottom: 1px solid rgba(236, 240, 241, 0.15); transition: background-color 0.2s ease-in-out;
      text-align: right; display: flex; align-items: center;
    }
    .side-menu-links a i { margin-left: 12px; width: 20px; text-align: center; font-size: 0.95em; }
    .side-menu-links a:last-child { border-bottom: none; }
    .side-menu-links a:hover { background-color: rgba(42, 85, 140, 0.5); }
    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.55); z-index: 1000; display: none;
      transition: opacity 0.3s ease; opacity: 0;
    }
    .overlay.active { display: block; opacity: 1; }
    /* --- סוף סגנונות הדר ותפריט צד --- */


    /* --- סגנונות תוכן עמוד בניית לוז חופשה --- */
    main {
      padding: 25px;
      margin: 30px auto;
      min-height: calc(100vh - 190px);
      /* רקע שקוף-לבן לקריאות מעל התמונה */
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); /* צל מודגש יותר */
      max-width: 900px; /* רוחב מוגדל */
      text-align: center;
    }

    main h2 {
      font-size: 2.5em;
      color: #17a2b8; /* צבע טורקיז לכותרת */
      margin-bottom: 15px;
      font-weight: 600;
    }
    main p { /* טקסט הסבר */
        color: #555;
        font-size: 1.1em;
        margin-bottom: 25px;
    }

     /* כפתורים */
    .btn {
      display: inline-flex; /* שימוש ב-flex ליישור אייקון וטקסט */
      align-items: center;
      justify-content: center; /* מרכוז תוכן בכפתור */
      gap: 8px;
      padding: 10px 25px; /* ריווח פנימי מוגדל */
      /* --- צבעי חופשה לכפתור --- */
      background-color: #17a2b8; /* טורקיז ראשי */
      color: #fff;
      /* ----------------------- */
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      border-radius: 6px;
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
      margin: 5px;
      text-decoration: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }
    .btn:hover {
      background-color: #138496; /* טורקיז כהה יותר בהובר */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }
     .btn:active {
         transform: translateY(0);
     }
     .btn i { /* אייקון בתוך כפתור */
         font-size: 0.9em;
         line-height: 1;
     }
      /* כפתור הוספה '+' גדול יותר */
      .action-buttons .btn {
          font-size: 24px;
          padding: 8px 18px;
          line-height: 1;
      }

     /* קבוצת כפתורים (שמור, צילום מסך וכו') */
     .button-group {
        margin-top: 30px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
    }

    /* עיצוב פריטי הלוז שנוספו */
    #scheduleContainer h3 { /* כותרת תאריך */
        color: #007bff; /* כחול לכותרת תאריך */
        margin-top: 25px;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
        font-size: 1.3em;
        font-weight: 600;
    }
    .schedule-item {
      position: relative;
      background-color: #ffffff; /* רקע לבן אטום לפריט */
      padding: 15px;
      margin: 15px auto; /* הגדלת רווח */
      border-radius: 8px; /* פינות מעוגלות יותר */
      box-shadow: 0 3px 7px rgba(0,0,0,0.1); /* צל בולט יותר */
      cursor: pointer;
      text-align: right; /* יישור לימין */
      max-width: 500px; /* רוחב מקסימלי לפריט */
      transition: transform 0.2s, box-shadow 0.2s;
      overflow: hidden; /* מניעת גלישת אמוג'י רקע */
       border-left: 5px solid #17a2b8; /* פס טורקיז בצד */
    }
    .schedule-item:hover {
        transform: translateY(-3px); /* אפקט הרמה קל */
        box-shadow: 0 5px 12px rgba(0,0,0,0.15);
    }
    .schedule-item h3 { /* כותרת פריט (זמן + נושא) */
      margin-bottom: 8px;
      color: #34495e; /* צבע כהה לכותרת */
      position: relative;
      z-index: 1;
      font-size: 1.1em;
      font-weight: 600;
    }
    .schedule-item p { /* תיאור ופרטים נוספים */
      position: relative;
      z-index: 1;
      color: #555;
      font-size: 0.95em;
      line-height: 1.5;
      margin-bottom: 5px; /* רווח בין שורות טקסט */
    }
     .schedule-item p:last-child {
         margin-bottom: 0;
     }
     /* כפתור מחיקה לפריט */
     .schedule-item span[onclick*="deleteScheduleItem"] {
         position: absolute;
         top: 10px;
         left: 10px; /* מיקום בצד שמאל */
         cursor: pointer;
         font-size: 1.2em;
         color: #e74c3c;
         padding: 5px;
         transition: color 0.2s;
         z-index: 2; /* מעל האמוג'י */
     }
      .schedule-item span[onclick*="deleteScheduleItem"]:hover {
         color: #c0392b;
     }


    /* רקע אמוג'י לפריט */
    .emoji-background {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 80px; /* גודל מותאם */
      opacity: 0.07; /* שקיפות מותאמת */
      pointer-events: none;
      z-index: 0;
    }

    /* כפתור ניווט בתוך פריט */
    .nav-button {
      position: absolute;
      left: 10px;
      bottom: 10px;
      font-size: 12px;
      padding: 4px 10px; /* ריווח מוקטן */
      background-color: #6c757d; /* צבע אפור לכפתור ניווט */
      z-index: 2;
    }
     .nav-button:hover {
        background-color: #5a6268;
     }

    /* עיצוב מודלים (חלונות קופצים) */
    .modal {
      display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.6); /* רקע שחור שקוף יותר */
      align-items: center; /* מרכוז אנכי */
      justify-content: center; /* מרכוז אופקי */
       padding: 20px; /* ריווח מהקצוות במסכים קטנים */
    }
    .modal-content {
      background-color: #ffffff; /* רקע לבן אטום */
      margin: auto; /* מרכוז */
      padding: 25px 30px; /* ריווח פנימי */
      border-radius: 8px;
      width: 90%;
      max-width: 550px; /* רוחב מקסימלי למודל */
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      text-align: right; /* יישור טקסט לימין */
       animation: fadeInScale 0.3s ease-out; /* אנימציית כניסה */
    }
     @keyframes fadeInScale {
         from { opacity: 0; transform: scale(0.95); }
         to { opacity: 1; transform: scale(1); }
     }

    .modal-content h2 {
       text-align: center; /* כותרת ממורכזת במודל */
       color: #17a2b8; /* צבע טורקיז */
       margin-bottom: 25px;
       font-size: 1.8em;
    }

    .close { /* כפתור סגירה (X) */
      color: #aaa; position: absolute; left: 15px; top: 10px;
      font-size: 30px; font-weight: bold; cursor: pointer; line-height: 1;
    }
    .close:hover { color: #333; }

    .form-group { margin-bottom: 18px; text-align: right; } /* הגדלת רווח ויישור */
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #495057;}
     .form-group label small { font-weight: normal; color: #6c757d; display: block; font-size: 0.85em;}
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px;
      font-size: 16px; color: #495057; background-color: #f8f9fa; /* רקע בהיר לשדות */
      text-align: right;
       transition: border-color 0.2s, box-shadow 0.2s;
    }
     .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
         border-color: #17a2b8; /* צבע גבול בפוקוס */
         box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25); /* צל עדין בפוקוס */
         outline: none;
     }
     /* עיצוב מיוחד ל-select */
     .form-group select {
       /* appearance: none; הסרת מראה ברירת מחדל */
       background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ced4da%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
       background-repeat: no-repeat;
       background-position: left 0.75rem center;
       background-size: 8px 10px;
       padding-left: 2rem; /* ריווח לחץ */
     }
      /* כפתור הצגת רשימת נושאים קבועים */
      #subjectsToggleBtn {
          background: none; border: 1px solid #ced4da; font-size: 20px; cursor: pointer;
          padding: 5px 8px; line-height: 1; border-radius: 4px; color: #6c757d;
          margin-right: 5px; /* רווח מה-select */
          vertical-align: middle;
      }
      #subjectsToggleBtn:hover { background-color: #e9ecef; }
      /* רשימת נושאים קבועים */
      #permanentSubjectsList {
          display: none; position: absolute; right: 0; top: 40px; /* מיקום מתחת לכפתור */
          background: #fff; border: 1px solid #ccc; border-radius: 6px;
          padding: 8px; z-index: 2100; /* מעל תוכן המודל */
          min-width: 200px; max-height: 150px; overflow-y: auto;
          box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      }
       #permanentSubjectsList span { /* עיצוב פריט ברשימה */
            display: flex; justify-content: space-between; align-items: center;
            margin: 3px 0; padding: 6px 10px; background-color: #f8f9fa;
            border-radius: 4px; font-size: 0.95em;
        }
        #permanentSubjectsList span span { cursor: pointer; color: #e74c3c; padding: 0 5px;}
        #permanentSubjectsList span span:hover { color: #c0392b; }


    /* עיצוב מיוחד למודל שם הלוז, תוצאות טיסה, וכו' */
    .modal-elegant { border-top: 5px solid #17a2b8; } /* פס טורקיז עליון */
    .modal-elegant h2 { color: #17a2b8; } /* כותרת טורקיז */
     /* התאמת צבע כפתורים בתוך מודלים */
    .modal-content .btn {
        background-color: #17a2b8; /* טורקיז */
    }
     .modal-content .btn:hover {
         background-color: #138496; /* טורקיז כהה */
     }
     /* כפתורי הוספה חד/רב פעמית במודל הוספת נושא */
      #addSubjectModal .form-group { margin-top: 25px; }


    /* תוצאות חיפוש טיסה */
    #flightResultContent { max-height: 300px; overflow-y: auto; margin-bottom: 15px; text-align: right;}
    .flight-card {
        background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px;
        padding: 15px; margin-bottom: 10px;
    }
    .flight-card h2 { font-size: 1.3em; margin-bottom: 10px; color: #17a2b8;}
    .flight-card p { font-size: 0.95em; margin-bottom: 5px; color: #333;}
     .flight-card p .time-label { font-weight: 600; color: #555;}

     /* שדה חיפוש טיסה עם אייקון */
    .flight-search-wrapper { position: relative; }
    .flight-search-wrapper input { padding-left: 40px !important; } /* Ensure padding for icon */
    .flight-search-wrapper .search-icon {
      position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
      cursor: pointer; color: #6c757d; font-size: 1.1em;
    }


    /* מודל תצוגת לוז סופי */
    #finalScheduleModal .modal-content { max-width: 700px; } /* רוחב גדול יותר */
    #finalScheduleDisplay { max-height: 60vh; overflow-y: auto; margin-bottom: 20px; }
    #finalScheduleDisplay .schedule-item { max-width: 100%; border-left: none; cursor: default; } /* התאמות לתצוגה סופית */
     #finalScheduleDisplay .schedule-item:hover { transform: none; box-shadow: 0 3px 7px rgba(0,0,0,0.1); }
    #finalScheduleTitle { /* שם הלוז בתצוגה הסופית */
        font-size: 1.8em; color: #17a2b8; margin-bottom: 20px; text-align: center;
    }


    /* Loader overlay (כללי - ישמש גם לטעינת דף) */
    .loader-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.75); color: #fff;
      display: flex; /* יוצג בהתחלה */
      align-items: center;
      justify-content: center; font-size: 1.6rem; z-index: 3000;
       flex-direction: column; gap: 15px;
       /* display: none; יוסתר ע"י JS כשהדף מוכן */
    }
     .loader-overlay i { /* סגנון לאייקון ב-loader */
        font-size: 2.5em;
        animation: spin 1.5s linear infinite;
     }
     @keyframes spin {
         0% { transform: rotate(0deg); }
         100% { transform: rotate(360deg); }
     }


    /* רספונסיביות */
    @media (max-width: 768px) {
        body { padding-top: 60px; }
        main { padding: 20px; margin: 20px auto; max-width: 95%; }
        main h2 { font-size: 2em; }
         .modal-content { padding: 20px; }
         .modal-content h2 { font-size: 1.5em; }
    }
    @media (max-width: 600px) {
        .auth-button { padding: 7px 12px; font-size: 0.9em;}
        .side-menu { width: 250px; }
        .side-menu-links a { padding: 14px 20px; font-size: 16px; }
         .side-menu-links a i { margin-left: 10px; }

        main { padding: 15px; }
        main h2 { font-size: 1.8em; }
        main p { font-size: 1em; }
        .btn { font-size: 15px; padding: 9px 20px; }
        .action-buttons .btn { font-size: 22px; padding: 7px 16px; }
        .button-group { flex-direction: column; align-items: stretch; gap: 10px;}
         .button-group .btn { width: 100%; }

         .modal-content { width: 95%; padding: 15px 20px;}
         .form-group input, .form-group select, .form-group textarea { padding: 10px; font-size: 15px; }
         .schedule-item { padding: 12px; }
         .schedule-item h3 { font-size: 1em; }
         .schedule-item p { font-size: 0.9em; }

        footer { padding: 20px; }
    }
    /* --- סוף סגנונות תוכן --- */
  </style>
</head>
<body>

  <div class="loader-overlay" id="pageLoader">
    <i class="fas fa-spinner"></i>
    <span>טוען את זמן זהב...</span>
  </div>
  <div class="overlay" id="overlay"></div> <nav class="topbar">
    <div class="hamburger-menu" onclick="toggleMenu()">
      <i class="fas fa-bars"></i>
    </div>
    <div class="site-name" onclick="goHome()">זמן זהב</div>
    <a href="auth.html" id="authLink" class="auth-button">התחברות</a>
  </nav>

  <div class="side-menu" id="sideMenu">
    <div class="close-menu" onclick="toggleMenu()">
      <i class="fas fa-times"></i>
    </div>
    <div class="side-menu-links">
      <a href="choose-schedule.html"><i class="fas fa-calendar-plus"></i> לו״ז חדש</a>
      <a href="my-schedules.html"><i class="fas fa-folder-open"></i> הלוזי״ם שלי</a>
      <a href="tips.html"><i class="fas fa-lightbulb"></i> טיפים לניהול זמנים</a>
      <a href="how-to-use.html"><i class="fas fa-info-circle"></i> עזרה והסבר</a>
    </div>
  </div>

  <main id="content">
    <h2>בניית לוז חופשה חדש 🏖️</h2>
    <p>לחץ על כפתור ה-'+' כדי להוסיף פעילות, טיסה, נסיעה או ארוחה ללו"ז שלך.</p>
    <div class="action-buttons">
      <button class="btn" onclick="openAddItemModal()" title="הוסף פריט ללוז">+</button>
    </div>
    <div id="scheduleContainer">
      </div>
    <div class="button-group">
      <button class="btn" onclick="openFinalSchedule()">
          <i class="fas fa-save"></i> שמור וסיים לו״ז
        </button>
    </div>
  </main>

  <footer>©️doronnakache</footer>

  <div id="scheduleNameModal" class="modal">
    <div class="modal-content modal-elegant">
      <span class="close" onclick="closeScheduleNameModal()">×</span>
      <h2>הזן שם ללו״ז החופשה</h2>
      <div class="form-group">
        <label for="scheduleNameInput">שם הלו״ז:</label>
        <input type="text" id="scheduleNameInput" placeholder="למשל: חופשה ביוון - קיץ 2025">
      </div>
      <button class="btn" onclick="saveScheduleName()">המשך</button>
    </div>
  </div>

  <div id="addItemModal" class="modal">
    <div class="modal-content modal-elegant">
      <span class="close" onclick="closeAddItemModal()">×</span>
      <h2 id="addItemModalTitle">הוספת פריט ללו״ז</h2>
      <form id="addItemForm" style="display: contents;"> <div class="form-group">
            <label for="modalDate">תאריך:</label>
            <input type="date" id="modalDate">
          </div>
          <div class="form-group">
            <label for="modalStartTime" id="startTimeLabel">שעת התחלה:</label>
            <input type="time" id="modalStartTime" onchange="setDefaultEndTime()">
          </div>
          <div class="form-group">
            <label for="modalEndTime" id="endTimeLabel">שעת סיום:</label>
            <input type="time" id="modalEndTime">
          </div>
          <div id="timeNote" style="font-size: 0.9rem; color: #555; display: none; margin-bottom: 10px; text-align: center;"></div>
          <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
            <label for="modalSubject" style="flex-shrink: 0;">נושא:</label>
            <select id="modalSubject" onchange="subjectChangeHandler()" style="flex-grow: 1;"></select>
            <div style="position: relative; display: inline-block;">
              <button type="button" id="subjectsToggleBtn" onclick="togglePermanentSubjectsList()" title="נהל נושאים קבועים">⋮</button>
              <div id="permanentSubjectsList"></div>
            </div>
          </div>

          <div id="extraQuestions" style="display: none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
            <div class="form-group">
              <label for="fromAddress">מאיפה: <small>כתובת או מקום יציאה</small></label>
              <input type="text" id="fromAddress" placeholder="לדוגמה: שדה התעופה בן גוריון">
            </div>
            <div class="form-group">
              <label for="toAddress">לאן: <small>כתובת או מקום יעד</small></label>
              <input type="text" id="toAddress" placeholder="לדוגמה: מלון הילטון, אתונה">
            </div>
            <div class="form-group" id="travelModeGroup" style="display: none;">
              <label for="travelModeSelect">אמצעי נסיעה:</label>
              <select id="travelModeSelect">
                <option value="taxi">מונית 🚖</option>
                <option value="transit">תחב״צ 🚋🚆</option>
                <option value="car">רכב פרטי / שכור 🚙</option>
              </select>
            </div>
            <button type="button" class="btn" id="checkRouteBtn" onclick="checkRoute()" style="background-color: #6c757d;">
                <i class="fas fa-map-marker-alt"></i> בדוק מסלול במפות Google
              </button>
          </div>

          <div id="locationField" style="display:none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;" class="form-group">
            <label for="locationInput">מיקום: <small>הזן את שם המקום או הכתובת</small></label>
            <input type="text" id="locationInput" placeholder="לדוגמה: האקרופוליס, אתונה">
             <button type="button" class="btn" onclick="navigateToGenericLocation()" style="background-color: #6c757d; margin-top: 10px;">
                 <i class="fas fa-map-marker-alt"></i> נווט למיקום במפות Google
               </button>
          </div>
          <div id="foodExtraOptions" style="display:none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
            <div class="form-group">
              <label for="foodTypeSelect">סוג ארוחה / מקום:</label>
              <select id="foodTypeSelect" onchange="foodTypeChangeHandler()">
                <option value="">-- בחר --</option>
                <option value="מסעדה">מסעדה 👨‍🍳</option>
                <option value="בית קפה">בית קפה ☕</option>
                <option value="במלון">במלון 🏨</option>
                <option value="הכנה עצמית/קנייה בסופר">קניות/הכנה עצמית 🛒</option>
                <option value="אוכל מהיר">אוכל מהיר 🥙</option>
                <option value="פיקניק">פיקניק 🧺</option>
              </select>
            </div>
            <div id="foodLocationDiv" class="form-group" style="display:none;">
              <label for="foodLocationInput">שם המקום / מיקום:</label>
              <input type="text" id="foodLocationInput" placeholder="לדוגמה: Ta Karamanlidika tou Fani">
              <button type="button" class="btn" onclick="showFoodRoute()" style="background-color: #6c757d; margin-top: 10px;">
                  <i class="fas fa-map-marker-alt"></i> נווט למקום במפות Google
                </button>
            </div>
          </div>

          <div id="flightExtraOptions" style="display:none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
            <div class="form-group flight-search-wrapper">
              <label for="flightNumberInput">מספר טיסה:</label>
              <input type="text" id="flightNumberInput" placeholder="למשל: LY541">
              <span class="search-icon" onclick="searchFlight()" title="חפש פרטי טיסה">🔍</span>
            </div>
            <div class="form-group">
              <label for="airlineInput">חברת תעופה:</label>
              <input type="text" id="airlineInput" placeholder="לדוגמה: אל על">
            </div>
            <div class="form-group">
              <label for="departureAirportInput">שדה תעופה (המראה):</label>
              <input type="text" id="departureAirportInput" placeholder="לדוגמה: Ben Gurion Intl">
            </div>
            <div class="form-group">
              <label for="arrivalAirportInput">שדה תעופה (נחיתה):</label>
              <input type="text" id="arrivalAirportInput" placeholder="לדוגמה: Eleftherios Venizelos Intl Airport">
            </div>
          </div>

          <div class="form-group" id="descriptionGroup" style="display: none;">
            <label for="modalDescription">תיאור / הערות:</label>
            <textarea id="modalDescription" rows="3" placeholder="פרטים נוספים, כרטיסים, הזמנות וכו'"></textarea>
          </div>

          <button type="button" class="btn" id="addItemBtn" onclick="saveItem()" style="display: none;">
              <i class="fas fa-check"></i> הוסף / שמור שינויים
            </button>
      </form> </div>
  </div>

  <div id="flightResultModal" class="modal">
    <div class="modal-content modal-elegant">
      <span class="close" onclick="closeFlightResultModal()">×</span>
      <h2><i class="fas fa-plane-departure"></i> תוצאות חיפוש טיסה</h2>
      <div id="flightResultContent">
        </div>
      <button class="btn" onclick="copyFlightToForm()">
          <i class="fas fa-copy"></i> העתק פרטים לטופס
        </button>
    </div>
  </div>

  <div id="finalScheduleModal" class="modal">
    <div class="modal-content" id="finalScheduleContent">
      <span class="close" onclick="closeFinalScheduleModal()">×</span>
      <h2 id="finalScheduleTitle"></h2>
      <div id="finalScheduleDisplay"></div>
      <div class="button-group">
        <button class="btn" onclick="captureScreenshotFromElement('finalScheduleDisplay', scheduleName)">
            <i class="fas fa-camera"></i> צילום מסך
          </button>
        <button class="btn" onclick="copyScheduleToClipboard()">
            <i class="fas fa-copy"></i> העתק כטקסט
          </button>
        <button class="btn" onclick="editFinalSchedule()">
            <i class="fas fa-edit"></i> ערוך לו"ז
          </button>
        <button class="btn" onclick="closeFinalScheduleModal()" style="background-color: #6c757d;">
            <i class="fas fa-times"></i> סגור
          </button>
      </div>
    </div>
  </div>

  <div id="addSubjectModal" class="modal">
    <div class="modal-content modal-elegant">
      <span class="close" onclick="closeAddSubjectModal()">×</span>
      <h2>הוספת נושא חדש</h2>
      <div class="form-group">
        <label for="newSubjectNameInput">שם הנושא (מומלץ להוסיף אמוג'י):</label>
        <input type="text" id="newSubjectNameInput" placeholder="למשל: בטן-גב בחוף 🏖️">
      </div>
      <div class="form-group" style="display: flex; justify-content: space-around; gap: 10px;">
        <button class="btn" onclick="addSubjectOneTime()">
            <i class="fas fa-plus"></i> הוספה חד פעמית
          </button>
        <button class="btn" onclick="addSubjectPermanent()" style="background-color: #28a745;">
            <i class="fas fa-star"></i> הוספה קבועה
          </button>
      </div>
    </div>
  </div>

  <div class="loader-overlay" id="loader" style="display: none;"> <i class="fas fa-spinner"></i>
      <span>מחפש פרטי טיסה...</span>
    </div>


  <script>
    // --- גלובליים והגדרות ---
    const db = firebase.firestore(); // ודא ש-db מוגדר גלובלית אחרי האתחול
    const subjectEmojis = { // מילון אמוג'י לנושאים
      "הליכה": "🚶", "נסיעה": "🚗", "ביקור/סיור": "🏛️", "טיסה": "✈️",
      "אוכל": "🍽️", "שינה": "😴", "לקום": "⏰", "חוף": "🏖️",
      "קניות": "🛍️", "מנוחה": "🧘", "בריכה": "🏊", "אטרקציה": "🎢",
      "מוזיאון": "🖼️", "מסעדה": "👨‍🍳", "בית קפה": "☕", "במלון": "🏨",
      "קניות/הכנה עצמית": "🛒", "אוכל מהיר": "🥙", "פיקניק": "🧺",
      "כללי": "📌"
    };

    let scheduleItems = []; // מערך פריטי הלוז הנוכחי
    let scheduleName = null; // שם הלוז הנוכחי
    let savedSchedules = []; // לוזים שמורים מהמשתמש
    let editingIndex = -1; // אינדקס פריט בעריכה בתוך scheduleItems
    let editingSavedScheduleIndex = -1; // אינדקס לוז שמור בעריכה
    let permanentSubjects = JSON.parse(localStorage.getItem('permanentVacationSubjects') || '[]'); // נושאים קבועים
    let customSubjects = []; // נושאים חד-פעמיים לסשן

    // --- מצב טעינת דף ---
    let domReady = false;
    let authReady = false;

    // --- פונקציות ניווט ותפריט (ללא שינוי) ---
    function goHome() { window.location.href = "index.html"; }
    function toggleMenu() {
      const sideMenu = document.getElementById("sideMenu");
      const overlay = document.getElementById("overlay");
      const isActive = sideMenu.classList.contains("active");
      sideMenu.classList.toggle("active");
      overlay.classList.toggle("active");
      document.body.style.overflow = isActive ? "" : "hidden";
    }
    document.getElementById("overlay").addEventListener("click", toggleMenu);

    // --- פונקציה להסתרת מחוון טעינת דף ---
    function hidePageLoader() {
        if (domReady && authReady) {
            const loader = document.getElementById('pageLoader');
            if (loader) {
                loader.style.display = 'none';
            }
        }
    }

    // --- ניהול מצב אימות (Auth) ---
    firebase.auth().onAuthStateChanged(function(user) {
      const authLink = document.getElementById("authLink");
      if (user) {
        // עדכון ברכה
        let currentHour = new Date().getHours();
        let greeting = "בוקר טוב";
        if (currentHour >= 12 && currentHour < 18) greeting = "צהריים טובים";
        else if (currentHour >= 18) greeting = "ערב טוב";
        let firstName = user.displayName ? user.displayName.split(" ")[0] : user.email.split("@")[0];
        firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1);
        authLink.innerText = `${greeting}, ${firstName}!`;
        authLink.title = "התנתק";
        authLink.onclick = function(e) {
          e.preventDefault();
          if (confirm("האם אתה בטוח שברצונך להתנתק?")) {
            firebase.auth().signOut().catch(error => console.error("Sign out error", error)); // Keep critical errors
          }
        };
        authLink.href = "#";
        loadSavedSchedulesData(); // טען נתונים קיימים
        checkForScheduleToEdit(); // בדוק אם הגיע לוז לעריכה
      } else {
        authLink.innerText = "התחברות";
        authLink.title = "התחבר או הירשם";
        authLink.href = "auth.html";
        authLink.onclick = null;
        savedSchedules = []; // אפס לוזים שמורים אם לא מחובר
        scheduleName = null; // אפס שם לוז
        scheduleItems = []; // אפס פריטים
        editingSavedScheduleIndex = -1;
        // אם במקרה נפתח ממשק עריכה, החזר למצב ברירת מחדל
        if (!document.getElementById('scheduleNameModal').style.display || document.getElementById('scheduleNameModal').style.display === 'none') {
             renderInitialView();
        }
      }
      authReady = true; // סימון שסטטוס האימות נבדק
      hidePageLoader(); // נסה להסתיר את ה-Loader
    });

    // --- הסתרת/הצגת הדר בגלילה (ללא שינוי) ---
    let lastScrollTop = 0;
    window.addEventListener("scroll", function() {
      let currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      const nav = document.querySelector(".topbar");
      const sideMenu = document.getElementById("sideMenu");
      if (nav && (!sideMenu || !sideMenu.classList.contains("active"))) {
           if (currentScroll > lastScrollTop && currentScroll > 70) nav.style.transform = "translateY(-100%)";
           else nav.style.transform = "translateY(0)";
      }
      lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
    }, false);


    // --- פונקציות ספציפיות לדף בניית לוז חופשה ---

    function renderInitialView() {
        const content = document.getElementById('content');
        if(content) {
            content.innerHTML = `
                <h2>בניית לוז חופשה חדש 🏖️</h2>
                <p>לחץ על כפתור ה-'+' כדי להוסיף פעילות, טיסה, נסיעה או ארוחה ללו"ז שלך.</p>
                <div class="action-buttons">
                  <button class="btn" onclick="openAddItemModal()" title="הוסף פריט ללוז">+</button>
                </div>
                <div id="scheduleContainer">
                  </div>
                <div class="button-group">
                  <button class="btn" onclick="openFinalSchedule()">
                      <i class="fas fa-save"></i> שמור וסיים לו״ז
                    </button>
                </div>
            `;
            renderScheduleItems(); // רנדר (יהיה ריק בהתחלה)
        }
    }


     function loadSavedSchedulesData() {
         const user = firebase.auth().currentUser;
         if (user && db) { // Check if db is initialized
             db.collection("schedules").doc(user.uid).get().then((doc) => {
                 if (doc.exists && doc.data().schedules) {
                     savedSchedules = doc.data().schedules;
                 } else {
                     savedSchedules = [];
                 }
             }).catch(error => {
                 console.error("Error loading saved schedules data: ", error); // Keep critical errors
             });
         } else {
            savedSchedules = []; // Reset if no user or db error
         }
     }

     function checkForScheduleToEdit() {
         const scheduleDataString = localStorage.getItem('scheduleToEdit');
         if (scheduleDataString) {
             try {
                 const scheduleData = JSON.parse(scheduleDataString);
                 if (scheduleData && scheduleData.schedule && scheduleData.originalIndex !== undefined) {
                     scheduleName = scheduleData.schedule.name;
                     scheduleItems = JSON.parse(JSON.stringify(scheduleData.schedule.scheduleItems || []));
                     editingSavedScheduleIndex = scheduleData.originalIndex;

                     // עדכן את הכותרת והצג את הפריטים הקיימים
                     document.getElementById("content").innerHTML = `
                         <h2><i class="fas fa-edit"></i> עריכת לו"ז: ${scheduleName.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</h2>
                         <p>הוסף, ערוך או מחק פריטים בלו"ז.</p>
                         <div class="action-buttons">
                           <button class="btn" onclick="openAddItemModal()" title="הוסף פריט ללוז">+</button>
                         </div>
                         <div id="scheduleContainer"></div>
                         <div class="button-group">
                           <button class="btn" onclick="updateAndFinish()">
                               <i class="fas fa-save"></i> שמור שינויים וסיים
                             </button>
                            <button class="btn" onclick="window.location.href='my-schedules.html'" style="background-color: #6c757d;">
                                <i class="fas fa-times"></i> בטל שינויים וחזור
                            </button>
                         </div>
                     `;
                     renderScheduleItems();
                 } else {
                    renderInitialView(); // If data invalid, show initial view
                 }
             } catch (e) {
                 console.error("Error parsing schedule to edit from localStorage:", e); // Keep critical errors
                 renderInitialView(); // Show initial view on error
             } finally {
                 localStorage.removeItem('scheduleToEdit');
             }
         } else {
             // אם לא עורכים, ולא קיים כבר ממשק (למשל אחרי התנתקות), הצג ברירת מחדל
             const contentHtml = document.getElementById('content')?.innerHTML;
             if(!contentHtml || contentHtml.includes('בניית לוז חופשה חדש')) {
                 renderInitialView();
             }
         }
     }

     function updateAndFinish() {
         if (editingSavedScheduleIndex === -1 || !Array.isArray(savedSchedules) || editingSavedScheduleIndex >= savedSchedules.length) {
             alert("שגיאה: לא ניתן לעדכן לוז לא קיים או שהנתונים השמורים אינם תקינים.");
             return;
         }
         const updatedSchedule = { name: scheduleName, scheduleItems: JSON.parse(JSON.stringify(scheduleItems)), category: "חופשה" };
         savedSchedules[editingSavedScheduleIndex] = updatedSchedule;

         saveSchedulesToFirestore();

         let finalHtml = "";
         const groups = groupItemsByDate(scheduleItems);
         const sortedDates = Object.keys(groups).sort();
         sortedDates.forEach(date => {
             finalHtml += `<h3>${formatDateHeader(date)}</h3>`;
             groups[date].forEach(item => {
                 finalHtml += generateScheduleItemHTML(item, scheduleItems.findIndex(i => i === item), true);
             });
         });

         const finalScheduleModal = document.getElementById("finalScheduleModal");
         const finalScheduleTitle = document.getElementById("finalScheduleTitle");
         const finalScheduleDisplay = document.getElementById("finalScheduleDisplay");

         if(finalScheduleModal && finalScheduleTitle && finalScheduleDisplay) {
            finalScheduleTitle.innerText = scheduleName.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            finalScheduleDisplay.innerHTML = finalHtml;
             finalScheduleModal.style.display = "flex"; // Use flex for centering

            const editButton = finalScheduleModal.querySelector('.button-group button[onclick^="editFinalSchedule"]');
            if(editButton) {
                editButton.innerHTML = '<i class="fas fa-check"></i> הלוז עודכן'; // Use innerHTML for icon
                editButton.disabled = true;
                editButton.style.backgroundColor = "#28a745"; // Green for success
            }
         }

         editingSavedScheduleIndex = -1; // איפוס מצב עריכה
     }

     function generateScheduleItemHTML(item, index, isFinalView = false) {
         let displaySubject = getDisplaySubject(item);
         let bgEmoji = getBackgroundEmoji(item);
         let extraLine = getExtraLine(item);
         let addressLine = "";
         let locationLine = "";

         // קו כתובת לנסיעה/הליכה
         if (item.fromAddress && item.toAddress && (item.subject === "נסיעה" || item.subject === "הליכה")) {
             addressLine = `<p style="font-size: 0.9em; color: #666;"><i class="fas fa-map-marker-alt"></i> ${item.fromAddress} <i class="fas fa-arrow-right" style="font-size: 0.8em;"></i> ${item.toAddress}</p>`;
         }
         // קו מיקום גנרי (אם קיים ולא מטופל אחרת)
         else if (item.location && !['טיסה'].includes(item.subject) && !(item.subject === 'אוכל' && item.foodLocation)) {
             locationLine = `<p style="font-size: 0.9em; color: #666;"><i class="fas fa-map-marker-alt"></i> מיקום: ${item.location}</p>`;
         }
         // קו מיקום לאוכל (מהשדה הייעודי)
         else if (item.subject === 'אוכל' && item.foodLocation) {
              locationLine = `<p style="font-size: 0.9em; color: #666;"><i class="fas fa-map-marker-alt"></i> מקום: ${item.foodLocation}</p>`;
         }


         let deleteButtonHTML = isFinalView ? '' : `<span title="מחק פריט" style="position: absolute; top: 10px; left: 10px; cursor: pointer; font-size: 1.2em; color: #e74c3c; padding: 5px; transition: color 0.2s; z-index: 2;" onclick="event.stopPropagation(); deleteScheduleItem(${index})">🗑️</span>`;

         let navButtonHTML = "";
         if (!isFinalView) { // כפתור ניווט רק בתצוגת עריכה
             if((item.subject === "נסיעה" || item.subject === "הליכה") && item.fromAddress && item.toAddress) {
                 navButtonHTML = `<button type="button" class="btn nav-button" onclick="event.stopPropagation(); checkRoute(${index})"><i class="fas fa-route"></i></button>`;
             } else if(item.location && !['טיסה'].includes(item.subject) && !(item.subject === 'אוכל' && item.foodLocation)) { // ניווט למיקום גנרי
                 navButtonHTML = `<button type="button" class="btn nav-button" onclick="event.stopPropagation(); navigateToGenericLocation(${index})"><i class="fas fa-route"></i></button>`;
             } else if(item.subject === "אוכל" && item.foodLocation) { // ניווט למקום אוכל
                 navButtonHTML = `<button type="button" class="btn nav-button" onclick="event.stopPropagation(); showFoodRoute(${index})"><i class="fas fa-route"></i></button>`;
             }
         }

         const clickAction = isFinalView ? '' : `onclick="showItemDetail(${index})"`;

         return `
             <div class="schedule-item" ${clickAction} data-date="${item.date}" data-subject="${item.subject}">
                 ${deleteButtonHTML}
                 ${navButtonHTML}
                 <div class="emoji-background">${bgEmoji}</div>
                 <h3>${item.startTime || '??:??'} - ${item.endTime || '??:??'} : ${displaySubject}</h3>
                 ${extraLine ? `<p style="font-size: 0.9em; color: #444;">${extraLine}</p>` : ''}
                 ${addressLine}
                 ${locationLine}
                 <p>${item.description || ''}</p>
             </div>
           `;
     }


    function openAddItemModal() {
        const addItemForm = document.getElementById("addItemForm");
        if (!addItemForm) return; // Safety check

        if (editingSavedScheduleIndex === -1 && !scheduleName) { // אם יוצרים לוז חדש ואין שם
            const scheduleNameInput = document.getElementById("scheduleNameInput");
            const scheduleNameModal = document.getElementById("scheduleNameModal");
            if(scheduleNameInput) scheduleNameInput.value = '';
            if(scheduleNameModal) scheduleNameModal.style.display = "flex"; // Use flex
        } else { // אם יש שם לוז (חדש או ערוך)
            editingIndex = -1; // איפוס אינדקס עריכת פריט
            document.getElementById("addItemModalTitle").innerText = "הוספת פריט ללו״ז";
            document.getElementById("addItemBtn").innerHTML = '<i class="fas fa-plus"></i> הוסף פריט';
            addItemForm.reset(); // איפוס הטופס

            // קביעת תאריך ושעה ברירת מחדל
            const modalDateInput = document.getElementById("modalDate");
            const modalStartTimeInput = document.getElementById("modalStartTime");

            if (scheduleItems.length > 0) {
                const lastItem = scheduleItems[scheduleItems.length - 1];
                if (modalDateInput) modalDateInput.value = lastItem.date;
                const lastItemOnDate = scheduleItems.filter(item => item.date === lastItem.date).pop();
                if (lastItemOnDate && lastItemOnDate.endTime) {
                     if(modalStartTimeInput) modalStartTimeInput.value = addOneMinute(lastItemOnDate.endTime);
                } else {
                    if(modalStartTimeInput) modalStartTimeInput.value = "09:00";
                }
            } else {
                if (modalDateInput) modalDateInput.valueAsDate = new Date();
                if (modalStartTimeInput) modalStartTimeInput.value = "09:00";
            }
            setDefaultEndTime();
            updateSubjectDropdownOptions();
            updatePermanentSubjectsList();
            subjectChangeHandler(); // אפס שדות לפי נושא ריק
            document.getElementById("addItemModal").style.display = "flex"; // הצג מודל
        }
    }

    function closeAddItemModal() {
        const modal = document.getElementById("addItemModal");
        if (modal) modal.style.display = "none";
    }
    function closeScheduleNameModal() {
        const modal = document.getElementById("scheduleNameModal");
        if (modal) modal.style.display = "none";
    }

    function saveScheduleName() {
      const nameInput = document.getElementById("scheduleNameInput")?.value.trim();
      if (!nameInput) { alert("אנא הזן שם ללו״ז."); return; }
      if (savedSchedules.some((sch, idx) => sch.name === nameInput && idx !== editingSavedScheduleIndex)) {
          alert("לוז עם שם זה כבר קיים. אנא בחר שם אחר."); return;
      }
      scheduleName = nameInput;
      closeScheduleNameModal();

      // עדכן כותרת עמוד
      const contentArea = document.getElementById("content");
      if(contentArea) {
          const titleElement = contentArea.querySelector('h2');
          if (titleElement) {
              titleElement.innerHTML = `<i class="fas fa-umbrella-beach"></i> לו"ז: ${scheduleName.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`;
          } else {
              // אם אין כותרת קיימת (למקרה שה-DOM השתנה), צור אותה מחדש
              renderInitialView(); // יצור מחדש את המבנה עם הכותרת
              const newTitleElement = contentArea.querySelector('h2');
              if(newTitleElement) newTitleElement.innerHTML = `<i class="fas fa-umbrella-beach"></i> לו"ז: ${scheduleName.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`;
          }
      }

       openAddItemModal(); // פתח אוטומטית מודל הוספה
    }


    function setDefaultEndTime() {
      const startTimeInput = document.getElementById("modalStartTime");
      const endTimeInput = document.getElementById("modalEndTime");
      if (!startTimeInput || !endTimeInput) return; // Safety check

      const startTime = startTimeInput.value;
      if (startTime) {
        let [h, m] = startTime.split(":").map(Number);
        h = (h + 1) % 24;
        const defaultEndTime = (h < 10 ? "0" + h : h) + ":" + (m < 10 ? "0" + m : m);
        if (!endTimeInput.value || endTimeInput.value === startTime) {
          endTimeInput.value = defaultEndTime;
        }
      }
    }

    function addOneMinute(timeStr) {
      if (!timeStr || !timeStr.includes(':')) return "09:00";
      let [h, m] = timeStr.split(":").map(Number);
      m++;
      if (m >= 60) { m = 0; h = (h + 1) % 24; }
      return (h < 10 ? "0" + h : h) + ":" + (m < 10 ? "0" + m : m);
    }


    function saveItem() {
      let dateValue = document.getElementById("modalDate")?.value;
      let startTime = document.getElementById("modalStartTime")?.value;
      let endTime = document.getElementById("modalEndTime")?.value;
      const subject = document.getElementById("modalSubject")?.value;
      const description = document.getElementById("modalDescription")?.value.trim();
      const location = document.getElementById("locationInput")?.value.trim(); // קריאת מיקום גנרי

      if (!dateValue) { alert("אנא בחר תאריך."); return; }
      if (!startTime || !endTime) { alert("אנא בחר שעת התחלה ושעת סיום."); return; }
      if (!subject) { alert("אנא בחר נושא."); return; }
       if (endTime <= startTime) {
          alert("שעת הסיום חייבת להיות מאוחרת משעת ההתחלה.");
          return;
       }

      const newItem = { date: dateValue, startTime, endTime, subject, description };

      // הוספת שדות ספציפיים + מיקום גנרי אם רלוונטי
      if (subject === "הליכה" || subject === "נסיעה") {
        newItem.fromAddress = document.getElementById("fromAddress")?.value.trim();
        newItem.toAddress = document.getElementById("toAddress")?.value.trim();
        if (!newItem.fromAddress || !newItem.toAddress) {
            alert("עבור הליכה/נסיעה, יש למלא מאיפה ולאן."); return;
        }
        if (subject === "נסיעה") {
          newItem.travelMode = document.getElementById("travelModeSelect")?.value;
        }
      } else if (subject === "אוכל") {
        newItem.foodType = document.getElementById("foodTypeSelect")?.value;
         if (!newItem.foodType) { alert("עבור אוכל, יש לבחור סוג."); return; }
        if(newItem.foodType === "מסעדה" || newItem.foodType === "אוכל מהיר" || newItem.foodType === "בית קפה") {
          newItem.foodLocation = document.getElementById("foodLocationInput")?.value.trim();
           if (!newItem.foodLocation) { alert("עבור מסעדה/אוכל מהיר/בית קפה, יש למלא שם או מיקום."); return; }
        } else if (location) { // אם נבחר סוג אחר והוזן מיקום גנרי
            newItem.location = location;
        }
      } else if (subject === "טיסה") {
        newItem.flightNumber = document.getElementById("flightNumberInput")?.value.trim().toUpperCase();
        newItem.airline = document.getElementById("airlineInput")?.value.trim();
        newItem.departureAirport = document.getElementById("departureAirportInput")?.value.trim();
        newItem.arrivalAirport = document.getElementById("arrivalAirportInput")?.value.trim();
        newItem.departureTime = startTime; // זמן המראה
        newItem.arrivalTime = endTime;     // זמן נחיתה
         if (!newItem.flightNumber || !newItem.departureAirport || !newItem.arrivalAirport) {
             alert("עבור טיסה, יש למלא לפחות מספר טיסה ושדות תעופה."); return;
         }
      } else if (!['שינה', 'לקום'].includes(subject)) { // לכל שאר הנושאים (לא שינה/לקום)
          if (location) { // שמור מיקום גנרי אם הוזן
              newItem.location = location;
          }
          // יכולה להיות בדיקה נוספת אם חובה למלא מיקום לנושאים מסוימים
          // if (!newItem.location && ['ביקור/סיור', 'אטרקציה', ...].includes(subject)) {
          //     alert(`עבור ${subject}, יש למלא מיקום.`); return;
          // }
      }
       // -----------------------------

      if (editingIndex === -1) {
        scheduleItems.push(newItem);
      } else if (editingIndex >= 0 && editingIndex < scheduleItems.length) {
        scheduleItems[editingIndex] = newItem;
        editingIndex = -1;
      } else {
         alert("שגיאה בעדכון פריט."); // Error case
         return;
      }

      scheduleItems.sort((a, b) => {
        if(a.date === b.date) { return (a.startTime || "").localeCompare(b.startTime || ""); }
        return (a.date || "").localeCompare(b.date || "");
      });

      renderScheduleItems();
      closeAddItemModal();
    }

     function renderScheduleItems() {
         const container = document.getElementById("scheduleContainer");
         if (!container) return;
         container.innerHTML = "";

         if (scheduleItems.length === 0) {
             container.innerHTML = '<p style="color: #6c757d; margin-top: 20px;">הלו"ז עדיין ריק. לחץ על \'+\' כדי להוסיף את הפריט הראשון.</p>';
             return;
         }

         const groups = groupItemsByDate(scheduleItems);
         const sortedDates = Object.keys(groups).sort();

         sortedDates.forEach(date => {
             const dateHeader = document.createElement('h3');
             dateHeader.innerHTML = formatDateHeader(date);
             container.appendChild(dateHeader);

             groups[date].forEach(item => {
                 const index = scheduleItems.findIndex(i => i === item);
                 if (index !== -1) {
                     const itemHTML = generateScheduleItemHTML(item, index, false);
                     container.innerHTML += itemHTML;
                 }
             });
         });
     }

    function deleteScheduleItem(index) {
      if (index < 0 || index >= scheduleItems.length) return;
      const itemSubject = scheduleItems[index].subject || 'פריט זה';
      if (confirm(`האם אתה בטוח שברצונך למחוק את הפריט "${itemSubject}" מהלו״ז?`)) {
        scheduleItems.splice(index, 1);
        renderScheduleItems();
      }
    }

     function showItemDetail(index) {
         if (index < 0 || index >= scheduleItems.length) return;
         editingIndex = index;
         const item = scheduleItems[index];
         const form = document.getElementById("addItemForm");
         if (!form) return;

         form.reset(); // איפוס כללי

         // מילוי שדות כלליים
         document.getElementById("modalDate").value = item.date;
         document.getElementById("modalStartTime").value = item.startTime;
         document.getElementById("modalEndTime").value = item.endTime;
         document.getElementById("modalDescription").value = item.description || "";

         updateSubjectDropdownOptions();
         document.getElementById("modalSubject").value = item.subject;
         subjectChangeHandler(); // הצג/הסתר שדות לפי הנושא

         // מילוי שדות ספציפיים + מיקום גנרי
         if (item.subject === "הליכה" || item.subject === "נסיעה") {
             document.getElementById("fromAddress").value = item.fromAddress || "";
             document.getElementById("toAddress").value = item.toAddress || "";
             if (item.subject === "נסיעה") {
                 document.getElementById("travelModeSelect").value = item.travelMode || "taxi";
             }
         } else if (item.subject === "אוכל") {
             document.getElementById("foodTypeSelect").value = item.foodType || "";
             foodTypeChangeHandler();
             if (item.foodLocation) {
                 document.getElementById("foodLocationInput").value = item.foodLocation;
             } else if (item.location) { // אם אין מיקום אוכל אבל יש מיקום גנרי
                 document.getElementById("locationInput").value = item.location;
             }
         } else if (subject === "טיסה") {
             document.getElementById("flightNumberInput").value = item.flightNumber || "";
             document.getElementById("airlineInput").value = item.airline || "";
             document.getElementById("departureAirportInput").value = item.departureAirport || "";
             document.getElementById("arrivalAirportInput").value = item.arrivalAirport || "";
             // עדכון שדות זמן לזמני טיסה אם קיימים
             document.getElementById("modalStartTime").value = item.departureTime || item.startTime;
             document.getElementById("modalEndTime").value = item.arrivalTime || item.endTime;
             updateFlightTimeNote();
         } else if (item.location) { // לכל שאר הנושאים עם מיקום גנרי
             document.getElementById("locationInput").value = item.location;
         }

         document.getElementById("addItemModalTitle").innerText = "עריכת פריט בלו״ז";
         document.getElementById("addItemBtn").innerHTML = '<i class="fas fa-save"></i> שמור שינויים';
         document.getElementById("addItemModal").style.display = "flex";
     }

    function openFinalSchedule() {
        if (!scheduleName) {
             alert("שגיאה: לא נקבע שם ללוז.");
             document.getElementById("scheduleNameModal").style.display = "flex"; // Use flex
             return;
         }
        if (scheduleItems.length === 0) {
            alert("עליך להוסיף לפחות פריט אחד ללו״ז לפני שניתן לשמור."); return;
        }

         const newSchedule = {
             name: scheduleName,
             scheduleItems: JSON.parse(JSON.stringify(scheduleItems)),
             category: "חופשה"
         };
         // אם זה לוז חדש, הוסף. אם זה עריכה, החלף (למקרה ש-updateAndFinish לא נקרא)
         if (editingSavedScheduleIndex === -1) {
             savedSchedules.push(newSchedule);
         } else if (editingSavedScheduleIndex >= 0 && editingSavedScheduleIndex < savedSchedules.length) {
             savedSchedules[editingSavedScheduleIndex] = newSchedule;
         } else {
            alert("שגיאה בשמירת הלוז."); return;
         }

         saveSchedulesToFirestore();

         let finalHtml = "";
         const groups = groupItemsByDate(scheduleItems);
         const sortedDates = Object.keys(groups).sort();
         sortedDates.forEach(date => {
             finalHtml += `<h3>${formatDateHeader(date)}</h3>`;
             groups[date].forEach(item => {
                 finalHtml += generateScheduleItemHTML(item, scheduleItems.findIndex(i => i === item), true);
             });
         });

         const finalScheduleModal = document.getElementById("finalScheduleModal");
         const finalScheduleTitle = document.getElementById("finalScheduleTitle");
         const finalScheduleDisplay = document.getElementById("finalScheduleDisplay");
         if(finalScheduleModal && finalScheduleTitle && finalScheduleDisplay) {
            finalScheduleTitle.innerText = scheduleName.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            finalScheduleDisplay.innerHTML = finalHtml;
            finalScheduleModal.style.display = "flex"; // Use flex

            // אפס כפתור עריכה למקרה שפותחים מחדש אחרי עריכה
             const editButton = finalScheduleModal.querySelector('.button-group button[onclick^="editFinalSchedule"]');
             if(editButton) {
                 editButton.innerHTML = '<i class="fas fa-edit"></i> ערוך לו"ז';
                 editButton.disabled = false;
                 editButton.style.backgroundColor = ""; // Reset color
             }
         }
         // אפס מצב עריכה אם הגענו לכאן
         editingSavedScheduleIndex = -1;
     }

    function closeFinalScheduleModal() {
      document.getElementById("finalScheduleModal").style.display = "none";
       window.location.href = "my-schedules.html"; // עבור לדף הלוזים שלי
    }

     function editFinalSchedule() {
        document.getElementById("finalScheduleModal").style.display = "none";

         // מצא אינדקס הלוז הנוכחי (האחרון שנוסף או זה שסומן לעריכה)
         if (editingSavedScheduleIndex === -1) { // אם לא היינו במצב עריכה קודם, זה האחרון
            editingSavedScheduleIndex = savedSchedules.length - 1;
         }
         if (editingSavedScheduleIndex < 0 || editingSavedScheduleIndex >= savedSchedules.length) {
             alert("שגיאה: לא נמצא הלוז לעריכה.");
             renderInitialView();
             return;
         }

         // ודא ש- scheduleName ו- scheduleItems תואמים ללוז הנבחר
         const scheduleToEdit = savedSchedules[editingSavedScheduleIndex];
         scheduleName = scheduleToEdit.name;
         scheduleItems = JSON.parse(JSON.stringify(scheduleToEdit.scheduleItems || []));


          // הצג מחדש את ממשק העריכה
          document.getElementById("content").innerHTML = `
              <h2><i class="fas fa-edit"></i> עריכת לו"ז: ${scheduleName.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</h2>
              <p>הוסף, ערוך או מחק פריטים בלו"ז.</p>
              <div class="action-buttons">
                <button class="btn" onclick="openAddItemModal()" title="הוסף פריט ללוז">+</button>
              </div>
              <div id="scheduleContainer"></div>
              <div class="button-group">
                <button class="btn" onclick="updateAndFinish()">
                    <i class="fas fa-save"></i> שמור שינויים וסיים
                  </button>
                  <button class="btn" onclick="window.location.href='my-schedules.html'" style="background-color: #6c757d;">
                      <i class="fas fa-times"></i> בטל שינויים וחזור
                  </button>
              </div>
          `;
          renderScheduleItems(); // רנדר את הפריטים ללוז הנבחר
     }

    // --- פונקציות צילום מסך והעתקה (ללא שינוי מהותי) ---
    function captureScreenshotFromElement(elementId, name) {
        const elem = document.getElementById(elementId);
        const titleElem = document.getElementById("finalScheduleTitle");

        if (!elem || !titleElem) {
            alert("שגיאה: לא נמצא האלמנט לצילום.");
            return;
        }

        const wrapper = document.createElement('div');
        wrapper.style.padding = '25px';
        wrapper.style.backgroundColor = '#ffffff';
        wrapper.style.display = 'inline-block';
        wrapper.style.textAlign = 'center';
        wrapper.style.border = '1px solid #eee';

        const titleClone = titleElem.cloneNode(true);
        titleClone.style.marginBottom = '20px';
        const scheduleClone = elem.cloneNode(true);
        scheduleClone.style.maxHeight = 'none';
        scheduleClone.style.overflowY = 'visible';

        wrapper.appendChild(titleClone);
        wrapper.appendChild(scheduleClone);

        wrapper.style.position = 'absolute';
        wrapper.style.left = '-9999px';
        wrapper.style.top = '-9999px';
        document.body.appendChild(wrapper);

        html2canvas(wrapper, {
            backgroundColor: "#ffffff",
            useCORS: true,
            scale: 1.5,
            logging: false // הוסר logging
        }).then(canvas => {
            document.body.removeChild(wrapper);
            canvas.toBlob(function(blob) {
                if (blob) {
                    const link = document.createElement("a");
                    const cleanName = name ? name.replace(/</g, "").replace(/>/g, "").trim() : 'לוז';
                    const safeName = (cleanName || 'לוז')
                       .replace(/[\s]/g, '_')
                       .replace(/[^a-z0-9א-ת_\-]/gi, '') || 'לוז';
                    link.download = safeName + ".png";
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    setTimeout(() => URL.revokeObjectURL(link.href), 100);
                } else {
                    alert("שגיאה ביצירת קובץ התמונה.");
                }
            }, 'image/png');
        }).catch(err => {
            if (document.body.contains(wrapper)) {
                document.body.removeChild(wrapper);
            }
            alert("שגיאה בצילום המסך.");
        });
    }

    function copyScheduleToClipboard() {
        let text = scheduleName ? `*${scheduleName.replace(/</g, "").replace(/>/g, "").trim()}*\n\n` : '*לוז חופשה*\n\n';
        const groups = groupItemsByDate(scheduleItems);
        const sortedDates = Object.keys(groups).sort();

        sortedDates.forEach(date => {
            text += `📅 *${formatDateHeader(date)}*\n--------------------\n`;
            groups[date].forEach(item => {
                 const emoji = getBackgroundEmoji(item);
                 const startTime = item.startTime || '??:??';
                 const endTime = item.endTime || '??:??';
                 let displaySubjectText = getDisplaySubject(item);

                 text += `*${startTime} - ${endTime}* : ${displaySubjectText} ${emoji}\n`;

                  if (item.subject === "טיסה") {
                     if (item.airline) text += `    חברה: ${item.airline}\n`;
                     if (item.flightNumber) text += `    מס': ${item.flightNumber}\n`;
                     if (item.departureAirport && item.arrivalAirport) text += `    *${item.departureAirport}* ⬅️ *${item.arrivalAirport}*\n`;
                 } else if (item.fromAddress && item.toAddress && (item.subject === "נסיעה" || item.subject === "הליכה")) {
                     text += `    מ: ${item.fromAddress}\n    ל: ${item.toAddress}\n`;
                     if(item.travelMode && item.subject === "נסיעה") text += `    (${translateTravelMode(item.travelMode)})\n`;
                 } else if (item.location && !['טיסה'].includes(item.subject) && !(item.subject === 'אוכל' && item.foodLocation)) { // מיקום גנרי
                     text += `    📍 מיקום: ${item.location}\n`;
                 } else if (item.subject === "אוכל") {
                     if (item.foodType) text += `    סוג: ${item.foodType}\n`;
                     if (item.foodLocation) text += `    📍 מקום: ${item.foodLocation}\n`; // מיקום ספציפי לאוכל
                 }

                 if (item.description) {
                     text += `   - ${item.description.trim()}\n`;
                 }
                 text += "\n";
            });
            text += "\n";
        });

        copyUsingClipboardAPI(text.trim());
    }

    // --- פונקציות עזר לניהול נתונים ---

    function groupItemsByDate(items) {
      return items.reduce((groups, item) => {
        const date = item.date;
        if (!date) return groups; // Skip items without date
        if (!groups[date]) { groups[date] = []; }
        groups[date].push(item);
        return groups;
      }, {});
    }

    function formatDateHeader(dateStr) {
        if (!dateStr) return "תאריך לא ידוע";
        try {
            const [year, month, day] = dateStr.split('-');
            const dateObj = new Date(Date.UTC(year, month - 1, day));
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Jerusalem' };
            return dateObj.toLocaleDateString('he-IL', options);
        } catch (e) {
            return dateStr; // Fallback
        }
    }

    function getDisplaySubject(item) {
      if (item.subject === "נסיעה" && item.travelMode) {
        return "נסיעה " + translateTravelMode(item.travelMode);
      }
      return item.subject || 'ללא נושא';
    }

    function translateTravelMode(mode) {
        switch(mode) {
            case 'taxi': return '🚖';
            case 'transit': return '🚋🚆';
            case 'car': return '🚙';
            default: return '';
        }
    }

     function getBackgroundEmoji(item) {
         if (!item || !item.subject) return subjectEmojis["כללי"];
         const emojiInSubject = item.subject.match(/\p{Emoji_Presentation}/u);
         if (emojiInSubject) return emojiInSubject[0];
         return subjectEmojis[item.subject] || subjectEmojis["כללי"];
     }

    function getExtraLine(item) {
        let line = "";
        let displaySubject = getDisplaySubject(item);

        // No extra line needed for travel/walk (handled by address/location)
        // No extra line needed for generic location (handled by locationLine)
        if(item.subject === "אוכל") {
            if(item.foodType) { line += `סוג: ${item.foodType}`; }
            // foodLocation is handled separately
        } else if(item.subject === "טיסה") {
            line = `טיסה ${item.flightNumber || ""}`;
             if(item.airline) line += ` (${item.airline})`;
        }
        return line;
    }

    function saveSchedulesToFirestore() {
      const user = firebase.auth().currentUser;
      if (user && db) { // Check db
        const schedulesToSave = Array.isArray(savedSchedules) ? savedSchedules : [];
        const validSchedules = schedulesToSave.filter(sch =>
            sch && typeof sch === 'object' && sch.name && Array.isArray(sch.scheduleItems)
        );

        db.collection("schedules").doc(user.uid).set({ schedules: validSchedules }, { merge: true })
        .then(() => { /* Saved */ })
        .catch((error) => {
            console.error("Error saving schedules to Firestore: ", error); // Keep critical errors
            alert(`שגיאה בשמירת הלוזים: ${error.message}`);
         });
      } else if (!user) {
          alert("אינך מחובר. לא ניתן לשמור שינויים.");
      }
    }

    // --- ניהול נושאים (קבועים וחד-פעמיים) ---

    function updateSubjectDropdownOptions() {
        const subjectDropdown = document.getElementById("modalSubject");
        if (!subjectDropdown) return;
        const currentValue = subjectDropdown.value;

        // אופציות ברירת מחדל
        const defaultOptions = [
            { value: "", text: "-- בחר נושא --" },
            { value: "הליכה", text: "🚶 הליכה" },
            { value: "נסיעה", text: "🚗 נסיעה" },
            { value: "ביקור/סיור", text: "🏛️ ביקור/סיור" },
            { value: "טיסה", text: "✈️ טיסה" },
            { value: "אוכל", text: "🍽️ אוכל" },
            { value: "שינה", text: "😴 שינה" },
            { value: "לקום", text: "⏰ לקום" },
            { value: "חוף", text: "🏖️ חוף" },
            { value: "קניות", text: "🛍️ קניות" },
            { value: "מנוחה", text: "🧘 מנוחה" },
            { value: "בריכה", text: "🏊 בריכה" },
            { value: "אטרקציה", text: "🎢 אטרקציה" },
            { value: "מוזיאון", text: "🖼️ מוזיאון" },
            { value: "כללי", text: "📌 כללי" }
        ];

        subjectDropdown.innerHTML = ""; // נקה קודם

        const allSubjects = new Set(defaultOptions.map(opt => opt.value));

        defaultOptions.forEach(opt => subjectDropdown.add(new Option(opt.text, opt.value)));

        // הוסף נושאים קבועים
        permanentSubjects.forEach(subject => {
            if (subject && !allSubjects.has(subject)) {
                 subjectDropdown.add(new Option(subject, subject));
                 allSubjects.add(subject);
            }
        });
        // הוסף נושאים חד-פעמיים
        customSubjects.forEach(subject => {
            if (subject && !allSubjects.has(subject)) {
                 subjectDropdown.add(new Option(subject, subject));
                 allSubjects.add(subject);
            }
        });

        // הוסף אופציה להוספה
        const addOption = new Option("+ הוסף נושא חדש...", "addSubject");
        addOption.style.fontWeight = "bold";
        addOption.style.color = "#007bff";
        subjectDropdown.add(addOption);

         // שחזר ערך קודם אם אפשר
         if (Array.from(subjectDropdown.options).some(o => o.value === currentValue)) {
             subjectDropdown.value = currentValue;
         } else {
             subjectDropdown.value = "";
         }
    }

    function openAddSubjectModal() {
        document.getElementById("addSubjectModal").style.display = "flex";
        document.getElementById("addItemModal").style.zIndex = 1999; // מאחורי מודל הנושא
    }
    function closeAddSubjectModal() {
        document.getElementById("addSubjectModal").style.display = "none";
        document.getElementById("addItemModal").style.zIndex = ""; // החזר Z-index
        document.getElementById("newSubjectNameInput").value = "";
          const subjectDropdown = document.getElementById("modalSubject");
          if (subjectDropdown.value === 'addSubject' || !Array.from(subjectDropdown.options).some(o => o.value === subjectDropdown.value)) {
               subjectDropdown.value = ""; // אפס אם "הוסף" נבחר או אם הערך לא קיים
          }
          subjectChangeHandler(); // עדכן שדות לפי הנושא הנוכחי
    }

    function addSubjectOneTime() {
        const newSubjectName = document.getElementById("newSubjectNameInput")?.value.trim();
        if (!newSubjectName) { alert("אנא הזן שם לנושא."); return; }
        if (customSubjects.includes(newSubjectName) || permanentSubjects.includes(newSubjectName) || Array.from(document.getElementById("modalSubject").options).some(o => o.value === newSubjectName)) {
            alert("נושא זה כבר קיים."); return;
        }
        customSubjects.push(newSubjectName);
        updateSubjectDropdownOptions();
        document.getElementById("modalSubject").value = newSubjectName;
        closeAddSubjectModal();
    }

    function addSubjectPermanent() {
        const newSubjectName = document.getElementById("newSubjectNameInput")?.value.trim();
        if (!newSubjectName) { alert("אנא הזן שם לנושא."); return; }
         if (permanentSubjects.includes(newSubjectName) || customSubjects.includes(newSubjectName) || Array.from(document.getElementById("modalSubject").options).some(o => o.value === newSubjectName)) {
            alert("נושא זה כבר קיים."); return;
        }
        permanentSubjects.push(newSubjectName);
        localStorage.setItem('permanentVacationSubjects', JSON.stringify(permanentSubjects));
        updateSubjectDropdownOptions();
        updatePermanentSubjectsList();
        document.getElementById("modalSubject").value = newSubjectName;
        closeAddSubjectModal();
        alert(`הנושא "${newSubjectName}" נוסף לרשימת הנושאים הקבועים!`);
    }

    function updatePermanentSubjectsList() {
        const container = document.getElementById("permanentSubjectsList");
        if (!container) return;
        container.innerHTML = "";
        if (permanentSubjects.length === 0) {
            container.innerHTML = '<span style="color: #6c757d; font-size: 0.9em; padding: 5px;">אין נושאים קבועים שמורים.</span>';
            return;
        }
        permanentSubjects.forEach(subject => {
            const itemSpan = document.createElement("span"); // Renamed variable
            const trash = document.createElement("span");
            trash.innerHTML = "🗑️";
            trash.title = "מחק נושא קבוע";
            trash.style.cursor = "pointer"; // Add cursor pointer
             trash.style.marginLeft = "auto"; // Push trash icon to the right
             trash.style.padding = "0 5px"; // Add some padding
             trash.onclick = function(event) {
                event.stopPropagation();
                if (confirm(`האם למחוק את הנושא הקבוע "${subject}"?`)) {
                    const index = permanentSubjects.indexOf(subject);
                    if (index > -1) {
                        permanentSubjects.splice(index, 1);
                        localStorage.setItem('permanentVacationSubjects', JSON.stringify(permanentSubjects));
                        updatePermanentSubjectsList();
                        updateSubjectDropdownOptions();
                        alert("הנושא הקבוע נמחק.");
                         const subjectDropdown = document.getElementById("modalSubject");
                         if (subjectDropdown && subjectDropdown.value === subject) {
                             subjectDropdown.value = "";
                             subjectChangeHandler();
                         }
                    }
                }
            };
             itemSpan.appendChild(document.createTextNode(subject));
             itemSpan.appendChild(trash);
             container.appendChild(itemSpan);
        });
    }

     function togglePermanentSubjectsList() {
      const container = document.getElementById("permanentSubjectsList");
      const isHidden = !container.style.display || container.style.display === "none";
      if (isHidden) {
          updatePermanentSubjectsList();
          container.style.display = "block";
          document.addEventListener('click', handleClickOutsideSubjectList, true); // Add listener only when opened
      } else {
          container.style.display = "none";
          document.removeEventListener('click', handleClickOutsideSubjectList, true); // Remove listener when closed
      }
    }

     function handleClickOutsideSubjectList(event) {
         const container = document.getElementById("permanentSubjectsList");
         const toggleBtn = document.getElementById("subjectsToggleBtn");
         if (container && toggleBtn && !container.contains(event.target) && !toggleBtn.contains(event.target)) {
             container.style.display = 'none';
             document.removeEventListener('click', handleClickOutsideSubjectList, true); // Clean up listener
         }
     }

    // *** פונקציה מעודכנת לטיפול בשדות לפי נושא ***
    function subjectChangeHandler() {
        const subj = document.getElementById("modalSubject")?.value;
        const extraQuestions = document.getElementById("extraQuestions");
        const locationField = document.getElementById("locationField");
        const foodOptions = document.getElementById("foodExtraOptions");
        const flightOptions = document.getElementById("flightExtraOptions");
        const descriptionGroup = document.getElementById("descriptionGroup");
        const addItemBtn = document.getElementById("addItemBtn");
        const startTimeLabel = document.getElementById("startTimeLabel");
        const endTimeLabel = document.getElementById("endTimeLabel");
        const timeNote = document.getElementById("timeNote");

        // Hide all optional sections initially
        if(extraQuestions) extraQuestions.style.display = "none";
        if(locationField) locationField.style.display = "none"; // Hide generic location initially
        if(foodOptions) foodOptions.style.display = "none";
        if(flightOptions) flightOptions.style.display = "none";
        if(descriptionGroup) descriptionGroup.style.display = "none";
        if(addItemBtn) addItemBtn.style.display = 'none';
        if(timeNote) timeNote.style.display = "none";

        // Reset time labels
        if(startTimeLabel) startTimeLabel.innerText = "שעת התחלה:";
        if(endTimeLabel) endTimeLabel.innerText = "שעת סיום:";

        if (subj === "addSubject") {
            openAddSubjectModal();
        } else if (subj) { // If a valid subject is selected
            if(descriptionGroup) descriptionGroup.style.display = "block";
            if(addItemBtn) addItemBtn.style.display = 'inline-flex';

            if (subj === "הליכה" || subj === "נסיעה") {
                if(extraQuestions) extraQuestions.style.display = "block";
                const travelModeGroup = document.getElementById("travelModeGroup");
                if(travelModeGroup) travelModeGroup.style.display = (subj === "נסיעה") ? "block" : "none";
            } else if (subj === "טיסה") {
                if(flightOptions) flightOptions.style.display = "block";
                if(startTimeLabel) startTimeLabel.innerText = "שעת המראה:";
                if(endTimeLabel) endTimeLabel.innerText = "שעת נחיתה:";
                updateFlightTimeNote();
                if(timeNote) timeNote.style.display = "block";
            } else if (subj === "אוכל") {
                if(foodOptions) foodOptions.style.display = "block";
                foodTypeChangeHandler(); // Handles specific food location
                // Show generic location field ONLY if type doesn't have specific location
                 const foodType = document.getElementById("foodTypeSelect")?.value;
                 if (locationField && foodType && !["מסעדה", "אוכל מהיר", "בית קפה"].includes(foodType)) {
                     locationField.style.display = "block";
                 }
            } else if (!['שינה', 'לקום'].includes(subj)) { // For all other subjects (excluding sleep/wake)
                if(locationField) locationField.style.display = "block"; // Show generic location
            }
            // For 'שינה', 'לקום', only description is shown (handled above)
        }
    }


    function foodTypeChangeHandler() {
      const foodType = document.getElementById("foodTypeSelect")?.value;
      const locationDiv = document.getElementById("foodLocationDiv");
      const genericLocationField = document.getElementById("locationField"); // Get generic location field

      if (locationDiv) {
          if (foodType === "מסעדה" || foodType === "אוכל מהיר" || foodType === "בית קפה") {
            locationDiv.style.display = "block";
             if (genericLocationField) genericLocationField.style.display = "none"; // Hide generic if specific is shown
             document.getElementById("locationInput").value = ""; // Clear generic location
          } else {
            locationDiv.style.display = "none";
            document.getElementById("foodLocationInput").value = ""; // Clear specific location
            // Show generic location field if a food type is selected but doesn't have a specific location field
             if (genericLocationField && foodType) {
                  genericLocationField.style.display = "block";
             } else if (genericLocationField) {
                  genericLocationField.style.display = "none"; // Hide if no food type selected
             }
          }
      }
    }

     // --- פונקציות ניווט ---
     function checkRoute(index) {
         // If index is provided (from schedule item), use its data
         if (typeof index === 'number' && index >= 0 && index < scheduleItems.length) {
             const item = scheduleItems[index];
             if (item.fromAddress && item.toAddress) {
                 const url = `https://www.google.com/maps/dir/?api=1&origin=$${encodeURIComponent(item.fromAddress)}&destination=${encodeURIComponent(item.toAddress)}`;
                 window.open(url, "_blank");
             } else {
                 alert("לא נמצאו כתובות תקינות לפריט זה.");
             }
         } else { // If called from modal button without index
             const from = document.getElementById("fromAddress")?.value.trim();
             const to = document.getElementById("toAddress")?.value.trim();
             if (!from || !to) { alert("אנא מלא מאיפה ולאן."); return; }
             const url = `https://www.google.com/maps/dir/?api=1&origin=$${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}`;
             window.open(url, "_blank");
         }
     }

     function navigateToGenericLocation(index) {
         let location = "";
          if (typeof index === 'number' && index >= 0 && index < scheduleItems.length) {
              location = scheduleItems[index].location;
          } else {
              location = document.getElementById("locationInput")?.value.trim();
          }

         if (!location) { alert("אנא הזן מיקום."); return; }
         showRouteToDestination(location);
     }

     function showFoodRoute(index) {
         let location = "";
          if (typeof index === 'number' && index >= 0 && index < scheduleItems.length) {
              location = scheduleItems[index].foodLocation;
          } else {
              location = document.getElementById("foodLocationInput")?.value.trim();
          }

         if (!location) { alert("אנא הזן שם או מיקום המקום."); return; }
         showRouteToDestination(location);
     }

     function showRouteToDestination(destination) {
         const encodedDestination = encodeURIComponent(destination);
         if (navigator.geolocation) {
             navigator.geolocation.getCurrentPosition((position) => {
                 const origin = `${position.coords.latitude},${position.coords.longitude}`;
                 const url = `https://www.google.com/maps/dir/?api=1&origin=$${origin}&destination=${encodedDestination}`;
                 window.open(url, "_blank");
             }, (error) => {
                 const url = `https://www.google.com/maps/search/?api=1&query=${encodedDestination}`;
                 window.open(url, "_blank");
                 alert("לא ניתן היה לקבל מיקום נוכחי. מציג את היעד במפה.");
             }, { timeout: 5000 }); // Added timeout
         } else {
             const url = `https://www.google.com/maps/search/?api=1&query=${encodedDestination}`;
             window.open(url, "_blank");
             alert("שירותי מיקום אינם נתמכים בדפדפן זה. מציג את היעד במפה.");
         }
     }
     // --- סוף פונקציות ניווט ---


     function updateFlightTimeNote() {
         const depTime = document.getElementById("modalStartTime")?.value;
         const arrTime = document.getElementById("modalEndTime")?.value;
         const depAirport = document.getElementById("departureAirportInput")?.value.trim();
         const arrAirport = document.getElementById("arrivalAirportInput")?.value.trim();
         const timeNote = document.getElementById("timeNote");
         if(!timeNote) return;

         let noteText = "";
         if (depTime) noteText += `המראה: ${depTime}`;
         if (depAirport) noteText += ` (${depAirport})`;
         if (arrTime) noteText += noteText ? `, נחיתה: ${arrTime}` : `נחיתה: ${arrTime}`;
         if (arrAirport) noteText += ` (${arrAirport})`;

         timeNote.innerText = noteText || "(שעת המראה ושעת נחיתה)";
         timeNote.style.display = 'block';
     }


    // --- פונקציות חיפוש טיסה (ללא שינוי מהותי, מלבד הסרת console.log) ---
    function searchFlight() {
        const flightNumberInput = document.getElementById("flightNumberInput");
        const flightDateInput = document.getElementById("modalDate");
        const loader = document.getElementById("loader"); // Loader for flight search specifically

        const flightNumber = flightNumberInput?.value.trim().toUpperCase();
        const flightDate = flightDateInput?.value;

        if (!flightNumber || !flightDate) {
            alert("אנא הזן מספר טיסה ותאריך.");
            return;
        }

        if(loader) loader.style.display = "flex"; // Show flight search loader

        const apiKey = "33d4ecb375mshcf029fba766af44p17668djsnaef3c36cb209"; // השתמש במפתח שלך!
        const host = "aerodatabox.p.rapidapi.com";
        const apiUrl = `https://aerodatabox.p.rapidapi.com/flights/number/${flightNumber}/${flightDate}?withAircraft=false&withLocation=false`;

        fetch(apiUrl, {
                method: "GET",
                headers: {
                    "x-rapidapi-host": host,
                    "x-rapidapi-key": apiKey,
                }
            })
            .then(response => {
                 if (!response.ok) {
                     return response.json().then(errData => {
                         throw new Error(errData.message || `שגיאה ${response.status}: ${response.statusText}`);
                     }).catch(() => {
                         throw new Error(`שגיאה ${response.status}: ${response.statusText}`);
                     });
                 }
                 return response.json();
             })
            .then(data => {
                let html = "";
                if (data && Array.isArray(data) && data.length > 0) {
                     const flight = data[0];
                    const airlineName = flight.airline?.name ?? "לא זמין";
                    const depAirport = flight.departure?.airport?.name ?? "לא זמין";
                    const arrAirport = flight.arrival?.airport?.name ?? "לא זמין";
                    const depTimeFull = flight.departure?.scheduledTime?.local ?? flight.departure?.actualTime?.local ?? "לא זמין";
                    const arrTimeFull = flight.arrival?.scheduledTime?.local ?? flight.arrival?.actualTime?.local ?? "לא זמין";
                    const depTimeLocalMatch = depTimeFull.match(/(\d{2}:\d{2})/);
                    const arrTimeLocalMatch = arrTimeFull.match(/(\d{2}:\d{2})/);
                    const depTimeLocal = depTimeLocalMatch ? depTimeLocalMatch[1] : "??:??";
                    const arrTimeLocal = arrTimeLocalMatch ? arrTimeLocalMatch[1] : "??:??";

                    html += '<div class="flight-card">';
                    html += `<h2>טיסת ${airlineName} (${flight.number || flightNumber})</h2>`;
                    html += `<p><span class="time-label">מ:</span> ${depAirport}</p>`;
                    html += `<p><span class="time-label">אל:</span> ${arrAirport}</p>`;
                    html += `<p><span class="time-label">יציאה מתוכננת:</span> ${depTimeFull}</p>`;
                    html += `<p><span class="time-label">הגעה מתוכננת:</span> ${arrTimeFull}</p>`;
                    html += '</div>';

                    window.flightData = {
                        flightNumber: flight.number || flightNumber, airline: airlineName,
                        departureAirport: depAirport, arrivalAirport: arrAirport,
                        departureTime: depTimeLocal, arrivalTime: arrTimeLocal
                    };

                } else {
                    html = `<p style="color: #dc3545;">לא נמצאו פרטי טיסה עבור מספר ${flightNumber} בתאריך ${flightDate}. אנא בדוק את הפרטים או הזן ידנית.</p>`;
                    window.flightData = null;
                }
                document.getElementById("flightResultContent").innerHTML = html;
                document.getElementById("flightResultModal").style.display = "flex";
            })
            .catch(error => {
                document.getElementById("flightResultContent").innerHTML = `<p style="color: #dc3545;">שגיאה בחיפוש הטיסה: ${error.message}. נסה שוב מאוחר יותר או הזן ידנית.</p>`;
                 document.getElementById("flightResultModal").style.display = "flex";
                 window.flightData = null;
            })
            .finally(() => {
                if(loader) loader.style.display = "none"; // Hide flight search loader
            });
    }

    function closeFlightResultModal() { document.getElementById("flightResultModal").style.display = "none"; }

    function copyFlightToForm() {
        if (window.flightData) {
            document.getElementById("flightNumberInput").value = window.flightData.flightNumber;
            document.getElementById("airlineInput").value = window.flightData.airline;
            document.getElementById("departureAirportInput").value = window.flightData.departureAirport;
            document.getElementById("arrivalAirportInput").value = window.flightData.arrivalAirport;
            document.getElementById("modalStartTime").value = window.flightData.departureTime;
            document.getElementById("modalEndTime").value = window.flightData.arrivalTime;
            updateFlightTimeNote();
            closeFlightResultModal();
            alert("פרטי הטיסה הועתקו לטופס.");
        } else {
            alert("אין נתוני טיסה להעתקה.");
        }
    }
     // --- סוף פונקציות חיפוש טיסה ---

     // --- פונקציות העתקה ללוח (ללא שינוי) ---
    function copyUsingClipboardAPI(textToCopy) {
         if (navigator.clipboard && navigator.clipboard.writeText) {
             navigator.clipboard.writeText(textToCopy).then(() => {
                 alert("הלו״ז הועתק ללוח בהצלחה!");
             }).catch(err => {
                 copyUsingExecCommand(textToCopy); // Fallback
             });
         } else {
             copyUsingExecCommand(textToCopy); // Fallback
         }
     }
     function copyUsingExecCommand(textToCopy) {
         const textArea = document.createElement("textarea");
         textArea.value = textToCopy;
         textArea.style.position = "fixed"; textArea.style.top = "-9999px"; textArea.style.left = "-9999px";
         textArea.setAttribute("readonly", "");
         document.body.appendChild(textArea);
         textArea.select();
         try {
             const successful = document.execCommand('copy');
             if (successful) {
                 alert("הלו״ז הועתק ללוח בהצלחה!");
             } else {
                  alert("העתקה נכשלה.");
             }
         } catch (err) {
             alert("העתקה נכשלה.");
         } finally {
             document.body.removeChild(textArea);
         }
     }


     // --- אתחול בעת טעינת הדף ---
      document.addEventListener('DOMContentLoaded', () => {
          domReady = true; // סימון שה-DOM נטען
          hidePageLoader(); // נסה להסתיר את ה-Loader (יפעל רק אם גם authReady=true)

          // איפוס טופס בעת פתיחת מודל להוספה חדשה
           const addItemModal = document.getElementById('addItemModal');
           const form = document.getElementById('addItemForm');
           if(addItemModal && form) {
                const observer = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        if (mutation.attributeName === 'style' && addItemModal.style.display === 'flex' && editingIndex === -1) {
                           form.reset();
                           subjectChangeHandler(); // אפס שדות תלויי-נושא
                       }
                   });
               });
               observer.observe(addItemModal, { attributes: true });
           }
            // Initial check for editing is now done inside onAuthStateChanged callback
       });

  </script>

  </body>
</html>
