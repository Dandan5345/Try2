<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×–××Ÿ ×–×”×‘ - ×‘× ×™×™×ª ×œ×•×– ×—×•×¤×©×”</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://i.imgur.com/GaYFAp1.png" type="image/png">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/brands.min.css" integrity="sha512-9YHSK59/rjvhtDcY/b+4rdnl0V4LPDWdkKceBl8ZLF5TB6745ml1AfluEU6dFWqwRglWA6dtZLwpdKyWHjmGBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script src="firebase-config.js"></script>

  <script>
    // ××ª×—×•×œ Firebase
    if (typeof firebaseConfig !== 'undefined') {
        try {
            firebase.initializeApp(firebaseConfig);
            firebase.analytics();
        } catch (e) {
             console.error("Firebase initialization failed:", e);
             alert("×©×’×™××” ×‘××ª×—×•×œ Firebase.");
        }
    } else {
        alert("×©×’×™××” ×§×¨×™×˜×™×ª: ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”×’×“×¨×•×ª Firebase.");
        console.error("Firebase config is missing!");
    }
  </script>

  <script>
    // ×¨×™×©×•× Service Worker ×¢× × ×ª×™×‘ ×™×—×¡×™
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js')
          .then(function(registration) { /* Registered */ })
          .catch(function(err) { /* Failed */ });
      });
    }
  </script>

  <style>
    /* --- Reset & Basic Styles --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url("https://i.imgur.com/vPycdhd.jpeg") no-repeat center center fixed;
      background-size: cover;
      direction: rtl;
      padding-top: 70px;
      padding-bottom: 60px;
      text-align: center;
      color: #333;
      min-height: 100vh;
    }

    /* --- Header & Side Menu --- */
     .topbar { background-color: #0A2342; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; transition: transform 0.3s ease; border-bottom: 3px solid #2A558C; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
     .site-name { position: absolute; left: 50%; transform: translateX(-50%); font-size: 26px; color: #ecf0f1; cursor: pointer; font-weight: 600; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); }
     .hamburger-menu { font-size: 24px; color: #ecf0f1; cursor: pointer; padding: 8px 12px; border-radius: 5px; transition: background-color 0.3s; z-index: 1002; }
     .hamburger-menu:hover { background-color: rgba(255, 255, 255, 0.15); }
     .auth-button { background-color: #007bff; padding: 8px 16px; border-radius: 6px; transition: background-color 0.3s, box-shadow 0.3s; font-weight: 600; color: #FFFFFF; border: none; cursor: pointer; text-decoration: none; font-size: 0.95em; }
     .auth-button:hover { background-color: #0056b3; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
     .side-menu { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background-color: #0A2342; z-index: 1001; padding-top: 70px; transition: right 0.3s ease; box-shadow: -3px 0 8px rgba(0, 0, 0, 0.15); }
     .side-menu.active { right: 0; }
     .close-menu { position: absolute; top: 15px; left: 15px; font-size: 26px; color: #ecf0f1; cursor: pointer; padding: 5px; line-height: 1; }
     .close-menu:hover { color: #bdc3c7; }
     .side-menu-links { display: flex; flex-direction: column; padding: 10px 0; }
     .side-menu-links a { padding: 16px 25px; color: #ecf0f1; text-decoration: none; font-size: 17px; border-bottom: 1px solid rgba(236, 240, 241, 0.15); transition: background-color 0.2s ease-in-out; text-align: right; display: flex; align-items: center; }
     .side-menu-links a i { margin-left: 12px; width: 20px; text-align: center; font-size: 0.95em; }
     .side-menu-links a:last-child { border-bottom: none; }
     .side-menu-links a:hover { background-color: rgba(42, 85, 140, 0.5); }
     .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); z-index: 999; /* Lower than menu/modals */ display: none; transition: opacity 0.3s ease; opacity: 0; }
     .overlay.active { display: block; opacity: 1; }

    /* --- Main Content & General Styles --- */
    main {
      padding: 25px; margin: 30px auto; min-height: calc(100vh - 190px);
      background-color: rgba(255, 255, 255, 0.9); border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); max-width: 900px;
      text-align: center;
    }
    main h2 { font-size: 2.5em; color: #17a2b8; margin-bottom: 15px; font-weight: 600; }
    main p { color: #555; font-size: 1.1em; margin-bottom: 25px; }

    /* --- Buttons --- */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 10px 20px; /* Slightly smaller padding */
      background-color: #17a2b8; color: #fff; border: none; cursor: pointer;
      font-size: 15px; /* Slightly smaller font */
      font-weight: 500; border-radius: 6px; transition: all 0.3s ease;
      margin: 5px; text-decoration: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }
    .btn:hover { background-color: #138496; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transform: translateY(-2px); }
    .btn:active { transform: translateY(0); }
    .btn i { font-size: 0.95em; line-height: 1; }
     /* Action Buttons (Add Item, Add Accommodation) */
     .action-buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px; /* ×”×¨×•×•×— ×‘×™×Ÿ ×”×›×¤×ª×•×¨×™× */
        margin-bottom: 20px;
     }
    .action-buttons .btn {
      font-size: 18px; /* ×’×•×“×œ ×¨×’×™×œ ×™×•×ª×¨ */
      padding: 10px 20px;
      min-width: 180px; /* ×¨×•×—×‘ ××™× ×™××œ×™ ×œ×›×¤×ª×•×¨×™ ×”×¤×¢×•×œ×” */
    }
    /* ×›×¤×ª×•×¨ ×¤×œ×•×¡ × ×©××¨ ×’×“×•×œ ×™×•×ª×¨ */
    .action-buttons .btn[onclick*="openAddItemModal"] {
         font-size: 24px;
         padding: 8px 18px;
         line-height: 1;
         min-width: auto; /* ×œ×œ× ×¨×•×—×‘ ××™× ×™××œ×™ */
    }

    /* Button Group (Save, Screenshot, etc.) */
    .button-group { margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }

    /* --- Schedule Display --- */
    /* Date Header */
    #scheduleContainer .date-header-wrapper {
        display: flex; align-items: center; justify-content: flex-start;
        gap: 10px; border-bottom: 1px solid #eee; margin-top: 25px;
        margin-bottom: 10px; padding-bottom: 5px;
    }
     #scheduleContainer h3 { /* Date Text */
        color: #007bff; font-size: 1.3em; font-weight: 600; margin: 0;
        padding: 0; border: none; flex-grow: 1; text-align: right;
    }
    /* Accommodation Indicator */
    .accommodation-indicator {
        display: inline-flex; align-items: center; gap: 5px;
        background-color: #e9ecef; color: #495057; padding: 3px 8px;
        border-radius: 4px; font-size: 0.85em; font-weight: 500;
        cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        max-width: 150px; border: 1px solid #ced4da;
    }
    .accommodation-indicator:hover { background-color: #dee2e6; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .accommodation-indicator i { font-size: 0.9em; color: #6c757d; }


    /* Schedule Item */
    .schedule-item {
        position: relative; background-color: #ffffff; padding: 15px; margin: 15px auto;
        border-radius: 8px; box-shadow: 0 3px 7px rgba(0,0,0,0.1); cursor: pointer;
        text-align: right; max-width: 500px; transition: transform 0.2s, box-shadow 0.2s;
        overflow: hidden; border-left: 5px solid #17a2b8;
    }
     .schedule-item:hover { transform: translateY(-3px); box-shadow: 0 5px 12px rgba(0,0,0,0.15); }
     .schedule-item h3 { margin-bottom: 8px; color: #34495e; position: relative; z-index: 1; font-size: 1.1em; font-weight: 600; }
     .schedule-item p { position: relative; z-index: 1; color: #555; font-size: 0.95em; line-height: 1.5; margin-bottom: 5px; }
     .schedule-item p:last-child { margin-bottom: 0; }
     .schedule-item span[onclick*="deleteScheduleItem"] { position: absolute; top: 10px; left: 10px; cursor: pointer; font-size: 1.2em; color: #e74c3c; padding: 5px; transition: color 0.2s; z-index: 2; }
     .schedule-item span[onclick*="deleteScheduleItem"]:hover { color: #c0392b; }
     .emoji-background { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; opacity: 0.07; pointer-events: none; z-index: 0; }
     .nav-button { position: absolute; left: 10px; bottom: 10px; font-size: 12px; padding: 4px 10px; background-color: #6c757d; z-index: 2; }
     .nav-button:hover { background-color: #5a6268; }

    /* --- Modals --- */
    .modal {
      display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.6);
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-content {
      background-color: #ffffff; margin: auto; padding: 25px 30px; border-radius: 8px;
      width: 90%; max-width: 550px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      text-align: right; animation: fadeInScale 0.3s ease-out;
    }
    @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-content h2 { text-align: center; color: #17a2b8; margin-bottom: 25px; font-size: 1.8em; }
    .close { color: #aaa; position: absolute; left: 15px; top: 10px; font-size: 30px; font-weight: bold; cursor: pointer; line-height: 1; }
    .close:hover { color: #333; }
    .form-group { margin-bottom: 18px; text-align: right; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #495057;}
    .form-group label small { font-weight: normal; color: #6c757d; display: block; font-size: 0.85em;}
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px;
      font-size: 16px; color: #495057; background-color: #f8f9fa; text-align: right;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: #17a2b8; box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25); outline: none;
    }
     .form-group select { /* Arrow for select */
       background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ced4da%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
       background-repeat: no-repeat; background-position: left 0.75rem center; background-size: 8px 10px; padding-left: 2rem;
     }
     /* Subject management styles */
     #subjectsToggleBtn { background: none; border: 1px solid #ced4da; font-size: 20px; cursor: pointer; padding: 5px 8px; line-height: 1; border-radius: 4px; color: #6c757d; margin-right: 5px; vertical-align: middle; }
     #subjectsToggleBtn:hover { background-color: #e9ecef; }
     #permanentSubjectsList { display: none; position: absolute; right: 0; top: 40px; background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 8px; z-index: 2100; min-width: 200px; max-height: 150px; overflow-y: auto; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
     #permanentSubjectsList span { display: flex; justify-content: space-between; align-items: center; margin: 3px 0; padding: 6px 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.95em; }
     #permanentSubjectsList span span { cursor: pointer; color: #e74c3c; padding: 0 5px; margin-left: auto; } /* Push trash to the right */
     #permanentSubjectsList span span:hover { color: #c0392b; }

    /* Elegant Modals */
    .modal-elegant { border-top: 5px solid #17a2b8; }
    .modal-elegant h2 { color: #17a2b8; }
    .modal-content .btn { background-color: #17a2b8; }
    .modal-content .btn:hover { background-color: #138496; }

    /* Specific Modal Styles */
    #flightResultContent { max-height: 300px; overflow-y: auto; margin-bottom: 15px; text-align: right; }
    .flight-card { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin-bottom: 10px; }
    .flight-card h2 { font-size: 1.3em; margin-bottom: 10px; color: #17a2b8;}
    .flight-card p { font-size: 0.95em; margin-bottom: 5px; color: #333;}
    .flight-card p .time-label { font-weight: 600; color: #555;}
    .flight-search-wrapper { position: relative; }
    .flight-search-wrapper input { padding-left: 40px !important; }
    .flight-search-wrapper .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6c757d; font-size: 1.1em; }

    #finalScheduleModal .modal-content { max-width: 700px; }
    #finalScheduleDisplay { max-height: 60vh; overflow-y: auto; margin-bottom: 20px; }
    #finalScheduleDisplay .schedule-item { max-width: 100%; border-left: none; cursor: default; }
    #finalScheduleDisplay .schedule-item:hover { transform: none; box-shadow: 0 3px 7px rgba(0,0,0,0.1); }
    #finalScheduleTitle { font-size: 1.8em; color: #17a2b8; margin-bottom: 20px; text-align: center; }

    #addSubjectModal .form-group { margin-top: 25px; }

    /* Accommodation Info Popup Styles */
     #accommodationInfoPopup {
         display: none; position: absolute; background-color: #fff; border: 1px solid #ccc;
         border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px;
         z-index: 2500; min-width: 250px; max-width: 300px; font-size: 0.9em;
         text-align: right; line-height: 1.6; color: #333;
     }
      #accommodationInfoPopup h4 { margin-top: 0; margin-bottom: 10px; color: #17a2b8; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; align-items: center; gap: 8px; }
      #accommodationInfoPopup p { margin-bottom: 5px; }
      #accommodationInfoPopup p strong { color: #555; margin-left: 5px; }
      #accommodationInfoPopup .popup-actions { margin-top: 15px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
      #accommodationInfoPopup .popup-actions .btn { padding: 5px 12px; font-size: 0.9em; }
      #accommodationInfoPopup .popup-actions .close-popup-btn { background: none; border: none; color: #aaa; font-size: 1.5em; cursor: pointer; padding: 0 5px; line-height: 1; }
      #accommodationInfoPopup .popup-actions .close-popup-btn:hover { color: #555; }


    /* --- Loaders --- */
    /* General loader styles still needed for flight search loader */
    .loader-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); color: #fff;
      display: flex; /* Base style, overridden by individual loaders */
      align-items: center; justify-content: center; font-size: 1.6rem; z-index: 3000;
      flex-direction: column; gap: 15px;
      opacity: 1;
    }
    .loader-overlay i { font-size: 2.5em; animation: spin 1.5s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* Flight loader initially hidden */
    #loader { display: none; }

    /* --- Responsiveness --- */
     @media (max-width: 768px) {
         body { padding-top: 60px; }
         main { padding: 20px; margin: 20px auto; max-width: 95%; }
         main h2 { font-size: 2em; }
         .modal-content { padding: 20px; }
         .modal-content h2 { font-size: 1.5em; }
         .action-buttons { flex-direction: column; gap: 10px; align-items: stretch;}
         .action-buttons .btn { width: 100%; min-width: unset; }
         #accommodationInfoPopup { max-width: 90%; }
     }
     @media (max-width: 600px) {
         .auth-button { padding: 7px 12px; font-size: 0.9em;}
         .side-menu { width: 250px; }
         .side-menu-links a { padding: 14px 20px; font-size: 16px; }
         .side-menu-links a i { margin-left: 10px; }
         main { padding: 15px; }
         main h2 { font-size: 1.8em; }
         main p { font-size: 1em; }
         .btn { font-size: 15px; padding: 9px 15px; }
         .action-buttons .btn { font-size: 16px; padding: 10px 15px; }
         .action-buttons .btn[onclick*="openAddItemModal"] { font-size: 22px; padding: 7px 16px; }
         .button-group { flex-direction: column; align-items: stretch; gap: 10px;}
         .button-group .btn { width: 100%; }
         .modal-content { width: 95%; padding: 15px 20px;}
         .form-group input, .form-group select, .form-group textarea { padding: 10px; font-size: 15px; }
         .schedule-item { padding: 12px; }
         .schedule-item h3 { font-size: 1em; }
         .schedule-item p { font-size: 0.9em; }
         footer { padding: 20px; }
          #scheduleContainer h3 { font-size: 1.2em; }
          .accommodation-indicator { font-size: 0.8em; padding: 2px 6px; max-width: 120px;}
     }
  </style>
</head>
<body>

  <div class="overlay" id="overlay"></div>

  <nav class="topbar">
    <div class="hamburger-menu" onclick="toggleMenu()"> <i class="fas fa-bars"></i> </div>
    <div class="site-name" onclick="goHome()">×–××Ÿ ×–×”×‘</div>
    <a href="auth.html" id="authLink" class="auth-button">×”×ª×—×‘×¨×•×ª</a>
  </nav>

  <div class="side-menu" id="sideMenu">
    <div class="close-menu" onclick="toggleMenu()"> <i class="fas fa-times"></i> </div>
    <div class="side-menu-links">
        <a href="choose-schedule.html"><i class="fas fa-calendar-plus"></i> ×œ×•×´×– ×—×“×©</a>
        <a href="my-schedules.html"><i class="fas fa-folder-open"></i> ×”×œ×•×–×™×´× ×©×œ×™</a>
        <a href="tips.html"><i class="fas fa-lightbulb"></i> ×˜×™×¤×™× ×œ× ×™×”×•×œ ×–×× ×™×</a>
        <a href="how-to-use.html"><i class="fas fa-info-circle"></i> ×¢×–×¨×” ×•×”×¡×‘×¨</a>
    </div>
  </div>

  <main id="content">
    <h2>×‘× ×™×™×ª ×œ×•×– ×—×•×¤×©×” ×—×“×© ğŸ–ï¸</h2>
    <p>×”×•×¡×£ ×¤×¢×™×œ×•×™×•×ª ×•××§×•××•×ª ×©×”×™×™×” ×œ×œ×•"×– ×©×œ×š.</p>
    <div class="action-buttons">
      <button class="btn" onclick="openAddItemModal()" title="×”×•×¡×£ ×¤×¨×™×˜ ×œ×œ×•×–">+</button>
      <button class="btn" onclick="openAccommodationModal()" title="×”×•×¡×£ ××§×•× ×©×”×™×™×”">
        <i class="fas fa-bed"></i> ×”×•×¡×£ ××§×•× ×©×”×™×™×”
      </button>
    </div>
    <div id="scheduleContainer"></div>
    <div class="button-group">
      <button class="btn" onclick="openFinalSchedule()">
          <i class="fas fa-save"></i> ×©××•×¨ ×•×¡×™×™× ×œ×•×´×–
        </button>
    </div>
  </main>

  <footer>Â©ï¸doronnakache</footer>

  <div id="scheduleNameModal" class="modal">
    <div class="modal-content modal-elegant">
      <span class="close" onclick="closeScheduleNameModal()">Ã—</span>
      <h2>×”×–×Ÿ ×©× ×œ×œ×•×´×– ×”×—×•×¤×©×”</h2>
      <div class="form-group"> <label for="scheduleNameInput">×©× ×”×œ×•×´×–:</label> <input type="text" id="scheduleNameInput" placeholder="×œ××©×œ: ×—×•×¤×©×” ×‘×™×•×•×Ÿ - ×§×™×¥ 2025"> </div>
      <button class="btn" onclick="saveScheduleName()">×”××©×š</button>
    </div>
  </div>

  <div id="addItemModal" class="modal">
    <div class="modal-content modal-elegant">
        <span class="close" onclick="closeAddItemModal()">Ã—</span>
        <h2 id="addItemModalTitle">×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×œ×•×´×–</h2>
        <form id="addItemForm" style="display: contents;">
            <div class="form-group"> <label for="modalDate">×ª××¨×™×š:</label> <input type="date" id="modalDate"> </div>
            <div class="form-group"> <label for="modalStartTime" id="startTimeLabel">×©×¢×ª ×”×ª×—×œ×”:</label> <input type="time" id="modalStartTime" onchange="setDefaultEndTime()"> </div>
            <div class="form-group"> <label for="modalEndTime" id="endTimeLabel">×©×¢×ª ×¡×™×•×:</label> <input type="time" id="modalEndTime"> </div>
            <div id="timeNote" style="font-size: 0.9rem; color: #555; display: none; margin-bottom: 10px; text-align: center;"></div>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; gap: 10px;"> <label for="modalSubject" style="flex-shrink: 0;">× ×•×©×:</label> <select id="modalSubject" onchange="subjectChangeHandler()" style="flex-grow: 1;"></select> <div style="position: relative; display: inline-block;"> <button type="button" id="subjectsToggleBtn" onclick="togglePermanentSubjectsList()" title="× ×”×œ × ×•×©××™× ×§×‘×•×¢×™×">â‹®</button> <div id="permanentSubjectsList"></div> </div> </div>
             <div id="extraQuestions" style="display: none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;"> <div class="form-group"> <label for="fromAddress">×××™×¤×”: <small>×›×ª×•×‘×ª ××• ××§×•× ×™×¦×™××”</small></label> <input type="text" id="fromAddress" placeholder="×œ×“×•×’××”: ×©×“×” ×”×ª×¢×•×¤×” ×‘×Ÿ ×’×•×¨×™×•×Ÿ"> </div> <div class="form-group"> <label for="toAddress">×œ××Ÿ: <small>×›×ª×•×‘×ª ××• ××§×•× ×™×¢×“</small></label> <input type="text" id="toAddress" placeholder="×œ×“×•×’××”: ××œ×•×Ÿ ×”×™×œ×˜×•×Ÿ, ××ª×•× ×”"> </div> <div class="form-group" id="travelModeGroup" style="display: none;"> <label for="travelModeSelect">×××¦×¢×™ × ×¡×™×¢×”:</label> <select id="travelModeSelect"> <option value="taxi">××•× ×™×ª ğŸš–</option> <option value="transit">×ª×—×‘×´×¦ ğŸš‹ğŸš†</option> <option value="car">×¨×›×‘ ×¤×¨×˜×™ / ×©×›×•×¨ ğŸš™</option> </select> </div> <button type="button" class="btn" id="checkRouteBtn" onclick="checkRoute()" style="background-color: #6c757d;"> <i class="fas fa-map-marker-alt"></i> ×‘×“×•×§ ××¡×œ×•×œ ×‘××¤×•×ª Google </button> </div>
             <div id="locationField" style="display:none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;" class="form-group"> <label for="locationInput">××™×§×•×: <small>×”×–×Ÿ ××ª ×©× ×”××§×•× ××• ×”×›×ª×•×‘×ª</small></label> <input type="text" id="locationInput" placeholder="×œ×“×•×’××”: ×”××§×¨×•×¤×•×œ×™×¡, ××ª×•× ×”"> <button type="button" class="btn" onclick="navigateToGenericLocation()" style="background-color: #6c757d; margin-top: 10px;"> <i class="fas fa-map-marker-alt"></i> × ×•×•×˜ ×œ××™×§×•× ×‘××¤×•×ª Google </button> </div>
             <div id="foodExtraOptions" style="display:none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;"> <div class="form-group"> <label for="foodTypeSelect">×¡×•×’ ××¨×•×—×” / ××§×•×:</label> <select id="foodTypeSelect" onchange="foodTypeChangeHandler()"> <option value="">-- ×‘×—×¨ --</option> <option value="××¡×¢×“×”">××¡×¢×“×” ğŸ‘¨â€ğŸ³</option> <option value="×‘×™×ª ×§×¤×”">×‘×™×ª ×§×¤×” â˜•</option> <option value="×‘××œ×•×Ÿ">×‘××œ×•×Ÿ ğŸ¨</option> <option value="×”×›× ×” ×¢×¦××™×ª/×§× ×™×™×” ×‘×¡×•×¤×¨">×§× ×™×•×ª/×”×›× ×” ×¢×¦××™×ª ğŸ›’</option> <option value="××•×›×œ ××”×™×¨">××•×›×œ ××”×™×¨ ğŸ¥™</option> <option value="×¤×™×§× ×™×§">×¤×™×§× ×™×§ ğŸ§º</option> </select> </div> <div id="foodLocationDiv" class="form-group" style="display:none;"> <label for="foodLocationInput">×©× ×”××§×•× / ××™×§×•×:</label> <input type="text" id="foodLocationInput" placeholder="×œ×“×•×’××”: Ta Karamanlidika tou Fani"> <button type="button" class="btn" onclick="showFoodRoute()" style="background-color: #6c757d; margin-top: 10px;"> <i class="fas fa-map-marker-alt"></i> × ×•×•×˜ ×œ××§×•× ×‘××¤×•×ª Google </button> </div> </div>
             <div id="flightExtraOptions" style="display:none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;"> <div class="form-group flight-search-wrapper"> <label for="flightNumberInput">××¡×¤×¨ ×˜×™×¡×”:</label> <input type="text" id="flightNumberInput" placeholder="×œ××©×œ: LY541"> <span class="search-icon" onclick="searchFlight()" title="×—×¤×© ×¤×¨×˜×™ ×˜×™×¡×”">ğŸ”</span> </div> <div class="form-group"> <label for="airlineInput">×—×‘×¨×ª ×ª×¢×•×¤×”:</label> <input type="text" id="airlineInput" placeholder="×œ×“×•×’××”: ××œ ×¢×œ"> </div> <div class="form-group"> <label for="departureAirportInput">×©×“×” ×ª×¢×•×¤×” (×”××¨××”):</label> <input type="text" id="departureAirportInput" placeholder="×œ×“×•×’××”: Ben Gurion Intl"> </div> <div class="form-group"> <label for="arrivalAirportInput">×©×“×” ×ª×¢×•×¤×” (× ×—×™×ª×”):</label> <input type="text" id="arrivalAirportInput" placeholder="×œ×“×•×’××”: Eleftherios Venizelos Intl Airport"> </div> </div>
            <div class="form-group" id="descriptionGroup" style="display: none;"> <label for="modalDescription">×ª×™××•×¨ / ×”×¢×¨×•×ª:</label> <textarea id="modalDescription" rows="3" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×, ×›×¨×˜×™×¡×™×, ×”×–×× ×•×ª ×•×›×•'"></textarea> </div>
            <button type="button" class="btn" id="addItemBtn" onclick="saveItem()" style="display: none;"> <i class="fas fa-check"></i> ×”×•×¡×£ / ×©××•×¨ ×©×™× ×•×™×™× </button>
        </form>
      </div>
  </div>

   <div id="accommodationModal" class="modal">
     <div class="modal-content modal-elegant">
       <span class="close" onclick="closeAccommodationModal()">Ã—</span>
       <h2>×”×•×¡×¤×ª ××§×•× ×©×”×™×™×”</h2>
       <form id="accommodationForm" style="display: contents;">
         <div class="form-group"> <label for="accommodationType">×¡×•×’ ×”××§×•×:</label> <select id="accommodationType"> <option value="">-- ×‘×—×¨ ×¡×•×’ --</option> <option value="××œ×•×Ÿ">××œ×•×Ÿ ğŸ¨</option> <option value="×“×™×¨×”">×“×™×¨×” ğŸ¢</option> <option value="Airbnb">Airbnb <i class="fab fa-airbnb"></i></option> <option value="×”×•×¡×˜×œ">×”×•×¡×˜×œ ğŸ’</option> <option value="×§××¤×™× ×’">×§××¤×™× ×’ â›º</option> <option value="××—×¨">××—×¨ â“</option> </select> </div>
         <div class="form-group"> <label for="accommodationName">×©× ×”××§×•×:</label> <input type="text" id="accommodationName" placeholder="×œ×“×•×’××”: Hilton Athens"> </div>
         <div class="form-group"> <label for="accommodationAddress">×›×ª×•×‘×ª:</label> <input type="text" id="accommodationAddress" placeholder="×œ×“×•×’××”: Vasilissis Sofias Avenue 46, Athens"> </div>
         <div class="form-group"> <button type="button" class="btn" onclick="checkAccommodationLocation()" style="background-color: #6c757d;"> <i class="fas fa-map-marker-alt"></i> ×”×¦×’ ××™×§×•× ×‘××¤×” </button> </div>
         <div class="form-group"> <label for="accommodationCheckIn">×ª××¨×™×š ×¦'×§-××™×Ÿ:</label> <input type="date" id="accommodationCheckIn"> </div>
         <div class="form-group"> <label for="accommodationCheckOut">×ª××¨×™×š ×¦'×§-×××•×˜:</label> <input type="date" id="accommodationCheckOut"> </div>
         <button type="button" class="btn" onclick="saveAccommodation()"> <i class="fas fa-save"></i> ×©××•×¨ ××§×•× ×©×”×™×™×” </button>
       </form>
     </div>
   </div>

  <div id="flightResultModal" class="modal"> <div class="modal-content modal-elegant"> <span class="close" onclick="closeFlightResultModal()">Ã—</span> <h2><i class="fas fa-plane-departure"></i> ×ª×•×¦××•×ª ×—×™×¤×•×© ×˜×™×¡×”</h2> <div id="flightResultContent"></div> <button class="btn" onclick="copyFlightToForm()"> <i class="fas fa-copy"></i> ×”×¢×ª×§ ×¤×¨×˜×™× ×œ×˜×•×¤×¡ </button> </div> </div>
  <div id="finalScheduleModal" class="modal"> <div class="modal-content" id="finalScheduleContent"> <span class="close" onclick="closeFinalScheduleModal()">Ã—</span> <h2 id="finalScheduleTitle"></h2> <div id="finalScheduleDisplay"></div> <div class="button-group"> <button class="btn" onclick="captureScreenshotFromElement('finalScheduleDisplay', scheduleName)"> <i class="fas fa-camera"></i> ×¦×™×œ×•× ××¡×š </button> <button class="btn" onclick="copyScheduleToClipboard()"> <i class="fas fa-copy"></i> ×”×¢×ª×§ ×›×˜×§×¡×˜ </button> <button class="btn" onclick="editFinalSchedule()"> <i class="fas fa-edit"></i> ×¢×¨×•×š ×œ×•"×– </button> <button class="btn" onclick="closeFinalScheduleModal()" style="background-color: #6c757d;"> <i class="fas fa-times"></i> ×¡×’×•×¨ </button> </div> </div> </div>
  <div id="addSubjectModal" class="modal"> <div class="modal-content modal-elegant"> <span class="close" onclick="closeAddSubjectModal()">Ã—</span> <h2>×”×•×¡×¤×ª × ×•×©× ×—×“×©</h2> <div class="form-group"> <label for="newSubjectNameInput">×©× ×”× ×•×©× (××•××œ×¥ ×œ×”×•×¡×™×£ ×××•×’'×™):</label> <input type="text" id="newSubjectNameInput" placeholder="×œ××©×œ: ×‘×˜×Ÿ-×’×‘ ×‘×—×•×£ ğŸ–ï¸"> </div> <div class="form-group" style="display: flex; justify-content: space-around; gap: 10px;"> <button class="btn" onclick="addSubjectOneTime()"> <i class="fas fa-plus"></i> ×”×•×¡×¤×” ×—×“ ×¤×¢××™×ª </button> <button class="btn" onclick="addSubjectPermanent()" style="background-color: #28a745;"> <i class="fas fa-star"></i> ×”×•×¡×¤×” ×§×‘×•×¢×” </button> </div> </div> </div>
  <div class="loader-overlay" id="loader" style="display: none;"> <i class="fas fa-spinner"></i> <span>××—×¤×© ×¤×¨×˜×™ ×˜×™×¡×”...</span> </div>
  <div id="accommodationInfoPopup"> <h4><span id="popupAccIcon"></span> <span id="popupAccName"></span></h4> <p><strong>×¡×•×’:</strong> <span id="popupAccType"></span></p> <p><strong>×›×ª×•×‘×ª:</strong> <span id="popupAccAddress"></span></p> <p><strong>×ª××¨×™×›×™×:</strong> <span id="popupAccDates"></span></p> <div class="popup-actions"> <button class="btn" id="popupAccNavBtn" onclick=""> <i class="fas fa-route"></i> × ×•×•×˜ </button> <button class="close-popup-btn" onclick="closeAccommodationInfoPopup()" title="×¡×’×•×¨">Ã—</button> </div> </div>


  <script>
    // --- Global Variables & Settings ---
    let db;
    try { db = firebase.firestore(); }
    catch (e) { console.error("Firestore init error:", e); }

    const subjectEmojis = { "×”×œ×™×›×”": "ğŸš¶", "× ×¡×™×¢×”": "ğŸš—", "×‘×™×§×•×¨/×¡×™×•×¨": "ğŸ›ï¸", "×˜×™×¡×”": "âœˆï¸", "××•×›×œ": "ğŸ½ï¸", "×©×™× ×”": "ğŸ˜´", "×œ×§×•×": "â°", "×—×•×£": "ğŸ–ï¸", "×§× ×™×•×ª": "ğŸ›ï¸", "×× ×•×—×”": "ğŸ§˜", "×‘×¨×™×›×”": "ğŸŠ", "××˜×¨×§×¦×™×”": "ğŸ¢", "××•×–×™××•×Ÿ": "ğŸ–¼ï¸", "××¡×¢×“×”": "ğŸ‘¨â€ğŸ³", "×‘×™×ª ×§×¤×”": "â˜•", "×‘××œ×•×Ÿ": "ğŸ¨", "×§× ×™×•×ª/×”×›× ×” ×¢×¦××™×ª": "ğŸ›’", "××•×›×œ ××”×™×¨": "ğŸ¥™", "×¤×™×§× ×™×§": "ğŸ§º", "×›×œ×œ×™": "ğŸ“Œ" };
    let scheduleItems = [];
    let accommodations = [];
    let scheduleName = null;
    let savedSchedules = [];
    let editingIndex = -1;
    let editingSavedScheduleIndex = -1;
    let permanentSubjects = JSON.parse(localStorage.getItem('permanentVacationSubjects') || '[]');
    let customSubjects = [];

    // --- Navigation & Menu Functions ---
    function goHome() { window.location.href = "index.html"; }
    function toggleMenu() {
      const sideMenu = document.getElementById("sideMenu");
      const overlay = document.getElementById("overlay");
      if(!sideMenu || !overlay) return;
      const isActive = sideMenu.classList.contains("active");
      sideMenu.classList.toggle("active");
      overlay.classList.toggle("active");
      document.body.style.overflow = isActive ? "" : "hidden";
    }
    document.getElementById("overlay")?.addEventListener("click", toggleMenu);

    // --- Firebase Auth State ---
    firebase.auth().onAuthStateChanged(function(user) {
        const authLink = document.getElementById("authLink");
        if (user) {
             let currentHour = new Date().getHours();
             let greeting = "×‘×•×§×¨ ×˜×•×‘";
             if (currentHour >= 12 && currentHour < 18) greeting = "×¦×”×¨×™×™× ×˜×•×‘×™×";
             else if (currentHour >= 18) greeting = "×¢×¨×‘ ×˜×•×‘";
             let firstName = user.displayName ? user.displayName.split(" ")[0] : user.email?.split("@")[0] || "××©×ª××©";
             firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1);
             if(authLink) {
                 authLink.innerText = `${greeting}, ${firstName}!`; authLink.title = "×”×ª× ×ª×§";
                 authLink.onclick = (e) => { e.preventDefault(); if (confirm("×œ×”×ª× ×ª×§?")) { firebase.auth().signOut().catch(e => console.error("Sign out error", e)); } }; authLink.href = "#";
             }
            loadSavedSchedulesData();
            checkForScheduleToEdit();
        } else {
            if(authLink) {
                 authLink.innerText = "×”×ª×—×‘×¨×•×ª"; authLink.title = "×”×ª×—×‘×¨ ××• ×”×™×¨×©×"; authLink.href = "auth.html"; authLink.onclick = null;
            }
            savedSchedules = []; scheduleName = null; scheduleItems = []; accommodations = []; editingSavedScheduleIndex = -1;
            const contentArea = document.getElementById('content');
            const nameModal = document.getElementById('scheduleNameModal');
             if (contentArea && nameModal && (!contentArea.innerHTML.includes('×¢×¨×™×›×ª ×œ×•"×–') || nameModal.style.display !== 'flex')) {
                 renderInitialView();
             } else if (contentArea && !contentArea.innerHTML.includes('×¢×¨×™×›×ª ×œ×•"×–') && !contentArea.querySelector('h2')?.innerText.includes('×œ×•"×–:')) {
                  renderInitialView();
             }
        }
    });

    // --- Header Scroll Behavior ---
    let lastScrollTop = 0;
    window.addEventListener("scroll", function() {
      let currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      const nav = document.querySelector(".topbar");
      const sideMenu = document.getElementById("sideMenu");
      if (nav && (!sideMenu || !sideMenu.classList.contains("active"))) {
           if (currentScroll > lastScrollTop && currentScroll > 70) nav.style.transform = "translateY(-100%)";
           else nav.style.transform = "translateY(0)";
      }
      lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
    }, false);

    // --- Initial View Rendering ---
    function renderInitialView() {
        const content = document.getElementById('content');
        if(content) {
            if (content.querySelector('h2')?.innerText.includes('×‘× ×™×™×ª ×œ×•×– ×—×•×¤×©×” ×—×“×©')) {
                renderScheduleItems();
                return;
            }
            content.innerHTML = `
                <h2>×‘× ×™×™×ª ×œ×•×– ×—×•×¤×©×” ×—×“×© ğŸ–ï¸</h2>
                <p>×”×•×¡×£ ×¤×¢×™×œ×•×™×•×ª ×•××§×•××•×ª ×©×”×™×™×” ×œ×œ×•"×– ×©×œ×š.</p>
                <div class="action-buttons">
                  <button class="btn" onclick="openAddItemModal()" title="×”×•×¡×£ ×¤×¨×™×˜ ×œ×œ×•×–">+</button>
                  <button class="btn" onclick="openAccommodationModal()" title="×”×•×¡×£ ××§×•× ×©×”×™×™×”">
                    <i class="fas fa-bed"></i> ×”×•×¡×£ ××§×•× ×©×”×™×™×”
                  </button>
                </div>
                <div id="scheduleContainer"></div>
                <div class="button-group">
                  <button class="btn" onclick="openFinalSchedule()">
                      <i class="fas fa-save"></i> ×©××•×¨ ×•×¡×™×™× ×œ×•×´×–
                    </button>
                </div>
            `;
            renderScheduleItems();
        }
    }

    // --- Data Loading/Saving (Includes Accommodations) ---
     function loadSavedSchedulesData() {
         const user = firebase.auth().currentUser;
         if (user && db) {
             db.collection("schedules").doc(user.uid).get().then((doc) => {
                 if (doc.exists) {
                     const data = doc.data();
                     savedSchedules = data.schedules || [];
                     accommodations = Array.isArray(data.accommodations) ? data.accommodations : [];
                 } else {
                     savedSchedules = []; accommodations = [];
                 }
             }).catch(error => {
                 console.error("Error loading saved data: ", error);
                 savedSchedules = []; accommodations = [];
             });
         } else {
            savedSchedules = []; accommodations = [];
         }
     }

     function checkForScheduleToEdit() {
         const scheduleDataString = localStorage.getItem('scheduleToEdit');
         localStorage.removeItem('scheduleToEdit');

         if (scheduleDataString) {
             try {
                 const scheduleData = JSON.parse(scheduleDataString);
                 if (scheduleData && scheduleData.schedule && scheduleData.originalIndex !== undefined) {
                     const loadedSchedule = scheduleData.schedule;
                     scheduleName = loadedSchedule.name;
                     scheduleItems = JSON.parse(JSON.stringify(loadedSchedule.scheduleItems || []));
                     accommodations = JSON.parse(JSON.stringify(loadedSchedule.accommodations || []));
                     editingSavedScheduleIndex = scheduleData.originalIndex;
                     document.getElementById("content").innerHTML = `<h2><i class="fas fa-edit"></i> ×¢×¨×™×›×ª ×œ×•"×–: ${scheduleName.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</h2> <p>×”×•×¡×£, ×¢×¨×•×š ××• ××—×§ ×¤×¨×™×˜×™× ×•××§×•××•×ª ×©×”×™×™×” ×‘×œ×•"×–.</p> <div class="action-buttons"> <button class="btn" onclick="openAddItemModal()" title="×”×•×¡×£ ×¤×¨×™×˜ ×œ×œ×•×–">+</button> <button class="btn" onclick="openAccommodationModal()" title="×”×•×¡×£ ××§×•× ×©×”×™×™×”"> <i class="fas fa-bed"></i> ×”×•×¡×£ ××§×•× ×©×”×™×™×” </button> </div> <div id="scheduleContainer"></div> <div class="button-group"> <button class="btn" onclick="updateAndFinish()"> <i class="fas fa-save"></i> ×©××•×¨ ×©×™× ×•×™×™× ×•×¡×™×™× </button> <button class="btn" onclick="window.location.href='my-schedules.html'" style="background-color: #6c757d;"> <i class="fas fa-times"></i> ×‘×˜×œ ×©×™× ×•×™×™× ×•×—×–×•×¨ </button> </div>`;
                     renderScheduleItems();
                 } else { renderInitialView(); }
             } catch (e) {
                 console.error("Error parsing schedule to edit:", e); renderInitialView();
             }
         } else if (!document.getElementById("content")?.innerHTML.includes('×¢×¨×™×›×ª ×œ×•"×–')) {
             renderInitialView();
         }
     }

     function saveSchedulesToFirestore() {
       const user = firebase.auth().currentUser;
       if (user && db) {
         const schedulesToSave = Array.isArray(savedSchedules) ? savedSchedules : [];
         const accommodationsToSave = Array.isArray(accommodations) ? accommodations : [];
         const validSchedules = schedulesToSave.filter(sch => sch && sch.name && Array.isArray(sch.scheduleItems));
         const validAccommodations = accommodationsToSave.filter(acc => acc && acc.type && acc.name && acc.address && acc.checkInDate && acc.checkOutDate);
         db.collection("schedules").doc(user.uid).set({ schedules: validSchedules, accommodations: validAccommodations }, { merge: true })
           .catch((error) => { console.error("Error saving data to Firestore: ", error); alert(`×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×: ${error.message}`); });
       } else if (!user) { alert("××™× ×š ××—×•×‘×¨. ×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ×©×™× ×•×™×™×."); }
     }

     function updateAndFinish() {
         if (editingSavedScheduleIndex === -1 || !Array.isArray(savedSchedules) || editingSavedScheduleIndex >= savedSchedules.length) { alert("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ×œ×•×– ×œ× ×§×™×™×."); return; }
         const updatedSchedule = { name: scheduleName, scheduleItems: JSON.parse(JSON.stringify(scheduleItems)), accommodations: JSON.parse(JSON.stringify(accommodations)), category: "×—×•×¤×©×”" };
         savedSchedules[editingSavedScheduleIndex] = updatedSchedule;
         saveSchedulesToFirestore();
         displayFinalScheduleModal(updatedSchedule);
         editingSavedScheduleIndex = -1;
     }

     function openFinalSchedule() {
         if (!scheduleName) { alert("×©×’×™××”: ×œ× × ×§×‘×¢ ×©× ×œ×œ×•×–."); document.getElementById("scheduleNameModal").style.display = "flex"; return; }
         const newSchedule = { name: scheduleName, scheduleItems: JSON.parse(JSON.stringify(scheduleItems)), accommodations: JSON.parse(JSON.stringify(accommodations)), category: "×—×•×¤×©×”" };
         if (editingSavedScheduleIndex === -1) { savedSchedules.push(newSchedule); }
         else if (editingSavedScheduleIndex >= 0 && editingSavedScheduleIndex < savedSchedules.length) { savedSchedules[editingSavedScheduleIndex] = newSchedule; }
         else { alert("×©×’×™××” ×‘×©××™×¨×ª ×”×œ×•×–."); return; }
         saveSchedulesToFirestore();
         displayFinalScheduleModal(newSchedule);
         editingSavedScheduleIndex = -1;
     }

      function displayFinalScheduleModal(scheduleData) {
          let finalHtml = "";
          const currentScheduleItems = scheduleData.scheduleItems || [];
          const currentAccommodations = scheduleData.accommodations || [];
          const groups = groupItemsByDate(currentScheduleItems);
          const allDates = new Set([ ...currentScheduleItems.map(item => item.date), ...currentAccommodations.flatMap(acc => getDatesInRange(acc.checkInDate, acc.checkOutDate)) ]);
          const sortedDates = Array.from(allDates).filter(Boolean).sort();

          sortedDates.forEach(date => {
              const activeAcc = currentAccommodations.find(acc => acc.checkInDate && acc.checkOutDate && date >= acc.checkInDate && date < acc.checkOutDate);
              finalHtml += `<h3 style="margin-top: 15px; padding-bottom: 3px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                              <span>${formatDateHeader(date)}</span>
                              ${activeAcc ? `<span style="font-size: 0.7em; font-weight: normal; color: #555; margin-right: 10px; white-space: nowrap;">(${getAccommodationIcon(activeAcc.type)} ${activeAcc.name})</span>` : ''}
                            </h3>`;
              if (groups[date]) {
                  groups[date].forEach(item => {
                       const itemIndex = currentScheduleItems.findIndex(i => i === item);
                      finalHtml += generateScheduleItemHTML(item, itemIndex , true);
                  });
              } else if (!activeAcc) {
                  finalHtml += '<p style="color: #999; font-size: 0.9em; margin: 5px 0; text-align: right;">××™×Ÿ ×¤×¨×™×˜×™× ×œ×™×•× ×–×”.</p>';
              }
          });

          const finalScheduleModal = document.getElementById("finalScheduleModal");
          const finalScheduleTitle = document.getElementById("finalScheduleTitle");
          const finalScheduleDisplay = document.getElementById("finalScheduleDisplay");
          if(finalScheduleModal && finalScheduleTitle && finalScheduleDisplay) {
             finalScheduleTitle.innerText = scheduleData.name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
             finalScheduleDisplay.innerHTML = finalHtml || '<p style="text-align: center; color: #777;">×”×œ×•"×– ×¨×™×§.</p>';
             finalScheduleModal.style.display = "flex";
              const editButton = finalScheduleModal.querySelector('.button-group button[onclick^="editFinalSchedule"]');
              if(editButton) {
                  editButton.innerHTML = '<i class="fas fa-edit"></i> ×¢×¨×•×š ×œ×•"×–';
                  editButton.disabled = false;
                  editButton.style.backgroundColor = "";
                   if (document.querySelector('.button-group button[onclick^="updateAndFinish"]')?.disabled) {
                        editButton.innerHTML = '<i class="fas fa-check"></i> ×”×œ×•×– ×¢×•×“×›×Ÿ';
                        editButton.disabled = true;
                        editButton.style.backgroundColor = "#28a745";
                   }
              }
          }
      }

     function editFinalSchedule() {
         document.getElementById("finalScheduleModal").style.display = "none";
         if (editingSavedScheduleIndex === -1) { editingSavedScheduleIndex = savedSchedules.length - 1; }
         if (editingSavedScheduleIndex < 0 || !Array.isArray(savedSchedules) || editingSavedScheduleIndex >= savedSchedules.length) { alert("×©×’×™××”: ×œ× × ××¦× ×”×œ×•×– ×œ×¢×¨×™×›×”."); renderInitialView(); return; }
         const scheduleToEdit = savedSchedules[editingSavedScheduleIndex];
         scheduleName = scheduleToEdit.name;
         scheduleItems = JSON.parse(JSON.stringify(scheduleToEdit.scheduleItems || []));
         accommodations = JSON.parse(JSON.stringify(scheduleToEdit.accommodations || []));
         document.getElementById("content").innerHTML = `<h2><i class="fas fa-edit"></i> ×¢×¨×™×›×ª ×œ×•"×–: ${scheduleName.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</h2> <p>×”×•×¡×£, ×¢×¨×•×š ××• ××—×§ ×¤×¨×™×˜×™× ×•××§×•××•×ª ×©×”×™×™×” ×‘×œ×•"×–.</p> <div class="action-buttons"> <button class="btn" onclick="openAddItemModal()" title="×”×•×¡×£ ×¤×¨×™×˜ ×œ×œ×•×–">+</button> <button class="btn" onclick="openAccommodationModal()" title="×”×•×¡×£ ××§×•× ×©×”×™×™×”"> <i class="fas fa-bed"></i> ×”×•×¡×£ ××§×•× ×©×”×™×™×” </button> </div> <div id="scheduleContainer"></div> <div class="button-group"> <button class="btn" onclick="updateAndFinish()"> <i class="fas fa-save"></i> ×©××•×¨ ×©×™× ×•×™×™× ×•×¡×™×™× </button> <button class="btn" onclick="window.location.href='my-schedules.html'" style="background-color: #6c757d;"> <i class="fas fa-times"></i> ×‘×˜×œ ×©×™× ×•×™×™× ×•×—×–×•×¨ </button> </div>`;
         renderScheduleItems();
     }

     function closeFinalScheduleModal() {
        document.getElementById("finalScheduleModal").style.display = "none";
        window.location.href = "my-schedules.html";
     }

    // --- Schedule Rendering ---
    function renderScheduleItems() {
         const container = document.getElementById("scheduleContainer");
         if (!container) return;
         container.innerHTML = "";

         scheduleItems.sort((a, b) => (a.date || "").localeCompare(b.date || "") || (a.startTime || "").localeCompare(b.startTime || ""));
         const groups = groupItemsByDate(scheduleItems);
         const allDates = new Set([ ...scheduleItems.map(item => item.date), ...accommodations.flatMap(acc => getDatesInRange(acc.checkInDate, acc.checkOutDate)) ]);
         const sortedDates = Array.from(allDates).filter(Boolean).sort();

         if (sortedDates.length === 0) { container.innerHTML = '<p style="color: #6c757d; margin-top: 20px;">×”×œ×•"×– ×¢×“×™×™×Ÿ ×¨×™×§. ×œ×—×¥ ×¢×œ \'+\' ×œ×”×•×¡×¤×ª ×¤×¨×™×˜ ××• <i class="fas fa-bed"></i> ×œ×”×•×¡×¤×ª ××§×•× ×©×”×™×™×”.</p>'; return; }

         accommodations.sort((a, b) => (a.checkInDate || "").localeCompare(b.checkInDate || ""));

         sortedDates.forEach(date => {
             const activeAccommodation = findAccommodationForDate(date);
             const dateHeaderWrapper = document.createElement('div'); dateHeaderWrapper.className = 'date-header-wrapper';
             if (activeAccommodation) {
                 const indicator = document.createElement('span'); indicator.className = 'accommodation-indicator';
                 indicator.title = `××§×•× ×©×”×™×™×”: ${activeAccommodation.name}\n×œ×—×¥ ×œ×¤×¨×˜×™×`; indicator.innerHTML = `${getAccommodationIcon(activeAccommodation.type)} ${activeAccommodation.name}`;
                 indicator.onclick = (event) => { event.stopPropagation(); showAccommodationInfo(activeAccommodation.id, event); }; dateHeaderWrapper.appendChild(indicator);
             }
             const dateHeader = document.createElement('h3'); dateHeader.innerHTML = formatDateHeader(date); dateHeaderWrapper.appendChild(dateHeader);
             container.appendChild(dateHeaderWrapper);

             if (groups[date]) {
                 groups[date].forEach(item => {
                     const index = scheduleItems.findIndex(i => i === item); if (index !== -1) {
                         const itemHTML = generateScheduleItemHTML(item, index, false); const tempDiv = document.createElement('div'); tempDiv.innerHTML = itemHTML.trim(); if (tempDiv.firstChild) container.appendChild(tempDiv.firstChild);
                     }
                 });
             }
         });
     }

    // --- Item Specific Functions ---
    function generateScheduleItemHTML(item, index, isFinalView = false) {
         let displaySubject = getDisplaySubject(item); let bgEmoji = getBackgroundEmoji(item); let extraLine = getExtraLine(item); let addressLine = ""; let locationLine = "";
         if (item.fromAddress && item.toAddress && (item.subject === "× ×¡×™×¢×”" || item.subject === "×”×œ×™×›×”")) { addressLine = `<p style="font-size: 0.9em; color: #666;"><i class="fas fa-map-marker-alt"></i> ${item.fromAddress} <i class="fas fa-arrow-right" style="font-size: 0.8em;"></i> ${item.toAddress}</p>`; }
         else if (item.location && !['×˜×™×¡×”'].includes(item.subject) && !(item.subject === '××•×›×œ' && item.foodLocation)) { locationLine = `<p style="font-size: 0.9em; color: #666;"><i class="fas fa-map-marker-alt"></i> ××™×§×•×: ${item.location}</p>`; }
         else if (item.subject === '××•×›×œ' && item.foodLocation) { locationLine = `<p style="font-size: 0.9em; color: #666;"><i class="fas fa-map-marker-alt"></i> ××§×•×: ${item.foodLocation}</p>`; }
         let deleteButtonHTML = isFinalView ? '' : `<span title="××—×§ ×¤×¨×™×˜" style="position: absolute; top: 10px; left: 10px; cursor: pointer; font-size: 1.2em; color: #e74c3c; padding: 5px; transition: color 0.2s; z-index: 2;" onclick="event.stopPropagation(); deleteScheduleItem(${index})">ğŸ—‘ï¸</span>`; let navButtonHTML = "";
         if (!isFinalView) {
             if((item.subject === "× ×¡×™×¢×”" || item.subject === "×”×œ×™×›×”") && item.fromAddress && item.toAddress) { navButtonHTML = `<button type="button" class="btn nav-button" onclick="event.stopPropagation(); checkRoute(${index})"><i class="fas fa-route"></i></button>`; }
             else if(item.location && !['×˜×™×¡×”'].includes(item.subject) && !(item.subject === '××•×›×œ' && item.foodLocation)) { navButtonHTML = `<button type="button" class="btn nav-button" onclick="event.stopPropagation(); navigateToGenericLocation(${index})"><i class="fas fa-route"></i></button>`; }
             else if(item.subject === "××•×›×œ" && item.foodLocation) { navButtonHTML = `<button type="button" class="btn nav-button" onclick="event.stopPropagation(); showFoodRoute(${index})"><i class="fas fa-route"></i></button>`; }
         } const clickAction = isFinalView ? '' : `onclick="showItemDetail(${index})"`;
         return `<div class="schedule-item" ${clickAction} data-date="${item.date}" data-subject="${item.subject}"> ${deleteButtonHTML} ${navButtonHTML} <div class="emoji-background">${bgEmoji}</div> <h3>${item.startTime || '??:??'} - ${item.endTime || '??:??'} : ${displaySubject}</h3> ${extraLine ? `<p style="font-size: 0.9em; color: #444;">${extraLine}</p>` : ''} ${addressLine} ${locationLine} <p>${item.description || ''}</p> </div>`;
     }
    function openAddItemModal() {
        const addItemForm = document.getElementById("addItemForm"); if (!addItemForm) return;
        if (editingSavedScheduleIndex === -1 && !scheduleName) { const scheduleNameInput = document.getElementById("scheduleNameInput"); const scheduleNameModal = document.getElementById("scheduleNameModal"); if(scheduleNameInput) scheduleNameInput.value = ''; if(scheduleNameModal) scheduleNameModal.style.display = "flex"; }
        else {
            editingIndex = -1; document.getElementById("addItemModalTitle").innerText = "×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×œ×•×´×–"; document.getElementById("addItemBtn").innerHTML = '<i class="fas fa-plus"></i> ×”×•×¡×£ ×¤×¨×™×˜'; addItemForm.reset();
            const modalDateInput = document.getElementById("modalDate"); const modalStartTimeInput = document.getElementById("modalStartTime");
            if (scheduleItems.length > 0) { const lastItem = scheduleItems[scheduleItems.length - 1]; if (modalDateInput) modalDateInput.value = lastItem.date; const lastItemOnDate = scheduleItems.filter(item => item.date === lastItem.date).pop(); if (lastItemOnDate?.endTime) { if(modalStartTimeInput) modalStartTimeInput.value = addOneMinute(lastItemOnDate.endTime); } else { if(modalStartTimeInput) modalStartTimeInput.value = "09:00"; } }
            else { if (modalDateInput) modalDateInput.valueAsDate = new Date(); if (modalStartTimeInput) modalStartTimeInput.value = "09:00"; }
            setDefaultEndTime(); updateSubjectDropdownOptions(); updatePermanentSubjectsList(); subjectChangeHandler(); document.getElementById("addItemModal").style.display = "flex";
        }
     }
    function closeAddItemModal() { document.getElementById("addItemModal").style.display = "none"; }
    function saveItem() {
        let dateValue = document.getElementById("modalDate")?.value; let startTime = document.getElementById("modalStartTime")?.value; let endTime = document.getElementById("modalEndTime")?.value; const subject = document.getElementById("modalSubject")?.value; const description = document.getElementById("modalDescription")?.value.trim(); const location = document.getElementById("locationInput")?.value.trim();
        if (!dateValue || !startTime || !endTime || !subject) { alert("×× × ××œ× ××ª ×›×œ ×©×“×•×ª ×”×—×•×‘×” (×ª××¨×™×š, ×©×¢×•×ª, × ×•×©×)."); return; } if (endTime <= startTime) { alert("×©×¢×ª ×”×¡×™×•× ×—×™×™×‘×ª ×œ×”×™×•×ª ×××•×—×¨×ª ××©×¢×ª ×”×”×ª×—×œ×”."); return; }
        const newItem = { date: dateValue, startTime, endTime, subject, description };
        if (subject === "×”×œ×™×›×”" || subject === "× ×¡×™×¢×”") { newItem.fromAddress = document.getElementById("fromAddress")?.value.trim(); newItem.toAddress = document.getElementById("toAddress")?.value.trim(); if (!newItem.fromAddress || !newItem.toAddress) { alert("×¢×‘×•×¨ ×”×œ×™×›×”/× ×¡×™×¢×”, ×™×© ×œ××œ× ×××™×¤×” ×•×œ××Ÿ."); return; } if (subject === "× ×¡×™×¢×”") newItem.travelMode = document.getElementById("travelModeSelect")?.value; }
        else if (subject === "××•×›×œ") { newItem.foodType = document.getElementById("foodTypeSelect")?.value; if (!newItem.foodType) { alert("×¢×‘×•×¨ ××•×›×œ, ×™×© ×œ×‘×—×•×¨ ×¡×•×’."); return; } if(["××¡×¢×“×”", "××•×›×œ ××”×™×¨", "×‘×™×ª ×§×¤×”"].includes(newItem.foodType)) { newItem.foodLocation = document.getElementById("foodLocationInput")?.value.trim(); if (!newItem.foodLocation) { alert("×¢×‘×•×¨ ×¡×•×’ ××•×›×œ ×–×”, ×™×© ×œ××œ× ×©× ××• ××™×§×•×."); return; } } else if (location) newItem.location = location; }
        else if (subject === "×˜×™×¡×”") { newItem.flightNumber = document.getElementById("flightNumberInput")?.value.trim().toUpperCase(); newItem.airline = document.getElementById("airlineInput")?.value.trim(); newItem.departureAirport = document.getElementById("departureAirportInput")?.value.trim(); newItem.arrivalAirport = document.getElementById("arrivalAirportInput")?.value.trim(); newItem.departureTime = startTime; newItem.arrivalTime = endTime; if (!newItem.flightNumber || !newItem.departureAirport || !newItem.arrivalAirport) { alert("×¢×‘×•×¨ ×˜×™×¡×”, ×™×© ×œ××œ× ×œ×¤×—×•×ª ××¡×¤×¨ ×˜×™×¡×” ×•×©×“×•×ª ×ª×¢×•×¤×”."); return; } }
        else if (!['×©×™× ×”', '×œ×§×•×'].includes(subject) && location) { newItem.location = location; }
        if (editingIndex === -1) { scheduleItems.push(newItem); } else if (editingIndex >= 0 && editingIndex < scheduleItems.length) { scheduleItems[editingIndex] = newItem; editingIndex = -1; } else { alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¤×¨×™×˜."); return; }
        renderScheduleItems(); closeAddItemModal();
    }
    function showItemDetail(index) {
        if (index < 0 || index >= scheduleItems.length) return; editingIndex = index; const item = scheduleItems[index]; const form = document.getElementById("addItemForm"); if (!form) return; form.reset();
        document.getElementById("modalDate").value = item.date; document.getElementById("modalStartTime").value = item.startTime; document.getElementById("modalEndTime").value = item.endTime; document.getElementById("modalDescription").value = item.description || "";
        updateSubjectDropdownOptions(); document.getElementById("modalSubject").value = item.subject; subjectChangeHandler();
        if (item.subject === "×”×œ×™×›×”" || item.subject === "× ×¡×™×¢×”") { document.getElementById("fromAddress").value = item.fromAddress || ""; document.getElementById("toAddress").value = item.toAddress || ""; if (item.subject === "× ×¡×™×¢×”") document.getElementById("travelModeSelect").value = item.travelMode || "taxi"; }
        else if (item.subject === "××•×›×œ") { document.getElementById("foodTypeSelect").value = item.foodType || ""; foodTypeChangeHandler(); if (item.foodLocation) document.getElementById("foodLocationInput").value = item.foodLocation; else if (item.location) document.getElementById("locationInput").value = item.location; }
        else if (item.subject === "×˜×™×¡×”") { document.getElementById("flightNumberInput").value = item.flightNumber || ""; document.getElementById("airlineInput").value = item.airline || ""; document.getElementById("departureAirportInput").value = item.departureAirport || ""; document.getElementById("arrivalAirportInput").value = item.arrivalAirport || ""; document.getElementById("modalStartTime").value = item.departureTime || item.startTime; document.getElementById("modalEndTime").value = item.arrivalTime || item.endTime; updateFlightTimeNote(); }
        else if (item.location) { document.getElementById("locationInput").value = item.location; }
        document.getElementById("addItemModalTitle").innerText = "×¢×¨×™×›×ª ×¤×¨×™×˜ ×‘×œ×•×´×–"; document.getElementById("addItemBtn").innerHTML = '<i class="fas fa-save"></i> ×©××•×¨ ×©×™× ×•×™×™×'; document.getElementById("addItemModal").style.display = "flex";
    }
    function deleteScheduleItem(index) { if (index < 0 || index >= scheduleItems.length) return; const itemSubject = scheduleItems[index].subject || '×¤×¨×™×˜ ×–×”'; if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×¨×™×˜ "${itemSubject}" ××”×œ×•×´×–?`)) { scheduleItems.splice(index, 1); renderScheduleItems(); } }

    // --- Accommodation Specific Functions ---
     function getAccommodationIcon(type) { switch (type) { case '××œ×•×Ÿ': return 'ğŸ¨'; case '×“×™×¨×”': return 'ğŸ¢'; case 'Airbnb': return '<i class="fab fa-airbnb"></i>'; case '×”×•×¡×˜×œ': return 'ğŸ’'; case '×§××¤×™× ×’': return 'â›º'; default: return 'â“'; } }
     function findAccommodationForDate(date) { if (!date) return null; let foundAcc = null; for (let i = accommodations.length - 1; i >= 0; i--) { const acc = accommodations[i]; if (acc.checkInDate && acc.checkOutDate && date >= acc.checkInDate && date < acc.checkOutDate) { foundAcc = acc; break; } } return foundAcc; }
     function getDatesInRange(startDate, endDate) { const dates = []; if (!startDate || !endDate || startDate >= endDate) return dates; try { let currentDate = new Date(startDate + 'T00:00:00Z'); const stopDate = new Date(endDate + 'T00:00:00Z'); while (currentDate < stopDate) { dates.push(currentDate.toISOString().split('T')[0]); currentDate.setUTCDate(currentDate.getUTCDate() + 1); } } catch(e) { console.error("Error getting dates in range:", e); } return dates; }
    function openAccommodationModal() { const form = document.getElementById('accommodationForm'); if (form) form.reset(); const lastDate = scheduleItems.length > 0 ? scheduleItems[scheduleItems.length - 1].date : null; const checkInInput = document.getElementById('accommodationCheckIn'); if (checkInInput) { checkInInput.value = lastDate || new Date().toISOString().split('T')[0]; } const checkOutInput = document.getElementById('accommodationCheckOut'); if (checkInInput?.value && checkOutInput) { try { let checkInDate = new Date(checkInInput.value + 'T00:00:00Z'); checkInDate.setUTCDate(checkInDate.getUTCDate() + 1); checkOutInput.value = checkInDate.toISOString().split('T')[0]; } catch (e) {} } document.getElementById('accommodationModal').style.display = 'flex'; }
    function closeAccommodationModal() { document.getElementById('accommodationModal').style.display = 'none'; }
    function checkAccommodationLocation() { const address = document.getElementById('accommodationAddress')?.value.trim(); if (!address) { alert("×× × ×”×–×Ÿ ×›×ª×•×‘×ª ×›×“×™ ×œ×”×¦×™×’ ×‘××¤×”."); return; } const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(address)}`; window.open(url, "_blank"); }
    function saveAccommodation() { const type = document.getElementById('accommodationType')?.value; const name = document.getElementById('accommodationName')?.value.trim(); const address = document.getElementById('accommodationAddress')?.value.trim(); const checkInDate = document.getElementById('accommodationCheckIn')?.value; const checkOutDate = document.getElementById('accommodationCheckOut')?.value; if (!type || !name || !address || !checkInDate || !checkOutDate) { alert("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª."); return; } if (checkOutDate <= checkInDate) { alert("×ª××¨×™×š ×¦'×§-×××•×˜ ×—×™×™×‘ ×œ×”×™×•×ª ×××•×—×¨ ××ª××¨×™×š ×¦'×§-××™×Ÿ."); return; } const newAccommodation = { id: 'acc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), type, name, address, checkInDate, checkOutDate }; accommodations.push(newAccommodation); accommodations.sort((a, b) => (a.checkInDate || "").localeCompare(b.checkInDate || "")); renderScheduleItems(); closeAccommodationModal(); }
    function showAccommodationInfo(accommodationId, event) { const acc = accommodations.find(a => a.id === accommodationId); const popup = document.getElementById('accommodationInfoPopup'); if (!acc || !popup) return; const popupIcon = document.getElementById('popupAccIcon'); const popupName = document.getElementById('popupAccName'); const popupType = document.getElementById('popupAccType'); const popupAddress = document.getElementById('popupAccAddress'); const popupDates = document.getElementById('popupAccDates'); const navBtn = document.getElementById('popupAccNavBtn'); if(popupIcon) popupIcon.innerHTML = getAccommodationIcon(acc.type); if(popupName) popupName.innerText = acc.name; if(popupType) popupType.innerText = acc.type; if(popupAddress) popupAddress.innerText = acc.address; if(popupDates) popupDates.innerText = `${formatDateForDisplay(acc.checkInDate)} - ${formatDateForDisplay(acc.checkOutDate)}`; if (navBtn) navBtn.onclick = () => navigateAccommodation(accommodationId); const indicator = event.currentTarget; const rect = indicator.getBoundingClientRect(); popup.style.display = 'block'; const popupWidth = popup.offsetWidth; const popupHeight = popup.offsetHeight; let top = rect.bottom + window.scrollY + 5; let left = rect.left + window.scrollX + (rect.width / 2) - (popupWidth / 2); if (left < 10) left = 10; if (left + popupWidth > window.innerWidth - 10) left = window.innerWidth - popupWidth - 10; if (top + popupHeight > window.innerHeight + window.scrollY - 10) { top = rect.top + window.scrollY - popupHeight - 10; } if (top < window.scrollY + 10) top = window.scrollY + 10; popup.style.top = `${top}px`; popup.style.left = `${left}px`; setTimeout(() => document.addEventListener('click', handleOutsidePopupClick, true), 0); }
     function handleOutsidePopupClick(event) { const popup = document.getElementById('accommodationInfoPopup'); if (popup && popup.style.display === 'block' && !popup.contains(event.target)) { let clickedIndicator = false; document.querySelectorAll('.accommodation-indicator').forEach(ind => { if (ind.contains(event.target)) clickedIndicator = true; }); if (!clickedIndicator) closeAccommodationInfoPopup(); } }
    function closeAccommodationInfoPopup() { const popup = document.getElementById('accommodationInfoPopup'); if (popup) popup.style.display = 'none'; document.removeEventListener('click', handleOutsidePopupClick, true); }
    function navigateAccommodation(accommodationId) { const acc = accommodations.find(a => a.id === accommodationId); if (acc?.address) { showRouteToDestination(acc.address); closeAccommodationInfoPopup(); } else { alert("×œ× × ××¦××” ×›×ª×•×‘×ª."); } }

    // --- Schedule Name Modal Functions ---
    function closeScheduleNameModal() { document.getElementById("scheduleNameModal").style.display = "none"; }
    function saveScheduleName() { const nameInput = document.getElementById("scheduleNameInput")?.value.trim(); if (!nameInput) { alert("×× × ×”×–×Ÿ ×©× ×œ×œ×•×´×–."); return; } if (savedSchedules.some((sch, idx) => sch.name === nameInput && idx !== editingSavedScheduleIndex)) { alert("×œ×•×– ×¢× ×©× ×–×” ×›×‘×¨ ×§×™×™×."); return; } scheduleName = nameInput; closeScheduleNameModal(); const contentArea = document.getElementById("content"); if(contentArea) { const titleElement = contentArea.querySelector('h2'); if (titleElement) titleElement.innerHTML = `<i class="fas fa-umbrella-beach"></i> ×œ×•"×–: ${scheduleName.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`; else renderInitialView(); } openAddItemModal(); }

    // --- Subject Management ---
    function updateSubjectDropdownOptions() { const subjectDropdown = document.getElementById("modalSubject"); if (!subjectDropdown) return; const currentValue = subjectDropdown.value; const defaultOptions = [ { value: "", text: "-- ×‘×—×¨ × ×•×©× --" }, { value: "×”×œ×™×›×”", text: "ğŸš¶ ×”×œ×™×›×”" }, { value: "× ×¡×™×¢×”", text: "ğŸš— × ×¡×™×¢×”" }, { value: "×‘×™×§×•×¨/×¡×™×•×¨", text: "ğŸ›ï¸ ×‘×™×§×•×¨/×¡×™×•×¨" }, { value: "×˜×™×¡×”", text: "âœˆï¸ ×˜×™×¡×”" }, { value: "××•×›×œ", text: "ğŸ½ï¸ ××•×›×œ" }, { value: "×©×™× ×”", text: "ğŸ˜´ ×©×™× ×”" }, { value: "×œ×§×•×", text: "â° ×œ×§×•×" }, { value: "×—×•×£", text: "ğŸ–ï¸ ×—×•×£" }, { value: "×§× ×™×•×ª", text: "ğŸ›ï¸ ×§× ×™×•×ª" }, { value: "×× ×•×—×”", text: "ğŸ§˜ ×× ×•×—×”" }, { value: "×‘×¨×™×›×”", text: "ğŸŠ ×‘×¨×™×›×”" }, { value: "××˜×¨×§×¦×™×”", text: "ğŸ¢ ××˜×¨×§×¦×™×”" }, { value: "××•×–×™××•×Ÿ", text: "ğŸ–¼ï¸ ××•×–×™××•×Ÿ" }, { value: "×›×œ×œ×™", text: "ğŸ“Œ ×›×œ×œ×™" } ]; subjectDropdown.innerHTML = ""; const allSubjects = new Set(defaultOptions.map(opt => opt.value)); defaultOptions.forEach(opt => subjectDropdown.add(new Option(opt.text, opt.value))); permanentSubjects.forEach(subject => { if (subject && !allSubjects.has(subject)) { subjectDropdown.add(new Option(subject, subject)); allSubjects.add(subject); } }); customSubjects.forEach(subject => { if (subject && !allSubjects.has(subject)) { subjectDropdown.add(new Option(subject, subject)); allSubjects.add(subject); } }); const addOption = new Option("+ ×”×•×¡×£ × ×•×©× ×—×“×©...", "addSubject"); addOption.style.fontWeight = "bold"; addOption.style.color = "#007bff"; subjectDropdown.add(addOption); if (Array.from(subjectDropdown.options).some(o => o.value === currentValue)) subjectDropdown.value = currentValue; else subjectDropdown.value = ""; }
    function openAddSubjectModal() { document.getElementById("addSubjectModal").style.display = "flex"; document.getElementById("addItemModal").style.zIndex = 1999; }
    function closeAddSubjectModal() { document.getElementById("addSubjectModal").style.display = "none"; document.getElementById("addItemModal").style.zIndex = ""; document.getElementById("newSubjectNameInput").value = ""; const subjectDropdown = document.getElementById("modalSubject"); if (subjectDropdown.value === 'addSubject' || !Array.from(subjectDropdown.options).some(o => o.value === subjectDropdown.value)) subjectDropdown.value = ""; subjectChangeHandler(); }
    function addSubjectOneTime() { const newSubjectName = document.getElementById("newSubjectNameInput")?.value.trim(); if (!newSubjectName) { alert("×× × ×”×–×Ÿ ×©× ×œ× ×•×©×."); return; } if (customSubjects.includes(newSubjectName) || permanentSubjects.includes(newSubjectName) || Array.from(document.getElementById("modalSubject").options).some(o => o.value === newSubjectName)) { alert("× ×•×©× ×–×” ×›×‘×¨ ×§×™×™×."); return; } customSubjects.push(newSubjectName); updateSubjectDropdownOptions(); document.getElementById("modalSubject").value = newSubjectName; closeAddSubjectModal(); }
    function addSubjectPermanent() { const newSubjectName = document.getElementById("newSubjectNameInput")?.value.trim(); if (!newSubjectName) { alert("×× × ×”×–×Ÿ ×©× ×œ× ×•×©×."); return; } if (permanentSubjects.includes(newSubjectName) || customSubjects.includes(newSubjectName) || Array.from(document.getElementById("modalSubject").options).some(o => o.value === newSubjectName)) { alert("× ×•×©× ×–×” ×›×‘×¨ ×§×™×™×."); return; } permanentSubjects.push(newSubjectName); localStorage.setItem('permanentVacationSubjects', JSON.stringify(permanentSubjects)); updateSubjectDropdownOptions(); updatePermanentSubjectsList(); document.getElementById("modalSubject").value = newSubjectName; closeAddSubjectModal(); alert(`×”× ×•×©× "${newSubjectName}" × ×•×¡×£ ×œ×¨×©×™××ª ×”× ×•×©××™× ×”×§×‘×•×¢×™×!`); }
    function updatePermanentSubjectsList() { const container = document.getElementById("permanentSubjectsList"); if (!container) return; container.innerHTML = ""; if (permanentSubjects.length === 0) { container.innerHTML = '<span style="color: #6c757d; font-size: 0.9em; padding: 5px;">××™×Ÿ × ×•×©××™× ×§×‘×•×¢×™× ×©××•×¨×™×.</span>'; return; } permanentSubjects.forEach(subject => { const itemSpan = document.createElement("span"); const trash = document.createElement("span"); trash.innerHTML = "ğŸ—‘ï¸"; trash.title = "××—×§ × ×•×©× ×§×‘×•×¢"; trash.style.cursor = "pointer"; trash.style.marginLeft = "auto"; trash.style.padding = "0 5px"; trash.onclick = function(event) { event.stopPropagation(); if (confirm(`×”×× ×œ××—×•×§ ××ª ×”× ×•×©× ×”×§×‘×•×¢ "${subject}"?`)) { const index = permanentSubjects.indexOf(subject); if (index > -1) { permanentSubjects.splice(index, 1); localStorage.setItem('permanentVacationSubjects', JSON.stringify(permanentSubjects)); updatePermanentSubjectsList(); updateSubjectDropdownOptions(); alert("×”× ×•×©× ×”×§×‘×•×¢ × ××—×§."); const subjectDropdown = document.getElementById("modalSubject"); if (subjectDropdown && subjectDropdown.value === subject) { subjectDropdown.value = ""; subjectChangeHandler(); } } } }; itemSpan.appendChild(document.createTextNode(subject)); itemSpan.appendChild(trash); container.appendChild(itemSpan); }); }
    function togglePermanentSubjectsList() { const container = document.getElementById("permanentSubjectsList"); const isHidden = !container.style.display || container.style.display === "none"; if (isHidden) { updatePermanentSubjectsList(); container.style.display = "block"; document.addEventListener('click', handleClickOutsideSubjectList, true); } else { container.style.display = "none"; document.removeEventListener('click', handleClickOutsideSubjectList, true); } }
    function handleClickOutsideSubjectList(event) { const container = document.getElementById("permanentSubjectsList"); const toggleBtn = document.getElementById("subjectsToggleBtn"); if (container && toggleBtn && !container.contains(event.target) && !toggleBtn.contains(event.target)) { container.style.display = 'none'; document.removeEventListener('click', handleClickOutsideSubjectList, true); } }
    function subjectChangeHandler() { const subj = document.getElementById("modalSubject")?.value; const extraQuestions = document.getElementById("extraQuestions"); const locationField = document.getElementById("locationField"); const foodOptions = document.getElementById("foodExtraOptions"); const flightOptions = document.getElementById("flightExtraOptions"); const descriptionGroup = document.getElementById("descriptionGroup"); const addItemBtn = document.getElementById("addItemBtn"); const startTimeLabel = document.getElementById("startTimeLabel"); const endTimeLabel = document.getElementById("endTimeLabel"); const timeNote = document.getElementById("timeNote"); if(extraQuestions) extraQuestions.style.display = "none"; if(locationField) locationField.style.display = "none"; if(foodOptions) foodOptions.style.display = "none"; if(flightOptions) flightOptions.style.display = "none"; if(descriptionGroup) descriptionGroup.style.display = "none"; if(addItemBtn) addItemBtn.style.display = 'none'; if(timeNote) timeNote.style.display = "none"; if(startTimeLabel) startTimeLabel.innerText = "×©×¢×ª ×”×ª×—×œ×”:"; if(endTimeLabel) endTimeLabel.innerText = "×©×¢×ª ×¡×™×•×:"; if (subj === "addSubject") { openAddSubjectModal(); } else if (subj) { if(descriptionGroup) descriptionGroup.style.display = "block"; if(addItemBtn) addItemBtn.style.display = 'inline-flex'; if (subj === "×”×œ×™×›×”" || subj === "× ×¡×™×¢×”") { if(extraQuestions) extraQuestions.style.display = "block"; const travelModeGroup = document.getElementById("travelModeGroup"); if(travelModeGroup) travelModeGroup.style.display = (subj === "× ×¡×™×¢×”") ? "block" : "none"; } else if (subj === "×˜×™×¡×”") { if(flightOptions) flightOptions.style.display = "block"; if(startTimeLabel) startTimeLabel.innerText = "×©×¢×ª ×”××¨××”:"; if(endTimeLabel) endTimeLabel.innerText = "×©×¢×ª × ×—×™×ª×”:"; updateFlightTimeNote(); if(timeNote) timeNote.style.display = "block"; } else if (subj === "××•×›×œ") { if(foodOptions) foodOptions.style.display = "block"; foodTypeChangeHandler(); } else if (!['×©×™× ×”', '×œ×§×•×'].includes(subj)) { if(locationField) locationField.style.display = "block"; } } }
    function foodTypeChangeHandler() { const foodType = document.getElementById("foodTypeSelect")?.value; const locationDiv = document.getElementById("foodLocationDiv"); const genericLocationField = document.getElementById("locationField"); if (locationDiv) { if (["××¡×¢×“×”", "××•×›×œ ××”×™×¨", "×‘×™×ª ×§×¤×”"].includes(foodType)) { locationDiv.style.display = "block"; if (genericLocationField) genericLocationField.style.display = "none"; document.getElementById("locationInput").value = ""; } else { locationDiv.style.display = "none"; document.getElementById("foodLocationInput").value = ""; if (genericLocationField && foodType) genericLocationField.style.display = "block"; else if (genericLocationField) genericLocationField.style.display = "none"; } } }

    // --- Navigation Functions ---
    function checkRoute(index) { let from, to; if (typeof index === 'number' && index >= 0 && index < scheduleItems.length) { const item = scheduleItems[index]; from = item.fromAddress; to = item.toAddress; } else { from = document.getElementById("fromAddress")?.value.trim(); to = document.getElementById("toAddress")?.value.trim(); } if (!from || !to) { alert("×× × ××œ× ×××™×¤×” ×•×œ××Ÿ."); return; } const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}`; window.open(url, "_blank"); }
    function navigateToGenericLocation(index) { let location = ""; if (typeof index === 'number' && index >= 0 && index < scheduleItems.length) location = scheduleItems[index].location; else location = document.getElementById("locationInput")?.value.trim(); if (!location) { alert("×× × ×”×–×Ÿ ××™×§×•×."); return; } showRouteToDestination(location); }
    function showFoodRoute(index) { let location = ""; if (typeof index === 'number' && index >= 0 && index < scheduleItems.length) location = scheduleItems[index].foodLocation; else location = document.getElementById("foodLocationInput")?.value.trim(); if (!location) { alert("×× × ×”×–×Ÿ ×©× ××• ××™×§×•× ×”××§×•×."); return; } showRouteToDestination(location); }
    function showRouteToDestination(destination) { const encodedDestination = encodeURIComponent(destination); if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((position) => { const origin = `${position.coords.latitude},${position.coords.longitude}`; const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${encodedDestination}`; window.open(url, "_blank"); }, (error) => { const url = `https://www.google.com/maps/search/?api=1&query=${encodedDestination}`; window.open(url, "_blank"); alert("×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××™×§×•× × ×•×›×—×™. ××¦×™×’ ××ª ×”×™×¢×“ ×‘××¤×”."); }, { timeout: 5000 }); } else { const url = `https://www.google.com/maps/search/?api=1&query=${encodedDestination}`; window.open(url, "_blank"); alert("×©×™×¨×•×ª×™ ××™×§×•× ××™× × × ×ª××›×™×. ××¦×™×’ ××ª ×”×™×¢×“ ×‘××¤×”."); } }

    // --- Flight Search ---
    function updateFlightTimeNote() { const depTime = document.getElementById("modalStartTime")?.value; const arrTime = document.getElementById("modalEndTime")?.value; const depAirport = document.getElementById("departureAirportInput")?.value.trim(); const arrAirport = document.getElementById("arrivalAirportInput")?.value.trim(); const timeNote = document.getElementById("timeNote"); if(!timeNote) return; let noteText = ""; if (depTime) noteText += `×”××¨××”: ${depTime}`; if (depAirport) noteText += ` (${depAirport})`; if (arrTime) noteText += noteText ? `, × ×—×™×ª×”: ${arrTime}` : `× ×—×™×ª×”: ${arrTime}`; if (arrAirport) noteText += ` (${arrAirport})`; timeNote.innerText = noteText || "(×©×¢×ª ×”××¨××” ×•×©×¢×ª × ×—×™×ª×”)"; timeNote.style.display = 'block'; }
    function searchFlight() { const flightNumberInput = document.getElementById("flightNumberInput"); const flightDateInput = document.getElementById("modalDate"); const loader = document.getElementById("loader"); const flightNumber = flightNumberInput?.value.trim().toUpperCase(); const flightDate = flightDateInput?.value; if (!flightNumber || !flightDate) { alert("×× × ×”×–×Ÿ ××¡×¤×¨ ×˜×™×¡×” ×•×ª××¨×™×š."); return; } if(loader) loader.style.display = "flex"; const apiKey = "33d4ecb375mshcf029fba766af44p17668djsnaef3c36cb209"; const host = "aerodatabox.p.rapidapi.com"; const apiUrl = `https://aerodatabox.p.rapidapi.com/flights/number/${flightNumber}/${flightDate}?withAircraft=false&withLocation=false`; fetch(apiUrl, { method: "GET", headers: { "x-rapidapi-host": host, "x-rapidapi-key": apiKey } }).then(response => { if (!response.ok) return response.json().then(errData => { throw new Error(errData.message || `×©×’×™××” ${response.status}: ${response.statusText}`); }).catch(() => { throw new Error(`×©×’×™××” ${response.status}: ${response.statusText}`); }); return response.json(); }).then(data => { let html = ""; if (data?.length > 0) { const flight = data[0]; const airlineName = flight.airline?.name ?? "?"; const depAirport = flight.departure?.airport?.name ?? "?"; const arrAirport = flight.arrival?.airport?.name ?? "?"; const depTimeFull = flight.departure?.scheduledTime?.local ?? flight.departure?.actualTime?.local ?? "?"; const arrTimeFull = flight.arrival?.scheduledTime?.local ?? flight.arrival?.actualTime?.local ?? "?"; const depTimeLocalMatch = depTimeFull.match(/(\d{2}:\d{2})/); const arrTimeLocalMatch = arrTimeFull.match(/(\d{2}:\d{2})/); const depTimeLocal = depTimeLocalMatch ? depTimeLocalMatch[1] : "??:??"; const arrTimeLocal = arrTimeLocalMatch ? arrTimeLocalMatch[1] : "??:??"; html += `<div class="flight-card"> <h2>×˜×™×¡×ª ${airlineName} (${flight.number || flightNumber})</h2> <p><span class="time-label">×:</span> ${depAirport}</p> <p><span class="time-label">××œ:</span> ${arrAirport}</p> <p><span class="time-label">×™×¦×™××” ××ª×•×›× × ×ª:</span> ${depTimeFull}</p> <p><span class="time-label">×”×’×¢×” ××ª×•×›× × ×ª:</span> ${arrTimeFull}</p> </div>`; window.flightData = { flightNumber: flight.number || flightNumber, airline: airlineName, departureAirport: depAirport, arrivalAirport: arrAirport, departureTime: depTimeLocal, arrivalTime: arrTimeLocal }; } else { html = `<p style="color: #dc3545;">×œ× × ××¦××• ×¤×¨×˜×™ ×˜×™×¡×”.</p>`; window.flightData = null; } document.getElementById("flightResultContent").innerHTML = html; document.getElementById("flightResultModal").style.display = "flex"; }).catch(error => { document.getElementById("flightResultContent").innerHTML = `<p style="color: #dc3545;">×©×’×™××” ×‘×—×™×¤×•×© ×”×˜×™×¡×”: ${error.message}.</p>`; document.getElementById("flightResultModal").style.display = "flex"; window.flightData = null; }).finally(() => { if(loader) loader.style.display = "none"; }); }
    function closeFlightResultModal() { document.getElementById("flightResultModal").style.display = "none"; }
    function copyFlightToForm() { if (window.flightData) { document.getElementById("flightNumberInput").value = window.flightData.flightNumber; document.getElementById("airlineInput").value = window.flightData.airline; document.getElementById("departureAirportInput").value = window.flightData.departureAirport; document.getElementById("arrivalAirportInput").value = window.flightData.arrivalAirport; document.getElementById("modalStartTime").value = window.flightData.departureTime; document.getElementById("modalEndTime").value = window.flightData.arrivalTime; updateFlightTimeNote(); closeFlightResultModal(); alert("×¤×¨×˜×™ ×”×˜×™×¡×” ×”×•×¢×ª×§×• ×œ×˜×•×¤×¡."); } else { alert("××™×Ÿ × ×ª×•× ×™ ×˜×™×¡×” ×œ×”×¢×ª×§×”."); } }

    // --- Utilities ---
    function setDefaultEndTime() { const startTimeInput = document.getElementById("modalStartTime"); const endTimeInput = document.getElementById("modalEndTime"); if (!startTimeInput || !endTimeInput) return; const startTime = startTimeInput.value; if (startTime) { let [h, m] = startTime.split(":").map(Number); h = (h + 1) % 24; const defaultEndTime = `${h < 10 ? "0" : ""}${h}:${m < 10 ? "0" : ""}${m}`; if (!endTimeInput.value || endTimeInput.value === startTime) endTimeInput.value = defaultEndTime; } }
    function addOneMinute(timeStr) { if (!timeStr || !timeStr.includes(':')) return "09:00"; let [h, m] = timeStr.split(":").map(Number); m++; if (m >= 60) { m = 0; h = (h + 1) % 24; } return `${h < 10 ? "0" : ""}${h}:${m < 10 ? "0" : ""}${m}`; }
    function captureScreenshotFromElement(elementId, name) { const elem = document.getElementById(elementId); const titleElem = document.getElementById("finalScheduleTitle"); if (!elem || !titleElem) { alert("×©×’×™××”: ×œ× × ××¦× ×”××œ×× ×˜ ×œ×¦×™×œ×•×."); return; } const wrapper = document.createElement('div'); wrapper.style.cssText = 'padding: 25px; background-color: #ffffff; display: inline-block; text-align: center; border: 1px solid #eee; position: absolute; left: -9999px; top: -9999px;'; const titleClone = titleElem.cloneNode(true); titleClone.style.marginBottom = '20px'; const scheduleClone = elem.cloneNode(true); scheduleClone.style.maxHeight = 'none'; scheduleClone.style.overflowY = 'visible'; wrapper.appendChild(titleClone); wrapper.appendChild(scheduleClone); document.body.appendChild(wrapper); html2canvas(wrapper, { backgroundColor: "#ffffff", useCORS: true, scale: 1.5, logging: false }).then(canvas => { document.body.removeChild(wrapper); canvas.toBlob(function(blob) { if (blob) { const link = document.createElement("a"); const cleanName = name ? name.replace(/</g, "").replace(/>/g, "").trim() : '×œ×•×–'; const safeName = (cleanName || '×œ×•×–').replace(/[\s]/g, '_').replace(/[^a-z0-9×-×ª_\-]/gi, '') || '×œ×•×–'; link.download = safeName + ".png"; link.href = URL.createObjectURL(blob); link.click(); setTimeout(() => URL.revokeObjectURL(link.href), 100); } else { alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×§×•×‘×¥ ×”×ª××•× ×”."); } }, 'image/png'); }).catch(err => { if (document.body.contains(wrapper)) document.body.removeChild(wrapper); alert("×©×’×™××” ×‘×¦×™×œ×•× ×”××¡×š."); }); }
    function copyScheduleToClipboard() { let text = scheduleName ? `*${scheduleName.replace(/</g, "").replace(/>/g, "").trim()}*\n\n` : '*×œ×•×– ×—×•×¤×©×”*\n\n'; const groups = groupItemsByDate(scheduleItems); const allDates = new Set([ ...scheduleItems.map(item => item.date), ...accommodations.flatMap(acc => getDatesInRange(acc.checkInDate, acc.checkOutDate)) ]); const sortedDates = Array.from(allDates).filter(Boolean).sort(); sortedDates.forEach(date => { text += `ğŸ“… *${formatDateHeader(date)}*\n`; const activeAcc = findAccommodationForDate(date); if(activeAcc) text += `  ${getAccommodationIcon(activeAcc.type)} ${activeAcc.name} (${activeAcc.address})\n`; text += `--------------------\n`; if (groups[date]) { groups[date].forEach(item => { const emoji = getBackgroundEmoji(item); const startTime = item.startTime || '??:??'; const endTime = item.endTime || '??:??'; let displaySubjectText = getDisplaySubject(item); text += `*${startTime} - ${endTime}* : ${displaySubjectText} ${emoji}\n`; if (item.subject === "×˜×™×¡×”") { if (item.airline) text += `    ×—×‘×¨×”: ${item.airline}\n`; if (item.flightNumber) text += `    ××¡': ${item.flightNumber}\n`; if (item.departureAirport && item.arrivalAirport) text += `    *${item.departureAirport}* â¬…ï¸ *${item.arrivalAirport}*\n`; } else if (item.fromAddress && item.toAddress && (item.subject === "× ×¡×™×¢×”" || item.subject === "×”×œ×™×›×”")) { text += `    ×: ${item.fromAddress}\n    ×œ: ${item.toAddress}\n`; if(item.travelMode && item.subject === "× ×¡×™×¢×”") text += `    (${translateTravelMode(item.travelMode)})\n`; } else if (item.location && !['×˜×™×¡×”'].includes(item.subject) && !(item.subject === '××•×›×œ' && item.foodLocation)) { text += `    ğŸ“ ××™×§×•×: ${item.location}\n`; } else if (item.subject === "××•×›×œ") { if (item.foodType) text += `    ×¡×•×’: ${item.foodType}\n`; if (item.foodLocation) text += `    ğŸ“ ××§×•×: ${item.foodLocation}\n`; } if (item.description) text += `   - ${item.description.trim()}\n`; text += "\n"; }); } else if (!activeAcc) { text += "  (××™×Ÿ ×¤×¨×™×˜×™× ×œ×™×•× ×–×”)\n\n"; } }); copyUsingClipboardAPI(text.trim()); }
    function copyUsingClipboardAPI(textToCopy) { if (navigator.clipboard?.writeText) { navigator.clipboard.writeText(textToCopy).then(() => { alert("×”×œ×•×´×– ×”×•×¢×ª×§ ×œ×œ×•×—!"); }).catch(err => { copyUsingExecCommand(textToCopy); }); } else { copyUsingExecCommand(textToCopy); } }
    function copyUsingExecCommand(textToCopy) { const textArea = document.createElement("textarea"); textArea.value = textToCopy; textArea.style.position = "fixed"; textArea.style.top = "-9999px"; textArea.style.left = "-9999px"; textArea.setAttribute("readonly", ""); document.body.appendChild(textArea); textArea.select(); try { if (document.execCommand('copy')) alert("×”×œ×•×´×– ×”×•×¢×ª×§ ×œ×œ×•×—!"); else alert("×”×¢×ª×§×” × ×›×©×œ×”."); } catch (err) { alert("×”×¢×ª×§×” × ×›×©×œ×”."); } finally { document.body.removeChild(textArea); } }
    function groupItemsByDate(items) { return items.reduce((groups, item) => { const date = item.date; if (!date) return groups; if (!groups[date]) groups[date] = []; groups[date].push(item); return groups; }, {}); }
    function formatDateHeader(dateStr) { if (!dateStr) return "×ª××¨×™×š ×œ× ×™×“×•×¢"; try { const [year, month, day] = dateStr.split('-'); const dateObj = new Date(Date.UTC(year, month - 1, day)); const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Jerusalem' }; return dateObj.toLocaleDateString('he-IL', options); } catch (e) { return dateStr; } }
    function formatDateForDisplay(dateStr) { if (!dateStr) return "?"; try { const [year, month, day] = dateStr.split('-'); return `${day}/${month}/${year}`; } catch (e) { return dateStr; } }
    function getDisplaySubject(item) { if (item.subject === "× ×¡×™×¢×”" && item.travelMode) return "× ×¡×™×¢×” " + translateTravelMode(item.travelMode); return item.subject || '×œ×œ× × ×•×©×'; }
    function translateTravelMode(mode) { switch(mode) { case 'taxi': return 'ğŸš–'; case 'transit': return 'ğŸš‹ğŸš†'; case 'car': return 'ğŸš™'; default: return ''; } }
    function getBackgroundEmoji(item) { if (!item?.subject) return subjectEmojis["×›×œ×œ×™"]; const emojiInSubject = item.subject.match(/\p{Emoji_Presentation}/u); if (emojiInSubject) return emojiInSubject[0]; return subjectEmojis[item.subject] || subjectEmojis["×›×œ×œ×™"]; }
    function getExtraLine(item) { let line = ""; if(item.subject === "××•×›×œ" && item.foodType) line += `×¡×•×’: ${item.foodType}`; else if(item.subject === "×˜×™×¡×”") { line = `×˜×™×¡×” ${item.flightNumber || ""}`; if(item.airline) line += ` (${item.airline})`; } return line; }

     document.addEventListener('DOMContentLoaded', () => {
         document.addEventListener('click', handleOutsidePopupClick, true);

         const addItemModal = document.getElementById('addItemModal');
         const form = document.getElementById('addItemForm');
         if(addItemModal && form) {
              const observer = new MutationObserver(mutations => {
                  mutations.forEach(mutation => {
                      if (mutation.attributeName === 'style' && addItemModal.style.display === 'flex' && editingIndex === -1) {
                         form.reset(); subjectChangeHandler();
                     }
                 });
             });
             observer.observe(addItemModal, { attributes: true });
         }
     });

  </script>

</body>
</html>